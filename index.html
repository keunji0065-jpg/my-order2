<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (AI ìë™ìŠ¤ìº”)</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .processed-chat { text-decoration: line-through; background-color: #f3f4f6 !important; color: #9ca3af !important; border-color: #e5e7eb !important; opacity: 0.6; }
        .selected-chat-active { border-left: 4px solid #3182ce; background-color: #ebf8ff; }
        .badge-pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .cancelled-item { text-decoration: line-through; color: #9ca3af; background-color: #f3f4f6; }
        
        /* AI ë²„íŠ¼ íš¨ê³¼ */
        .ai-btn { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; }
        .ai-btn:hover { opacity: 0.9; transform: scale(1.05); }
        .ai-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* AI ê°ì§€ëœ ì£¼ë¬¸ ìŠ¤íƒ€ì¼ */
        .ai-detected { border: 2px solid #34d399; background-color: #ecfdf5; }
        .ai-badge { background-color: #34d399; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // âœ… URL ê³ ì •
        const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbx-vBZvKr4C0eWjpaPplaD-AEPaQ0FPG7Tzz5gm-yXQYQUkX686TpA-ZXBnebFpq0G_/exec";

        const Icon = ({ name, className="" }) => <i className={`ph ph-${name} ${className}`}></i>;

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const LiveTab = ({ orders, setOrders, productHistory, setProductHistory, quickShipping, setQuickShipping, shippingOverrides, setShippingOverrides, bankAccount, setBankAccount, googleScriptUrl, geminiKey, setGeminiKey }) => {
            const [chats, setChats] = useState([]);
            const [deposits, setDeposits] = useState([]);
            const [addresses, setAddresses] = useState([]); 
            const [clickedChats, setClickedChats] = useState(new Set());
            const [selectedNick, setSelectedNick] = useState(null); 
            const [matchedDeposits, setMatchedDeposits] = useState(new Set());
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            
            // ê²€ìƒ‰ í•„í„° (ê°ê° ë¶„ë¦¬)
            const [chatSearch, setChatSearch] = useState('');
            const [depositSearch, setDepositSearch] = useState('');
            const [orderSearch, setOrderSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            
            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: '' }); 
            const [isAiLoading, setIsAiLoading] = useState(false);

            // ğŸ¤– AI ë¶„ì„ ê²°ê³¼ ì €ì¥ì†Œ (Chat ID -> {product, qty})
            const [aiDetectedData, setAiDetectedData] = useState({});
            const [showAiOnly, setShowAiOnly] = useState(false); // AI ê°ì§€ëœ ê²ƒë§Œ ë³´ê¸° í•„í„°

            // ë°ì´í„° ë¡œë”©
            const fetchData = async () => {
                if (!googleScriptUrl || googleScriptUrl.includes("ì—¬ê¸°ì—")) {
                    setConnectionStatus({ code: 'error_url', msg: 'ì£¼ì†Œ ë¯¸ì…ë ¥' });
                    return;
                }
                try {
                    const res = await fetch(googleScriptUrl);
                    if (!res.ok) throw new Error(`HTTP ì—ëŸ¬: ${res.status}`);
                    const text = await res.text();
                    let data;
                    try { data = JSON.parse(text); } catch (e) { throw new Error("ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜"); }
                    
                    if (data.chats) {
                        setChats(data.chats);
                        if (data.chats.length === 0) setConnectionStatus({ code: 'warning_empty', msg: 'ë°ì´í„° 0ê±´' });
                        else setConnectionStatus({ code: 'success', msg: 'ì—°ê²° ì„±ê³µ' });
                    }
                    if (data.deposits) setDeposits(data.deposits);
                    if (data.addresses) setAddresses(data.addresses);
                    if (data.error_yt) console.error("ìœ íŠœë¸Œ ì‹œíŠ¸ ì—ëŸ¬:", data.error_yt);

                } catch (e) {
                    console.error("ì—°ê²° ì‹¤íŒ¨:", e);
                    setConnectionStatus({ code: 'error_fetch', msg: e.message });
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [googleScriptUrl]);

            const findAddress = (nick) => {
                return addresses.find(a => a.nickname.trim() === nick.trim());
            };

            const saveToGoogleSheet = async () => {
                if (Object.keys(orders).length === 0) return alert("ì €ì¥í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                if (!confirm("í˜„ì¬ ì£¼ë¬¸ì„œë¥¼ êµ¬ê¸€ ì‹œíŠ¸ 'ìµœì¢…ì£¼ë¬¸ì„œ'ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                let saveList = [];
                orders.forEach(o => {
                    if (o.isCancelled) return;
                    const addr = findAddress(o.customer) || {};
                    const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping);
                    
                    saveList.push({
                        nickname: o.customer,
                        product: o.product,
                        qty: o.quantity,
                        price: o.price,
                        deposit: o.deposit,
                        shipping: currentShipping, 
                        grandTotal: 0, 
                        address: addr.address || '',
                        phone: addr.phone || '',
                        realname: addr.realname || ''
                    });
                });

                try {
                    const res = await fetch(googleScriptUrl, {
                        method: 'POST',
                        body: JSON.stringify(saveList)
                    });
                    const json = await res.json();
                    if(json.result === 'success') alert("âœ… ì €ì¥ ì™„ë£Œ!");
                    else alert("ì €ì¥ ì‹¤íŒ¨: " + json.msg);
                } catch(e) {
                    alert("ì „ì†¡ ì˜¤ë¥˜: " + e.message);
                }
            };

            const addOrderLogic = (nickname, content, qty = 1) => {
                const initialProduct = content || '';
                const initialPrice = productHistory[initialProduct] || 0;
                setOrders(prev => {
                    const existIdx = prev.findIndex(o => o.customer === nickname && o.product === initialProduct && !o.isCancelled);
                    setSelectedNick(nickname);
                    setOrderSearch(''); 
                    if (existIdx >= 0) {
                        const next = [...prev];
                        next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + qty, price: (next[existIdx].quantity + qty) * initialPrice };
                        return next;
                    }
                    return [{ id: Date.now(), customer: nickname, product: initialProduct, quantity: qty, price: initialPrice, deposit: 0, originalText: content, isCancelled: false }, ...prev];
                });
            };

            // ğŸ¤– AI ì¼ê´„ ìŠ¤ìº” (Batch Scan)
            const scanChatsWithGemini = async () => {
                if (!geminiKey) return alert("ìš°ì¸¡ ìƒë‹¨ í†±ë‹ˆë°”í€´(âš™ï¸)ì—ì„œ Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
                
                // ì•„ì§ ë¶„ì„ ì•ˆ ëœ ìµœì‹  ì±„íŒ… 20ê°œë§Œ ê°€ì ¸ì˜¤ê¸° (ë¹„ìš©/ì†ë„ ê³ ë ¤)
                const unanalyzedChats = chats.filter(c => !aiDetectedData[c.id]).slice(0, 30);
                
                if (unanalyzedChats.length === 0) return alert("ìƒˆë¡œ ë¶„ì„í•  ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");

                setIsAiLoading(true);
                
                // í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                const chatTextList = unanalyzedChats.map(c => `ID:${c.id}, ë‚´ìš©:${c.content}`).join('\n');
                const prompt = `
                    ë‹¤ìŒì€ ë¼ì´ë¸Œ ì»¤ë¨¸ìŠ¤ ì±„íŒ… ë‚´ì—­ì´ë‹¤. ì¡ë‹´ì€ ë¬´ì‹œí•˜ê³ , 'ì£¼ë¬¸'ìœ¼ë¡œ ë³´ì´ëŠ” ë©”ì‹œì§€ë§Œ ê³¨ë¼ë‚´ë¼.
                    ìƒí’ˆëª…ê³¼ ìˆ˜ëŸ‰ì„ ì •í™•íˆ ì¶”ì¶œí•´ë¼. ìˆ˜ëŸ‰ì´ ì—†ìœ¼ë©´ 1ë¡œ ê°„ì£¼í•´ë¼.
                    
                    ì±„íŒ… ë¦¬ìŠ¤íŠ¸:
                    ${chatTextList}

                    ê²°ê³¼ë¥¼ ì•„ë˜ì™€ ê°™ì€ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•´ë¼. ì„¤ëª…ì€ í•„ìš” ì—†ë‹¤.
                    [{"id": "ì±„íŒ…ID", "product": "ìƒí’ˆëª…", "qty": ìˆ˜ëŸ‰}, ...]
                    ì£¼ë¬¸ì´ ì•„ë‹Œ ê²ƒì€ ê²°ê³¼ì— í¬í•¨ì‹œí‚¤ì§€ ë§ˆë¼.
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    // JSON ì¶”ì¶œ
                    const jsonMatch = resultText.match(/\[.*\]/s);
                    if (jsonMatch) {
                        const results = JSON.parse(jsonMatch[0]);
                        const newDetection = {};
                        let count = 0;
                        results.forEach(r => {
                            newDetection[r.id] = { product: r.product, qty: r.qty };
                            count++;
                        });
                        setAiDetectedData(prev => ({ ...prev, ...newDetection }));
                        if(count > 0) {
                            alert(`ğŸ¤– ${count}ê±´ì˜ ì£¼ë¬¸ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!\nì´ˆë¡ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ëŒ“ê¸€ì„ í´ë¦­í•˜ë©´ ë°”ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.`);
                            setShowAiOnly(true); // í¸ì˜ìƒ AI í•„í„° ì¼œì£¼ê¸°
                        } else {
                            alert("ì£¼ë¬¸ìœ¼ë¡œ ë³´ì´ëŠ” ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    } else {
                        alert("AI ì‘ë‹µ ë¶„ì„ ì‹¤íŒ¨");
                    }
                } catch (error) {
                    console.error("Gemini Scan Error:", error);
                    alert("AI ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setIsAiLoading(false);
                }
            };

            // âœ¨ Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ë©”ì‹œì§€ ì‘ì„±)
            const callGeminiMessage = async (nick, items, total, deposit, balance) => {
                if (!geminiKey) return alert("ìš°ì¸¡ ìƒë‹¨ í†±ë‹ˆë°”í€´(âš™ï¸)ì—ì„œ Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
                setIsAiLoading(true);
                try {
                    const itemListText = items.map(i => `${i.product} ${i.quantity}ê°œ`).join(', ');
                    const status = balance >= 0 ? "ì™„ë‚© (ê°ì‚¬ì¸ì‚¬)" : `ë¯¸ì…ê¸ˆ (ì…ê¸ˆìš”ì²­, ì”ì•¡ ${Math.abs(balance)}ì›)`;
                    
                    const prompt = `
                        ê³ ê°ë‹˜ê»˜ ë³´ë‚¼ ì •ì¤‘í•˜ê³  ì¹œì ˆí•œ ì¹´ì¹´ì˜¤í†¡ ì£¼ë¬¸ í™•ì¸ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì¤˜. ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì‚¬ìš©í•´.
                        ê³ ê°ëª…: ${nick}
                        ì£¼ë¬¸ë‚´ì—­: ${itemListText}
                        ì´ê¸ˆì•¡: ${total}ì›
                        ì…ê¸ˆí™•ì¸ì•¡: ${deposit}ì›
                        ìƒíƒœ: ${status}
                        ê³„ì¢Œ: ${bankAccount}
                        
                        ${balance < 0 ? 'ì¶”ê°€ ì…ê¸ˆì´ í•„ìš”í•œ ìƒí™©ì´ì•¼.' : 'ì…ê¸ˆì´ í™•ì¸ë˜ì–´ ë°°ì†¡ ì¤€ë¹„ì¤‘ì´ë¼ëŠ” ë‚´ìš©ì´ì•¼.'}
                        ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ì‘ì„±í•´ì¤˜.
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const msg = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (msg) {
                        navigator.clipboard.writeText(msg).then(() => alert(`ğŸ¤– AI ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${msg}`));
                    }
                } catch (error) {
                    console.error("Gemini Error:", error);
                    alert("AI ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨");
                } finally {
                    setIsAiLoading(false);
                }
            };

            // ëŒ“ê¸€ í´ë¦­ ì‹œ: AI ë¶„ì„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë‚´ìš© ì”€
            const handleChatClick = (chat) => { 
                setClickedChats(prev => new Set(prev).add(chat.id));
                const aiData = aiDetectedData[chat.id];
                if (aiData) {
                    addOrderLogic(chat.nickname, aiData.product, aiData.qty);
                } else {
                    addOrderLogic(chat.nickname, chat.content, 1); 
                }
            };

            const handleManualSubmit = (e) => { e.preventDefault(); if (!manualNick.trim()) return alert("ë‹‰ë„¤ì„!"); addOrderLogic(manualNick, manualProduct, 1); setManualProduct(''); };
            const handleDepositClick = (deposit, index) => {
                if (matchedDeposits.has(index)) return;
                if (!selectedNick) return alert("ì˜¤ë¥¸ìª½ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                const depositAmount = Number(deposit.amount);
                setOrders(prev => {
                    const targetOrders = prev.filter(o => o.customer === selectedNick);
                    const otherOrders = prev.filter(o => o.customer !== selectedNick);
                    if (targetOrders.length === 0) return prev;
                    const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                    return [...updatedTargets, ...otherOrders];
                });
                setMatchedDeposits(prev => new Set(prev).add(index));
            };
            const handleProductChange = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id === id) {
                        const newOrder = { ...o, [field]: value };
                        if (field === 'product' && productHistory[value]) newOrder.price = newOrder.quantity * productHistory[value];
                        if (field === 'price' && o.product) { const unitPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: unitPrice })); }
                        return newOrder;
                    } return o;
                }));
            };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            const handleNicknameEdit = (oldNick) => {
                const newNick = prompt(`'${oldNick}'ë‹˜ì˜ ë‹‰ë„¤ì„ì„ ë¬´ì—‡ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`, oldNick);
                if (newNick && newNick !== oldNick) {
                    setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o));
                    if (shippingOverrides[oldNick]) {
                        const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] };
                        delete newOverrides[oldNick];
                        setShippingOverrides(newOverrides);
                    }
                    if (selectedNick === oldNick) setSelectedNick(newNick);
                }
            };
            const handleOrderCancel = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o)); };
            const handleOrderDelete = (id) => { if(confirm("ì´ ì£¼ë¬¸ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setOrders(prev => prev.filter(o => o.id !== id)); };

            // ê¸°ì¡´ ì¹´í†¡ ë³µì‚¬ (ë‹¨ìˆœí˜•)
            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance) => {
                const activeItems = items.filter(i => !i.isCancelled);
                const itemListText = activeItems.map(i => `- ${i.product} ${i.quantity}ê°œ`).join('\n');
                const isPaid = balance >= 0;
                let msg = `[ì£¼ë¬¸ì„œ] ${nick}ë‹˜\n\nğŸ“¦ ì£¼ë¬¸ ë‚´ì—­\n${itemListText}\n\n`;
                msg += `ğŸ’° ì´ ê¸ˆì•¡: ${grandTotal.toLocaleString()}ì›\n`;
                if (depositTotal > 0) msg += `ğŸ’¸ ì…ê¸ˆ í™•ì¸: ${depositTotal.toLocaleString()}ì›\n`;
                if (isPaid) { msg += `âœ… ì™„ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.`; if (balance > 0) msg += ` (ì”ì•¡ ${balance.toLocaleString()}ì›ì€ ì ë¦½)`; } 
                else { msg += `------------------\nğŸ”º ë¯¸ì…ê¸ˆì•¡: ${Math.abs(balance).toLocaleString()}ì›\n------------------\nğŸ¦ ê³„ì¢Œ: ${bankAccount}\nì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ˜Š`; }
                
                const textArea = document.createElement("textarea");
                textArea.value = msg;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); alert(`${nick}ë‹˜ ì£¼ë¬¸ì„œ ë³µì‚¬ ì™„ë£Œ!`); } catch (err) { alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err); }
                document.body.removeChild(textArea);
            };

            // [NEW] í•„í„°ë§ (ê° ì„¹ì…˜ë³„)
            const filteredChats = useMemo(() => {
                let result = chats;
                // AI í•„í„°
                if (showAiOnly) {
                    result = result.filter(c => aiDetectedData[c.id]);
                }
                // ê²€ìƒ‰ í•„í„°
                if (chatSearch) {
                    result = result.filter(c => c.nickname.toLowerCase().includes(chatSearch.toLowerCase()) || c.content.toLowerCase().includes(chatSearch.toLowerCase()));
                }
                return result;
            }, [chats, chatSearch, showAiOnly, aiDetectedData]);

            const filteredDeposits = useMemo(() => {
                if (!depositSearch) return deposits;
                return deposits.filter(d => d.name.toLowerCase().includes(depositSearch.toLowerCase()) || String(d.amount).includes(depositSearch));
            }, [deposits, depositSearch]);

            const filteredGroupedOrders = useMemo(() => {
                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                return Object.entries(groups).filter(([nick, items]) => {
                    if (orderSearch && !nick.toLowerCase().includes(orderSearch.toLowerCase())) return false;
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const activeItems = items.filter(i => !i.isCancelled);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + finalShipping;
                    const balance = depositTotal - grandTotal;
                    const isPaid = balance >= 0 && depositTotal > 0;
                    if (filterStatus === 'unpaid' && isPaid) return false;
                    if (filterStatus === 'paid' && !isPaid) return false;
                    return true;
                });
            }, [orders, orderSearch, filterStatus, shippingOverrides, quickShipping]);

            const StatusMessage = () => {
                const { code, msg } = connectionStatus;
                if (code === 'error_url') return <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-2 m-2 text-xs">ğŸš¨ ì£¼ì†Œ ì—†ìŒ</div>;
                if (code === 'error_fetch') return <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-2 m-2 text-xs">âš ï¸ ì—°ê²° ì‹¤íŒ¨: {msg}</div>;
                if (code === 'warning_empty') return <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 m-2 text-xs">â„¹ï¸ ë°ì´í„° 0ê±´ (ì‹œíŠ¸ ì´ë¦„ Sheet1 í™•ì¸ í•„ìš”)</div>;
                return null;
            };

            return (
                <div className="flex h-full gap-2 p-2 overflow-hidden bg-gray-50">
                    <datalist id="product-list">{Object.keys(productHistory).map(name => <option key={name} value={name} />)}</datalist>
                    
                    {/* [1. ëŒ“ê¸€ ì˜ì—­ (30%)] */}
                    <div className="w-[30%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-red-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-red-600 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span>
                                <span className="text-xs text-gray-500">{filteredChats.length}ê±´</span>
                            </div>
                            
                            {/* AI ìŠ¤ìº” ë²„íŠ¼ & í•„í„° */}
                            <div className="flex gap-2">
                                <button onClick={scanChatsWithGemini} disabled={isAiLoading} 
                                    className={`flex-1 text-xs ai-btn px-2 py-1.5 rounded font-bold flex justify-center items-center gap-1 shadow-sm ${isAiLoading ? 'opacity-70 cursor-wait' : ''}`}>
                                    {isAiLoading ? <Icon name="spinner" className="ai-loading"/> : <Icon name="sparkle" weight="fill"/>} {isAiLoading ? "ë¶„ì„ì¤‘..." : "AI ì£¼ë¬¸ ìŠ¤ìº”"}
                                </button>
                                <button onClick={()=>setShowAiOnly(!showAiOnly)} 
                                    className={`px-2 py-1.5 text-xs rounded border flex items-center gap-1 ${showAiOnly ? 'bg-green-100 text-green-700 border-green-300 font-bold' : 'bg-gray-50 text-gray-500'}`}>
                                    <Icon name={showAiOnly ? "check-square" : "square"} /> ì£¼ë¬¸ë§Œ ë³´ê¸°
                                </button>
                            </div>

                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                <input type="text" placeholder="ë‹‰ë„¤ì„/ë‚´ìš© ê²€ìƒ‰" value={chatSearch} onChange={e => setChatSearch(e.target.value)} 
                                    className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-red-500 outline-none" />
                                {chatSearch && <button onClick={()=>setChatSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}
                            </div>
                            <div className="flex flex-wrap gap-2 text-[11px] text-gray-500 items-center bg-white p-1 rounded border border-gray-100">
                                <span>ê¸°ë³¸ë°°ì†¡: <input type="number" value={quickShipping} onChange={(e)=>setQuickShipping(Number(e.target.value))} className="w-10 border rounded px-1 text-right bg-gray-50" />ì›</span>
                                <span className="flex-1 flex items-center gap-1">ê³„ì¢Œ: <input type="text" value={bankAccount} onChange={(e)=>setBankAccount(e.target.value)} className="flex-1 border rounded px-1 bg-gray-50" placeholder="ê³„ì¢Œ ì…ë ¥" /></span>
                            </div>
                        </div>
                        
                        <StatusMessage />

                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {filteredChats.map(chat => {
                                const isClicked = clickedChats.has(chat.id);
                                const aiResult = aiDetectedData[chat.id]; // AI ë¶„ì„ ê²°ê³¼

                                return (
                                    <div key={chat.id} onClick={() => handleChatClick(chat)} 
                                         className={`p-2 border rounded cursor-pointer transition-all flex flex-col gap-1 
                                            ${isClicked ? 'processed-chat' : 'bg-white hover:bg-red-50 hover:border-red-200'}
                                            ${aiResult && !isClicked ? 'ai-detected' : ''} 
                                         `}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className={`font-bold ${isClicked ? 'text-gray-500' : 'text-gray-700'}`}>{chat.nickname}</span>
                                            <span className="text-gray-400">{chat.time ? new Date(chat.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                        </div>
                                        <div className="text-sm">{chat.content}</div>
                                        
                                        {/* AIê°€ ì°¾ì€ ìƒí’ˆ í‘œì‹œ */}
                                        {aiResult && !isClicked && (
                                            <div className="flex justify-between items-center mt-1">
                                                <span className="ai-badge flex items-center gap-1"><Icon name="robot" weight="fill"/> AIê°ì§€</span>
                                                <span className="text-xs font-bold text-green-600">
                                                    {aiResult.product} <span className="bg-green-100 px-1 rounded text-[10px]">{aiResult.qty}ê°œ</span>
                                                </span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {filteredChats.length === 0 && <div className="text-center text-gray-400 py-10 text-sm">í‘œì‹œí•  ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* [2. ì…ê¸ˆ ì˜ì—­ (20%)] */}
                    <div className="w-[20%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-yellow-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-yellow-700 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="money" weight="fill"/> ì…ê¸ˆ ë‚´ì—­</span>
                                <span className="text-xs text-gray-500">{filteredDeposits.length}ê±´</span>
                            </div>
                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                <input type="text" placeholder="ì…ê¸ˆì/ê¸ˆì•¡ ê²€ìƒ‰" value={depositSearch} onChange={e => setDepositSearch(e.target.value)} 
                                    className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-yellow-500 outline-none" />
                                {depositSearch && <button onClick={()=>setDepositSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}
                            </div>
                            {selectedNick && <div className="text-[11px] text-blue-600 bg-blue-50 p-1 rounded text-center animate-pulse">ğŸ‘‡ '{selectedNick}'ë‹˜ ì…ê¸ˆ ë§¤ì¹­ ì¤‘</div>}
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-yellow-50/30">
                            {filteredDeposits.map((d, i) => {
                                const isUsed = matchedDeposits.has(i);
                                const isSuggested = selectedNick && d.name.includes(selectedNick.replace(/ /g,''));
                                return (
                                    <div key={i} onClick={() => handleDepositClick(d, i)} 
                                         className={`flex justify-between p-2 border rounded cursor-pointer transition-all 
                                            ${isUsed ? 'opacity-40 bg-gray-100 line-through' : ''} 
                                            ${isSuggested && !isUsed ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-400' : 'bg-white hover:bg-yellow-100'}
                                         `}>
                                        <span className="text-gray-700 text-sm">{d.name}</span>
                                        <span className="font-mono text-blue-600 font-bold text-sm">+{Number(d.amount).toLocaleString()}</span>
                                    </div>
                                );
                            })}
                            {filteredDeposits.length === 0 && <div className="text-center text-gray-400 py-10 text-sm">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* [3. ì£¼ë¬¸ì„œ ì˜ì—­ (50%)] */}
                    <div className="w-[50%] bg-gray-100 border rounded-lg flex flex-col overflow-hidden">
                        <div className="p-2 bg-white border-b font-bold text-indigo-700 shadow-sm flex flex-col gap-2">
                            <div className="flex justify-between items-center">
                                <span>ğŸ“¦ ì£¼ë¬¸ì„œ ({filteredGroupedOrders.length}ëª…)</span>
                                <div className="flex items-center gap-2">
                                    <button onClick={saveToGoogleSheet} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1">
                                        <Icon name="floppy-disk" weight="fill"/> êµ¬ê¸€ì‹œíŠ¸ ì €ì¥
                                    </button>
                                    <div className="flex bg-gray-100 rounded p-0.5 gap-0.5 text-xs">
                                        <button onClick={()=>setFilterStatus('all')} className={`px-2 py-1 rounded ${filterStatus==='all' ? 'bg-white shadow text-indigo-600 font-bold':'text-gray-500'}`}>ì „ì²´</button>
                                        <button onClick={()=>setFilterStatus('unpaid')} className={`px-2 py-1 rounded ${filterStatus==='unpaid' ? 'bg-white shadow text-red-600 font-bold':'text-gray-500'}`}>ğŸ”ºë¯¸ì…ê¸ˆ</button>
                                        <button onClick={()=>setFilterStatus('paid')} className={`px-2 py-1 rounded ${filterStatus==='paid' ? 'bg-white shadow text-green-600 font-bold':'text-gray-500'}`}>âœ…ì™„ë‚©</button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1 flex gap-2 items-center bg-indigo-50 p-2 rounded border border-indigo-100">
                                    <span className="text-xs font-bold text-indigo-600 whitespace-nowrap">ğŸ–ï¸ ì¶”ê°€:</span>
                                    <form onSubmit={handleManualSubmit} className="flex gap-1 w-full">
                                        <input type="text" placeholder="ë‹‰ë„¤ì„" value={manualNick} onChange={e => setManualNick(e.target.value)} className="w-24 border rounded px-2 py-1 text-sm outline-none" />
                                        <input type="text" list="product-list" placeholder="ìƒí’ˆëª…" value={manualProduct} onChange={e => setManualProduct(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm outline-none" />
                                        <button type="submit" className="bg-indigo-600 text-white px-2 py-1 rounded text-sm font-bold hover:bg-indigo-700">ï¼‹</button>
                                    </form>
                                </div>
                                <div className="w-1/3 relative">
                                    <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                    <input type="text" placeholder="ì£¼ë¬¸ì ê²€ìƒ‰..." value={orderSearch} onChange={(e) => setOrderSearch(e.target.value)} className="w-full h-full pl-8 pr-2 border rounded text-sm outline-none" />
                                    {orderSearch && <button onClick={()=>setOrderSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill"/></button>}
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-3">
                            {filteredGroupedOrders.map(([nick, items]) => {
                                const isSelected = selectedNick === nick;
                                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                                
                                const activeItems = items.filter(i => !i.isCancelled);
                                const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                                const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                                const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                                const grandTotal = productTotal + finalShipping;
                                const balance = depositTotal - grandTotal;
                                let statusBadge;
                                if (depositTotal === 0) statusBadge = <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold">ë¯¸ì…ê¸ˆ</span>;
                                else if (balance >= 0) statusBadge = <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">âœ… ì™„ë‚©</span>;
                                else statusBadge = <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold badge-pulse">ğŸ”º {Math.abs(balance).toLocaleString()}ì› ë¶€ì¡±</span>;

                                const addr = findAddress(nick);

                                return (
                                    <div key={nick} onClick={() => setSelectedNick(prev => prev === nick ? null : nick)} className={`bg-white rounded-xl border shadow-sm transition-all overflow-hidden cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 shadow-md' : 'hover:border-indigo-300'}`}>
                                        <div className={`p-3 flex justify-between items-center ${isSelected ? 'bg-indigo-50' : 'bg-gray-50'} border-b`}>
                                            <div className="flex flex-col gap-1">
                                                <div className="flex items-center gap-2 group">
                                                    <span className="font-bold text-lg text-gray-800">{nick}</span>
                                                    <button onClick={(e)=>{e.stopPropagation(); handleNicknameEdit(nick);}} className="text-gray-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="pencil-simple" weight="bold"/></button>
                                                    <span className="text-xs bg-white border px-1.5 rounded text-gray-500">{items.length}ê±´</span>
                                                </div>
                                                <div className="flex items-center gap-1 text-xs">
                                                    {addr ? <span className="text-green-600 font-bold flex items-center gap-1"><Icon name="house-line" weight="fill"/> {addr.realname} ({addr.address.substring(0,10)}...)</span> : <span className="text-red-400 flex items-center gap-1"><Icon name="warning-circle" weight="fill"/> ì£¼ì†Œì—†ìŒ</span>}
                                                </div>
                                            </div>
                                            <div className="text-right flex items-center gap-3">
                                                <div className="text-xs text-gray-500 text-right"><div>ìƒí’ˆ {productTotal.toLocaleString()} + ë°°ì†¡ {finalShipping.toLocaleString()}</div><div className="font-bold text-lg font-mono text-gray-800">{grandTotal.toLocaleString()}ì›</div></div>
                                                <div className="flex flex-col gap-1 items-end">
                                                    {statusBadge}
                                                    <div className="flex gap-1">
                                                        <button onClick={(e) => { e.stopPropagation(); copyOrderSheet(nick, items, grandTotal, depositTotal, balance); }} className="bg-yellow-300 hover:bg-yellow-400 text-black px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm"><Icon name="chat-circle-dots" weight="fill"/> ì¹´í†¡ë³µì‚¬</button>
                                                        {/* âœ¨ AI ë©”ì‹œì§€ ë²„íŠ¼ */}
                                                        <button onClick={(e) => { e.stopPropagation(); callGeminiMessage(nick, activeItems, grandTotal, depositTotal, balance); }} className="ai-btn px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm">
                                                            {isAiLoading ? <Icon name="spinner" className="ai-loading"/> : <Icon name="sparkle" weight="fill"/>} AIë©”ì‹œì§€
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="p-2 space-y-1">
                                            {items.map((item, idx) => (
                                                <div key={idx} className={`flex justify-between items-center text-sm p-1.5 hover:bg-gray-50 rounded group ${item.isCancelled ? 'cancelled-item' : ''}`}>
                                                    <div className="flex-1 flex gap-2 items-center">
                                                        <input type="text" list="product-list" value={item.product} onChange={(e) => handleProductChange(item.id, 'product', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-full border-b border-dashed border-gray-300 bg-transparent focus:border-indigo-500 focus:bg-white outline-none px-1 py-0.5" placeholder="ìƒí’ˆëª…" disabled={item.isCancelled} />
                                                    </div>
                                                    <div className="flex items-center gap-2 pl-2">
                                                        <span className="font-bold text-indigo-600 bg-indigo-50 px-2 rounded text-xs shrink-0">{item.quantity}ê°œ</span>
                                                        <input type="number" value={item.price} onChange={(e) => handleProductChange(item.id, 'price', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-20 text-right font-mono text-gray-500 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 bg-transparent outline-none" disabled={item.isCancelled} />
                                                        <div className="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderCancel(item.id);}} className={`p-1 rounded ${item.isCancelled ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600'}`} title={item.isCancelled ? "ì·¨ì†Œ ë³µêµ¬" : "ì£¼ë¬¸ ì·¨ì†Œ"}><Icon name={item.isCancelled ? "arrow-u-up-left" : "prohibit"} weight="bold"/></button>
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderDelete(item.id);}} className="p-1 rounded bg-gray-200 text-gray-600 hover:bg-red-500 hover:text-white" title="ì™„ì „ ì‚­ì œ"><Icon name="trash" weight="bold"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="flex justify-end items-center gap-2 px-2 py-1 text-xs text-gray-400">ë°°ì†¡ë¹„ ìˆ˜ì •: <input type="number" value={currentShipping} onClick={(e)=>e.stopPropagation()} onChange={(e)=>handleShippingChange(nick, e.target.value)} className="w-12 text-right border rounded bg-white px-1 focus:ring-1 focus:ring-indigo-500" /></div>
                                            {depositTotal > 0 && (<div className="mt-2 pt-2 border-t border-dashed flex justify-between text-sm text-green-600 font-bold px-2"><span>â”” ì…ê¸ˆí™•ì¸ì•¡</span><span>{depositTotal.toLocaleString()}ì›</span></div>)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const OrderManagementTab = ({ orders, shippingOverrides, quickShipping, addresses }) => {
            const handleExportProducts = () => {
                const summary = {}; orders.forEach(o => { 
                    if(o.isCancelled) return; 
                    const name = o.product || '(ìƒí’ˆëª… ì—†ìŒ)'; if (!summary[name]) summary[name] = 0; summary[name] += Number(o.quantity); 
                });
                const data = Object.entries(summary).map(([product, qty]) => ({ 'ìƒí’ˆëª…': product, 'ì´í•„ìš”ìˆ˜ëŸ‰': qty }));
                downloadExcel(data, 'ìƒí’ˆë³„_ë°œì£¼ë¦¬ìŠ¤íŠ¸');
            };
            const handleExportCustomers = () => {
                const groups = {}; orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                const data = Object.entries(groups).map(([nick, items]) => {
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const activeItems = items.filter(i => !i.isCancelled);
                    if(activeItems.length === 0) return null; 
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + currentShipping;
                    const balance = depositTotal - grandTotal;
                    const itemSummary = activeItems.map(i => `${i.product}(${i.quantity})`).join(', ');
                    
                    const addrInfo = addresses.find(a => a.nickname.trim() === nick.trim()) || {};

                    return { 'ë‹‰ë„¤ì„': nick, 'ì‹¤ëª…': addrInfo.realname || '', 'ì „í™”ë²ˆí˜¸': addrInfo.phone || '', 'ì£¼ì†Œ': addrInfo.address || '', 'ì£¼ë¬¸ë‚´ì—­': itemSummary, 'ìƒí’ˆí•©ê³„': productTotal, 'ë°°ì†¡ë¹„': currentShipping, 'ì´ì£¼ë¬¸ê¸ˆì•¡': grandTotal, 'ì…ê¸ˆí™•ì¸ì•¡': depositTotal, 'ì”ì•¡(ë¯¸ìˆ˜ê¸ˆ)': -balance, 'ìƒíƒœ': balance >= 0 ? 'ì™„ë‚©' : 'ë¯¸ë‚©' };
                }).filter(d => d !== null);
                downloadExcel(data, 'ê³ ê°ë³„_ì •ì‚°_ë°°ì†¡ë¦¬ìŠ¤íŠ¸');
            };
            return (
                <div className="flex flex-col items-center justify-center h-full p-10 gap-6">
                    <div className="bg-white p-8 rounded-xl shadow-lg border text-center w-full max-w-md">
                        <div className="text-4xl mb-4">ğŸ“¦</div><h2 className="text-xl font-bold mb-2">ë°œì£¼ìš© í’ˆëª© ì§‘ê³„</h2><p className="text-gray-500 mb-6 text-sm">ì–´ë–¤ ìƒí’ˆì´ ëª‡ ê°œ í•„ìš”í•œì§€ ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.</p>
                        <button onClick={handleExportProducts} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"><Icon name="file-xls" weight="fill" size={20}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div className="bg-white p-8 rounded-xl shadow-lg border text-center w-full max-w-md">
                        <div className="text-4xl mb-4">ğŸ‘¥</div><h2 className="text-xl font-bold mb-2">ë°°ì†¡ìš© ê³ ê° ë¦¬ìŠ¤íŠ¸</h2><p className="text-gray-500 mb-6 text-sm">ì£¼ì†Œ, ì „í™”ë²ˆí˜¸ í¬í•¨ëœ ë°°ì†¡ ëª…ë‹¨ì„ ë½‘ìŠµë‹ˆë‹¤.</p>
                        <button onClick={handleExportCustomers} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"><Icon name="file-xls" weight="fill" size={20}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            const [activeTab, setActiveTab] = useState('live');
            const [quickShipping, setQuickShipping] = useState(4000); 
            const [bankAccount, setBankAccount] = useState(() => localStorage.getItem('bankAccount') || "ì¹´ì¹´ì˜¤ë±…í¬ 000-0000-0000");
            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [shippingOverrides, setShippingOverrides] = useState(() => JSON.parse(localStorage.getItem('shippingOverrides')) || {});
            const [addresses, setAddresses] = useState([]);
            // âœ… Gemini API Key ê¸°ë³¸ê°’ ì„¤ì •
            const [geminiKey, setGeminiKey] = useState(() => localStorage.getItem('geminiKey') || 'AIzaSyB13knjwU8Om5Ci9E2Th9K2ZeE7l167hgc');

            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('bankAccount', bankAccount); }, [bankAccount]);
            useEffect(() => { localStorage.setItem('shippingOverrides', JSON.stringify(shippingOverrides)); }, [shippingOverrides]);
            useEffect(() => { localStorage.setItem('geminiKey', geminiKey); }, [geminiKey]);

            const tabs = [{ id: 'live', label: 'ğŸ¥ ë¼ì´ë¸Œê´€ì œ', icon: 'monitor-play' }, { id: 'manage', label: 'ğŸ“Š ì£¼ë¬¸ê´€ë¦¬(ì—‘ì…€)', icon: 'file-xls' }];

            // ì„¤ì • ëª¨ë‹¬
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700">
                    <header className="h-12 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md">
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="lightning" className="text-yellow-400" weight="fill"/> ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO <span className="text-xs bg-indigo-800 px-2 py-0.5 rounded text-indigo-300">AI íƒ‘ì¬</span></div>
                        <div className="flex items-center gap-2">
                            <div className="flex bg-indigo-800 rounded p-1 gap-1">
                                {tabs.map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-900 shadow' : 'text-indigo-300 hover:text-white'}`}><Icon name={tab.icon} weight="bold"/> {tab.label}</button>
                                ))}
                            </div>
                            <button onClick={()=>setIsSettingsOpen(!isSettingsOpen)} className="p-2 hover:bg-indigo-800 rounded text-indigo-300 hover:text-white"><Icon name="gear" weight="fill" size={20}/></button>
                        </div>
                    </header>
                    
                    {/* ì„¤ì • ëª¨ë‹¬ (Gemini Key ì…ë ¥) */}
                    {isSettingsOpen && (
                        <div className="absolute top-12 right-4 bg-white shadow-xl border rounded-lg p-4 w-80 z-50 animate-pop">
                            <h3 className="font-bold mb-2 flex items-center gap-2"><Icon name="sparkle" weight="fill" className="text-purple-500"/> AI ì„¤ì •</h3>
                            <div className="text-sm text-gray-600 mb-2">Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ AI ìë™ë¶„ì„ ë° ë©”ì‹œì§€ ì‘ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
                            <input type="password" value={geminiKey} onChange={(e)=>setGeminiKey(e.target.value)} placeholder="API Key ì…ë ¥" className="w-full border rounded px-2 py-1 text-sm mb-2" />
                            <div className="text-xs text-gray-400">í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
                            <button onClick={()=>setIsSettingsOpen(false)} className="w-full bg-indigo-600 text-white rounded py-1 text-sm font-bold mt-2">ë‹«ê¸°</button>
                        </div>
                    )}

                    <main className="flex-1 overflow-hidden bg-gray-100">
                        {activeTab === 'live' && (<LiveTab orders={orders} setOrders={setOrders} productHistory={productHistory} setProductHistory={setProductHistory} quickShipping={quickShipping} setQuickShipping={setQuickShipping} shippingOverrides={shippingOverrides} setShippingOverrides={setShippingOverrides} bankAccount={bankAccount} setBankAccount={setBankAccount} googleScriptUrl={GOOGLE_API_URL} setAddresses={setAddresses} addresses={addresses} geminiKey={geminiKey} setGeminiKey={setGeminiKey} />)}
                        {activeTab === 'manage' && (<OrderManagementTab orders={orders} shippingOverrides={shippingOverrides} quickShipping={quickShipping} addresses={addresses} />)}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
