<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>by.Í∞ïÏùÄÏßÄ v2.9 (Print Fixed)</title>
    
    <!-- Daum Postcode -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'Roboto', 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fff1f2',
                            100: '#ffe4e6',
                            200: '#fecdd3',
                            300: '#fda4af',
                            400: '#fb7185',
                            500: '#f43f5e',
                            600: '#e11d48',
                            700: '#be123c',
                            800: '#9f1239',
                            900: '#881337',
                            950: '#4c0519',
                        },
                        dark: {
                            bg: '#0a0a0a',
                            card: '#171717',
                            input: '#262626',
                            text: '#e5e5e5',
                            muted: '#a3a3a3',
                            border: '#404040',
                        }
                    },
                    boxShadow: {
                        'soft': '0 2px 10px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 10px rgba(225, 29, 72, 0.2)',
                    }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Pretendard', sans-serif; -webkit-font-smoothing: antialiased; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: #a3a3a3; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #737373; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #525252; }

        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

        /* === PRINT FIX: The Ultimate Solution === */
        @media print {
            /* 1. Hide everything by default */
            body > * { display: none !important; }
            
            /* 2. Unhide the React Root but hide its normal children (header, main) */
            #root { display: block !important; }
            header, main, .fixed, .no-print { display: none !important; }

            /* 3. Force the receipt modal wrapper to be visible and fill the page */
            .receipt-modal-overlay {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                z-index: 9999 !important;
                background: white !important;
                display: block !important;
                overflow: visible !important; /* Critical for printing long lists */
            }

            /* 4. Ensure the inner container expands freely */
            .receipt-content-container {
                overflow: visible !important;
                height: auto !important;
                display: block !important;
            }

            /* 5. Page break rules for individual receipts */
            .receipt-page {
                page-break-inside: avoid;
                break-inside: avoid;
                page-break-after: always;
                break-after: page;
                margin-bottom: 0 !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
            }
            
            /* Reset colors for printing */
            * { 
                color: black !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
            .text-white { color: white !important; } /* Keep button text white if any */
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-900 dark:text-dark-text font-sans transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: Number(order.quantity) || 1,
                price: Number(order.price) || 0,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                shippingMemo: order.shippingMemo || '',
            };
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 16, className = "", weight = "bold" }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls", Sun: "ph-sun", Printer: "ph-printer"
            };
            const weightClass = weight === 'bold' ? 'ph-bold' : 'ph';
            return <i className={`${weightClass} ${map[name] || 'ph-question'} ${className}`} style={{ fontSize: size }}></i>;
        });

        // --- COMPONENT: Receipt Modal (PRINT FIXED) ---
        const ReceiptModal = ({ isOpen, onClose, orders, shippingFee }) => {
            if (!isOpen) return null;

            const grouped = useMemo(() => {
                return orders.reduce((acc, o) => {
                    const key = o.customer || 'ÎØ∏ÏßÄÏ†ï';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(o);
                    return acc;
                }, {});
            }, [orders]);

            const handlePrint = () => {
                window.print();
            };

            return (
                // Added 'receipt-modal-overlay' class for print targeting
                <div className="receipt-modal-overlay fixed inset-0 z-[100] bg-slate-900/90 backdrop-blur-sm flex flex-col overflow-hidden">
                    {/* Header (Hidden on Print via .no-print) */}
                    <div className="flex justify-between items-center p-4 bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border flex-none no-print">
                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <Icon name="Receipt" className="text-brand-600" size={24}/> Í∞úÎ≥Ñ Íµ¨Îß§ÎÇ¥Ïó≠ÏÑú (Ï¥ù {Object.keys(grouped).length}Î™Ö)
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={handlePrint} className="px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md font-bold flex items-center gap-2 transition-colors">
                                <Icon name="Printer" size={18}/> Ïù∏ÏáÑÌïòÍ∏∞
                            </button>
                            <button onClick={onClose} className="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-md font-bold transition-colors">Îã´Í∏∞</button>
                        </div>
                    </div>

                    {/* Scrollable Content - Added 'receipt-content-container' for print */}
                    <div className="receipt-content-container flex-1 overflow-y-auto p-6 bg-slate-100 dark:bg-black custom-scroll">
                        <div id="receipt-container" className="max-w-3xl mx-auto space-y-6 print:space-y-0">
                            {Object.entries(grouped).map(([name, items], idx) => {
                                const shipFee = items[0].customShippingFee ?? shippingFee;
                                const subTotal = items.reduce((sum, i) => sum + i.price, 0);
                                const isShipPaid = items.some(i => i.isShippingPaid);
                                const totalRequired = subTotal + shipFee;
                                const paidTotal = items.reduce((sum, i) => sum + i.deposit + i.cardAmount, 0);
                                const shippingCredit = isShipPaid ? shipFee : 0;
                                const unpaid = Math.max(0, totalRequired - paidTotal - shippingCredit);
                                const isPaid = unpaid === 0;

                                return (
                                    <div key={idx} className="receipt-page bg-white text-black p-8 rounded-xl shadow-sm max-w-xl mx-auto print:shadow-none print:border print:border-gray-300 print:mb-0">
                                        <div className="text-center border-b-2 border-black pb-4 mb-4">
                                            <h1 className="text-2xl font-black tracking-tight mb-1">ORDER RECEIPT</h1>
                                            <p className="text-sm font-bold text-gray-500">{new Date().toLocaleDateString()} Ï£ºÎ¨∏ÎÇ¥Ïó≠</p>
                                        </div>

                                        <div className="flex justify-between items-end mb-6">
                                            <div>
                                                <p className="text-xs text-gray-500 font-bold">CUSTOMER</p>
                                                <p className="text-xl font-bold">{name} Îãò</p>
                                            </div>
                                            <div className="text-right">
                                                 <span className={`px-2 py-1 rounded text-xs font-bold ${isPaid ? 'bg-black text-white' : 'bg-red-100 text-red-600 border border-red-200'}`}>
                                                    {isPaid ? 'Í≤∞Ï†úÏôÑÎ£å' : 'ÎØ∏ÏûÖÍ∏à'}
                                                </span>
                                            </div>
                                        </div>

                                        <table className="w-full text-sm mb-6">
                                            <thead>
                                                <tr className="border-b border-black">
                                                    <th className="text-left py-2">ÏÉÅÌíàÎ™Ö</th>
                                                    <th className="text-center py-2">ÏàòÎüâ</th>
                                                    <th className="text-right py-2">Í∏àÏï°</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {items.map((item, i) => (
                                                    <tr key={i} className="border-b border-dashed border-gray-200">
                                                        <td className="py-2 pr-2 font-medium">{item.product}</td>
                                                        <td className="py-2 text-center text-gray-500">{item.quantity}</td>
                                                        <td className="py-2 text-right font-bold">{item.price.toLocaleString()}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        <div className="space-y-2 border-t border-black pt-4 mb-6">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">ÏÉÅÌíà Ìï©Í≥Ñ</span>
                                                <span className="font-bold">{subTotal.toLocaleString()} Ïõê</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-600">Î∞∞ÏÜ°ÎπÑ</span>
                                                <span className="font-bold">{shipFee.toLocaleString()} Ïõê</span>
                                            </div>
                                            {paidTotal > 0 && (
                                                <div className="flex justify-between text-sm text-blue-600">
                                                    <span>Í∏∞ÏàòÎÇ©Ïï°(ÏûÖÍ∏à/Ïπ¥Îìú)</span>
                                                    <span className="font-bold">- {paidTotal.toLocaleString()} Ïõê</span>
                                                </div>
                                            )}
                                            {shippingCredit > 0 && (
                                                <div className="flex justify-between text-sm text-blue-600">
                                                    <span>Î∞∞ÏÜ°ÎπÑ Í≤∞Ï†úÏôÑÎ£å</span>
                                                    <span className="font-bold">- {shippingCredit.toLocaleString()} Ïõê</span>
                                                </div>
                                            )}
                                            <div className="flex justify-between text-xl font-black mt-4 pt-2 border-t border-dashed border-gray-300">
                                                <span>{isPaid ? 'Í≤∞Ï†ú Ï¥ùÏï°' : 'ÏûÖÍ∏à ÏöîÏ≤≠Ïï°'}</span>
                                                <span className={isPaid ? 'text-black' : 'text-red-600'}>
                                                    {isPaid ? totalRequired.toLocaleString() : unpaid.toLocaleString()} Ïõê
                                                </span>
                                            </div>
                                        </div>

                                        <div className="bg-gray-50 p-4 rounded-lg text-center text-sm print:bg-gray-100">
                                            {isPaid ? (
                                                <p className="font-bold text-blue-600 flex items-center justify-center gap-1">
                                                    <Icon name="CheckCircle" weight="fill"/> ÏôÑÎÇ© ÌôïÏù∏! Í∞êÏÇ¨Ìï©ÎãàÎã§ üòç
                                                </p>
                                            ) : (
                                                <div className="text-gray-700">
                                                    <p className="font-bold mb-1">ÏûÖÍ∏à Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§ üôè</p>
                                                    <p className="text-xs text-gray-500 mb-2">ÏïÑÎûò Í≥ÑÏ¢åÎ°ú ÏûÖÍ∏àÌï¥ Ï£ºÏÑ∏Ïöî</p>
                                                    <div className="inline-block bg-white border border-gray-200 px-4 py-2 rounded text-left shadow-sm">
                                                        <p className="text-xs text-gray-400 font-bold mb-0.5">Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨ ÍπÄÏÑ†Ï†ï</p>
                                                        <p className="font-mono font-bold text-lg tracking-wide text-brand-600">7942 18 01611</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Top Summary Card ---
        const SummaryDashboardCard = React.memo(({ totalRevenue, orderCount, shippingCount }) => {
            return (
                <div className="relative overflow-hidden rounded-xl bg-slate-900 dark:bg-black text-white p-4 shadow-lg border border-slate-800 dark:border-slate-800 h-full flex flex-col justify-between">
                    <div className="relative z-10">
                        <div className="flex items-center gap-1.5 mb-0.5">
                            <span className="inline-block w-1.5 h-1.5 rounded-full bg-brand-500"></span>
                            <p className="text-slate-400 text-[10px] font-bold tracking-widest uppercase">Ï¥ù ÏòàÏÉÅ Îß§Ï∂ú</p>
                        </div>
                        <div className="flex items-baseline justify-end gap-1 mt-2">
                            <p className="text-3xl font-bold tracking-tight text-white leading-none">{totalRevenue.toLocaleString()}</p>
                            <span className="text-sm text-slate-500 font-medium">Ïõê</span>
                        </div>
                    </div>
                    <div className="relative z-10 flex items-center justify-between border-t border-white/10 pt-2 mt-1">
                        <div>
                            <p className="text-slate-500 text-[9px] font-bold uppercase">Ï¥ù Ï£ºÎ¨∏</p>
                            <p className="text-base font-semibold leading-none">{orderCount} <span className="text-[9px] text-slate-600 font-normal">Í∞ú</span></p>
                        </div>
                        <div className="text-right">
                            <p className="text-slate-500 text-[9px] font-bold uppercase">Î∞∞ÏÜ° ÏòàÏ†ï</p>
                            <p className="text-base font-semibold text-brand-400 leading-none">{shippingCount} <span className="text-[9px] text-slate-600 font-normal">Í±¥</span></p>
                        </div>
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Detail List Card ---
        const DetailListCard = React.memo(({ title, items }) => {
            return (
                <div className="bg-white dark:bg-dark-card rounded-xl border border-slate-200 dark:border-dark-border p-3 h-full shadow-sm flex flex-col justify-center">
                    <div className="flex flex-col gap-1">
                        {items.map((item, idx) => (
                            <div key={idx} onClick={item.onClick} className={`flex items-center justify-between py-1.5 px-2 rounded transition-all ${item.onClick ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 active:scale-[0.99]' : ''} ${item.isActive ? 'bg-brand-50 dark:bg-brand-900/20 ring-1 ring-brand-200 dark:ring-brand-900/40' : ''}`}>
                                <span className="text-xs font-bold text-slate-600 dark:text-slate-300 tracking-tight">{item.label}</span>
                                <div className={`text-sm font-bold ${item.valueColor || 'text-slate-800 dark:text-slate-200'} tracking-tight`}>
                                    {typeof item.value === 'number' ? item.value.toLocaleString() : item.value}
                                    <span className="text-[11px] font-normal text-slate-400 ml-0.5">Ïõê</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Inline Product Manager ---
        const InlineProductManager = ({ productHistory, setProductHistory, setOrders, showToast }) => {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');

            const handleSave = () => {
                if (!name.trim()) { showToast("ÏÉÅÌíàÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", "error"); return; }
                const cleanName = name.trim();
                const newUnitPrice = Number(price);
                const isUpdate = productHistory.hasOwnProperty(cleanName);
                setProductHistory(prev => ({ ...prev, [cleanName]: newUnitPrice }));
                let updatedCount = 0;
                setOrders(prevOrders => prevOrders.map(order => { if (order.product && order.product.trim() === cleanName) { updatedCount++; return { ...order, price: order.quantity * newUnitPrice }; } return order; }));
                if (isUpdate) showToast(`${cleanName}: ${updatedCount}Í±¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!`);
                else showToast(`${cleanName}: Îì±Î°ù ÏôÑÎ£å`);
                setName(''); setPrice('');
            };

            const handleEditName = (oldName, currentPrice) => {
                const newName = window.prompt(`'${oldName}' ÏÉÅÌíàÏùò Ïù¥Î¶ÑÏùÑ Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, oldName);
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    const cleanNewName = newName.trim();
                    setProductHistory(prev => { const next = { ...prev }; delete next[oldName]; next[cleanNewName] = currentPrice; return next; });
                    setOrders(prev => prev.map(o => { if (o.product === oldName) return { ...o, product: cleanNewName }; return o; }));
                    showToast("ÏÉÅÌíàÎ™ÖÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.");
                }
            };

            const handleEditPrice = (pName, oldPrice) => {
                const newPriceStr = window.prompt(`'${pName}' ÏÉÅÌíàÏùò Îã®Í∞ÄÎ•º Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, oldPrice);
                if (newPriceStr !== null) {
                    const cleanStr = newPriceStr.replace(/,/g, '').trim();
                    const newPrice = Number(cleanStr);
                    if (!isNaN(newPrice)) {
                        setProductHistory(prev => ({ ...prev, [pName]: newPrice }));
                        let count = 0;
                        setOrders(prev => prev.map(o => { if (o.product === pName) { count++; return { ...o, price: o.quantity * newPrice }; } return o; }));
                        showToast(`${pName}: Îã®Í∞Ä Î≥ÄÍ≤ΩÎê®.`);
                    } else { showToast("ÏûòÎ™ªÎêú Ïà´ÏûêÏûÖÎãàÎã§.", "error"); }
                }
            };

            const handleItemClick = (pName, pPrice) => { setName(pName); setPrice(pPrice); };
            const handleDelete = (key) => { if(window.confirm(`'${key}' ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) setProductHistory(prev => { const next = { ...prev }; delete next[key]; return next; }); };

            return (
                <div className="bg-white dark:bg-dark-card rounded border border-slate-200 dark:border-dark-border p-3 flex flex-col h-full hover:border-slate-300 transition-colors overflow-hidden">
                    <div className="flex items-center justify-between mb-2 flex-none">
                        <h2 className="text-xs font-bold flex items-center gap-1 text-slate-800 dark:text-dark-text uppercase tracking-wide"><Icon name="List" className="text-brand-600" size={14}/> ÏÉÅÌíà Í¥ÄÎ¶¨</h2>
                        <span className="text-[10px] text-slate-400 cursor-default">ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÏ†ï</span>
                    </div>
                    <div className="flex gap-1 mb-2 flex-none">
                        <input className="flex-1 p-1.5 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 transition-all dark:text-white" placeholder="ÏÉÅÌíàÎ™Ö" value={name} onChange={e => setName(e.target.value)} />
                        <input className="w-16 p-1.5 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 transition-all dark:text-white" type="number" placeholder="Îã®Í∞Ä" value={price} onChange={e => setPrice(e.target.value)} />
                        <button onClick={handleSave} className="px-2 bg-slate-800 hover:bg-slate-900 text-white rounded text-[10px] font-bold whitespace-nowrap transition-colors">Ï†ÄÏû•</button>
                    </div>
                    <div className="flex-1 relative">
                        <div className="absolute inset-0 overflow-y-auto custom-scroll pr-1">
                            {Object.entries(productHistory).length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-slate-400 text-[10px]"><span>Îì±Î°ùÎêú ÏÉÅÌíà ÏóÜÏùå</span></div>
                            ) : (
                                <ul className="space-y-0.5">
                                    {Object.entries(productHistory).map(([pName, pPrice], idx) => (
                                        <li key={pName} className={`flex justify-between items-center p-1.5 rounded group border border-transparent hover:border-brand-200 dark:hover:border-brand-800 transition-all cursor-pointer ${idx % 2 === 0 ? 'bg-slate-50/50 dark:bg-white/5' : 'bg-transparent'}`} onClick={() => handleItemClick(pName, pPrice)}>
                                            <span className="font-medium text-xs text-slate-700 dark:text-dark-text truncate max-w-[60%] hover:text-brand-600" onClick={(e) => { e.stopPropagation(); handleEditName(pName, pPrice); }} title="Ïù¥Î¶Ñ ÏàòÏ†ï">{pName}</span>
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] text-slate-500 dark:text-slate-400 font-mono font-bold hover:text-brand-600" onClick={(e) => { e.stopPropagation(); handleEditPrice(pName, pPrice); }} title="Îã®Í∞Ä ÏàòÏ†ï">{pPrice.toLocaleString()}</span>
                                                <button onClick={(e) => { e.stopPropagation(); handleDelete(pName); }} className="text-slate-300 hover:text-red-500 opacity-50 group-hover:opacity-100 transition-all p-0.5"><Icon name="Trash2" size={12}/></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ActionButton = React.memo(({ onClick, color, icon, text, className='' }) => {
            const baseClass = "px-3 py-1.5 rounded-md text-xs font-bold flex items-center gap-1.5 whitespace-nowrap transition-all active:scale-95 border";
            let colorClass = "";
            if (color === 'blue') colorClass = "bg-brand-600 hover:bg-brand-700 text-white border-transparent shadow-sm";
            else if (color === 'white') colorClass = "bg-white dark:bg-dark-card hover:bg-slate-50 text-slate-700 dark:text-slate-200 border-slate-200 dark:border-dark-border shadow-sm";
            else if (color === 'slate') colorClass = "bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 text-slate-600 dark:text-slate-300 border-transparent";
            else colorClass = "bg-white border-slate-200 text-slate-700 hover:bg-slate-50";
            return <button onClick={onClick} className={`${baseClass} ${colorClass} ${className}`}><Icon name={icon} size={14} weight="bold"/> {text}</button>;
        });

        // --- ADDRESS & AUTOCOMPLETE COMPONENTS (Untouched) ---
        const AddressEditor = ({ order, handleUpdateOrder, handleUpdateOrderBatch, setEditingAddressId, showToast }) => {
            const [rawAddressText, setRawAddressText] = useState('');
            const handleOpenAddressSearch = () => {
                if (window.daum && window.daum.Postcode) {
                    try { new daum.Postcode({ oncomplete: function(data) { let fullAddress = data.roadAddress || data.jibunAddress; let extraAddress = ''; if(data.userSelectedType === 'R'){ if(data.bname !== '') extraAddress += data.bname; if(data.buildingName !== '') extraAddress += (extraAddress !== '' ? `, ${data.buildingName}` : data.buildingName); if(extraAddress !== '') fullAddress += ` (${extraAddress})`; } handleUpdateOrderBatch(order.id, { zipCode: data.zonecode, addressText: fullAddress }); showToast('Ï£ºÏÜå ÏûÖÎ†• ÏôÑÎ£å'); } }).open(); } catch (error) { fallbackToNaver(); }
                } else { fallbackToNaver(); }
            };
            const fallbackToNaver = () => { showToast('ÎÑ§Ïù¥Î≤Ñ Ï£ºÏÜåÍ≤ÄÏÉâÏùÑ ÏóΩÎãàÎã§.', 'error'); window.open('https://search.naver.com/search.naver?query=%EC%9A%B0%ED%8E%B8%EB%B2%88%ED%98%B8%EA%B2%80%EC%83%89', '_blank'); };
            const parseAddressInfo = (text) => {
                const result = { recipientName: '', phone: '', zipCode: '', addressText: '', shippingMemo: '' };
                let remainingText = text.replace(/\n/g, ' ').trim();
                const phoneMatch = remainingText.match(/010[.\-\s/]*\d{3,4}[.\-\s/]*\d{4}/);
                if (phoneMatch) { const rawPhone = phoneMatch[0]; const digitsOnly = rawPhone.replace(/\D/g, ''); if (digitsOnly.startsWith('010') && (digitsOnly.length === 10 || digitsOnly.length === 11)) { result.phone = digitsOnly; remainingText = remainingText.replace(rawPhone, ' ').trim(); } }
                const zipMatch = remainingText.match(/\d{5,6}/); if (zipMatch) { result.zipCode = zipMatch[0]; remainingText = remainingText.replace(zipMatch[0], ' '); }
                const words = remainingText.split(/\s+/).filter(w => w.length > 0);
                if (words.length > 0) { const potentialName = words.find(w => /^[Í∞Ä-Ìû£]{2,4}$/.test(w)); if (potentialName) { result.recipientName = potentialName; remainingText = remainingText.replace(potentialName, ' '); } else { const firstWord = words[0]; const isAddressKeyword = ['Ïãú', 'ÎèÑ', 'Íµ¨', 'Íµ∞', 'Ïùç', 'Î©¥', 'Îèô', 'Í∞Ä', 'Î°ú', 'Í∏∏'].some(kw => firstWord.endsWith(kw)); if (!isAddressKeyword) { result.recipientName = firstWord; remainingText = remainingText.replace(firstWord, ' '); } } }
                const addressKeywords = ['Ïãú', 'ÎèÑ', 'ÌäπÎ≥ÑÏãú', 'Í¥ëÏó≠Ïãú', 'ÌäπÎ≥ÑÏûêÏπòÏãú', 'ÌäπÎ≥ÑÏûêÏπòÎèÑ', 'Íµ¨', 'Íµ∞', 'Ïùç', 'Î©¥', 'Îèô', 'Í∞Ä', 'Î°ú', 'Í∏∏', 'Î≤àÏßÄ', 'ÏïÑÌååÌä∏', 'ÏÇ∞Îã®']; let addressMatch = remainingText.match(new RegExp(`([Í∞Ä-Ìû£0-9\\s-]*(${addressKeywords.join('|')})[Í∞Ä-Ìû£0-9\\s,-]*)`, 'g')); if (addressMatch) { let bestMatch = addressMatch.reduce((a, b) => a.length > b.length ? a : b, ''); if (bestMatch.length > 2) { result.addressText = bestMatch.trim(); remainingText = remainingText.replace(bestMatch, ' '); } }
                result.shippingMemo = remainingText.replace(/(Î∞∞ÏÜ°|ÏöîÏ≤≠|Î©îÎ™®|ÏÇ¨Ìï≠)[:\s]*/g, '').trim();
                return result;
            };
            const handleParse = () => { if (!rawAddressText.trim()) { showToast('ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error'); return; } const parsed = parseAddressInfo(rawAddressText); const updates = { recipientName: parsed.recipientName || order.recipientName, phone: parsed.phone || order.phone, zipCode: parsed.zipCode || order.zipCode, addressText: parsed.addressText || order.addressText, shippingMemo: parsed.shippingMemo || order.shippingMemo }; handleUpdateOrderBatch(order.id, updates); showToast('ÏûêÎèô ÏûÖÎ†• ÏôÑÎ£å'); setRawAddressText(''); };
            const handleChange = (field, value) => { handleUpdateOrderBatch(order.id, { [field]: value }); };
            const inputClass = "w-full p-2 border border-slate-200 dark:border-dark-border rounded text-xs dark:bg-dark-input dark:text-dark-text focus:border-brand-500 transition-all bg-white dark:bg-dark-card";
            return (
                <div className="col-span-full p-3 bg-slate-50 dark:bg-dark-bg rounded border border-slate-200 dark:border-dark-border mt-1 mb-1 animate-fade-in relative">
                    <div className="flex justify-between items-center pb-2 border-b border-slate-200 dark:border-dark-border mb-2">
                        <h3 className="text-xs font-bold text-slate-800 dark:text-dark-text flex items-center gap-1"><Icon name="MapPin" size={14} className="text-brand-600"/> Î∞∞ÏÜ° Ï†ïÎ≥¥</h3>
                        <div className="flex gap-1"><ActionButton onClick={handleOpenAddressSearch} color="white" icon="Search" text="Í≤ÄÏÉâ" /><ActionButton onClick={() => setEditingAddressId(null)} color="blue" icon="FloppyDisk" text="ÏôÑÎ£å" /></div>
                    </div>
                    <div className="flex gap-2 mb-2">
                        <textarea className="flex-1 p-2 border border-slate-200 dark:border-dark-border rounded text-xs dark:bg-dark-input dark:text-dark-text focus:border-brand-500 resize-none h-12 bg-white dark:bg-dark-card" placeholder="Ï£ºÏÜå ÌÖçÏä§Ìä∏ Î∂ôÏó¨ÎÑ£Í∏∞" value={rawAddressText} onChange={(e) => setRawAddressText(e.target.value)}/>
                        <button onClick={handleParse} className="w-12 flex-none bg-slate-800 text-white hover:bg-slate-900 rounded text-xs font-bold">ÏûêÎèô</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-2 mb-2">
                        <div><label className="block text-[10px] font-bold mb-0.5 text-slate-500">ÏàòÎ†πÏù∏</label><input type="text" value={order.recipientName} onChange={(e) => handleChange('recipientName', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-0.5 text-slate-500">Ïó∞ÎùΩÏ≤ò</label><input type="text" value={order.phone} onChange={(e) => handleChange('phone', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-0.5 text-slate-500">Ïö∞Ìé∏Î≤àÌò∏</label><input type="text" value={order.zipCode} onChange={(e) => handleChange('zipCode', e.target.value)} className={inputClass} /></div>
                        <div><label className="block text-[10px] font-bold mb-0.5 text-slate-500">Î©îÎ™®</label><input type="text" value={order.shippingMemo} onChange={(e) => handleChange('shippingMemo', e.target.value)} className={inputClass} /></div>
                    </div>
                    <div><label className="block text-[10px] font-bold mb-0.5 text-slate-500">Ï£ºÏÜå</label><input type="text" value={order.addressText} onChange={(e) => handleChange('addressText', e.target.value)} className={inputClass} /></div>
                </div>
            );
        };

        const ProductAutocomplete = ({ id, value, onChange, onSelect, onDeleteProduct, onKeyDown, priceMap }) => {
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => { const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setShowSuggestions(false); } }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);
            const filtered = Object.entries(priceMap).filter(([name]) => name.toLowerCase().includes(value.toLowerCase()));
            const handleSelect = (name, price) => { onSelect(name, price); setShowSuggestions(false); };
            const handleDelete = (e, name) => { e.stopPropagation(); onDeleteProduct(name); };
            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <input id={id} className="w-full bg-transparent outline-none text-slate-900 dark:text-dark-text text-sm font-medium tracking-tight font-sans placeholder-slate-300 focus:placeholder-slate-400" value={value} onChange={(e) => { onChange(e); setShowSuggestions(true); }} onFocus={() => setShowSuggestions(true)} onKeyDown={onKeyDown} placeholder="ÏÉÅÌíàÎ™Ö" autoComplete="off" />
                    {showSuggestions && filtered.length > 0 && (
                        <ul className="absolute z-50 left-0 mt-1 w-full bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded shadow-lg max-h-40 overflow-y-auto py-1">
                            {filtered.map(([name, price]) => (
                                <li key={name} className="px-2 py-1.5 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer flex justify-between items-center text-xs border-b border-slate-50 dark:border-dark-border last:border-0 group transition-colors" onClick={() => handleSelect(name, price)}>
                                    <div className="flex items-center flex-1 min-w-0 gap-2"><span className="font-medium text-slate-700 dark:text-dark-text truncate">{name}</span><span className="text-[10px] text-slate-500 bg-slate-100 dark:bg-slate-700 px-1 py-0.5 rounded">{price.toLocaleString()}</span></div>
                                    <button onClick={(e) => handleDelete(e, name)} className="p-0.5 text-slate-300 hover:text-brand-600 rounded transition-colors opacity-0 group-hover:opacity-100"><Icon name="Trash2" size={12} /></button>
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [globalMemo, setGlobalMemo] = useState(() => localStorage.getItem('globalMemo') || '');
            const [productHistory, setProductHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('productHistory')) || {}; } catch { return {}; } });
            const [orders, setOrders] = useState(() => { try { const stored = JSON.parse(localStorage.getItem('youtubeOrders')); if (Array.isArray(stored)) return stored.map(sanitizeOrder).filter(o => o !== null); return []; } catch { return []; } });
            const [isProcessing, setIsProcessing] = useState(false);
            const [toast, setToast] = useState(null);
            const [pricePerUnit, setPricePerUnit] = useState('');
            const [shippingFee, setShippingFee] = useState(4000);
            const [defaultProductName, setDefaultProductName] = useState('');
            const [filterText, setFilterText] = useState('');
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const [editingShippingId, setEditingShippingId] = useState(null); 
            const [unpaidFilter, setUnpaidFilter] = useState(null); 
            const [isExcelMenuOpen, setIsExcelMenuOpen] = useState(false);
            const [isReceiptModalOpen, setIsReceiptModalOpen] = useState(false);
            
            const ordersRef = useRef(orders);
            const fileInputRef = useRef(null);
            const excelMenuRef = useRef(null); 

            useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); ordersRef.current = orders; }, [orders]);
            useEffect(() => { localStorage.setItem('globalMemo', globalMemo); }, [globalMemo]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => {
                const handleClickOutside = (event) => { if (excelMenuRef.current && !excelMenuRef.current.contains(event.target)) { setIsExcelMenuOpen(false); } };
                document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const getCSVString = (listData, mode) => {
                const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || ''));
                const firstIds = {};
                list.forEach(o => { if (o.customer && !firstIds[o.customer]) firstIds[o.customer] = o.id; });
                const clean = (val) => '"' + String(val || '').replace(/"/g, '""') + '"';
                const cleanPhone = (val) => { if (!val) return '""'; const strVal = String(val); return '"\u200B' + strVal + '"'; };

                if (mode === 'invoice') {
                    const excelHeaders = ['', '', '', '', 'ÏÉÅÌíàÎ™Ö', 'ÏàòÎ†πÏù∏', 'Ïó∞ÎùΩÏ≤ò', 'Ï£ºÏÜå', 'Î∞∞ÏÜ°Î©îÎ™®', '', 'Î©îÎ™®', 'Ïö∞Ìé∏Î≤àÌò∏', ''];
                    const csv = [excelHeaders.join(',')].concat(list.map(o => {
                            let quantitySuffix = ''; if (o.quantity >= 2) { quantitySuffix = ` ‚òÖ${o.quantity}`; }
                            const productName = `[${o.customer || 'ÎØ∏ÏßÄÏ†ï'}] ${o.product}${quantitySuffix}`;
                            return ['', '', '', '', clean(productName), clean(o.recipientName), cleanPhone(o.phone), clean(o.addressText), clean(o.shippingMemo), '', clean(o.memo), cleanPhone(o.zipCode), ''].join(',');
                        })).join('\n');
                    return "\ufeff" + csv;
                } else {
                    const headers = ['ÎãâÎÑ§ÏûÑ', 'ÏûÖÍ∏àÎ™Ö', 'ÏÉÅÌíàÎ™Ö', 'ÏàòÎüâ', 'Í∏àÏï°', 'ÏûÖÍ∏àÏï°(ÌòÑÍ∏à)', 'Ïπ¥ÎìúÍ≤∞Ï†úÏï°', 'Î∞∞ÏÜ°ÎπÑ', 'ÎØ∏ÏàòÍ∏à', 'ÏàòÎ†πÏù∏', 'Ïó∞ÎùΩÏ≤ò', 'Ïö∞Ìé∏Î≤àÌò∏', 'Ï£ºÏÜå', 'Î∞∞ÏÜ°Î©îÎ™®', 'Î©îÎ™®'];
                    const csv = [headers.join(',')].concat(list.map(o => {
                            const isFirst = firstIds[o.customer] === o.id;
                            const ship = o.customShippingFee ?? shippingFee;
                            const shipCharge = isFirst ? ship : 0;
                            const unpaid = Math.max(0, (o.price + shipCharge) - (o.deposit + o.cardAmount + (isFirst && o.isShippingPaid ? ship : 0)));
                            return [clean(o.customer), clean(o.phone), clean(o.product), o.quantity, o.price, clean(o.deposit), clean(o.cardAmount), clean(shipCharge), clean(unpaid), clean(o.recipientName), cleanPhone(o.phone), cleanPhone(o.zipCode), clean(o.addressText), clean(o.shippingMemo), clean(o.memo)].join(',');
                        })).join('\n');
                    return "\ufeff" + csv;
                }
            };

            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 3000); };
            const handleDownloadCSV = (mode = 'invoice') => { if (ordersRef.current.length === 0) return; const csvContent = getCSVString(ordersRef.current, mode); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const typeName = mode === 'invoice' ? 'ÏÜ°Ïû•Ïö©' : 'Ï†ÑÏ≤¥ÎÇ¥Ïó≠'; const fileName = `Í∞ïÏùÄÏßÄ_Ï£ºÎ¨∏ÏÑú_${typeName}_${new Date().toLocaleDateString()}.csv`; a.download = fileName; a.click(); URL.revokeObjectURL(url); showToast(`${typeName} ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!`); };
            const handleDownloadProductCSV = () => { const targetOrders = filteredOrders.length > 0 ? filteredOrders : orders; if (targetOrders.length === 0) return; const summary = targetOrders.reduce((acc, curr) => { const name = curr.product; if (!acc[name]) acc[name] = 0; acc[name] += curr.quantity; return acc; }, {}); const csv = "\ufeff" + ["ÏÉÅÌíàÎ™Ö,Ï¥ùÏàòÎüâ"].concat(Object.entries(summary).map(([name, qty]) => `"${name}",${qty}`)).join('\n'); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Í∞ïÏùÄÏßÄ_Ï£ºÎ¨∏ÏÑú_Î∞úÏ£ºÎÇ¥Ïó≠_${new Date().toLocaleDateString()}.csv`; a.click(); URL.revokeObjectURL(url); showToast('Î∞úÏ£º ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å!'); };
            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`; a.download = `Í∞ïÏùÄÏßÄ_Ï£ºÎ¨∏ÏÑú_Î∞±ÏóÖ_${timestamp}.html`; a.click(); URL.revokeObjectURL(url); showToast('Ïï± ÌååÏùºÏù¥ ÏïàÏ†ÑÌïòÍ≤å Î∞±ÏóÖ(Ï†ÄÏû•)ÎêòÏóàÏäµÎãàÎã§!'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const uploaded = results.data.map((row, i) => sanitizeOrder({ id: Date.now() + i, originalText: `UPLOAD: ${row['ÏÉÅÌíàÎ™Ö']}`, customer: row['ÎãâÎÑ§ÏûÑ']?.trim(), product: row['ÏÉÅÌíàÎ™Ö'], quantity: Number(row['ÏàòÎüâ']) || 1, price: Number(row['Í∏àÏï°']?.replace(/,/g, '')) || 0, deposit: Number(row['ÏûÖÍ∏àÏï°(ÌòÑÍ∏à)']), cardAmount: Number(row['Ïπ¥ÎìúÍ≤∞Ï†úÏï°']), recipientName: row['ÏàòÎ†πÏù∏'], phone: row['Ïó∞ÎùΩÏ≤ò'], zipCode: row['Ïö∞Ìé∏Î≤àÌò∏'], addressText: row['Ï£ºÏÜå'], shippingMemo: row['Î∞∞ÏÜ°Î©îÎ™®'], memo: row['Î©îÎ™®'] })).filter(o => o.customer); setOrders(prev => [...uploaded, ...prev]); showToast(`${uploaded.length}Í±¥ ÏóÖÎ°úÎìú ÏôÑÎ£å!`); }}); e.target.value = null; };
            const handleReset = () => { if (window.confirm("Ï†ïÎßêÎ°ú Î™®Îì† Ï£ºÎ¨∏ ÎÇ¥Ïó≠ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { setOrders([]); showToast("Ï¥àÍ∏∞Ìôî ÏôÑÎ£å", "error"); } };
            const getNicknameColor = (name) => {
                if (!name) return 'text-slate-900 dark:text-dark-text';
                const colors = ['text-rose-600 dark:text-rose-400', 'text-orange-600 dark:text-orange-400', 'text-amber-600 dark:text-amber-400', 'text-emerald-600 dark:text-emerald-400', 'text-cyan-600 dark:text-cyan-400', 'text-blue-600 dark:text-blue-400', 'text-indigo-600 dark:text-indigo-400', 'text-violet-600 dark:text-violet-400'];
                let hash = 0; for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                return colors[Math.abs(hash) % colors.length];
            };
            const handleCopyMemo = () => { if (!globalMemo) { showToast('Î≥µÏÇ¨Ìï† Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error'); return; } const ta = document.createElement("textarea"); ta.value = globalMemo; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('Î©îÎ™® Î≥µÏÇ¨ ÏôÑÎ£å'); };
            
            // --- CUSTOM COPY RESULTS LOGIC (UPDATED v2.4 with Emoji) ---
            const handleCopyResults = () => { 
                if (filteredOrders.length === 0) return; 
                let text = ''; 
                const grouped = filteredOrders.reduce((acc, o) => { (acc[o.customer] = acc[o.customer] || []).push(o); return acc; }, {}); 
                Object.entries(grouped).forEach(([name, items]) => { 
                    text += `üíô ${name} Îãò üíô\n\n`; 
                    items.forEach(o => { const qtyText = o.quantity > 1 ? ` (${o.quantity})` : ''; text += `${o.product}${qtyText} ${o.price.toLocaleString()}\n` }); 
                    const shipFee = items[0].customShippingFee ?? shippingFee; 
                    if (shipFee > 0) text += `Î∞∞ÏÜ°ÎπÑ ${shipFee.toLocaleString()}\n`; 
                    text += `-\n`; 
                    const cardTotal = items.reduce((s, o) => s + o.cardAmount, 0); 
                    const depositTotal = items.reduce((s, o) => s + o.deposit, 0); 
                    const itemTotal = items.reduce((s, o) => s + o.price, 0); 
                    const paidTotal = depositTotal + cardTotal; 
                    const totalRequired = itemTotal + shipFee; 
                    const isShipPaid = items.some(o => o.isShippingPaid); 
                    if (cardTotal > 0) { 
                        const cardFee = Math.round(cardTotal * 0.10); 
                        const totalCardPayment = cardTotal + cardFee; 
                        text += `ÏûÖÍ∏à ${depositTotal.toLocaleString()}\n`; 
                        text += `Ïπ¥Îìú ${cardTotal.toLocaleString()}\n`; 
                        text += `Ï¥ù Ïπ¥ÎìúÍ≤∞Ï†ú (10%) \n${totalCardPayment.toLocaleString()} ÏòàÏ†ï\n`; 
                    } else if (depositTotal > 0) { 
                        const displayDepositTotal = isShipPaid ? (depositTotal + shipFee) : depositTotal; 
                        text += `ÏûÖÍ∏à ${displayDepositTotal.toLocaleString()}\n`; 
                    } 
                    text += `¬†-\n`; 
                    
                    const shippingCredit = isShipPaid ? shipFee : 0; 
                    const totalUnpaid = Math.max(0, totalRequired - paidTotal - shippingCredit); 
                    
                    if (totalUnpaid > 0) { 
                        text += `ÎØ∏ÏûÖÍ∏à: ${totalUnpaid.toLocaleString()}Ïõê\n\n`; 
                        text += `Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨ ÍπÄÏÑ†Ï†ï\n7942 18 01611 \n\nÏûÖÍ∏à Î∂ÄÌÉÅÎìúÎ¶ΩÎãàÎã§ üôè\n\n`; 
                    } else { 
                        text += `ÏôÑÎÇ© ÌôïÏù∏! Í∞êÏÇ¨Ìï©ÎãàÎã§ üòç\n\n`; 
                    } 
                }); 
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast('Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Î≥µÏÇ¨ ÏôÑÎ£å'); 
            };

            const firstOrderIds = useMemo(() => { const ids = {}; orders.forEach(o => { if (o.customer && !ids[o.customer]) ids[o.customer] = o.id; }); return ids; }, [orders]);
            const customerCounts = useMemo(() => orders.reduce((acc, o) => { if(o.customer) acc[o.customer] = (acc[o.customer] || 0) + 1; return acc; }, {}), [orders]);
            const filteredOrders = useMemo(() => { 
                let result = orders;
                if (filterText) { const lower = filterText.toLowerCase(); result = result.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower))); }
                if (unpaidFilter) {
                    const grouped = orders.reduce((acc, o) => { const k = o.customer || 'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null}; acc[k].p += o.price; acc[k].d += o.deposit; acc[k].c += o.cardAmount; if(o.isShippingPaid) acc[k].ship = true; if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; return acc; }, {});
                    result = result.filter(o => { const g = grouped[o.customer || 'u']; if (!g) return false; const ship = g.fee ?? shippingFee; const totalRequired = g.p + ship; const totalPaid = g.d + g.c; const shippingCredit = g.ship ? ship : 0; const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit); if (unpaidFilter === 'ship') { return !g.ship && ship > 0; } if (unpaidFilter === 'cash') { let cashUnpaid = 0; if (g.ship) { cashUnpaid = personUnpaid; } else { const unpaidAttribToShip = Math.min(personUnpaid, ship); cashUnpaid = personUnpaid - unpaidAttribToShip; } return cashUnpaid > 0; } return true; });
                }
                return result;
            }, [orders, filterText, unpaidFilter, shippingFee]);

            const stats = useMemo(() => {
                const res = { qty: 0, orderCount: 0, shippingCount: 0, cardRev: 0, cashRev: 0, shipRev: 0, totalRev: 0, cardUnpaid: 0, cashUnpaid: 0, shipUnpaid: 0, totalUnpaid: 0 };
                const grouped = filteredOrders.reduce((acc, o) => { const k = o.customer || 'u'; if(!acc[k]) acc[k] = {p:0, d:0, c:0, ship:false, fee:null, q:0}; acc[k].p += o.price; acc[k].d += o.deposit; acc[k].c += o.cardAmount; acc[k].q += o.quantity; if(o.isShippingPaid) acc[k].ship = true; if(o.customShippingFee !== null) acc[k].fee = o.customShippingFee; return acc; }, {});
                Object.values(grouped).forEach(g => { const ship = g.fee ?? shippingFee; res.orderCount++; res.shippingCount++; res.cardRev += g.c; res.cashRev += Math.max(0, g.p - g.c); res.shipRev += ship; res.totalRev += (g.p + ship); res.qty += g.q; const totalRequired = g.p + ship; const totalPaid = g.d + g.c; const shippingCredit = g.ship ? ship : 0; const personUnpaid = Math.max(0, totalRequired - totalPaid - shippingCredit); if (g.ship) { res.cashUnpaid += personUnpaid; } else { const unpaidAttribToShip = Math.min(personUnpaid, ship); res.shipUnpaid += unpaidAttribToShip; res.cashUnpaid += (personUnpaid - unpaidAttribToShip); } res.totalUnpaid += personUnpaid; });
                return res;
            }, [filteredOrders, shippingFee]);
            
            const filteredStats = useMemo(() => { return stats; }, [stats]);

            const handleToggleAmountEdit = (id) => { setEditingAmountId(id === editingAmountId ? null : id); setEditingShippingId(null); };
            const handleToggleShippingEdit = (id) => { setEditingShippingId(id === editingShippingId ? null : id); setEditingAmountId(null); };
            const handleToggleAddressEdit = (id) => { setEditingAddressId(id === editingAddressId ? null : id); };
            const handleKeyDown = (e, index, field) => { if (e.key === 'Enter') { e.preventDefault(); const nextIndex = index + 1; if (nextIndex < filteredOrders.length) { const nextElement = document.getElementById(`${field}-${nextIndex}`); if (nextElement) { nextElement.focus(); if (nextElement.select) nextElement.select(); } } } };
            const handleMemoKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); const textarea = e.target; const start = textarea.selectionStart; const end = textarea.selectionEnd; const value = globalMemo; const newValue = value.substring(0, start) + "\n‚ñ´ " + value.substring(end); setGlobalMemo(newValue); setTimeout(() => { textarea.selectionStart = textarea.selectionEnd = start + 3; }, 0); } };
            const handleParseOrders = () => {
                if (!rawInput.trim()) { showToast('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const blocks = rawInput.split(/\n\s*\n/).filter(block => block.trim() !== '');
                    const newOrders = blocks.map((block, i) => { const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l); if (lines.length === 0) return null; let rawCustomer = lines[0].replace(/@/g, '').trim(); let customer = rawCustomer.replace(/-[a-zA-Z0-9]+$/, '').trim(); let product = lines.slice(1).join(' ').trim() || defaultProductName; let quantity = 1; let unitPrice = productHistory[product] || Number(pricePerUnit) || 0; const price = quantity * unitPrice; const existingOrder = orders.find(o => o.customer === customer); let recipientName = '', zipCode = '', addressText = '', shippingMemo = '', phone = ''; if (existingOrder) { recipientName = existingOrder.recipientName; phone = existingOrder.phone; zipCode = existingOrder.zipCode; addressText = existingOrder.addressText; shippingMemo = existingOrder.shippingMemo; } return sanitizeOrder({ id: Date.now() + i + Math.random(), originalText: block, customer, product, quantity, price, phone, deposit: 0, isPaid: false, isShippingPaid: false, isCardPaid: false, cardAmount: 0, customShippingFee: null, memo: '', recipientName, zipCode, addressText, shippingMemo }); }).filter(o => o !== null);
                    setOrders(prev => [...newOrders, ...prev]); setRawInput(''); setIsProcessing(false); showToast(`${newOrders.length}Í±¥ Ï∂îÍ∞Ä ÏôÑÎ£å!`);
                }, 100);
            };
            const handleAddEmptyOrder = () => { setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: defaultProductName, quantity: 1, price: Number(pricePerUnit) || 0 }), ...prev]); };
            const handleUpdateOrder = (id, field, value) => { setOrders(prev => prev.map(o => { if (o.id !== id) return o; let updates = { [field]: value }; if (field === 'quantity') { const savedUnitPrice = productHistory[o.product] || Number(pricePerUnit) || 0; updates.price = value * savedUnitPrice; } if (field === 'product') { const savedUnitPrice = productHistory[value]; if (savedUnitPrice !== undefined) { updates.price = o.quantity * savedUnitPrice; } } if (field === 'price') { if (o.product && o.quantity > 0) { const unitPrice = value / o.quantity; setProductHistory(prevHist => ({ ...prevHist, [o.product]: unitPrice })); } } const newPrice = updates.price ?? o.price; if (field === 'deposit') { const rem = Math.max(0, newPrice - value); updates.cardAmount = rem; updates.isCardPaid = rem > 0; } return sanitizeOrder({ ...o, ...updates }); })); };
            const handleProductSelect = (id, product, unitPrice) => { setOrders(prev => prev.map(o => { if (o.id !== id) return o; return sanitizeOrder({ ...o, product: product, price: o.quantity * unitPrice }); })); };
            const handleDeleteProduct = useCallback((productName) => { if (window.confirm(`'${productName}' ÏÉÅÌíàÏùÑ ÏûêÎèôÏôÑÏÑ± Î™©Î°ùÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) { setProductHistory(prev => { const newHistory = { ...prev }; delete newHistory[productName]; return newHistory; }); showToast(`'${productName}' ÏÉÅÌíàÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`); } }, []);
            const handleUpdateOrderBatch = (id, updates) => { setOrders(prev => { const targetOrder = prev.find(o => o.id === id); if (!targetOrder || !targetOrder.customer) return prev; const isAddressUpdate = ['recipientName', 'phone', 'zipCode', 'addressText', 'shippingMemo'].some(key => key in updates); const targetCustomer = targetOrder.customer.trim(); return prev.map(o => { if (o.id === id) return sanitizeOrder({ ...o, ...updates }); if (isAddressUpdate && o.customer && o.customer.trim() === targetCustomer) return sanitizeOrder({ ...o, ...updates }); return o; }); }); };
            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            const handleAutoDepositFull = (id) => { setOrders(prev => { return prev.map(o => { if (o.id === id) { if (o.isPaid) { return sanitizeOrder({ ...o, deposit: 0, cardAmount: 0, isPaid: false, isCardPaid: false }); } else { return sanitizeOrder({ ...o, deposit: o.price, cardAmount: 0, isPaid: true, isCardPaid: false }); } } return o; }); }); setEditingAmountId(null); setEditingShippingId(null); };
            const handleAutoCardFull = (id) => { setOrders(prev => prev.map(o => o.id === id ? sanitizeOrder({ ...o, deposit: 0, cardAmount: o.price, isPaid: true, isCardPaid: true }) : o)); setEditingAmountId(null); setEditingShippingId(null); };
            const handleUnpaidFilterClick = (type) => { if (unpaidFilter === type) { setUnpaidFilter(null); } else { setUnpaidFilter(type); } };

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 dark:bg-dark-bg text-slate-900 dark:text-dark-text font-sans">
                    <header className="sticky top-0 z-50 bg-white/90 dark:bg-dark-card/90 backdrop-blur-md border-b border-slate-200 dark:border-dark-border flex-none transition-all duration-300">
                        <div className="max-w-[1920px] mx-auto px-4 h-14 flex items-center justify-between gap-4">
                            <div className="flex items-center gap-2 text-brand-600 dark:text-brand-500 min-w-fit">
                                <Icon name="Package" size={20} weight="bold" />
                                <h1 className="text-base font-bold text-slate-900 dark:text-dark-text tracking-tight hidden md:block">Ï£ºÎ¨∏ Í¥ÄÎ¶¨ <span className="text-brand-600 dark:text-brand-500">ÏãúÏä§ÌÖú</span></h1>
                            </div>
                            <div className="flex items-center gap-2 text-xs whitespace-nowrap">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors text-slate-500 dark:text-slate-400"><Icon name={isDarkMode ? "Sun" : "Moon"} size={16} /></button>
                                <div className="h-4 w-px bg-slate-200 dark:bg-slate-800 mx-1"></div>
                                <button onClick={() => setIsProductManagerOpen(true)} className="px-2 py-1 text-slate-600 dark:text-slate-300 hover:text-brand-600 font-medium">ÏÉÅÌíàÍ¥ÄÎ¶¨</button>
                                <button onClick={handleReset} className="px-2 py-1 text-slate-600 dark:text-slate-300 hover:text-brand-600 font-medium">Ï¥àÍ∏∞Ìôî</button>
                                <button onClick={() => setIsReceiptModalOpen(true)} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-all shadow-sm flex items-center gap-1 font-bold">ÏòÅÏàòÏ¶ù Ï∂úÎ†•</button>
                                <div className="relative" ref={excelMenuRef}>
                                    <button onClick={() => setIsExcelMenuOpen(!isExcelMenuOpen)} className="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white rounded transition-all shadow-sm flex items-center gap-1 font-bold">ÏóëÏÖÄ <Icon name="CaretDown" size={10} weight="bold" /></button>
                                    {isExcelMenuOpen && (
                                        <div className="absolute top-full right-0 mt-1 w-40 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded shadow-xl z-50 overflow-hidden py-1">
                                            <button onClick={() => { handleDownloadCSV('full'); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 flex items-center gap-2"><Icon name="FileXls" size={14}/> Ï†ÑÏ≤¥ ÎÇ¥Ïó≠</button>
                                            <button onClick={() => { handleDownloadCSV('invoice'); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 flex items-center gap-2"><Icon name="Truck" size={14}/> ÏÜ°Ïû•Ïö©</button>
                                            <button onClick={() => { handleDownloadProductCSV(); setIsExcelMenuOpen(false); }} className="w-full text-left px-3 py-2 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 flex items-center gap-2"><Icon name="List" size={14}/> Î∞úÏ£ºÏö©</button>
                                        </div>
                                    )}
                                </div>
                                <button onClick={handleDownloadHTML} className="px-3 py-1.5 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 rounded font-bold">Î∞±ÏóÖ</button>
                                <button onClick={handleUploadClick} className="px-3 py-1.5 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:border-brand-500 hover:text-brand-600 rounded font-bold">Î≥µÏõê</button>
                                <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                            </div>
                        </div>
                    </header>

                    <main className="max-w-[1920px] mx-auto w-full px-4 py-4 flex flex-col gap-4">
                        <datalist id="product-options">{Object.entries(productHistory).map(([product, price]) => (<option key={product} value={product} label={`${price.toLocaleString()}Ïõê`} />))}</datalist>
                        
                        {/* Compact Top Section: Summary + 2 Detail Lists */}
                        <div className="flex-none grid grid-cols-1 lg:grid-cols-4 gap-3 h-auto lg:h-32">
                            <div className="lg:col-span-2 h-full"><SummaryDashboardCard totalRevenue={stats.totalRev} orderCount={stats.qty} shippingCount={stats.shippingCount} /></div>
                            <div className="lg:col-span-1 h-full">
                                <DetailListCard items={[{ label: "Ïπ¥ÎìúÎß§Ï∂ú", value: stats.cardRev, valueColor: "text-slate-800 dark:text-slate-200" }, { label: "ÌòÑÍ∏àÎß§Ï∂ú", value: stats.cashRev, valueColor: "text-slate-800 dark:text-slate-200" }, { label: "Î∞∞ÏÜ°ÎπÑÎß§Ï∂ú", value: stats.shipRev, valueColor: "text-slate-800 dark:text-slate-200" }]} />
                            </div>
                            <div className="lg:col-span-1 h-full">
                                <DetailListCard items={[{ label: "Ï¥ù ÎØ∏ÏàòÍ∏à", value: stats.totalUnpaid, valueColor: "text-red-600 dark:text-red-500" }, { label: "ÌòÑÍ∏à ÎØ∏ÏàòÍ∏à", value: stats.cashUnpaid, valueColor: "text-red-600 dark:text-red-500", onClick: () => handleUnpaidFilterClick('cash'), isActive: unpaidFilter === 'cash' }, { label: "Î∞∞ÏÜ° ÎØ∏ÏàòÍ∏à", value: stats.shipUnpaid, valueColor: "text-red-600 dark:text-red-500", onClick: () => handleUnpaidFilterClick('ship'), isActive: unpaidFilter === 'ship' }]} />
                            </div>
                        </div>

                        {/* 3-Column Grid: Paste | Product Manager | Memo */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-3 h-[18rem]">
                            <div className="bg-white dark:bg-dark-card rounded border border-slate-200 dark:border-dark-border p-3 flex flex-col h-full hover:border-slate-300 transition-colors">
                                <div className="flex items-center justify-between mb-2"><h2 className="text-xs font-bold flex items-center gap-1 text-slate-800 dark:text-dark-text uppercase tracking-wide"><Icon name="ClipboardList" className="text-brand-500" size={14}/> ÎåìÍ∏Ä Î∂ôÏó¨ÎÑ£Í∏∞</h2></div>
                                <textarea className="flex-1 w-full p-3 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded focus:border-brand-500 resize-none text-xs dark:text-dark-text mb-2 font-mono placeholder-slate-400 focus:bg-white dark:focus:bg-dark-card transition-colors" placeholder="Ïòà: @ÍπÄÏ≤†Ïàò \n AÏÑ∏Ìä∏ 2Í∞ú \n\n @ÏòÅÌù¨ \n BÏÑ∏Ìä∏ 1Í∞ú" value={rawInput} onChange={(e) => setRawInput(e.target.value)}></textarea>
                                <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-2 bg-slate-900 dark:bg-white hover:bg-brand-600 text-white dark:text-black rounded font-bold text-xs transition-all flex justify-center items-center gap-1 shadow-sm">{isProcessing ? 'Ï≤òÎ¶¨ Ï§ë...' : 'Î≥ÄÌôò Ïã§Ìñâ'} <Icon name="ArrowRight" size={12}/></button>
                            </div>
                            
                            {/* INLINE PRODUCT MANAGER (New Middle Column) */}
                            <InlineProductManager productHistory={productHistory} setProductHistory={setProductHistory} setOrders={setOrders} showToast={showToast} />

                            <div className="bg-white dark:bg-dark-card rounded border border-slate-200 dark:border-dark-border p-3 flex flex-col h-full hover:border-slate-300 transition-colors">
                                <div className="flex justify-between items-center mb-2"><h2 className="text-xs font-bold flex items-center gap-1 text-slate-800 dark:text-dark-text uppercase tracking-wide"><Icon name="Note" className="text-amber-500" size={14}/> Î©îÎ™®Ïû•</h2><button onClick={handleCopyMemo} className="text-[10px] font-medium text-slate-400 hover:text-brand-600 transition-colors flex items-center gap-1"><Icon name="Copy" size={12}/> Î≥µÏÇ¨</button></div>
                                <textarea className="flex-1 w-full p-3 bg-yellow-50/50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/30 rounded focus:border-amber-400 resize-none text-xs dark:text-amber-100 transition-all placeholder-slate-400" placeholder="ÏûêÏú†Î°≠Í≤å Î©îÎ™®ÌïòÏÑ∏Ïöî..." value={globalMemo} onChange={(e) => setGlobalMemo(e.target.value)} onKeyDown={handleMemoKeyDown}></textarea>
                            </div>
                        </div>
                        
                        <div className="bg-white dark:bg-dark-card rounded border border-slate-200 dark:border-dark-border flex flex-col overflow-hidden">
                            <div className="p-3 border-b border-slate-100 dark:border-dark-border flex flex-col sm:flex-row gap-3 items-center justify-between bg-white dark:bg-dark-card">
                                <div className="flex items-center gap-2 w-full sm:w-auto">
                                    <div className="relative flex-1 sm:w-64"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={14} /></div><input className="w-full pl-8 pr-3 py-1.5 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs focus:ring-1 focus:ring-brand-500 focus:border-brand-500 dark:text-dark-text transition-all" placeholder="Ïù¥Î¶Ñ ÎòêÎäî ÏÉÅÌíà Í≤ÄÏÉâ..." value={filterText} onChange={(e) => setFilterText(e.target.value)} /></div>
                                </div>
                                <div className="flex items-center gap-2 overflow-x-auto w-full sm:w-auto pb-2 sm:pb-0">
                                    <div className="flex items-center bg-slate-50 dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1"><span className="text-[10px] text-slate-400 dark:text-slate-500 mr-2 uppercase font-bold">Í∏∞Î≥∏ÏÉÅÌíà</span><input type="text" value={defaultProductName} onChange={(e) => setDefaultProductName(e.target.value)} className="w-20 bg-transparent outline-none font-semibold text-slate-700 dark:text-dark-text text-xs" placeholder="Í∏∞Î≥∏ ÏÉÅÌíà" /></div>
                                    <div className="flex items-center bg-slate-50 dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1"><span className="text-[10px] text-slate-400 dark:text-slate-500 mr-2 uppercase font-bold">Îã®Í∞Ä</span><input type="number" value={pricePerUnit} onChange={(e) => setPricePerUnit(e.target.value)} className="w-16 bg-transparent outline-none font-semibold text-right text-slate-700 dark:text-dark-text text-xs" placeholder="0" /></div>
                                    <div className="flex items-center bg-slate-50 dark:bg-dark-input rounded border border-slate-200 dark:border-dark-border px-2 py-1"><span className="text-[10px] text-slate-400 dark:text-slate-500 mr-2 uppercase font-bold">Î∞∞ÏÜ°ÎπÑ</span><input type="number" value={shippingFee} onChange={(e) => setShippingFee(Number(e.target.value))} className="w-16 bg-transparent outline-none font-semibold text-right text-slate-700 dark:text-dark-text text-xs" /></div>
                                    <ActionButton onClick={handleAddEmptyOrder} color="blue" icon="Plus" text="Ï∂îÍ∞Ä" />
                                    <ActionButton onClick={handleCopyResults} color="slate" icon="Copy" text="Î≥µÏÇ¨" />
                                </div>
                            </div>
                            <div className="sticky top-14 z-30 grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-3 px-3 py-2 bg-slate-50 dark:bg-dark-input border-b border-slate-200 dark:border-dark-border text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-center">
                                <div>Ï£ºÏÜå</div><div className="text-left">Í≥†Í∞ù Ï†ïÎ≥¥</div><div className="text-left">ÏÉÅÌíàÎ™Ö</div><div>ÏàòÎüâ</div><div class="text-right">Í∏àÏï°</div><div>ÏÉÅÌÉú</div><div>Î©îÎ™®</div><div>ÏÇ≠Ï†ú</div>
                            </div>
                            <div className="p-3 space-y-2 min-h-[300px] bg-slate-50/30 dark:bg-black/20">
                                {filteredOrders.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-64 text-slate-400 dark:text-slate-600"><Icon name="Package" size={32} className="mb-2 opacity-20"/><p className="text-xs font-medium">{unpaidFilter ? 'Ï°∞Í±¥Ïóê ÎßûÎäî Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§.' : 'Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'}</p></div>
                                ) : (
                                    filteredOrders.map((order, index) => {
                                        const isFirst = firstOrderIds[order.customer] === order.id;
                                        const addressIconClass = order.isAddressFilled ? 'bg-brand-600 text-white shadow-md shadow-brand-500/20' : 'bg-slate-100 text-slate-300 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-600 dark:hover:bg-slate-700';
                                        const nickColor = getNicknameColor(order.customer);
                                        let moneyIcon = order.deposit > 0 ? (order.cardAmount > 0 ? 'bg-orange-50 text-orange-600 ring-1 ring-orange-200' : 'bg-emerald-50 text-emerald-600 ring-1 ring-emerald-200') : 'bg-slate-50 text-slate-300 dark:bg-slate-800 dark:text-slate-600';
                                        let cardIcon = order.cardAmount > 0 ? 'bg-pink-50 text-pink-600 ring-1 ring-pink-200' : 'bg-slate-50 text-slate-300 dark:bg-slate-800 dark:text-slate-600';
                                        const currentShippingFee = order.customShippingFee ?? shippingFee;
                                        const isFreeShipping = currentShippingFee === 0;
                                        let shippingIconClass = order.isShippingPaid ? 'bg-blue-50 text-blue-600 ring-1 ring-blue-200' : (isFreeShipping ? 'bg-slate-100 text-slate-400' : 'bg-slate-50 text-slate-300 dark:bg-slate-800 dark:text-slate-600');
                                        const rowBg = order.price > 0 && (order.deposit + order.cardAmount < order.price) ? 'bg-red-50/50 border-red-200 dark:bg-red-900/10 dark:border-red-900/50' : 'bg-white border-slate-200 dark:bg-dark-card dark:border-dark-border';
                                        return (
                                            <React.Fragment key={order.id}>
                                                <div className={`group grid grid-cols-[0.5fr_2.0fr_4.0fr_0.4fr_1.0fr_1.5fr_2.0fr_0.5fr] gap-3 p-2 border rounded items-center text-xs transition-all hover:shadow-sm ${rowBg}`}>
                                                    <div className="flex justify-center"><button onClick={() => handleToggleAddressEdit(order.id)} className={`w-7 h-7 rounded-full flex items-center justify-center transition-all ${addressIconClass}`}><Icon name="MapPin" size={14} weight="bold"/></button></div>
                                                    <div className="relative pl-1">
                                                        <input id={`customer-${index}`} onKeyDown={e => handleKeyDown(e, index, 'customer')} className={`w-full bg-transparent font-bold outline-none text-sm ${nickColor}`} value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} placeholder="ÎãâÎÑ§ÏûÑ" />
                                                        <input id={`phone-${index}`} onKeyDown={e => handleKeyDown(e, index, 'phone')} className="w-full bg-transparent text-slate-400 dark:text-slate-500 text-[10px] outline-none block mt-0.5 font-medium" value={order.phone} onChange={e => handleUpdateOrder(order.id, 'phone', e.target.value)} placeholder="ÏûÖÍ∏àÏûêÎ™Ö" />
                                                        {customerCounts[order.customer] > 1 && <span className="absolute right-0 top-0 text-[9px] bg-slate-100 dark:bg-slate-700 px-1 py-0.5 rounded text-slate-500 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-600">{customerCounts[order.customer]}</span>}
                                                    </div>
                                                    <div><ProductAutocomplete id={`product-${index}`} value={order.product} onChange={(e) => handleUpdateOrder(order.id, 'product', e.target.value)} onSelect={(name, price) => handleProductSelect(order.id, name, price)} onDeleteProduct={handleDeleteProduct} onKeyDown={(e) => handleKeyDown(e, index, 'product')} priceMap={productHistory} /></div>
                                                    <div className="flex justify-center"><input id={`quantity-${index}`} onKeyDown={e => handleKeyDown(e, index, 'quantity')} type="number" className="w-full text-center bg-slate-50 dark:bg-dark-input rounded font-bold dark:text-dark-text py-0.5 focus:ring-1 focus:ring-brand-500 outline-none transition-all" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', Number(e.target.value))} /></div>
                                                    <div className="text-right"><input id={`price-${index}`} onKeyDown={e => handleKeyDown(e, index, 'price')} className="w-full text-right bg-transparent font-bold text-slate-800 dark:text-slate-200 outline-none" value={order.price === 0 ? '' : order.price.toLocaleString()} onChange={e => { const v = e.target.value.replace(/,/g,''); if(!isNaN(v)) handleUpdateOrder(order.id, 'price', Number(v)); }} placeholder="0" /></div>
                                                    <div className="flex justify-center gap-1">
                                                        <button onClick={() => handleAutoDepositFull(order.id)} className={`w-7 h-7 rounded-full flex justify-center items-center transition-all ${moneyIcon}`} title="ÌòÑÍ∏à ÏôÑÎÇ© Ï≤òÎ¶¨"><Icon name="DollarSign" size={14} weight="bold"/></button>
                                                        {isFirst ? (
                                                            <div className="relative group/ship">
                                                                <button onClick={() => handleUpdateOrder(order.id, 'isShippingPaid', !order.isShippingPaid)} onContextMenu={(e) => { e.preventDefault(); handleToggleShippingEdit(order.id); }} className={`w-7 h-7 rounded-full flex justify-center items-center transition-all ${shippingIconClass}`} title="Î∞∞ÏÜ°ÎπÑ ÎÇ©Î∂Ä ÌÜ†Í∏Ä"><Icon name="Truck" size={14} weight="bold"/></button>
                                                                {currentShippingFee !== shippingFee && (<span className="absolute -top-1 -right-1 bg-slate-800 text-white text-[8px] px-1 rounded-full border border-white dark:border-dark-card shadow-sm font-bold">{currentShippingFee/1000}k</span>)}
                                                            </div>
                                                        ) : <div className="w-7"/>}
                                                        <button onClick={() => handleToggleAmountEdit(order.id)} className={`w-7 h-7 rounded-full flex justify-center items-center transition-all ${cardIcon}`} title="Ïπ¥Îìú Í≤∞Ï†ú Í¥ÄÎ¶¨"><Icon name="CreditCard" size={14} weight="bold"/></button>
                                                    </div>
                                                    <div><input id={`memo-${index}`} onKeyDown={e => handleKeyDown(e, index, 'memo')} className="w-full text-center bg-transparent outline-none text-slate-600 dark:text-slate-400 text-[10px] placeholder-slate-300" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} placeholder="Î©îÎ™®" /></div>
                                                    <div className="flex justify-center"><button onClick={() => handleDelete(order.id)} className="text-slate-300 hover:text-brand-500 dark:text-slate-700 dark:hover:text-brand-500 transition-colors p-1"><Icon name="Trash2" size={14}/></button></div>
                                                </div>
                                                {editingAmountId === order.id && ( <div className="col-span-full p-2 bg-slate-50 dark:bg-slate-800/50 rounded border border-slate-200 dark:border-slate-700 flex gap-3 justify-end items-center mb-1 animate-fade-in mx-1 shadow-inner"> <button onClick={() => handleAutoCardFull(order.id)} className="px-2 py-1 rounded bg-pink-100 text-pink-700 hover:bg-pink-200 text-[10px] font-bold transition-colors flex items-center gap-1"><Icon name="CreditCard" size={12} weight="bold"/> Ïπ¥Îìú Ï†ÑÏï°</button> <div className="flex items-center gap-2 bg-white dark:bg-dark-card px-2 py-0.5 rounded border border-slate-200 dark:border-dark-border"><span className="text-[10px] font-bold text-slate-500">ÌòÑÍ∏à</span><input type="number" className="w-16 p-0.5 text-right text-xs font-bold outline-none bg-transparent" value={order.deposit} onChange={e => handleUpdateOrder(order.id, 'deposit', Number(e.target.value))} /></div><div className="flex items-center gap-2 bg-white dark:bg-dark-card px-2 py-0.5 rounded border border-slate-200 dark:border-dark-border"><span className="text-[10px] font-bold text-slate-500">Ïπ¥Îìú</span><input type="number" className="w-16 p-0.5 text-right text-xs font-bold outline-none bg-transparent" value={order.cardAmount} onChange={e => handleUpdateOrder(order.id, 'cardAmount', Number(e.target.value))} /></div></div> )}
                                                {editingShippingId === order.id && ( <div className="col-span-full p-2 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-100 dark:border-blue-900/50 flex gap-2 justify-center items-center mb-1 animate-fade-in mx-1"> <span className="text-[10px] font-bold text-blue-700 dark:text-blue-300">Í∞úÎ≥Ñ Î∞∞ÏÜ°ÎπÑ:</span> <input type="number" className="w-20 p-1 rounded border border-blue-200 text-center font-bold text-xs text-blue-900 outline-none focus:ring-1 focus:ring-blue-500" value={order.customShippingFee ?? shippingFee} onChange={e => handleUpdateOrder(order.id, 'customShippingFee', Number(e.target.value))} /> <button onClick={() => handleUpdateOrder(order.id, 'customShippingFee', null)} className="text-[10px] bg-white text-blue-600 px-2 py-1 rounded border border-blue-200 hover:bg-blue-50 font-medium transition-colors">Í∏∞Î≥∏Í∞í</button> <button onClick={() => setEditingShippingId(null)} className="text-[10px] bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 font-bold transition-colors ml-1">Îã´Í∏∞</button> </div> )}
                                                {editingAddressId === order.id && <AddressEditor order={order} handleUpdateOrder={handleUpdateOrder} handleUpdateOrderBatch={handleUpdateOrderBatch} setEditingAddressId={setEditingAddressId} showToast={showToast} />}
                                            </React.Fragment>
                                        );
                                    })
                                )}
                            </div>
                            <div className="p-3 bg-white dark:bg-dark-card border-t border-slate-200 dark:border-dark-border text-xs flex justify-between items-center">
                                <div className="flex items-center gap-1.5"><div className="w-1.5 h-1.5 rounded-full bg-brand-500"></div><span className="text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Ï¥ù {filteredStats.shippingCount}Í±¥ Î∞∞ÏÜ° ÏòàÏ†ï</span></div>
                                <div className="text-right flex items-center gap-4">
                                    <div className="flex flex-col items-end"><span className="text-[9px] text-slate-400 font-bold uppercase">Ï¥ù Ï£ºÎ¨∏ Í∏àÏï°</span><span className="font-bold text-sm text-slate-800 dark:text-white">{(filteredStats.totalRev).toLocaleString()} <span className="text-[10px] font-normal text-slate-500">Ïõê</span></span></div>
                                    {filteredStats.totalUnpaid > 0 && (<div className="flex flex-col items-end pl-4 border-l border-slate-200 dark:border-dark-border"><span className="text-[9px] text-brand-400 font-bold uppercase">ÎØ∏ÏûÖÍ∏à</span><span className="font-bold text-sm text-brand-600 dark:text-brand-500">{(filteredStats.totalUnpaid).toLocaleString()} <span className="text-[10px] font-normal text-brand-400">Ïõê</span></span></div>)}
                                </div>
                            </div>
                        </div>
                    </main>
                    <ReceiptModal isOpen={isReceiptModalOpen} onClose={() => setIsReceiptModalOpen(false)} orders={filteredOrders} shippingFee={shippingFee} />
                    {toast && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 px-4 py-2 bg-slate-900 text-white rounded-full shadow-2xl flex items-center gap-2 animate-slide-up z-[100] border border-slate-800">
                            <Icon name={toast.type==='error'?'WarningCircle':'CheckCircle'} className={toast.type==='error'?'text-red-500':'text-emerald-400'} size={16} weight="bold"/> 
                            <span className="font-medium text-xs">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        };
        
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (error) {
            document.body.innerHTML = `<div style="color:red; padding:20px;"><h3>Critical Error</h3><pre>${error.message}</pre></div>`;
            console.error(error);
        }
    </script>
</body>
</html>
