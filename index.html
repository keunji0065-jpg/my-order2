<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (í™”ë©´ê°œì„ )</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .processed-chat { text-decoration: line-through; background-color: #f3f4f6 !important; color: #9ca3af !important; border-color: #e5e7eb !important; opacity: 0.6; }
        .selected-chat-active { border-left: 4px solid #3182ce; background-color: #ebf8ff; }
        .badge-pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .cancelled-item { text-decoration: line-through; color: #9ca3af; background-color: #f3f4f6; }
        
        .keyword-detected { border: 2px solid #3b82f6; background-color: #eff6ff; }
        .keyword-badge { background-color: #3b82f6; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // âœ… URL ê³ ì •
        const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbx-vBZvKr4C0eWjpaPplaD-AEPaQ0FPG7Tzz5gm-yXQYQUkX686TpA-ZXBnebFpq0G_/exec";

        const Icon = ({ name, className="" }) => <i className={`ph ph-${name} ${className}`}></i>;

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const LiveTab = ({ orders, setOrders, productHistory, setProductHistory, quickShipping, setQuickShipping, shippingOverrides, setShippingOverrides, bankAccount, setBankAccount, googleScriptUrl, addresses }) => {
            const [chats, setChats] = useState([]);
            const [deposits, setDeposits] = useState([]);
            const [clickedChats, setClickedChats] = useState(new Set());
            const [selectedNick, setSelectedNick] = useState(null); 
            const [matchedDeposits, setMatchedDeposits] = useState(new Set());
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            
            // ê²€ìƒ‰ í•„í„°
            const [chatSearch, setChatSearch] = useState('');
            const [depositSearch, setDepositSearch] = useState('');
            const [orderSearch, setOrderSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            
            // í‚¤ì›Œë“œ í•„í„° ìƒíƒœ
            const [keywords, setKeywords] = useState(new Set()); 
            const [keywordInput, setKeywordInput] = useState('');
            const [showKeywordOnly, setShowKeywordOnly] = useState(false);

            // ì¹´ë“œ ê²°ì œ ìƒíƒœ
            const [cardPayments, setCardPayments] = useState({});

            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: '' }); 
            const [copyStatus, setCopyStatus] = useState({});

            // ë°ì´í„° ë¡œë”©
            const fetchData = async () => {
                if (!googleScriptUrl || googleScriptUrl.includes("ì—¬ê¸°ì—")) {
                    setConnectionStatus({ code: 'error_url', msg: 'ì£¼ì†Œ ë¯¸ì…ë ¥' });
                    return;
                }
                try {
                    const res = await fetch(googleScriptUrl);
                    if (!res.ok) throw new Error(`HTTP ì—ëŸ¬: ${res.status}`);
                    const text = await res.text();
                    let data;
                    try { data = JSON.parse(text); } catch (e) { throw new Error("ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜"); }
                    
                    if (data.chats) {
                        setChats(data.chats);
                        if (data.chats.length === 0) setConnectionStatus({ code: 'warning_empty', msg: 'ë°ì´í„° 0ê±´' });
                        else setConnectionStatus({ code: 'success', msg: 'ì—°ê²° ì„±ê³µ' });
                    }
                    if (data.deposits) setDeposits(data.deposits);
                    // ì£¼ì†ŒëŠ” ë¡œì»¬ íŒŒì¼/ìˆ˜ì •ë³¸ ì‚¬ìš© (ì¶©ëŒ ë°©ì§€)
                    if (data.error_yt) console.error("ìœ íŠœë¸Œ ì‹œíŠ¸ ì—ëŸ¬:", data.error_yt);

                } catch (e) {
                    console.error("ì—°ê²° ì‹¤íŒ¨:", e);
                    setConnectionStatus({ code: 'error_fetch', msg: e.message });
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [googleScriptUrl]);

            const findAddress = (nick) => {
                return addresses.find(a => a.nickname.trim() === nick.trim());
            };

            // í‚¤ì›Œë“œ ê´€ë¦¬
            const handleAddKeyword = (e) => {
                e.preventDefault();
                if(!keywordInput.trim()) return;
                setKeywords(prev => new Set(prev).add(keywordInput.trim()));
                setKeywordInput('');
            };

            const handleRemoveKeyword = (keyword) => {
                setKeywords(prev => {
                    const next = new Set(prev);
                    next.delete(keyword);
                    return next;
                });
            };

            const toggleCardPayment = (nick) => {
                setCardPayments(prev => ({ ...prev, [nick]: !prev[nick] }));
            };

            const saveToGoogleSheet = async () => {
                if (Object.keys(orders).length === 0) return alert("ì €ì¥í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                if (!confirm("í˜„ì¬ ì£¼ë¬¸ì„œë¥¼ êµ¬ê¸€ ì‹œíŠ¸ 'ìµœì¢…ì£¼ë¬¸ì„œ'ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                let saveList = [];
                orders.forEach(o => {
                    if (o.isCancelled) return;
                    const addr = findAddress(o.customer) || {};
                    const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping);
                    
                    saveList.push({
                        nickname: o.customer,
                        product: o.product,
                        qty: o.quantity,
                        price: o.price,
                        deposit: o.deposit,
                        shipping: currentShipping, 
                        grandTotal: 0, 
                        address: addr.address || '',
                        zipcode: addr.zipcode || '', // ìš°í¸ë²ˆí˜¸ ì¶”ê°€
                        phone: addr.phone || '',
                        realname: addr.realname || '',
                        memo: addr.memo || '' // ë°°ì†¡ë©”ëª¨ ì¶”ê°€
                    });
                });

                try {
                    const res = await fetch(googleScriptUrl, {
                        method: 'POST',
                        body: JSON.stringify(saveList)
                    });
                    const json = await res.json();
                    if(json.result === 'success') alert("âœ… ì €ì¥ ì™„ë£Œ!");
                    else alert("ì €ì¥ ì‹¤íŒ¨: " + json.msg);
                } catch(e) {
                    alert("ì „ì†¡ ì˜¤ë¥˜: " + e.message);
                }
            };

            const addOrderLogic = (nickname, content, qty = 1) => {
                const initialProduct = content || '';
                const initialPrice = productHistory[initialProduct] || 0;
                setOrders(prev => {
                    const existIdx = prev.findIndex(o => o.customer === nickname && o.product === initialProduct && !o.isCancelled);
                    setSelectedNick(nickname);
                    setOrderSearch(''); 
                    if (existIdx >= 0) {
                        const next = [...prev];
                        next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + qty, price: (next[existIdx].quantity + qty) * initialPrice };
                        return next;
                    }
                    return [{ id: Date.now(), customer: nickname, product: initialProduct, quantity: qty, price: initialPrice, deposit: 0, originalText: content, isCancelled: false }, ...prev];
                });
            };

            const handleChatClick = (chat) => { 
                setClickedChats(prev => new Set(prev).add(chat.id));
                addOrderLogic(chat.nickname, chat.content, 1); 
            };

            const handleManualSubmit = (e) => { e.preventDefault(); if (!manualNick.trim()) return alert("ë‹‰ë„¤ì„!"); addOrderLogic(manualNick, manualProduct, 1); setManualProduct(''); };
            const handleDepositClick = (deposit, index) => {
                if (matchedDeposits.has(index)) return;
                if (!selectedNick) return alert("ì˜¤ë¥¸ìª½ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                const depositAmount = Number(deposit.amount);
                setOrders(prev => {
                    const targetOrders = prev.filter(o => o.customer === selectedNick);
                    const otherOrders = prev.filter(o => o.customer !== selectedNick);
                    if (targetOrders.length === 0) return prev;
                    const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                    return [...updatedTargets, ...otherOrders];
                });
                setMatchedDeposits(prev => new Set(prev).add(index));
            };
            const handleProductChange = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id === id) {
                        const newOrder = { ...o, [field]: value };
                        if (field === 'product' && productHistory[value]) newOrder.price = newOrder.quantity * productHistory[value];
                        if (field === 'price' && o.product) { const unitPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: unitPrice })); }
                        return newOrder;
                    } return o;
                }));
            };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            const handleNicknameEdit = (oldNick) => {
                const newNick = prompt(`'${oldNick}'ë‹˜ì˜ ë‹‰ë„¤ì„ì„ ë¬´ì—‡ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`, oldNick);
                if (newNick && newNick !== oldNick) {
                    setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o));
                    if (shippingOverrides[oldNick]) {
                        const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] };
                        delete newOverrides[oldNick];
                        setShippingOverrides(newOverrides);
                    }
                    if (selectedNick === oldNick) setSelectedNick(newNick);
                }
            };
            const handleOrderCancel = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o)); };
            const handleOrderDelete = (id) => { if(confirm("ì´ ì£¼ë¬¸ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setOrders(prev => prev.filter(o => o.id !== id)); };

            // âœ… [ì¹´í†¡ ë³µì‚¬] ì‚¬ì¥ë‹˜ ë§ì¶¤ ì–‘ì‹ (ì¹´ë“œê²°ì œ í¬í•¨, ì•Œë¦¼ì°½ ì œê±°)
            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance, isCard) => {
                const activeItems = items.filter(i => !i.isCancelled);
                
                const itemListText = activeItems.map(i => `${i.product}(${i.quantity}ê°œ) ${Number(i.price).toLocaleString()}ì›`).join('\n');
                
                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                
                let msg = `ğŸ’™ ${nick} ë‹˜ ğŸ’™\n\n\n`;
                msg += `${itemListText}\n`;
                msg += `ë°°ì†¡ë¹„ ${currentShipping.toLocaleString()}ì›\n\n`;
                msg += `ì´ ì£¼ë¬¸ê¸ˆì•¡ ${grandTotal.toLocaleString()}ì›\n\n`;
                msg += `------------------\n`;

                if (isCard) {
                    // ì¹´ë“œ ê²°ì œ ì–‘ì‹
                    const cardBaseAmount = Math.abs(balance); // ê²°ì œí•  ì›ê¸ˆ (ë¯¸ìˆ˜ê¸ˆ)
                    const cardFee = cardBaseAmount * 0.1;     // ìˆ˜ìˆ˜ë£Œ 10%
                    const cardTotal = cardBaseAmount + cardFee; // ì´ ê²°ì œì•¡

                    if (depositTotal > 0) {
                        msg += `[ì…ê¸ˆí™•ì¸]\n`;
                        msg += `${depositTotal.toLocaleString()}ì›\n\n`;
                    }
                    msg += `[ì¹´ë“œê²°ì œ]\n`;
                    msg += `ê¸ˆì•¡ ${cardBaseAmount.toLocaleString()}ì›\n`;
                    msg += `10%   ${cardFee.toLocaleString()}ì›\n`;
                    msg += `ğŸ‘‰ì´ ${cardTotal.toLocaleString()}ì› ì˜ˆì •\n\n`;
                    msg += `í•¸ë“œí°ë²ˆí˜¸ ë‚¨ê²¨ì£¼ì„¸ìš”ğŸŒ¸\n`;
                    msg += `------------------\n\n`;

                } else {
                    // í˜„ê¸ˆ ê²°ì œ ì–‘ì‹ (ê¸°ì¡´ ìœ ì§€)
                    const isPaid = balance >= 0;

                    if (depositTotal > 0) {
                        msg += `[ì…ê¸ˆí™•ì¸]\n`;
                        msg += `${depositTotal.toLocaleString()}ì›\n\n`;
                        msg += `------------------\n\n`;
                    }

                    if (isPaid) {
                        msg += `ì™„ë‚© í™•ì¸! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜\n`;
                        msg += `------------------\n\n`;
                    } else {
                        msg += `[ë¯¸ì…ê¸ˆ]\n`;
                        msg += `ì´ ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡\n`;
                        msg += `ğŸ‘‰ ${Math.abs(balance).toLocaleString()}ì› \n\n`;
                        msg += `${bankAccount}\n`;
                        msg += `ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n\n`;
                        msg += `------------------\n\n`;
                    }
                }

                msg += `ë°©ì†¡ë§ˆë‹¤ 1íšŒ\n`;
                msg += `í•˜ë‹¨ì˜ ì£¼ë¬¸ì„œ(ë°°ì†¡ì§€ì…ë ¥) í•„ìˆ˜!!\n\n`;
                msg += `ì´ë¯¸ ì°¸ì—¬í•œ ì„¤ë¬¸ ì¼ ê²½ìš°\n`;
                msg += `â–« ë‹µë³€ ìˆ˜ì •í•˜ê¸° \n`;
                msg += `â–« ë˜ëŠ” ì„¤ë¬¸ ì¶”ê°€ ì°¸ì—¬\n\n`;
                msg += `ë¯¸ì…ë ¥ì´ ë§ì•„ ê³„ì† ì•ˆë‚´í•©ë‹ˆë‹¤. \n`;
                msg += `ì–‘í•´ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;

                const textArea = document.createElement("textarea");
                textArea.value = msg;
                document.body.appendChild(textArea);
                textArea.select();
                try { 
                    document.execCommand('copy'); 
                    setCopyStatus(prev => ({ ...prev, [nick]: true }));
                    setTimeout(() => {
                        setCopyStatus(prev => ({ ...prev, [nick]: false }));
                    }, 2000);
                } catch (err) { alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err); }
                document.body.removeChild(textArea);
            };

            const filteredChats = useMemo(() => {
                let result = chats;
                if (showKeywordOnly) {
                    result = result.filter(c => {
                        const content = c.content.toLowerCase();
                        return [...keywords].some(k => content.includes(k.toLowerCase()));
                    });
                }
                if (chatSearch) {
                    result = result.filter(c => c.nickname.toLowerCase().includes(chatSearch.toLowerCase()) || c.content.toLowerCase().includes(chatSearch.toLowerCase()));
                }
                return result;
            }, [chats, chatSearch, showKeywordOnly, keywords]);

            const filteredDeposits = useMemo(() => {
                if (!depositSearch) return deposits;
                return deposits.filter(d => d.name.toLowerCase().includes(depositSearch.toLowerCase()) || String(d.amount).includes(depositSearch));
            }, [deposits, depositSearch]);

            const filteredGroupedOrders = useMemo(() => {
                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                return Object.entries(groups).filter(([nick, items]) => {
                    if (orderSearch && !nick.toLowerCase().includes(orderSearch.toLowerCase())) return false;
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const activeItems = items.filter(i => !i.isCancelled);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + finalShipping;
                    const balance = depositTotal - grandTotal;
                    const isPaid = balance >= 0 && depositTotal > 0;
                    if (filterStatus === 'unpaid' && isPaid) return false;
                    if (filterStatus === 'paid' && !isPaid) return false;
                    return true;
                });
            }, [orders, orderSearch, filterStatus, shippingOverrides, quickShipping]);

            // ëŒ€ì‹œë³´ë“œ í†µê³„ ê³„ì‚°
            const dashboardStats = useMemo(() => {
                let totalSales = 0;
                let totalDeposit = 0;
                let totalUnpaid = 0;
                let totalCardExpected = 0;

                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });

                Object.entries(groups).forEach(([nick, items]) => {
                    const activeItems = items.filter(i => !i.isCancelled);
                    if (activeItems.length === 0) return;

                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + currentShipping;
                    const balance = grandTotal - depositTotal; // ë¯¸ìˆ˜ê¸ˆ (ì–‘ìˆ˜)

                    totalSales += grandTotal;
                    totalDeposit += depositTotal;

                    if (balance > 0) {
                        if (cardPayments[nick]) {
                            const fee = balance * 0.1;
                            totalCardExpected += (balance + fee);
                        } else {
                            totalUnpaid += balance;
                        }
                    }
                });

                return { totalSales, totalDeposit, totalUnpaid, totalCardExpected };
            }, [orders, shippingOverrides, quickShipping, cardPayments]);

            const StatusMessage = () => {
                const { code, msg } = connectionStatus;
                if (code === 'error_url') return <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-2 m-2 text-xs">ğŸš¨ ì£¼ì†Œ ì—†ìŒ</div>;
                if (code === 'error_fetch') return <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-2 m-2 text-xs">âš ï¸ ì—°ê²° ì‹¤íŒ¨: {msg}</div>;
                if (code === 'warning_empty') return <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 m-2 text-xs">â„¹ï¸ ë°ì´í„° 0ê±´ (ì‹œíŠ¸ ì´ë¦„ Sheet1 í™•ì¸ í•„ìš”)</div>;
                return null;
            };

            return (
                <div className="flex h-full gap-2 p-2 overflow-hidden bg-gray-50">
                    <datalist id="product-list">{Object.keys(productHistory).map(name => <option key={name} value={name} />)}</datalist>
                    
                    {/* [1. ëŒ“ê¸€ ì˜ì—­ (30%)] */}
                    <div className="w-[30%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-red-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-red-600 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span>
                                <span className="text-xs text-gray-500">{filteredChats.length}ê±´</span>
                            </div>
                            
                            {/* í‚¤ì›Œë“œ ë“±ë¡ì°½ */}
                            <div className="flex flex-col gap-2 bg-gray-50 p-2 rounded border border-gray-100">
                                <form onSubmit={handleAddKeyword} className="flex gap-1">
                                    <input 
                                        type="text" 
                                        value={keywordInput}
                                        onChange={(e) => setKeywordInput(e.target.value)}
                                        placeholder="í‚¤ì›Œë“œ ì¶”ê°€ (ì˜ˆ: 240, ì£¼ë¬¸)" 
                                        className="flex-1 text-xs border rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-500" 
                                    />
                                    <button type="submit" className="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-600">ì¶”ê°€</button>
                                </form>
                                {/* âœ… í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ (ìŠ¤í¬ë¡¤ ì ìš©) */}
                                {keywords.size > 0 && (
                                    <div className="flex flex-wrap gap-1 max-h-16 overflow-y-auto scrollbar-thin mt-1 p-1 bg-white border rounded">
                                        {[...keywords].map(k => (
                                            <span key={k} onClick={() => handleRemoveKeyword(k)} 
                                                className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[10px] cursor-pointer hover:bg-red-100 hover:text-red-600 flex items-center gap-1 shrink-0">
                                                {k} <Icon name="x" weight="bold"/>
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* í•„í„° ë²„íŠ¼ */}
                            <div className="flex gap-2">
                                <button onClick={()=>setShowKeywordOnly(!showKeywordOnly)} 
                                    className={`flex-1 px-2 py-1.5 text-xs rounded border flex justify-center items-center gap-1 ${showKeywordOnly ? 'bg-blue-100 text-blue-700 border-blue-300 font-bold' : 'bg-gray-50 text-gray-500'}`}>
                                    <Icon name={showKeywordOnly ? "check-square" : "square"} /> ğŸ¯ í‚¤ì›Œë“œë§Œ ë³´ê¸°
                                </button>
                            </div>

                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                <input type="text" placeholder="ë‹‰ë„¤ì„/ë‚´ìš© ê²€ìƒ‰" value={chatSearch} onChange={e => setChatSearch(e.target.value)} 
                                    className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-red-500 outline-none" />
                                {chatSearch && <button onClick={()=>setChatSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}
                            </div>
                        </div>
                        
                        <StatusMessage />

                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {filteredChats.map(chat => {
                                const isClicked = clickedChats.has(chat.id);
                                const isKeywordMatch = [...keywords].some(k => chat.content.includes(k));

                                return (
                                    <div key={chat.id} onClick={() => handleChatClick(chat)} 
                                         className={`p-2 border rounded cursor-pointer transition-all flex flex-col gap-1 
                                            ${isClicked ? 'processed-chat' : 'bg-white hover:bg-red-50 hover:border-red-200'}
                                            ${isKeywordMatch && !isClicked ? 'keyword-detected' : ''} 
                                         `}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className={`font-bold ${isClicked ? 'text-gray-500' : 'text-gray-700'}`}>{chat.nickname}</span>
                                            <span className="text-gray-400">{chat.time ? new Date(chat.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                        </div>
                                        <div className="text-sm">{chat.content}</div>
                                        
                                        {/* í‚¤ì›Œë“œ ê°ì§€ ë±ƒì§€ */}
                                        {isKeywordMatch && !isClicked && (
                                             <div className="flex justify-between items-center mt-1">
                                                <span className="keyword-badge flex items-center gap-1"><Icon name="target" weight="fill"/> í‚¤ì›Œë“œë¨</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {filteredChats.length === 0 && <div className="text-center text-gray-400 py-10 text-sm">í‘œì‹œí•  ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* [2. ì…ê¸ˆ ì˜ì—­ (20%)] */}
                    <div className="w-[20%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-yellow-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-yellow-700 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="money" weight="fill"/> ì…ê¸ˆ ë‚´ì—­</span>
                                <span className="text-xs text-gray-500">{filteredDeposits.length}ê±´</span>
                            </div>
                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                <input type="text" placeholder="ì…ê¸ˆì/ê¸ˆì•¡ ê²€ìƒ‰" value={depositSearch} onChange={e => setDepositSearch(e.target.value)} 
                                    className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-yellow-500 outline-none" />
                                {depositSearch && <button onClick={()=>setDepositSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}
                            </div>
                            {selectedNick && <div className="text-[11px] text-blue-600 bg-blue-50 p-1 rounded text-center animate-pulse">ğŸ‘‡ '{selectedNick}'ë‹˜ ì…ê¸ˆ ë§¤ì¹­ ì¤‘</div>}
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-yellow-50/30">
                            {filteredDeposits.map((d, i) => {
                                const isUsed = matchedDeposits.has(i);
                                const isSuggested = selectedNick && d.name.includes(selectedNick.replace(/ /g,''));
                                return (
                                    <div key={i} onClick={() => handleDepositClick(d, i)} 
                                         className={`flex justify-between p-2 border rounded cursor-pointer transition-all 
                                            ${isUsed ? 'opacity-40 bg-gray-100 line-through' : ''} 
                                            ${isSuggested && !isUsed ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-400' : 'bg-white hover:bg-yellow-100'}
                                         `}>
                                        <span className="text-gray-700 text-sm">{d.name}</span>
                                        <span className="font-mono text-blue-600 font-bold text-sm">+{Number(d.amount).toLocaleString()}</span>
                                    </div>
                                );
                            })}
                            {filteredDeposits.length === 0 && <div className="text-center text-gray-400 py-10 text-sm">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                        </div>
                    </div>

                    {/* [3. ì£¼ë¬¸ì„œ ì˜ì—­ (50%)] */}
                    <div className="w-[50%] bg-gray-100 border rounded-lg flex flex-col overflow-hidden">
                        
                        {/* [NEW] ìƒë‹¨ ëŒ€ì‹œë³´ë“œ */}
                        <div className="grid grid-cols-4 gap-2 p-2 bg-indigo-50 border-b border-indigo-100 text-center text-xs">
                            <div className="bg-white p-1 rounded shadow-sm">
                                <div className="text-gray-400">ì´ ë§¤ì¶œ</div>
                                <div className="font-bold text-indigo-700 text-sm">{dashboardStats.totalSales.toLocaleString()}ì›</div>
                            </div>
                            <div className="bg-white p-1 rounded shadow-sm">
                                <div className="text-gray-400">ì…ê¸ˆì•¡</div>
                                <div className="font-bold text-green-600 text-sm">{dashboardStats.totalDeposit.toLocaleString()}ì›</div>
                            </div>
                            <div className="bg-white p-1 rounded shadow-sm">
                                <div className="text-gray-400">ë¯¸ìˆ˜ê¸ˆ</div>
                                <div className="font-bold text-red-500 text-sm">{dashboardStats.totalUnpaid.toLocaleString()}ì›</div>
                            </div>
                            <div className="bg-white p-1 rounded shadow-sm ring-1 ring-purple-100">
                                <div className="text-gray-400">ì¹´ë“œì˜ˆì •(10%)</div>
                                <div className="font-bold text-purple-600 text-sm">{dashboardStats.totalCardExpected.toLocaleString()}ì›</div>
                            </div>
                        </div>

                        <div className="p-2 bg-white border-b font-bold text-indigo-700 shadow-sm flex flex-col gap-2">
                            <div className="flex justify-between items-center">
                                <span>ğŸ“¦ ì£¼ë¬¸ì„œ ({filteredGroupedOrders.length}ëª…)</span>
                                <div className="flex items-center gap-2">
                                    <button onClick={saveToGoogleSheet} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-1">
                                        <Icon name="floppy-disk" weight="fill"/> êµ¬ê¸€ì‹œíŠ¸ ì €ì¥
                                    </button>
                                    <div className="flex bg-gray-100 rounded p-0.5 gap-0.5 text-xs">
                                        <button onClick={()=>setFilterStatus('all')} className={`px-2 py-1 rounded ${filterStatus==='all' ? 'bg-white shadow text-indigo-600 font-bold':'text-gray-500'}`}>ì „ì²´</button>
                                        <button onClick={()=>setFilterStatus('unpaid')} className={`px-2 py-1 rounded ${filterStatus==='unpaid' ? 'bg-white shadow text-red-600 font-bold':'text-gray-500'}`}>ğŸ”ºë¯¸ì…ê¸ˆ</button>
                                        <button onClick={()=>setFilterStatus('paid')} className={`px-2 py-1 rounded ${filterStatus==='paid' ? 'bg-white shadow text-green-600 font-bold':'text-gray-500'}`}>âœ…ì™„ë‚©</button>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1 flex gap-2 items-center bg-indigo-50 p-2 rounded border border-indigo-100">
                                    <span className="text-xs font-bold text-indigo-600 whitespace-nowrap">ğŸ–ï¸ ì¶”ê°€:</span>
                                    <form onSubmit={handleManualSubmit} className="flex gap-1 w-full">
                                        <input type="text" placeholder="ë‹‰ë„¤ì„" value={manualNick} onChange={e => setManualNick(e.target.value)} className="w-24 border rounded px-2 py-1 text-sm outline-none" />
                                        <input type="text" list="product-list" placeholder="ìƒí’ˆëª…" value={manualProduct} onChange={e => setManualProduct(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm outline-none" />
                                        <button type="submit" className="bg-indigo-600 text-white px-2 py-1 rounded text-sm font-bold hover:bg-indigo-700">ï¼‹</button>
                                    </form>
                                </div>
                                <div className="w-1/3 relative">
                                    <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                    <input type="text" placeholder="ì£¼ë¬¸ì ê²€ìƒ‰..." value={orderSearch} onChange={(e) => setOrderSearch(e.target.value)} className="w-full h-full pl-8 pr-2 border rounded text-sm outline-none" />
                                    {orderSearch && <button onClick={()=>setOrderSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill"/></button>}
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 text-[11px] text-gray-500 items-center bg-white p-1 rounded border border-gray-100">
                                <span>ê¸°ë³¸ë°°ì†¡: <input type="number" value={quickShipping} onChange={(e)=>setQuickShipping(Number(e.target.value))} className="w-10 border rounded px-1 text-right bg-gray-50" />ì›</span>
                                <span className="flex-1 flex items-center gap-1">ê³„ì¢Œ: <textarea value={bankAccount} onChange={(e)=>setBankAccount(e.target.value)} className="flex-1 border rounded px-1 bg-gray-50 resize-none h-8 text-[10px] leading-tight" placeholder="ê³„ì¢Œ ì…ë ¥"></textarea></span>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-3">
                            {filteredGroupedOrders.map(([nick, items]) => {
                                const isSelected = selectedNick === nick;
                                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                                
                                const activeItems = items.filter(i => !i.isCancelled);
                                const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                                const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                                const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                                const grandTotal = productTotal + finalShipping;
                                const balance = depositTotal - grandTotal;
                                const isCard = cardPayments[nick]; // ì¹´ë“œ ê²°ì œ ì—¬ë¶€

                                let statusBadge;
                                if (isCard) {
                                    statusBadge = <span className="bg-purple-100 text-purple-600 px-2 py-0.5 rounded text-xs font-bold border border-purple-200">ğŸ’³ ì¹´ë“œ</span>;
                                } else if (depositTotal === 0) {
                                    statusBadge = <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold">ë¯¸ì…ê¸ˆ</span>;
                                } else if (balance >= 0) {
                                    statusBadge = <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">âœ… ì™„ë‚©</span>;
                                } else {
                                    statusBadge = <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold badge-pulse">ğŸ”º {Math.abs(balance).toLocaleString()}ì› ë¶€ì¡±</span>;
                                }

                                const addr = findAddress(nick);
                                const isCopied = copyStatus[nick]; // ë³µì‚¬ ìƒíƒœ í™•ì¸

                                return (
                                    <div key={nick} onClick={() => setSelectedNick(prev => prev === nick ? null : nick)} className={`bg-white rounded-xl border shadow-sm transition-all overflow-hidden cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 shadow-md' : 'hover:border-indigo-300'}`}>
                                        <div className={`p-3 flex justify-between items-center ${isSelected ? 'bg-indigo-50' : 'bg-gray-50'} border-b`}>
                                            <div className="flex flex-col gap-1">
                                                <div className="flex items-center gap-2 group">
                                                    <span className="font-bold text-lg text-gray-800">{nick}</span>
                                                    <button onClick={(e)=>{e.stopPropagation(); handleNicknameEdit(nick);}} className="text-gray-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="pencil-simple" weight="bold"/></button>
                                                    <span className="text-xs bg-white border px-1.5 rounded text-gray-500">{items.length}ê±´</span>
                                                    
                                                    {/* [NEW] ì¹´ë“œ ê²°ì œ í† ê¸€ ë²„íŠ¼ */}
                                                    <button onClick={(e) => { e.stopPropagation(); toggleCardPayment(nick); }} 
                                                        className={`ml-2 text-xs px-2 py-0.5 rounded border flex items-center gap-1 transition-colors ${isCard ? 'bg-purple-100 border-purple-300 text-purple-700 font-bold' : 'bg-gray-50 text-gray-400 hover:bg-gray-100'}`}>
                                                        <Icon name="credit-card" weight={isCard ? "fill" : "regular"}/> ì¹´ë“œ
                                                    </button>
                                                </div>
                                                {/* âœ… [ê°œì„ ] ì£¼ì†Œê°€ ê¸¸ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ê¹€ */}
                                                <div className="flex items-start gap-1 text-xs mt-1">
                                                    {addr ? (
                                                        <div className="text-green-600 font-bold flex flex-col gap-0.5">
                                                             <span className="flex items-center gap-1"><Icon name="house-line" weight="fill"/> {addr.realname} ({addr.phone})</span>
                                                             {/* ğŸ’¡ [í•µì‹¬] ì£¼ì†Œê°€ ê¸¸ì–´ë„ ë‹¤ ë³´ì´ê²Œ ìŠ¤íƒ€ì¼ ìˆ˜ì • */}
                                                             <span className="text-[11px] text-slate-500 font-normal break-all whitespace-normal leading-tight">{addr.address}</span>
                                                        </div>
                                                    ) : (
                                                        <span className="text-red-400 flex items-center gap-1"><Icon name="warning-circle" weight="fill"/> ì£¼ì†Œì—†ìŒ</span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="text-right flex items-center gap-3">
                                                <div className="text-xs text-gray-500 text-right"><div>ìƒí’ˆ {productTotal.toLocaleString()} + ë°°ì†¡ {finalShipping.toLocaleString()}</div><div className="font-bold text-lg font-mono text-gray-800">{grandTotal.toLocaleString()}ì›</div></div>
                                                <div className="flex flex-col gap-1 items-end">
                                                    {statusBadge}
                                                    <div className="flex gap-1">
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); copyOrderSheet(nick, items, grandTotal, depositTotal, balance, isCard); }} 
                                                            className={`px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm transition-all ${isCopied ? 'bg-green-500 text-white copy-anim' : 'bg-yellow-300 hover:bg-yellow-400 text-black'}`}>
                                                            {isCopied ? <><Icon name="check" weight="bold"/> ë³µì‚¬ë¨!</> : <><Icon name="chat-circle-dots" weight="fill"/> ì¹´í†¡ë³µì‚¬</>}
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="p-2 space-y-1">
                                            {items.map((item, idx) => (
                                                <div key={idx} className={`flex justify-between items-center text-sm p-1.5 hover:bg-gray-50 rounded group ${item.isCancelled ? 'cancelled-item' : ''}`}>
                                                    <div className="flex-1 flex gap-2 items-center">
                                                        <input type="text" list="product-list" value={item.product} onChange={(e) => handleProductChange(item.id, 'product', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-full border-b border-dashed border-gray-300 bg-transparent focus:border-indigo-500 focus:bg-white outline-none px-1 py-0.5" placeholder="ìƒí’ˆëª…" disabled={item.isCancelled} />
                                                    </div>
                                                    <div className="flex items-center gap-2 pl-2">
                                                        <span className="font-bold text-indigo-600 bg-indigo-50 px-2 rounded text-xs shrink-0">{item.quantity}ê°œ</span>
                                                        <input type="number" value={item.price} onChange={(e) => handleProductChange(item.id, 'price', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-20 text-right font-mono text-gray-500 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 bg-transparent outline-none" disabled={item.isCancelled} />
                                                        <div className="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderCancel(item.id);}} className={`p-1 rounded ${item.isCancelled ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600'}`} title={item.isCancelled ? "ì·¨ì†Œ ë³µêµ¬" : "ì£¼ë¬¸ ì·¨ì†Œ"}><Icon name={item.isCancelled ? "arrow-u-up-left" : "prohibit"} weight="bold"/></button>
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderDelete(item.id);}} className="p-1 rounded bg-gray-200 text-gray-600 hover:bg-red-500 hover:text-white" title="ì™„ì „ ì‚­ì œ"><Icon name="trash" weight="bold"/></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {/* âœ… [ìˆ˜ì •] ë°°ì†¡ë¹„ ì…ë ¥ì¹¸ ì—¬ë°± ë° ìŠ¤íƒ€ì¼ ê°œì„  */}
                                            <div className="flex justify-end items-center gap-2 px-2 py-2 text-xs text-gray-400 border-t border-dashed border-gray-100 mt-1">
                                                <span>ë°°ì†¡ë¹„:</span>
                                                <input 
                                                    type="number" 
                                                    value={currentShipping} 
                                                    onClick={(e)=>e.stopPropagation()} 
                                                    onChange={(e)=>handleShippingChange(nick, e.target.value)} 
                                                    className="w-24 text-right border rounded bg-white px-2 py-1 focus:ring-1 focus:ring-indigo-500 text-slate-600 font-bold" 
                                                />
                                            </div>
                                            
                                            {depositTotal > 0 && (<div className="mt-2 pt-2 border-t border-dashed flex justify-between text-sm text-green-600 font-bold px-2"><span>â”” ì…ê¸ˆí™•ì¸ì•¡</span><span>{depositTotal.toLocaleString()}ì›</span></div>)}
                                            
                                            {/* ì¹´ë“œ ê²°ì œ ìƒì„¸ ë‚´ì—­ (í™”ë©´ í‘œì‹œìš©) */}
                                            {isCard && balance < 0 && (
                                                <div className="mt-1 pt-2 border-t border-dashed bg-purple-50 p-2 rounded text-xs text-right text-gray-600">
                                                    <div>ë¯¸ìˆ˜ê¸ˆ {Math.abs(balance).toLocaleString()}ì›</div>
                                                    <div>+ ì¹´ë“œìˆ˜ìˆ˜ë£Œ 10% {(Math.abs(balance)*0.1).toLocaleString()}ì›</div>
                                                    <div className="font-bold text-purple-700 mt-1">ğŸ’³ ì¹´ë“œ ê²°ì œì˜ˆì •: {(Math.abs(balance) * 1.1).toLocaleString()}ì›</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // [NEW] ê³ ê°ê´€ë¦¬ íƒ­ ì»´í¬ë„ŒíŠ¸
        const CustomerTab = ({ addresses, setAddresses }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);

            // ì£¼ì†Œ ì¶”ê°€/ìˆ˜ì • ìƒíƒœ
            const [editMode, setEditMode] = useState(null); // null or nickname
            const [inputData, setInputData] = useState({ nickname: '', realname: '', phone: '', zipcode: '', address: '', memo: '' });

            // ê²€ìƒ‰ í•„í„°
            const filteredAddresses = useMemo(() => {
                if (!searchTerm) return addresses;
                return addresses.filter(a => 
                    a.nickname.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    a.realname.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [addresses, searchTerm]);

            // ì¶”ê°€/ìˆ˜ì • í•¸ë“¤ëŸ¬
            const handleSave = () => {
                if (!inputData.nickname) return alert("ë‹‰ë„¤ì„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
                
                // ê¸°ì¡´ì— ìˆëŠ” ë‹‰ë„¤ì„ì¸ì§€ í™•ì¸ (ìˆ˜ì • ëª¨ë“œê°€ ì•„ë‹ ë•Œ)
                if (!editMode && addresses.some(a => a.nickname === inputData.nickname)) {
                    if (!confirm("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                }

                setAddresses(prev => {
                    // ê¸°ì¡´ ê±° ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€ (ë®ì–´ì“°ê¸° íš¨ê³¼)
                    const next = prev.filter(a => a.nickname !== inputData.nickname);
                    return [...next, inputData];
                });
                
                setEditMode(null);
                setInputData({ nickname: '', realname: '', phone: '', zipcode: '', address: '', memo: '' });
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleEdit = (customer) => {
                setEditMode(customer.nickname);
                setInputData(customer);
            };

            const handleDelete = (nickname) => {
                if (confirm(`${nickname}ë‹˜ì˜ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setAddresses(prev => prev.filter(a => a.nickname !== nickname));
                }
            };

            // ì—‘ì…€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ìŠ¤ë§ˆíŠ¸ íŒŒì‹± ì ìš© - ì‚¬ìš©ì ìš”ì²­ ì»¬ëŸ¼ ë°˜ì˜)
            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        const wsname = wb.SheetNames[0];
                        const ws = wb.Sheets[wsname];
                        // í—¤ë”ê°€ ìˆëŠ” JSONìœ¼ë¡œ ë³€í™˜ (raw:falseë¡œ í•˜ë©´ í¬ë§·ëœ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜´ - 0 ìœ ì§€ ìœ ë¦¬)
                        // header: "A" ì˜µì…˜ ì‚¬ìš©
                        const data = XLSX.utils.sheet_to_json(ws, { raw: false, header: "A" });
                        
                        // ë°ì´í„° ì •ì œ ë° ë³‘í•©
                        const newAddresses = data.map(row => {
                            // Dì—´: ë‹‰ë„¤ì„, Fì—´: ì´ë¦„, Gì—´: ì „í™”ë²ˆí˜¸, Hì—´: ì£¼ì†Œ, Iì—´: ë°°ì†¡ë©”ëª¨
                            const nickname = row['D'] ? String(row['D']).trim() : '';
                            if (!nickname || nickname === 'ë‹‰ë„¤ì„') return null; // í—¤ë”ë‚˜ ë¹ˆ ê°’ ì œì™¸

                            const realname = row['F'] ? String(row['F']).trim() : '';
                            let phone = row['G'] ? String(row['G']).trim() : '';
                            let fullAddr = row['H'] ? String(row['H']).trim() : '';
                            const memo = row['I'] ? String(row['I']).trim() : '';
                            
                            // 1. ì „í™”ë²ˆí˜¸ 0 ì±„ìš°ê¸°
                            phone = String(phone).replace(/[^0-9]/g, '');
                            if (phone.length === 10 && phone.startsWith('10')) phone = '0' + phone;
                            if (phone.length === 11) phone = phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');

                            // 2. ì£¼ì†Œì—ì„œ ìš°í¸ë²ˆí˜¸ ë¶„ë¦¬
                            let zipcode = '';
                            let address = fullAddr;
                            
                            const zipMatch = fullAddr.match(/[\(\[](\d{5})[\)\]]/);
                            if (zipMatch) {
                                zipcode = zipMatch[1]; // ê´„í˜¸ ì•ˆì˜ ìˆ«ìë§Œ ì¶”ì¶œ
                                address = fullAddr.replace(zipMatch[0], '').trim(); // ìš°í¸ë²ˆí˜¸ ë¶€ë¶„ ì œê±°í•˜ê³  ë‚˜ë¨¸ì§€ ì£¼ì†Œë§Œ
                            }

                            return { nickname, realname, phone, zipcode, address, memo };
                        }).filter(a => a); // null ì œì™¸

                        if (newAddresses.length > 0) {
                            // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ë‹‰ë„¤ì„ ê¸°ì¤€ ë®ì–´ì“°ê¸°)
                            setAddresses(prev => {
                                const map = new Map(prev.map(item => [item.nickname, item]));
                                newAddresses.forEach(item => map.set(item.nickname, item));
                                return Array.from(map.values());
                            });
                            alert(`âœ… ${newAddresses.length}ëª… ë¡œë“œ ì™„ë£Œ! (ì¤‘ë³µì€ ìµœì‹  ì •ë³´ë¡œ ì—…ë°ì´íŠ¸ë¨)`);
                        } else {
                            alert("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ Dì—´ì— 'ë‹‰ë„¤ì„'ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
                        }
                    } catch (err) {
                        alert("ì—‘ì…€ ì½ê¸° ì‹¤íŒ¨: " + err);
                    }
                };
                reader.readAsBinaryString(file);
                e.target.value = ''; 
            };

            return (
                <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border p-4 overflow-hidden">
                    <div className="flex justify-between items-center mb-4 pb-4 border-b">
                        <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="address-book" weight="fill" className="text-indigo-600"/> ê³ ê° ì£¼ì†Œë¡ ê´€ë¦¬ <span className="text-sm font-normal text-gray-500">({addresses.length}ëª…)</span></h2>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleExcelUpload} className="hidden" accept=".xlsx, .xls" />
                            <button onClick={() => fileInputRef.current.click()} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 shadow-sm">
                                <Icon name="file-xls" weight="fill"/> ì—‘ì…€ ì¼ê´„ë“±ë¡
                            </button>
                        </div>
                    </div>

                    {/* ì…ë ¥ í¼ */}
                    <div className="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4 flex gap-2 items-end">
                        <div className="flex-1 grid grid-cols-6 gap-2">
                            <div><label className="text-xs font-bold text-gray-500">ë‹‰ë„¤ì„(í•„ìˆ˜)</label><input type="text" value={inputData.nickname} onChange={e=>setInputData({...inputData, nickname:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="ì˜ˆ: ê¹”ë¡œ" /></div>
                            <div><label className="text-xs font-bold text-gray-500">ì´ë¦„(ì‹¤ëª…)</label><input type="text" value={inputData.realname} onChange={e=>setInputData({...inputData, realname:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="í™ê¸¸ë™" /></div>
                            <div><label className="text-xs font-bold text-gray-500">ì „í™”ë²ˆí˜¸</label><input type="text" value={inputData.phone} onChange={e=>setInputData({...inputData, phone:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="010-0000-0000" /></div>
                            <div className="col-span-2 flex gap-1">
                                <div className="w-20"><label className="text-xs font-bold text-gray-500">ìš°í¸ë²ˆí˜¸</label><input type="text" value={inputData.zipcode} onChange={e=>setInputData({...inputData, zipcode:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="01234" /></div>
                                <div className="flex-1"><label className="text-xs font-bold text-gray-500">ì£¼ì†Œ</label><input type="text" value={inputData.address} onChange={e=>setInputData({...inputData, address:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." /></div>
                            </div>
                            <div><label className="text-xs font-bold text-gray-500">ë°°ì†¡ë©”ëª¨</label><input type="text" value={inputData.memo} onChange={e=>setInputData({...inputData, memo:e.target.value})} className="w-full border rounded px-2 py-1 text-sm" placeholder="ë¬¸ì•" /></div>
                        </div>
                        <button onClick={handleSave} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded font-bold h-10 shadow-sm">{editMode ? 'ìˆ˜ì •ì™„ë£Œ' : 'ì¶”ê°€'}</button>
                        {editMode && <button onClick={()=>{setEditMode(null); setInputData({ nickname: '', realname: '', phone: '', zipcode: '', address: '', memo: '' });}} className="bg-gray-400 hover:bg-gray-500 text-white px-3 py-2 rounded font-bold h-10">ì·¨ì†Œ</button>}
                    </div>

                    {/* ê²€ìƒ‰ì°½ */}
                    <div className="relative mb-2">
                        <Icon name="magnifying-glass" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>
                        <input type="text" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-10 border rounded py-2 text-sm outline-none focus:border-indigo-500" />
                    </div>

                    {/* ë¦¬ìŠ¤íŠ¸ */}
                    <div className="flex-1 overflow-y-auto border rounded bg-white">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-100 text-gray-600 sticky top-0">
                                <tr>
                                    <th className="p-2 border-b">ë‹‰ë„¤ì„</th>
                                    <th className="p-2 border-b">ì´ë¦„</th>
                                    <th className="p-2 border-b">ì „í™”ë²ˆí˜¸</th>
                                    <th className="p-2 border-b w-16">ìš°í¸ë²ˆí˜¸</th>
                                    <th className="p-2 border-b">ì£¼ì†Œ</th>
                                    <th className="p-2 border-b">ë°°ì†¡ë©”ëª¨</th>
                                    <th className="p-2 border-b w-20 text-center">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredAddresses.map((addr, i) => (
                                    <tr key={i} className="hover:bg-gray-50 group">
                                        <td className="p-2 font-bold text-indigo-700">{addr.nickname}</td>
                                        <td className="p-2">{addr.realname}</td>
                                        <td className="p-2">{addr.phone}</td>
                                        <td className="p-2 font-mono text-gray-500">{addr.zipcode}</td>
                                        <td className="p-2 text-gray-600">{addr.address}</td>
                                        <td className="p-2 text-gray-500 text-xs">{addr.memo}</td>
                                        <td className="p-2 text-center">
                                            <button onClick={()=>handleEdit(addr)} className="text-blue-500 hover:text-blue-700 mx-1"><Icon name="pencil-simple" weight="fill"/></button>
                                            <button onClick={()=>handleDelete(addr.nickname)} className="text-red-400 hover:text-red-600 mx-1"><Icon name="trash" weight="fill"/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filteredAddresses.length === 0 && <div className="text-center py-10 text-gray-400">ë“±ë¡ëœ ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            const [activeTab, setActiveTab] = useState('live');
            const [quickShipping, setQuickShipping] = useState(4000); 
            // ğŸ”¹ ì‚¬ì¥ë‹˜ì˜ ìš”ì²­ëŒ€ë¡œ ê¸°ë³¸ê°’ ì„¤ì • (ì¹´ì¹´ì˜¤ë±…í¬ ê¹€ì„ ì • ì¤„ë°”ê¿ˆ ì ìš©)
            const [bankAccount, setBankAccount] = useState(() => localStorage.getItem('bankAccount') || "ì¹´ì¹´ì˜¤ë±…í¬ ê¹€ì„ ì •\n7942 18 01611");
            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [shippingOverrides, setShippingOverrides] = useState(() => JSON.parse(localStorage.getItem('shippingOverrides')) || {});
            // âœ… ì£¼ì†Œë¡ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥)
            const [addresses, setAddresses] = useState(() => JSON.parse(localStorage.getItem('verifiedAddresses')) || []);
            const [cardPayments, setCardPayments] = useState(() => JSON.parse(localStorage.getItem('cardPayments')) || {});

            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('bankAccount', bankAccount); }, [bankAccount]);
            useEffect(() => { localStorage.setItem('shippingOverrides', JSON.stringify(shippingOverrides)); }, [shippingOverrides]);
            useEffect(() => { localStorage.setItem('verifiedAddresses', JSON.stringify(addresses)); }, [addresses]);
            useEffect(() => { localStorage.setItem('cardPayments', JSON.stringify(cardPayments)); }, [cardPayments]);


            const tabs = [
                { id: 'live', label: 'ğŸ¥ ë¼ì´ë¸Œê´€ì œ', icon: 'monitor-play' }, 
                { id: 'customer', label: 'ğŸ‘¥ ê³ ê°ê´€ë¦¬', icon: 'address-book' }, // ğŸ†• íƒ­ ì¶”ê°€
                { id: 'manage', label: 'ğŸ“Š ì£¼ë¬¸ê´€ë¦¬(ì—‘ì…€)', icon: 'file-xls' }
            ];

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700">
                    <header className="h-12 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md">
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="lightning" className="text-yellow-400" weight="fill"/> ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO</div>
                        <div className="flex items-center gap-2">
                            <div className="flex bg-indigo-800 rounded p-1 gap-1">
                                {tabs.map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-900 shadow' : 'text-indigo-300 hover:text-white'}`}><Icon name={tab.icon} weight="bold"/> {tab.label}</button>
                                ))}
                            </div>
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden bg-gray-100 p-2">
                        {activeTab === 'live' && (<LiveTab orders={orders} setOrders={setOrders} productHistory={productHistory} setProductHistory={setProductHistory} quickShipping={quickShipping} setQuickShipping={setQuickShipping} shippingOverrides={shippingOverrides} setShippingOverrides={setShippingOverrides} bankAccount={bankAccount} setBankAccount={setBankAccount} googleScriptUrl={GOOGLE_API_URL} addresses={addresses} cardPayments={cardPayments} setCardPayments={setCardPayments} />)}
                        {activeTab === 'customer' && (<CustomerTab addresses={addresses} setAddresses={setAddresses} />)}
                        {activeTab === 'manage' && (<OrderManagementTab orders={orders} shippingOverrides={shippingOverrides} quickShipping={quickShipping} addresses={addresses} />)}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
