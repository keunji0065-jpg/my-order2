<html lang="ko" class="antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강은지 주문서 PRO (Lite) - v3.97 (스마트 업로드 & 다운로드 수정)</title>
    
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparser.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'],
                        mono: ['Pretendard', 'monospace'],
                    },
                    colors: {
                        brand: { 50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1', 500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43' },
                        accent: { rose: '#d64545', teal: '#3ebd93', amber: '#f0b429', indigo: '#5c7cfa' },
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        dark: { bg: '#121212', card: '#1e1e1e', border: '#2c2c2c', input: '#252525' }
                    },
                    boxShadow: { 'soft': '0 1px 3px 0 rgba(0, 0, 0, 0.05)', 'inner-soft': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.03)' },
                    fontSize: { 'xxs': '0.65rem' },
                    animation: { spin: 'spin 1s linear infinite' },
                    screens: {
                        'print': {'raw': 'print'},
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
        body { font-family: 'NanumSquareNeo', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f5f7fa; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        *:focus { outline: none !important; }
        
        .grid-rows-compact { grid-template-columns: 60px 75px 100px 70px 1.8fr 50px 80px 30px 1fr 30px; }
        .dragging { opacity: 0.5; border: 2px dashed #627d98; }
        
        /* --- 인쇄 전용 스타일 --- */
        @media print {
            @page { size: A4; margin: 0; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body * { visibility: hidden; }
            #print-area-wrapper, #print-area-wrapper * { visibility: visible; }
            #print-area-wrapper { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background-color: white !important; color: black !important; z-index: 9999; }
            html, body, #root, main, .flex, .h-screen, .overflow-hidden { overflow: visible !important; height: auto !important; width: auto !important; position: static !important; display: block !important; }
            ::-webkit-scrollbar { display: none; }

            .print-flex-between { display: flex !important; justify-content: space-between !important; align-items: center !important; width: 100% !important; }
            .print-text-right { text-align: right !important; }
            .print-text-center { text-align: center !important; }
            .print-text-left { text-align: left !important; }

            .receipt-card { border: none !important; color: black !important; background: transparent !important; box-shadow: none !important; border-radius: 0 !important; width: 100%; font-family: 'Pretendard', sans-serif !important; height: 100%; display: flex; flex-direction: column; }
            .receipt-header-box { background-color: #f3f4f6 !important; border-bottom: 2px solid #000 !important; padding: 10px 15px !important; margin-bottom: 5px !important; }
            .receipt-table-header { background-color: #e5e7eb !important; border-top: 1px solid #000 !important; border-bottom: 1px solid #000 !important; font-weight: 800 !important; }
            .receipt-table-row { border-bottom: 1px solid #e5e7eb !important; }
            .receipt-total-box { background-color: #f3f4f6 !important; border: 1px solid #d1d5db !important; border-radius: 8px !important; padding: 12px 15px !important; margin-top: auto !important; }

            .print-page-single { width: 100%; padding: 10mm; box-sizing: border-box; page-break-after: always; page-break-inside: avoid; min-height: 290mm; }
            .print-page-double { width: 100%; height: 297mm; display: flex; flex-direction: column; box-sizing: border-box; page-break-after: always; }
            .print-half-page { flex: 1; padding: 10mm; box-sizing: border-box; display: flex; flex-direction: column; justify-content: flex-start; border-bottom: 1px dashed black; overflow: hidden; height: 50%; }
            .print-half-page:last-child { border-bottom: none; }
            .text-slate-500, .text-slate-400, .text-brand-600, .text-brand-700 { color: black !important; }
            .no-print { display: none !important; }
        }
        .tab-content { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .dark .modal-content { background: #1e1e1e; border: 1px solid #333; color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        const parseNum = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            const firstLine = String(val).split('\n')[0].replace(/,/g, '');
            const num = parseFloat(firstLine);
            return isNaN(num) ? 0 : num;
        };
        
        const formatDateShort = (timestamp) => {
            if (!timestamp) return '';
            const d = new Date(timestamp);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const hh = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${mm}-${dd} ${hh}:${min}`;
        };

        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            const rawPrice = parseNum(order.price !== undefined ? order.price : 0);
            const rawQty = parseNum(order.quantity !== undefined ? order.quantity : 1);
            
            const isAddressFilled = !!order.recipientName && !!order.phone && !!order.addressText;

            return {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: rawQty,
                price: rawPrice,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                addressDetail: order.addressDetail || '',
                shippingMemo: order.shippingMemo || '',
                isCRM: !!order.isCRM,
                isAddressFilled: isAddressFilled
            };
        };

        const Icon = React.memo(({ name, size = 14, className = "", weight = "regular" }) => {
            const weightClass = weight === "regular" ? "" : `ph-${weight}`;
            return <i className={`ph ph-${name} ${weightClass} ${className}`} style={{ fontSize: size }}></i>;
        });

        const ActionButton = React.memo(({ onClick, color, icon, text, loading }) => {
            const base = "px-2 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-all border shadow-sm h-7";
            const colors = {
                brand: "bg-brand-600 text-white border-brand-700 hover:bg-brand-700",
                white: "bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border-slate-200 dark:border-dark-border hover:bg-slate-50 hover:text-brand-700",
                ghost: "bg-transparent text-slate-500 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800",
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${colors[color] || colors.white} ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                    {loading ? <Icon name="spinner" size={12} className="animate-spin"/> : <Icon name={icon.toLowerCase()} size={12}/>} {text}
                </button>
            );
        });

        // --- Components ---
        const SummarySection = ({ stats, handleUnpaidFilterClick, unpaidFilter }) => (
            <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm w-full grid grid-cols-4 divide-x divide-slate-100 dark:divide-slate-700 h-auto overflow-hidden">
                <div className="px-4 py-1 flex flex-col justify-center items-start text-left min-w-0">
                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-0.5">총 예상 매출</span>
                    <div className="flex items-baseline gap-1">
                        <span className="text-3xl font-extrabold text-blue-900 dark:text-blue-100 font-mono tracking-tight truncate">{stats.totalRev.toLocaleString()}</span>
                        <span className="text-sm text-slate-400 font-bold">원</span>
                    </div>
                </div>
                <div className="px-4 py-1 flex flex-col justify-center gap-0 min-w-0">
                    <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                        <div className="flex items-center gap-2 text-slate-500"><Icon name="money" size={16} className="text-amber-500"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">현금</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalCash.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                        <div className="flex items-center gap-2 text-slate-500"><Icon name="credit-card" size={16} className="text-purple-500"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">카드</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalCard.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                        <div className="flex items-center gap-2 text-slate-500"><Icon name="truck" size={16} className="text-sky-500"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">배송</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalShipping.toLocaleString()}</span>
                    </div>
                </div>
                <div className="px-4 py-1 flex flex-col justify-center gap-1 min-w-0">
                    <div className="flex justify-between items-center text-slate-700 dark:text-slate-300 px-1 py-0.5">
                        <div className="flex items-center gap-2 text-slate-500"><Icon name="package" size={18} className="text-indigo-500"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">주문</span></div><span className="font-bold font-mono text-xl leading-none">{stats.qty}<span className="text-xs font-normal text-slate-400 ml-0.5">개</span></span>
                    </div>
                    <div className="flex justify-between items-center text-slate-700 dark:text-slate-300 px-1 py-0.5">
                        <div className="flex items-center gap-2 text-slate-500"><Icon name="paper-plane-tilt" size={18} className="text-teal-500"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">배송</span></div><span className="font-bold font-mono text-xl leading-none">{stats.shippingCount}<span className="text-xs font-normal text-slate-400 ml-0.5">건</span></span>
                    </div>
                </div>
                <div className="px-4 py-1 flex flex-col justify-center gap-1 min-w-0">
                    <div className={`flex justify-between items-center text-sm px-2 py-0.5 rounded cursor-pointer transition-all ${unpaidFilter === 'cash' ? 'bg-rose-500 text-white font-bold shadow-md transform scale-[1.02]' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`} onClick={() => handleUnpaidFilterClick('cash')}>
                        <div className="flex items-center gap-2"><Icon name="hand-coins" size={18} className={unpaidFilter === 'cash' ? 'text-white' : 'text-rose-500'}/><span className={`${unpaidFilter === 'cash' ? 'text-white' : 'text-slate-600 dark:text-slate-400'} font-bold text-sm`}>물품미수금</span></div><span className={`font-mono text-lg leading-none ${unpaidFilter !== 'cash' && stats.productUnpaid > 0 ? 'text-rose-600 font-bold' : ''}`}>{stats.productUnpaid.toLocaleString()}</span>
                    </div>
                    <div className={`flex justify-between items-center text-sm px-2 py-0.5 rounded cursor-pointer transition-all ${unpaidFilter === 'ship' ? 'bg-orange-500 text-white font-bold shadow-md transform scale-[1.02]' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`} onClick={() => handleUnpaidFilterClick('ship')}>
                        <div className="flex items-center gap-2"><Icon name="truck" size={18} className={unpaidFilter === 'ship' ? 'text-white' : 'text-orange-500'}/><span className={`${unpaidFilter === 'ship' ? 'text-white' : 'text-slate-600 dark:text-slate-400'} font-bold text-sm`}>배송미수금</span></div><span className={`font-mono text-lg leading-none ${unpaidFilter !== 'ship' && stats.shipUnpaid > 0 ? 'text-orange-600 font-bold' : ''}`}>{stats.shipUnpaid.toLocaleString()}</span>
                    </div>
                </div>
            </div>
        );

        const TabNavigation = ({ activeTab, onTabChange }) => (
            <div className="flex items-end px-2 pt-1 border-b border-slate-200 dark:border-dark-border bg-white dark:bg-dark-card shrink-0 gap-1 overflow-x-auto no-scrollbar">
                {[
                    { id: 'order', label: '주문관리', icon: 'clipboard-text' },
                    { id: 'customer', label: '고객관리', icon: 'user' },
                    { id: 'receipt', label: '구매내역서', icon: 'receipt' },
                ].map(tab => (
                    <button key={tab.id} onClick={() => onTabChange(tab.id)} className={`flex items-center gap-1.5 px-3 py-2 text-xs font-bold rounded-t-lg transition-all border-t border-x relative top-[1px] ${activeTab === tab.id ? 'bg-[#f5f7fa] dark:bg-dark-bg border-slate-200 dark:border-dark-border border-b-[#f5f7fa] dark:border-b-dark-bg text-brand-600 dark:text-brand-400 z-10' : 'bg-slate-50 dark:bg-dark-input border-transparent text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}>
                        <Icon name={tab.icon} size={14} className={activeTab === tab.id ? 'ph-fill' : ''} /><span>{tab.label}</span>
                    </button>
                ))}
            </div>
        );

        // --- AddressAdminPanel: 헤더 제거, 기능만 유지 ---
        const AddressAdminPanel = ({ selectedOrder, onSaveAddress, showToast }) => {
            const [localAddr, setLocalAddr] = useState({ recipientName: '', phone: '', zipCode: '', addressText: '', addressDetail: '', shippingMemo: '' });
            const [tab, setTab] = useState('input');
            const [rawText, setRawText] = useState('');
            
            useEffect(() => { 
                if (selectedOrder) { 
                    setLocalAddr({ 
                        recipientName: selectedOrder.recipientName || '', 
                        phone: selectedOrder.phone || '', 
                        zipCode: selectedOrder.zipCode || '', 
                        addressText: selectedOrder.addressText || '', 
                        addressDetail: selectedOrder.addressDetail || '', 
                        shippingMemo: selectedOrder.shippingMemo || '' 
                    }); 
                    setRawText(''); 
                } else { 
                    setLocalAddr({ recipientName: '', phone: '', zipCode: '', addressText: '', addressDetail: '', shippingMemo: '' }); 
                } 
            }, [selectedOrder]);

            const handleChange = (field, val) => setLocalAddr(prev => ({...prev, [field]: val}));
            
            const handleSave = () => { 
                if (!selectedOrder) return; 
                onSaveAddress(selectedOrder.id, localAddr); 
            };
            
            const handlePostcode = () => { try { new daum.Postcode({ oncomplete: function(data) { setLocalAddr(prev => ({ ...prev, zipCode: data.zonecode, addressText: data.address, addressDetail: '' })); } }).open(); } catch(e) { showToast("팝업이 차단되었습니다.", "error"); } };
            
            const handleParseRaw = () => { 
                if (!rawText.trim()) return; 
                let text = rawText; 
                let name = '', phone = '', address = '', memo = ''; 
                
                const phoneMatch = text.match(/(01[016789])\D*(\d{3,4})\D*(\d{4})/); 
                
                if (phoneMatch) { 
                    phone = `${phoneMatch[1]}-${phoneMatch[2]}-${phoneMatch[3]}`; 
                    text = text.replace(phoneMatch[0], ''); 
                } 
                
                const zipMatch = text.match(/\d{5}/); 
                if(zipMatch) text = text.replace(zipMatch[0], ''); 
                
                const lines = text.split('\n').map(l => l.trim()).filter(Boolean); 
                lines.forEach(line => { 
                    if (line.match(/^(이름|수령인|받는분):?/)) name = line.replace(/^(이름|수령인|받는분):?/, '').trim();
                    else if (line.match(/^(주소|배송지):?/)) address = line.replace(/^(주소|배송지):?/, '').trim();
                    else if (line.match(/^(메모|요청사항):?/)) memo = line.replace(/^(메모|요청사항):?/, '').trim(); 
                }); 
                
                if (!name && lines.length > 0) name = lines[0]; 
                if (!address && lines.length > 1) address = lines.find(l => l !== name && l.match(/[시도구군길로]/)) || lines[1]; 
                
                setLocalAddr(prev => ({ 
                    ...prev, 
                    recipientName: name || prev.recipientName, 
                    phone: phone || prev.phone, 
                    addressText: address || prev.addressText, 
                    shippingMemo: memo || prev.shippingMemo 
                })); 
                setTab('edit'); 
                showToast("정보가 입력되었습니다."); 
            };
            
            if (!selectedOrder) { return (<div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col h-full shadow-soft items-center justify-center text-slate-400 text-xs"><Icon name="map-pin" size={24} className="mb-2 opacity-50"/><p>주문을 선택해주세요</p></div>); }
            
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col h-full shadow-soft overflow-hidden">
                    <div className="flex border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 shrink-0 p-1 gap-1">
                        <button onClick={()=>setTab('input')} className={`flex-1 py-1.5 text-xs font-bold rounded transition-all ${tab==='input' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>붙여넣기</button>
                        <button onClick={()=>setTab('edit')} className={`flex-1 py-1.5 text-xs font-bold rounded transition-all ${tab==='edit' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 shadow-sm' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>상세수정</button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2">
                        {tab === 'input' ? (
                            <div className="h-full flex flex-col gap-2">
                                <textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs resize-none outline-none focus:border-brand-500 placeholder-slate-400" placeholder={`예시:\n홍길동\n010-1234-5678\n서울시 강남구...`} value={rawText} onChange={e => setRawText(e.target.value)}></textarea>
                                <button onClick={handleParseRaw} className="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white rounded text-xs font-bold transition-colors">자동 입력</button>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">수령인</label>
                                    <input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.recipientName} onChange={e=>handleChange('recipientName', e.target.value)} />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">연락처</label>
                                    <input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.phone} onChange={e=>handleChange('phone', e.target.value)} />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">우편번호</label>
                                    <div className="flex-1 flex gap-1">
                                        <input className="w-20 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 text-center" value={localAddr.zipCode} readOnly placeholder="00000" />
                                        <button onClick={handlePostcode} className="bg-brand-600 hover:bg-brand-700 text-white px-2 py-1 rounded text-xs font-bold flex-1 flex items-center justify-center gap-1"><Icon name="magnifying-glass" /> 주소검색</button>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">주소</label>
                                    <input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.addressText} onChange={e=>handleChange('addressText', e.target.value)} />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">상세</label>
                                    <input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" placeholder="상세주소 (동/호수)" value={localAddr.addressDetail} onChange={e=>handleChange('addressDetail', e.target.value)} />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className="w-12 text-xs text-slate-500 text-right">배송메모</label>
                                    <input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.shippingMemo} onChange={e=>handleChange('shippingMemo', e.target.value)} />
                                </div>
                                <div className="pt-2 text-right">
                                    <button onClick={handleSave} className="bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors shadow-sm">저장</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const CustomerTab = ({ customerDB, setCustomerDB, orders, showToast, setOrders }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [search, setSearch] = useState('');
            const [isRenaming, setIsRenaming] = useState(false);
            const [tempName, setTempName] = useState('');
            const fileInputRef = useRef(null);

            const allCustomers = useMemo(() => { const orderCustomers = new Set(orders.map(o => o.customer)); const dbCustomers = Object.keys(customerDB); const merged = new Set([...orderCustomers, ...dbCustomers]); return Array.from(merged).filter(c => c && c.toLowerCase().includes(search.toLowerCase())).sort(); }, [orders, customerDB, search]);
            const customerOrders = useMemo(() => { if (!selectedCustomer) return []; return orders.filter(o => o.customer === selectedCustomer).sort((a,b) => b.id - a.id); }, [orders, selectedCustomer]);
            
            const handleUpdateCustomer = (field, value) => { 
                if (!selectedCustomer) return; 
                setCustomerDB(prev => ({ ...prev, [selectedCustomer]: { ...prev[selectedCustomer], [field]: value } })); 
            };

            // 닉네임 변경 시작
            const startRenaming = () => {
                setTempName(selectedCustomer);
                setIsRenaming(true);
            };

            // 닉네임 변경 저장 및 주문 목록 일괄 업데이트
            const saveRename = () => {
                const newName = tempName.trim();
                if (!newName) {
                    showToast("닉네임을 입력해주세요.", "error");
                    return;
                }
                if (newName === selectedCustomer) {
                    setIsRenaming(false);
                    return;
                }
                if (customerDB[newName]) {
                    showToast("이미 존재하는 닉네임입니다.", "error");
                    return;
                }

                // 1. 고객 DB 키 변경
                const newDB = { ...customerDB };
                newDB[newName] = newDB[selectedCustomer]; // 기존 정보 복사
                delete newDB[selectedCustomer]; // 기존 키 삭제
                setCustomerDB(newDB);

                // 2. 주문 내역 일괄 업데이트 (중요!)
                setOrders(prev => prev.map(o => o.customer === selectedCustomer ? { ...o, customer: newName } : o));

                // 3. 상태 업데이트
                setSelectedCustomer(newName);
                setIsRenaming(false);
                showToast(`닉네임이 '${selectedCustomer}' → '${newName}'으로 변경되었습니다.`);
            };
            
            // [수정됨] 스마트 업로드 기능 구현
            const handleFileUpload = (e) => { 
                const file = e.target.files[0]; 
                if (!file) return; 
                
                Papa.parse(file, { 
                    header: true, 
                    skipEmptyLines: true, 
                    complete: (results) => { 
                        const newDB = { ...customerDB }; 
                        let count = 0; 
                        
                        // 헤더 매핑 도우미 함수
                        const findColumn = (keywords) => {
                            const headers = results.meta.fields || [];
                            return headers.find(h => keywords.some(k => h.includes(k)));
                        };

                        const nameField = findColumn(['닉네임', '이름', '성함', '참여자']);
                        const recipientField = findColumn(['성함', '수령인', '받는분', '이름']);
                        const phoneField = findColumn(['핸드폰', '연락처', '전화']);
                        const addrField = findColumn(['주소', '배송지']);
                        const memoField = findColumn(['배송요청', '메모', '요청']);

                        if (!nameField) {
                            showToast("닉네임(또는 이름/성함) 열을 찾을 수 없습니다.", "error");
                            return;
                        }

                        results.data.forEach(row => { 
                            const nick = row[nameField]?.trim();
                            if (nick) { 
                                // 전화번호 정제 (하이픈 추가)
                                let phone = row[phoneField] || '';
                                const phoneMatch = phone.match(/(01[016789])\D*(\d{3,4})\D*(\d{4})/);
                                if (phoneMatch) phone = `${phoneMatch[1]}-${phoneMatch[2]}-${phoneMatch[3]}`;

                                // 주소/우편번호 분리 ( (12345) 서울... 형식 )
                                let fullAddr = row[addrField] || '';
                                let zipCode = '';
                                let addressText = fullAddr;
                                
                                const zipMatch = fullAddr.match(/^\(?(\d{5})\)?\s*(.*)$/);
                                if (zipMatch) {
                                    zipCode = zipMatch[1];
                                    addressText = zipMatch[2];
                                }

                                newDB[nick] = { 
                                    recipientName: row[recipientField] || nick, // 수령인 없으면 닉네임 사용
                                    phone: phone, 
                                    zipCode: zipCode, 
                                    addressText: addressText, 
                                    addressDetail: '', // 상세주소는 보통 주소 컬럼에 같이 들어있으므로 일단 비움 (필요시 분리 로직 추가 가능)
                                    shippingMemo: row[memoField] || '' 
                                }; 
                                count++; 
                            } 
                        }); 
                        setCustomerDB(newDB); 
                        showToast(`총 ${count}명 고객 정보가 업데이트되었습니다.`, 'success'); 
                    } 
                }); 
                e.target.value = null; 
            };

            // [수정됨] 다운로드 기능 (BOM 추가 및 안전한 CSV 생성)
            const handleFileDownload = () => { 
                try {
                    const rows = Object.entries(customerDB).map(([nick, info]) => ({ 
                        '닉네임': nick, 
                        '수령인': info.recipientName || '', 
                        '연락처': info.phone || '', 
                        '우편번호': info.zipCode || '', 
                        '주소': info.addressText || '', 
                        '상세주소': info.addressDetail || '', 
                        '배송메모': info.shippingMemo || ''
                    })); 
                    
                    if (rows.length === 0) {
                        showToast("저장된 고객 정보가 없습니다.", "error");
                        return;
                    }

                    const csv = Papa.unparse(rows); 
                    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); 
                    const url = URL.createObjectURL(blob); 
                    const link = document.createElement('a'); 
                    link.href = url; 
                    link.setAttribute('download', `고객목록_${new Date().toISOString().slice(0, 10)}.csv`); 
                    document.body.appendChild(link); 
                    link.click(); 
                    document.body.removeChild(link); 
                } catch (e) {
                    console.error(e);
                    showToast("다운로드 중 오류가 발생했습니다.", "error");
                }
            };
            
            const currentInfo = customerDB[selectedCustomer] || {};
            
            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="address-book" size={14}/> 고객 목록</h3><div className="flex gap-1"><button onClick={() => fileInputRef.current.click()} className="text-[10px] bg-brand-600 text-white px-2 py-1 rounded hover:bg-brand-700 flex items-center gap-1" title="[스마트 업로드] 엑셀/CSV 파일의 헤더를 자동으로 인식합니다. (닉네임, 성함, 연락처, 주소 등)"><Icon name="file-csv"/> 업로드</button><button onClick={handleFileDownload} className="text-[10px] bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 flex items-center gap-1"><Icon name="download-simple"/> 다운</button></div><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv,.xlsx,.xls" style={{display:'none'}} /></div>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="고객명 검색..." value={search} onChange={e => setSearch(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="magnifying-glass" size={12}/></div></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">{allCustomers.map(c => (<button key={c} onClick={() => { setSelectedCustomer(c); setIsRenaming(false); }} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold dark:bg-brand-900/30 dark:text-brand-400' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span className="truncate">{c}</span>{customerDB[c] && <Icon name="check-circle" size={10} className="text-emerald-500"/>}</button>))}</div>
                    </div>
                    <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                        {selectedCustomer ? (
                            <>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-4">
                                    <div className="flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2 mb-4">
                                        <div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center shrink-0"><Icon name="user"/></div>
                                        {isRenaming ? (
                                            <div className="flex-1 flex gap-2 items-center">
                                                <input className="flex-1 p-1 border rounded text-sm font-bold bg-white focus:border-brand-500 outline-none" value={tempName} onChange={e=>setTempName(e.target.value)} autoFocus />
                                                <button onClick={saveRename} className="bg-brand-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-brand-700">저장</button>
                                                <button onClick={()=>setIsRenaming(false)} className="bg-slate-200 text-slate-700 px-3 py-1 rounded text-xs font-bold hover:bg-slate-300">취소</button>
                                            </div>
                                        ) : (
                                            <h3 className="text-sm font-bold flex-1 flex items-center gap-2">
                                                {selectedCustomer} 님의 정보
                                                <button onClick={startRenaming} className="text-slate-400 hover:text-brand-600 p-1" title="닉네임 변경"><Icon name="pencil-simple" size={14}/></button>
                                            </h3>
                                        )}
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs text-slate-500 block mb-1">수령인</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.recipientName || ''} onChange={e => handleUpdateCustomer('recipientName', e.target.value)} /></div>
                                        <div><label className="text-xs text-slate-500 block mb-1">연락처</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.phone || ''} onChange={e => handleUpdateCustomer('phone', e.target.value)} /></div>
                                        
                                        {/* [수정됨] 우편번호 필드 추가 및 주소검색과 연동 */}
                                        <div className="col-span-2">
                                            <label className="text-xs text-slate-500 block mb-1">우편번호</label>
                                            <div className="flex gap-2 mb-1">
                                                <input className="w-32 p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700 text-center bg-slate-50" value={currentInfo.zipCode || ''} readOnly placeholder="00000" />
                                                <button onClick={() => { try { new daum.Postcode({ oncomplete: (data) => { handleUpdateCustomer('zipCode', data.zonecode); handleUpdateCustomer('addressText', data.address); } }).open(); } catch(e) { showToast("주소 검색 팝업 차단됨", "error"); } }} className="bg-brand-600 text-white px-3 py-1.5 rounded text-xs hover:bg-brand-700 font-bold flex items-center gap-1"><Icon name="magnifying-glass"/> 주소 검색</button>
                                            </div>
                                        </div>

                                        <div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">주소</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700 mb-1" value={currentInfo.addressText || ''} onChange={e => handleUpdateCustomer('addressText', e.target.value)} /><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={currentInfo.addressDetail || ''} onChange={e => handleUpdateCustomer('addressDetail', e.target.value)} /></div>
                                        <div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">배송메모</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.shippingMemo || ''} onChange={e => handleUpdateCustomer('shippingMemo', e.target.value)} /></div>
                                    </div>
                                </div>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex-1 flex flex-col overflow-hidden"><div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="clock"/> 주문 이력</h3></div><div className="flex-1 overflow-y-auto"><table className="w-full text-xs text-left"><thead className="bg-slate-50 dark:bg-dark-input text-slate-500 border-b dark:border-slate-700 sticky top-0"><tr><th className="p-2">날짜</th><th className="p-2">상품명</th><th className="p-2">수량</th><th className="p-2 text-right">금액</th><th className="p-2 text-center">상태</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-800">{customerOrders.map(o => (<tr key={o.id}><td className="p-2 text-slate-400">{new Date(o.id).toLocaleDateString()}</td><td className="p-2 font-bold">{o.product}</td><td className="p-2">{o.quantity}</td><td className="p-2 text-right font-mono">{o.price.toLocaleString()}</td><td className="p-2 text-center"><span className={`px-2 py-0.5 rounded-full ${o.isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{o.isPaid ? '결제완료' : '미결제'}</span></td></tr>))}{customerOrders.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">주문 내역이 없습니다.</td></tr>}</tbody></table></div></div>
                            </>
                        ) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-400"><Icon name="user" size={48} className="mb-2 opacity-20"/><p>왼쪽 목록에서 고객을 선택하세요.</p></div>)}
                    </div>
                </div>
            );
        };
        
        try { ReactDOM.createRoot(document.getElementById('root')).render(<App />); } catch (e) { document.body.innerHTML = `<div style="color:red;padding:20px">${e.message}</div>`; }
    </script>
</body>
</html>
