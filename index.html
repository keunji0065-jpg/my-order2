<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강은지 주문서 PRO (통합 관리 시스템)</title>
    
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparser.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'],
                        mono: ['Pretendard', 'monospace'],
                    },
                    colors: {
                        brand: { 50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1', 500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43' },
                        accent: { rose: '#d64545', teal: '#3ebd93', amber: '#f0b429', indigo: '#5c7cfa' },
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        dark: { bg: '#121212', card: '#1e1e1e', border: '#2c2c2c', input: '#252525' }
                    },
                    boxShadow: { 'soft': '0 1px 3px 0 rgba(0, 0, 0, 0.05)', 'inner-soft': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.03)' },
                    fontSize: { 'xxs': '0.65rem' },
                    animation: { spin: 'spin 1s linear infinite' }
                }
            }
        }
    </script>
    
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
        body { font-family: 'NanumSquareNeo', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f5f7fa; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        *:focus { outline: none !important; }
        .grid-rows-compact { grid-template-columns: 1.4fr 1fr 0.8fr 2.5fr 0.5fr 1fr 40px 1.5fr 30px; }
        .dragging { opacity: 0.5; border: 2px dashed #627d98; }
        @media print {
            @page { margin: 0; size: auto; }
            body { background-color: white; color: black; }
            body * { visibility: hidden; height: 0; overflow: hidden; }
            .print-area, .print-area * { visibility: visible; height: auto; overflow: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .receipt-container { box-shadow: none !important; border: 1px solid #ccc !important; margin: 0 auto; width: 100%; max-width: 100%; page-break-inside: avoid; }
            .page-break { page-break-after: always; }
        }
        .tab-content { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
        [contenteditable="true"]:focus { outline: 2px dashed #627d98; background-color: rgba(98, 125, 152, 0.05); border-radius: 4px; padding: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: Number(order.quantity) || 1,
                price: Number(order.price) || 0,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                addressDetail: order.addressDetail || '',
                shippingMemo: order.shippingMemo || '',
                isCRM: !!order.isCRM,
            };
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 14, className = "", weight = "regular", spin = false }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls", Sun: "ph-sun", Lightning: "ph-lightning",
                Star: "ph-star", Users: "ph-users", AddressBook: "ph-address-book", CloudArrowUp: "ph-cloud-arrow-up", CloudArrowDown: "ph-cloud-arrow-down",
                Gear: "ph-gear", Spinner: "ph-spinner", Printer: "ph-printer", Receipt: "ph-receipt", House: "ph-house",
                Tag: "ph-tag", ChatCircle: "ph-chat-circle", ChartPie: "ph-chart-pie", Warehouse: "ph-warehouse",
                Folder: "ph-folder", FolderOpen: "ph-folder-open", CaretUp: "ph-caret-up", Headset: "ph-headset",
                ArrowCounterClockwise: "ph-arrow-counter-clockwise", ArrowsLeftRight: "ph-arrows-left-right", Calendar: "ph-calendar",
                DotsSixVertical: "ph-dots-six-vertical", ChatText: "ph-chat-text", Link: "ph-link", Robot: "ph-robot", UserFocus: "ph-user-focus",
                FileCsv: "ph-file-csv", CaretRight: "ph-caret-right", DownloadSimple: "ph-download-simple", CaretLeft: "ph-caret-left",
                Trophy: "ph-trophy"
            };
            const weightClass = weight === 'bold' ? 'ph-bold' : (weight === 'fill' ? 'ph-fill' : 'ph');
            const spinClass = spin ? 'animate-spin' : '';
            return <i className={`${weightClass} ${map[name] || 'ph-question'} ${className} ${spinClass}`} style={{ fontSize: size }}></i>;
        });

        const ActionButton = React.memo(({ onClick, color, icon, text, active, className, loading }) => {
            const base = "px-2 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-all border shadow-sm h-7";
            const colors = {
                brand: "bg-brand-600 text-white border-brand-700 hover:bg-brand-700",
                white: "bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border-slate-200 dark:border-dark-border hover:bg-slate-50 hover:text-brand-700",
                dark: "bg-brand-800 text-white border-brand-900 hover:bg-brand-900",
                ghost: "bg-transparent text-slate-500 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800",
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${colors[color] || colors.white} ${active ? 'ring-1 ring-brand-500' : ''} ${className} ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                    {loading ? <Icon name="Spinner" size={12} spin={true}/> : <Icon name={icon} size={12} weight="bold"/>} {text}
                </button>
            );
        });

        const ProductAutocomplete = ({ value, onChange, onSelect }) => {
            return (
                <input 
                    className="w-full bg-transparent font-bold outline-none" 
                    value={value} 
                    onChange={onChange} 
                />
            );
        };

        // --- COMPONENT: Summary Section ---
        const SummarySection = React.memo(({ stats, handleUnpaidFilterClick, unpaidFilter }) => {
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-3 w-full flex flex-wrap md:flex-nowrap items-center justify-between gap-4 divide-y md:divide-y-0 md:divide-x divide-slate-100 dark:divide-slate-700">
                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[140px]">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="TrendUp" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">총 예상 매출</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-extrabold text-blue-900 dark:text-blue-100 font-mono">{stats.totalRev.toLocaleString()}</span>
                                <span className="text-xs text-slate-400">원</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[120px]">
                        <div className="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Package" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">총 주문량</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-lg font-bold text-slate-700 dark:text-slate-200 font-mono">{stats.qty}</span>
                                <span className="text-xs text-slate-400">개</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[120px]">
                        <div className="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Truck" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">배송 건수</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-lg font-bold text-slate-700 dark:text-slate-200 font-mono">{stats.shippingCount}</span>
                                <span className="text-xs text-slate-400">건 (명)</span>
                            </div>
                        </div>
                    </div>

                    <div 
                        className={`flex-1 px-2 flex items-center gap-3 min-w-[140px] cursor-pointer transition-colors rounded-lg p-1 ${unpaidFilter === 'cash' ? 'bg-red-50 dark:bg-red-900/20 ring-1 ring-rose-200' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        onClick={() => handleUnpaidFilterClick('cash')}
                    >
                        <div className="w-10 h-10 bg-rose-100 text-rose-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Wallet" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">물품 미수금</span>
                            <span className={`text-lg font-bold font-mono ${stats.productUnpaid > 0 ? 'text-rose-600' : 'text-slate-700 dark:text-slate-200'}`}>{stats.productUnpaid.toLocaleString()}</span>
                        </div>
                    </div>

                    <div 
                        className={`flex-1 px-2 flex items-center gap-3 min-w-[140px] cursor-pointer transition-colors rounded-lg p-1 ${unpaidFilter === 'ship' ? 'bg-amber-50 dark:bg-amber-900/20 ring-1 ring-amber-200' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        onClick={() => handleUnpaidFilterClick('ship')}
                    >
                        <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Truck" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">배송 미수금</span>
                            <span className={`text-lg font-bold font-mono ${stats.shipUnpaid > 0 ? 'text-amber-600' : 'text-slate-700 dark:text-slate-200'}`}>{stats.shipUnpaid.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Tab Navigation ---
        const TabNavigation = ({ activeTab, onTabChange }) => {
            const tabs = [
                { id: 'home', label: '일정관리', icon: 'Calendar' },
                { id: 'product', label: '상품관리', icon: 'Tag' },
                { id: 'order', label: '주문관리', icon: 'ClipboardList' },
                { id: 'customer', label: '고객관리', icon: 'User' },
                { id: 'statement', label: '구매내역서', icon: 'Receipt' },
                { id: 'inquiry', label: '문의관리', icon: 'Headset' },
                { id: 'stats', label: '통계조회', icon: 'ChartBar' },
            ];

            return (
                <div className="flex items-end px-2 pt-1 border-b border-slate-200 dark:border-dark-border bg-white dark:bg-dark-card shrink-0 gap-1 overflow-x-auto no-scrollbar">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => onTabChange(tab.id)}
                            className={`flex items-center gap-1.5 px-3 py-2 text-xs font-bold rounded-t-lg transition-all border-t border-x relative top-[1px]
                                ${activeTab === tab.id 
                                    ? 'bg-[#f5f7fa] dark:bg-dark-bg border-slate-200 dark:border-dark-border border-b-[#f5f7fa] dark:border-b-dark-bg text-brand-600 dark:text-brand-400 z-10' 
                                    : 'bg-slate-50 dark:bg-dark-input border-transparent text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'
                                }`}
                        >
                            <Icon name={tab.icon} size={14} weight={activeTab === tab.id ? 'fill' : 'regular'} />
                            <span>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        // --- COMPONENT: Home Tab (Schedule) ---
        const HomeTab = ({ schedules, setSchedules, showToast }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [inputTitle, setInputTitle] = useState('');
            const [inputContent, setInputContent] = useState('');
            const [editingId, setEditingId] = useState(null);

            const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();

            const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

            const days = useMemo(() => {
                const totalDays = daysInMonth(year, month);
                const startDay = firstDayOfMonth(year, month);
                const arr = Array(startDay).fill(null);
                for (let i = 1; i <= totalDays; i++) arr.push(i);
                return arr;
            }, [year, month]);

            const getSchedulesForDate = (d) => {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                return schedules.filter(s => s.date === dateStr);
            };

            const handleSaveSchedule = () => {
                if (!inputTitle.trim()) { showToast('제목을 입력해주세요', 'error'); return; }
                const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
                
                if (editingId) {
                    setSchedules(prev => prev.map(s => s.id === editingId ? { ...s, title: inputTitle, content: inputContent } : s));
                    setEditingId(null);
                    showToast('일정이 수정되었습니다.');
                } else {
                    const newSchedule = { id: Date.now(), date: dateStr, title: inputTitle, content: inputContent };
                    setSchedules(prev => [...prev, newSchedule]);
                    showToast('일정이 등록되었습니다.');
                }
                setInputTitle(''); setInputContent('');
            };

            const handleDeleteSchedule = (id) => { if (window.confirm('일정을 삭제하시겠습니까?')) { setSchedules(prev => prev.filter(s => s.id !== id)); } };
            const handleEditClick = (s) => { setEditingId(s.id); setInputTitle(s.title); setInputContent(s.content); };

            const selectedDateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
            const schedulesForSelectedDate = schedules.filter(s => s.date === selectedDateStr);

            return (
                <div className="p-4 space-y-4 tab-content h-full flex flex-col md:flex-row gap-4">
                    <div className="flex-1 bg-white dark:bg-dark-card rounded-lg shadow-soft border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full">
                        <div className="flex justify-between items-center mb-4 shrink-0">
                            <h3 className="text-lg font-bold flex items-center gap-2 text-slate-800 dark:text-slate-100"><Icon name="Calendar" weight="fill" /> {year}년 {month + 1}월</h3>
                            <div className="flex gap-1"><button onClick={prevMonth} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded"><Icon name="CaretLeft"/></button><button onClick={()=>setCurrentDate(new Date())} className="text-xs px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded">오늘</button><button onClick={nextMonth} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded"><Icon name="CaretRight"/></button></div>
                        </div>
                        <div className="grid grid-cols-7 gap-1 text-center text-xs font-bold text-slate-500 mb-2 shrink-0"><div className="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div className="text-blue-500">토</div></div>
                        <div className="grid grid-cols-7 gap-1 flex-1 auto-rows-fr overflow-y-auto">
                            {days.map((d, i) => {
                                if (!d) return <div key={i} className="bg-transparent"></div>;
                                const daySchedules = getSchedulesForDate(d);
                                const isToday = year === today.getFullYear() && month === today.getMonth() && d === today.getDate();
                                const isSelected = year === selectedDate.getFullYear() && month === selectedDate.getMonth() && d === selectedDate.getDate();
                                return (
                                    <div key={i} onClick={() => { setSelectedDate(new Date(year, month, d)); setEditingId(null); setInputTitle(''); setInputContent(''); }} className={`border rounded p-1 flex flex-col gap-1 cursor-pointer transition-colors relative min-h-[60px] overflow-hidden ${isSelected ? 'border-brand-500 bg-brand-50 dark:bg-brand-900/20' : 'border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800'} ${isToday ? 'ring-1 ring-amber-400' : ''}`}>
                                        <span className={`text-[10px] font-bold ${isToday ? 'text-amber-600' : 'text-slate-500'}`}>{d}</span>
                                        <div className="flex flex-col gap-0.5 overflow-y-auto no-scrollbar">{daySchedules.map(s => (<span key={s.id} className="text-[9px] bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded px-1 truncate block">{s.title}</span>))}</div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                    <div className="w-full md:w-80 bg-white dark:bg-dark-card rounded-lg shadow-soft border border-slate-200 dark:border-dark-border p-4 flex flex-col h-full">
                        <h4 className="text-sm font-bold mb-3 border-b pb-2 border-slate-100 dark:border-slate-700 flex justify-between items-center"><span>{selectedDate.getDate()}일 일정</span><button onClick={() => { setEditingId(null); setInputTitle(''); setInputContent(''); }} className="text-xs text-brand-600 hover:underline">+ 새 일정</button></h4>
                        <div className="flex flex-col gap-2 mb-4 p-3 bg-slate-50 dark:bg-dark-input/30 rounded border border-slate-100 dark:border-slate-800">
                            <input className="text-sm font-bold bg-transparent border-b border-slate-200 dark:border-slate-700 pb-1 outline-none focus:border-brand-500" placeholder="일정 제목" value={inputTitle} onChange={e => setInputTitle(e.target.value)} />
                            <textarea className="text-xs bg-transparent outline-none resize-none h-20" placeholder="상세 내용" value={inputContent} onChange={e => setInputContent(e.target.value)}></textarea>
                            <button onClick={handleSaveSchedule} className="bg-brand-600 text-white text-xs font-bold py-1.5 rounded hover:bg-brand-700 transition-colors">{editingId ? '수정 완료' : '일정 추가'}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2">
                            {schedulesForSelectedDate.length > 0 ? schedulesForSelectedDate.map(s => (
                                <div key={s.id} className="group relative p-3 bg-slate-50 dark:bg-dark-input rounded border border-slate-200 dark:border-slate-700 hover:border-brand-300 transition-all">
                                    <div className="font-bold text-sm mb-1">{s.title}</div>
                                    <div className="text-xs text-slate-500 whitespace-pre-wrap">{s.content}</div>
                                    <div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onClick={() => handleEditClick(s)} className="p-1 text-slate-400 hover:text-brand-600"><Icon name="Pencil" size={12}/></button>
                                        <button onClick={() => handleDeleteSchedule(s.id)} className="p-1 text-slate-400 hover:text-rose-600"><Icon name="Trash2" size={12}/></button>
                                    </div>
                                </div>
                            )) : <div className="text-center text-slate-400 text-xs py-10">일정이 없습니다.</div>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: Product Management Tab ---
        const ProductTab = ({ productHistory, setProductHistory, productCategories, setProductCategories, productNumbers, setProductNumbers, categoryOrder, setCategoryOrder, setOrders, showToast }) => {
            const [selectedCategory, setSelectedCategory] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [draggedIdx, setDraggedIdx] = useState(null);
            const [isAddingSite, setIsAddingSite] = useState(false);
            const [newSiteName, setNewSiteName] = useState('');
            const [newSite, setNewSite] = useState('');
            const [newCode, setNewCode] = useState('');
            const [newName, setNewName] = useState('');
            const [newPrice, setNewPrice] = useState('');

            const siteRef = useRef(null);
            const codeRef = useRef(null);
            const nameRef = useRef(null);
            const priceRef = useRef(null);
            const newSiteInputRef = useRef(null);

            useEffect(() => {
                const existingCats = new Set(Object.values(productCategories).filter(Boolean));
                setCategoryOrder(prev => { const next = [...prev]; existingCats.forEach(c => { if (!next.includes(c)) next.push(c); }); return next; });
            }, [productCategories]);

            useEffect(() => { if (isAddingSite && newSiteInputRef.current) newSiteInputRef.current.focus(); }, [isAddingSite]);

            const onDragStart = (e, index) => { setDraggedIdx(index); e.dataTransfer.effectAllowed = "move"; };
            const onDragOver = (e, index) => { e.preventDefault(); };
            const onDrop = (e, index) => { e.preventDefault(); if (draggedIdx === null) return; const newOrder = [...categoryOrder]; const draggedItem = newOrder[draggedIdx]; newOrder.splice(draggedIdx, 1); newOrder.splice(index, 0, draggedItem); setCategoryOrder(newOrder); setDraggedIdx(null); };

            const categoryCounts = useMemo(() => { const counts = { all: Object.keys(productHistory).length }; Object.entries(productCategories).forEach(([prod, cat]) => { if (cat) counts[cat] = (counts[cat] || 0) + 1; }); return counts; }, [productHistory, productCategories]);
            const filteredProducts = useMemo(() => { return Object.entries(productHistory).map(([name, price]) => ({ name, price, site: productCategories[name] || '기본 창고', code: productNumbers[name] || '' })).filter(p => { const matchesCategory = selectedCategory === 'all' || p.site === selectedCategory; const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase()); return matchesCategory && matchesSearch; }); }, [productHistory, productCategories, productNumbers, selectedCategory, searchTerm]);

            const handleSave = () => {
                const cleanName = newName; const unitPrice = Number(newPrice); const site = newSite.trim() || '기본 창고'; const code = newCode.trim();
                if (cleanName && productHistory[cleanName]) { if (!window.confirm('이미 존재하는 상품입니다. 정보를 수정하시겠습니까?')) return; }
                if (cleanName) setProductHistory(prev => ({ ...prev, [cleanName]: unitPrice }));
                if (cleanName) setProductCategories(prev => ({ ...prev, [cleanName]: site }));
                if (cleanName) setProductNumbers(prev => ({ ...prev, [cleanName]: code }));
                setCategoryOrder(prev => { if (!prev.includes(site)) return [...prev, site]; return prev; });
                if (cleanName) setOrders(prev => prev.map(o => (o.product === cleanName) ? { ...o, price: o.quantity * unitPrice } : o));
                showToast("상품이 저장되었습니다."); setNewName(''); setNewPrice(''); setNewCode(''); if (codeRef.current) codeRef.current.focus();
            };

            const handleDelete = (name) => { if (window.confirm(`'${name}' 상품을 삭제하시겠습니까?`)) { setProductHistory(prev => { const n = { ...prev }; delete n[name]; return n; }); setProductCategories(prev => { const n = { ...prev }; delete n[name]; return n; }); setProductNumbers(prev => { const n = { ...prev }; delete n[name]; return n; }); showToast("삭제되었습니다."); } };
            const handleInlineUpdate = (oldName, field, value) => { if (field === 'price') { const price = Number(value); setProductHistory(prev => ({ ...prev, [oldName]: price })); setOrders(prev => prev.map(o => o.product === oldName ? { ...o, price: o.quantity * price } : o)); } else if (field === 'site') { setProductCategories(prev => ({ ...prev, [oldName]: value })); setCategoryOrder(prev => !prev.includes(value) ? [...prev, value] : prev); } else if (field === 'code') { setProductNumbers(prev => ({ ...prev, [oldName]: value })); } else if (field === 'name') { const newName = value; if (newName === oldName) return; if (newName && productHistory[newName]) { showToast("이미 존재하는 상품명입니다.", "error"); return; } const price = productHistory[oldName]; const site = productCategories[oldName]; const code = productNumbers[oldName]; setProductHistory(prev => { const n = { ...prev }; delete n[oldName]; n[newName] = price; return n; }); setProductCategories(prev => { const n = { ...prev }; delete n[oldName]; n[newName] = site; return n; }); setProductNumbers(prev => { const n = { ...prev }; delete n[oldName]; n[newName] = code; return n; }); setOrders(prev => prev.map(o => o.product === oldName ? { ...o, product: newName } : o)); showToast("상품명 변경 완료"); } };
            const onInputKeyDown = (e, nextField) => { if (e.key === 'Enter') { e.preventDefault(); if (nextField === 'submit') { handleSave(); } else if (nextField === 'name') { nameRef.current.focus(); } else if (nextField === 'price') { priceRef.current.focus(); } } };
            const handleFolderClick = (cat) => { setSelectedCategory(cat); if (cat !== 'all') { setNewSite(cat); } else { setNewSite(''); } };
            const handleAddCategory = () => { if (newSiteName.trim()) { setCategoryOrder(prev => !prev.includes(newSiteName.trim()) ? [...prev, newSiteName.trim()] : prev); setNewSiteName(''); setIsAddingSite(false); } else { setIsAddingSite(false); } };

            return (
                <div className="flex h-full tab-content bg-slate-50 dark:bg-dark-bg p-2 gap-2">
                    <div className="w-48 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex justify-between items-center"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="Warehouse" size={12}/> 사이트 목록</h3><button onClick={() => setIsAddingSite(true)} className="text-xs bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 rounded px-1.5 py-0.5"><Icon name="Plus"/></button></div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            <button onClick={() => handleFolderClick('all')} className={`w-full flex items-center justify-between px-3 py-2 text-xs rounded-md transition-all ${selectedCategory === 'all' ? 'bg-brand-50 text-brand-700 font-bold dark:bg-brand-900/30 dark:text-brand-400' : 'text-slate-600 hover:bg-slate-50 dark:text-slate-400 dark:hover:bg-slate-800'}`}><div className="flex items-center gap-2"><Icon name={selectedCategory === 'all' ? "FolderOpen" : "Folder"} weight="fill"/> 전체 사이트</div><span className="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-1.5 rounded-full text-[9px] min-w-[1.2rem] text-center">{categoryCounts.all || 0}</span></button>
                            {categoryOrder.map((cat, idx) => (<div key={cat} draggable onDragStart={(e) => onDragStart(e, idx)} onDragOver={(e) => onDragOver(e, idx)} onDrop={(e) => onDrop(e, idx)} className={`group flex items-center justify-between px-2 py-1 rounded-md transition-all cursor-move ${selectedCategory === cat ? 'bg-brand-50 dark:bg-brand-900/30' : 'hover:bg-slate-50 dark:hover:bg-slate-800'} ${draggedIdx === idx ? 'opacity-50 border border-brand-300 border-dashed' : ''}`}><div className="flex items-center gap-2 flex-1 overflow-hidden" onClick={() => handleFolderClick(cat)}><Icon name="DotsSixVertical" size={12} className="text-slate-300 cursor-grab"/><span className={`text-xs truncate flex-1 text-left ${selectedCategory === cat ? 'text-brand-700 font-bold dark:text-brand-400' : 'text-slate-600 dark:text-slate-400'}`}>{cat}</span></div><span className="bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 px-1.5 rounded-full text-[9px] min-w-[1.2rem] text-center">{categoryCounts[cat] || 0}</span></div>))}
                            {isAddingSite && (<div className="px-2 py-1"><input ref={newSiteInputRef} className="w-full text-xs border border-brand-500 rounded px-2 py-1 outline-none bg-white dark:bg-dark-input animate-fade-in" placeholder="사이트명 입력" value={newSiteName} onChange={e => setNewSiteName(e.target.value)} onBlur={handleAddCategory} onKeyDown={e => e.key === 'Enter' && handleAddCategory()}/></div>)}
                        </div>
                    </div>
                    <div className="flex-1 flex flex-col gap-2">
                        <div className="bg-white dark:bg-dark-card p-3 rounded-lg border border-slate-200 dark:border-dark-border shadow-sm flex items-end gap-2">
                            <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">사이트</label><input ref={siteRef} className={`w-full border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none focus:border-brand-500 ${selectedCategory !== 'all' ? 'bg-slate-100 text-slate-500 cursor-not-allowed dark:bg-slate-800' : 'bg-slate-50 dark:bg-dark-input'}`} value={newSite} onChange={e=>setNewSite(e.target.value)} placeholder="쿠팡" list="site-options" readOnly={selectedCategory !== 'all'}/><datalist id="site-options">{categoryOrder.map(c=><option key={c} value={c}/>)}</datalist></div>
                            <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">상품번호</label><input ref={codeRef} className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none focus:border-brand-500" value={newCode} onChange={e=>setNewCode(e.target.value)} onKeyDown={(e) => onInputKeyDown(e, 'name')} placeholder="P-001" /></div>
                            <div className="flex-1"><label className="text-[10px] font-bold text-slate-400 mb-1 block">상품명</label><input ref={nameRef} className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none focus:border-brand-500" value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={(e) => onInputKeyDown(e, 'price')} placeholder="상품명을 입력하세요" /></div>
                            <div className="w-20"><label className="text-[10px] font-bold text-slate-400 mb-1 block">단가</label><input ref={priceRef} type="number" className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs text-right font-mono outline-none focus:border-brand-500" value={newPrice} onChange={e=>setNewPrice(e.target.value)} onKeyDown={(e) => onInputKeyDown(e, 'submit')} placeholder="0" /></div>
                            <button onClick={handleSave} className="bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded text-xs font-bold h-[30px] flex items-center gap-1 min-w-[60px] justify-center"><Icon name="Plus" weight="bold"/> 등록</button>
                        </div>
                        <div className="bg-white dark:bg-dark-card rounded-lg border border-slate-200 dark:border-dark-border flex-1 flex flex-col overflow-hidden shadow-sm">
                            <div className="p-2 border-b border-slate-100 dark:border-slate-800 flex items-center gap-2 justify-between">
                                <div className="flex items-center gap-2"><span className="text-xs font-bold text-slate-700 dark:text-slate-300">{selectedCategory === 'all' ? '전체 상품' : selectedCategory}</span><span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-1.5 rounded text-slate-500">{filteredProducts.length}개</span></div>
                                <div className="relative w-48"><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" /></div><input className="w-full pl-7 pr-2 py-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs outline-none focus:border-brand-500" placeholder="상품 검색..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                <table className="w-full text-xs text-left border-collapse">
                                    <thead className="text-slate-500 font-bold border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-dark-input/50 sticky top-0 z-10"><tr><th className="py-2 px-3 w-24">사이트</th><th className="py-2 px-3 w-24">상품번호</th><th className="py-2 px-3">상품명 (클릭수정)</th><th className="py-2 px-3 w-20 text-right">단가</th><th className="py-2 px-3 w-10 text-center"></th></tr></thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800">{filteredProducts.map((p, idx) => (<tr key={idx} className="group hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"><td className="p-1 px-2"><input className="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-500 rounded px-1 py-1 outline-none text-slate-500 truncate" value={p.site} onChange={(e) => handleInlineUpdate(p.name, 'site', e.target.value)} list="site-options"/></td><td className="p-1 px-2"><input className="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-500 rounded px-1 py-1 outline-none text-slate-500 font-mono" value={p.code} onChange={(e) => handleInlineUpdate(p.name, 'code', e.target.value)}/></td><td className="p-1 px-2"><input className="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-500 rounded px-1 py-1 outline-none font-bold text-slate-700 dark:text-slate-200" defaultValue={p.name} onBlur={(e) => handleInlineUpdate(p.name, 'name', e.target.value)} onKeyDown={(e)=> { if(e.key==='Enter') e.currentTarget.blur(); }}/></td><td className="p-1 px-2"><input type="number" className="w-full bg-transparent border border-transparent hover:border-slate-200 focus:border-brand-500 rounded px-1 py-1 outline-none text-right font-mono text-slate-600 dark:text-slate-400" value={p.price} onChange={(e) => handleInlineUpdate(p.name, 'price', e.target.value)}/></td><td className="p-1 text-center"><button onClick={() => handleDelete(p.name)} className="text-slate-300 hover:text-rose-500 transition-colors p-1"><Icon name="Trash2" /></button></td></tr>))}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- OTHER COMPONENTS ---
        const AddressAdminPanel = ({ selectedOrder, handleUpdateOrderBatch, showToast }) => {
            const [localAddr, setLocalAddr] = useState({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' });
            const [tab, setTab] = useState('input'); const [rawText, setRawText] = useState('');
            useEffect(() => { if (selectedOrder) { setLocalAddr({ recipientName: selectedOrder.recipientName || '', phone: selectedOrder.phone || '', addressText: selectedOrder.addressText || '', addressDetail: selectedOrder.addressDetail || '', shippingMemo: selectedOrder.shippingMemo || '' }); setRawText(''); } else { setLocalAddr({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' }); } }, [selectedOrder]);
            const handleChange = (field, val) => setLocalAddr(prev => ({...prev, [field]: val}));
            const handleSave = () => { if (!selectedOrder) return; handleUpdateOrderBatch(selectedOrder.id, localAddr); showToast('주소 정보 저장 완료'); };
            const handlePostcode = () => { new daum.Postcode({ oncomplete: function(data) { setLocalAddr(prev => ({ ...prev, zipCode: data.zonecode, addressText: data.address, addressDetail: '' })); } }).open(); };
            const handleParseRaw = () => { if (!rawText.trim()) return; let text = rawText; let name = '', phone = '', address = '', memo = ''; const phoneMatch = text.match(/(01[016789])[- .]?(\d{3,4})[- .]?(\d{4})/); if (phoneMatch) { phone = phoneMatch[0]; text = text.replace(phone, ''); } const zipMatch = text.match(/\d{5}/); if(zipMatch) text = text.replace(zipMatch[0], ''); const lines = text.split('\n').map(l => l.trim()).filter(Boolean); lines.forEach(line => { if (line.match(/^(이름|수령인|받는분):?/)) name = line.replace(/^(이름|수령인|받는분):?/, '').trim();else if (line.match(/^(주소|배송지):?/)) address = line.replace(/^(주소|배송지):?/, '').trim();else if (line.match(/^(메모|요청사항):?/)) memo = line.replace(/^(메모|요청사항):?/, '').trim(); }); if (!name && lines.length > 0) name = lines[0]; if (!address && lines.length > 1) address = lines.find(l => l !== name && l.match(/[시도구군길로]/)) || lines[1]; setLocalAddr(prev => ({ ...prev, recipientName: name || prev.recipientName, phone: phone || prev.phone, addressText: address || prev.addressText, shippingMemo: memo || prev.shippingMemo })); setTab('edit'); showToast("정보가 입력되었습니다. 확인해주세요."); };
            
            if (!selectedOrder) { return (<div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col h-full shadow-soft items-center justify-center text-slate-400 text-xs"><Icon name="MapPin" size={24} className="mb-2 opacity-50"/><p>주문을 선택해주세요</p></div>); }
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col h-full shadow-soft overflow-hidden">
                    <div className="flex items-center justify-between px-2 pt-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 shrink-0"><div className="flex gap-1"><button onClick={()=>setTab('input')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='input' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>정보 붙여넣기</button><button onClick={()=>setTab('edit')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='edit' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>상세 수정</button></div><span className="text-[9px] text-slate-400 font-mono pb-1 pr-1">#{selectedOrder.id.toString().slice(-4)}</span></div>
                    <div className="flex-1 overflow-y-auto p-2">{tab === 'input' ? (<div className="h-full flex flex-col gap-2"><textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs resize-none outline-none focus:border-brand-500 placeholder-slate-400" placeholder="예시:&#13;&#10;홍길동&#13;&#10;010-1234-5678&#13;&#10;서울시 강남구..." value={rawText} onChange={e => setRawText(e.target.value)}></textarea><button onClick={handleParseRaw} className="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white rounded text-xs font-bold transition-colors">자동 입력</button></div>) : (<div className="space-y-2"><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">수령인</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.recipientName} onChange={e=>handleChange('recipientName', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">연락처</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.phone} onChange={e=>handleChange('phone', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">주소</label><div className="flex-1 flex flex-col gap-1"><div className="relative w-full"><input className="w-full p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 pr-6" value={localAddr.addressText} onChange={e=>handleChange('addressText', e.target.value)} /><button onClick={handlePostcode} className="absolute right-1 top-1 text-slate-400 hover:text-brand-600"><Icon name="Search" size={10}/></button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={localAddr.addressDetail} onChange={e=>handleChange('addressDetail', e.target.value)} /></div></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">배송메모</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.shippingMemo} onChange={e=>handleChange('shippingMemo', e.target.value)} /></div><div className="pt-2 text-right"><button onClick={handleSave} className="bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors shadow-sm">저장</button></div></div>)}</div></div>
            );
        };
        const InquiryTab = ({ csRecords, setCsRecords, showToast, sites }) => {
            const [search, setSearch] = useState(''); const [filterTab, setFilterTab] = useState('all'); const [newType, setNewType] = useState('CS'); const [newSite, setNewSite] = useState(sites[0] || '기본 창고'); const [newCustomer, setNewCustomer] = useState(''); const [newContent, setNewContent] = useState(''); const [newStatus, setNewStatus] = useState('접수');
            const filters = ['all', 'CS', '반품', '교환', '재고없음', '주소없음', '적립금'];
            const statusOptions = ['접수', '완료', '반품요청', '반품송장', '반품완료', '환불완료', '교환요청', '교환송장', '교환완료'];
            const formatDateShort = (d) => { const date = new Date(d); if (isNaN(date.getTime())) return d; const yy = String(date.getFullYear()).slice(2); const mm = String(date.getMonth() + 1).padStart(2, '0'); const dd = String(date.getDate()).padStart(2, '0'); return `${yy}/${mm}/${dd}`; };
            const addRecord = () => { if (!newCustomer.trim() || !newContent.trim()) { showToast("고객명과 내용을 입력하세요", "error"); return; } const record = { id: Date.now(), date: formatDateShort(new Date()), type: newType, site: newSite, customer: newCustomer, content: newContent, status: newStatus }; setCsRecords(prev => [record, ...prev]); setNewCustomer(''); setNewContent(''); showToast("문의가 등록되었습니다."); };
            const updateStatus = (id, status) => { setCsRecords(prev => prev.map(r => r.id === id ? { ...r, status: status } : r)); };
            const deleteRecord = (id) => { if (window.confirm('삭제하시겠습니까?')) { setCsRecords(prev => prev.filter(r => r.id !== id)); } };
            const filteredRecords = csRecords.filter(r => { const matchesTab = filterTab === 'all' || r.type === filterTab; const matchesSearch = ( r.customer.toLowerCase().includes(search.toLowerCase()) || r.content.toLowerCase().includes(search.toLowerCase()) || (r.site && r.site.toLowerCase().includes(search.toLowerCase())) ); return matchesTab && matchesSearch; });
            const getStatusColor = (status) => { if (status.includes('완료')) return 'bg-slate-200 text-slate-500'; if (status.includes('요청')) return 'bg-rose-100 text-rose-600'; if (status.includes('송장')) return 'bg-blue-100 text-blue-600'; return 'bg-brand-100 text-brand-600'; };

            return (
                <div className="p-4 flex flex-col h-full tab-content gap-4">
                     <div className="flex flex-col gap-2"><div className="flex items-center justify-between"><div className="flex gap-1 overflow-x-auto no-scrollbar">{filters.map(f => (<button key={f} onClick={() => setFilterTab(f)} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${filterTab === f ? 'bg-brand-600 text-white border-brand-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>{f === 'all' ? '전체' : f}</button>))}</div><div className="relative w-48 shrink-0"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" placeholder="문의 검색..." value={search} onChange={e => setSearch(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div></div></div>
                    <div className="bg-white dark:bg-dark-card p-3 rounded-lg border border-slate-200 dark:border-dark-border shadow-sm flex flex-wrap gap-2 items-end">
                        <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">구분</label><select className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none" value={newType} onChange={e=>setNewType(e.target.value)}>{filters.filter(f=>f!=='all').map(f=><option key={f} value={f}>{f}</option>)}</select></div>
                        <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">사이트</label><select className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none" value={newSite} onChange={e=>setNewSite(e.target.value)}>{sites.length > 0 ? sites.map(s=><option key={s} value={s}>{s}</option>) : <option>기본 창고</option>}</select></div>
                        <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">상태</label><select className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none" value={newStatus} onChange={e=>setNewStatus(e.target.value)}>{statusOptions.map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                        <div className="w-24"><label className="text-[10px] font-bold text-slate-400 mb-1 block">고객명</label><input className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none" value={newCustomer} onChange={e=>setNewCustomer(e.target.value)} placeholder="닉네임" /></div>
                        <div className="flex-1"><label className="text-[10px] font-bold text-slate-400 mb-1 block">내용</label><textarea rows={1} className="w-full bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded px-2 py-1.5 text-xs outline-none resize-none h-[30px]" value={newContent} onChange={e=>setNewContent(e.target.value)} placeholder="문의 내용 입력" /></div>
                        <button onClick={addRecord} className="bg-brand-600 hover:bg-brand-700 text-white px-4 py-1.5 rounded text-xs font-bold h-[30px] flex items-center gap-1">등록</button>
                    </div>
                    <div className="flex-1 overflow-y-auto bg-white dark:bg-dark-card rounded-lg border border-slate-200 dark:border-dark-border shadow-sm">
                        <table className="w-full text-xs text-left">
                            <thead className="bg-slate-50 dark:bg-dark-input text-slate-500 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-10"><tr><th className="py-2 px-3 w-20">날짜</th><th className="py-2 px-3 w-20">구분</th><th className="py-2 px-3 w-24 text-center">상태</th><th className="py-2 px-3 w-24">사이트</th><th className="py-2 px-3 w-24">고객명</th><th className="py-2 px-3">내용</th><th className="py-2 px-3 w-10"></th></tr></thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                {filteredRecords.map(r => (<tr key={r.id} className="hover:bg-slate-50 dark:hover:bg-slate-800"><td className="py-2 px-3 text-slate-400">{r.date}</td><td className="py-2 px-3"><span className={`inline-block w-14 text-center px-1.5 py-0.5 rounded text-[10px] ${r.type==='반품'?'bg-rose-100 text-rose-600': r.type==='교환'?'bg-amber-100 text-amber-600': r.type==='재고없음'?'bg-gray-100 text-gray-600': r.type==='주소없음'?'bg-orange-100 text-orange-600': r.type==='적립금'?'bg-purple-100 text-purple-600': 'bg-blue-100 text-blue-600'}`}>{r.type}</span></td><td className="py-2 px-3 text-center"><select className={`bg-transparent border-none outline-none text-[10px] font-bold px-2 py-0.5 rounded-full cursor-pointer ${getStatusColor(r.status)}`} value={r.status} onChange={(e)=>updateStatus(r.id, e.target.value)}>{statusOptions.map(s=><option key={s} value={s} className="bg-white text-slate-700">{s}</option>)}</select></td><td className="py-2 px-3 text-slate-500">{r.site || '-'}</td><td className="py-2 px-3 font-bold">{r.customer}</td><td className="py-2 px-3 whitespace-pre-wrap">{r.content}</td><td className="py-2 px-3 text-center"><button onClick={()=>deleteRecord(r.id)} className="text-slate-300 hover:text-rose-500"><Icon name="X" /></button></td></tr>))}
                                {filteredRecords.length === 0 && <tr><td colSpan="7" className="text-center py-10 text-slate-400">내역이 없습니다.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        const CustomerTab = ({ customerDB, setCustomerDB, orders, showToast }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [search, setSearch] = useState('');
            const fileInputRef = useRef(null);
            const allCustomers = useMemo(() => { const orderCustomers = new Set(orders.map(o => o.customer)); const dbCustomers = Object.keys(customerDB); const merged = new Set([...orderCustomers, ...dbCustomers]); return Array.from(merged).filter(c => c && c.toLowerCase().includes(search.toLowerCase())).sort(); }, [orders, customerDB, search]);
            const customerOrders = useMemo(() => { if (!selectedCustomer) return []; return orders.filter(o => o.customer === selectedCustomer).sort((a,b) => b.id - a.id); }, [orders, selectedCustomer]);
            const handleUpdateCustomer = (field, value) => { if (!selectedCustomer) return; setCustomerDB(prev => ({ ...prev, [selectedCustomer]: { ...prev[selectedCustomer], [field]: value } })); };
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['닉네임'] || row['Nickname'] || row['이름'] || row['성함']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['수령인'] || row['받는분'] || row['이름'] || nick.trim(), phone: row['연락처'] || row['전화번호'] || row['휴대폰'] || '', zipCode: row['우편번호'] || row['Zip'] || '', addressText: row['주소'] || row['Address'] || row['기본주소'] || '', addressDetail: row['상세주소'] || '', shippingMemo: row['배송메모'] || row['배송요청사항'] || row['메모'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`총 ${count}명 고객 등록 완료`, 'success'); } }); e.target.value = null; };
            const handleFileDownload = () => { const rows = Object.entries(customerDB).map(([nick, info]) => ({ '닉네임': nick, '수령인': info.recipientName, '연락처': info.phone, '우편번호': info.zipCode, '주소': info.addressText, '상세주소': info.addressDetail, '배송메모': info.shippingMemo })); const csv = Papa.unparse(rows); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', `고객목록_${new Date().toISOString().slice(0, 10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const currentInfo = customerDB[selectedCustomer] || {};

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="AddressBook" size={14}/> 고객 목록</h3><div className="flex gap-1"><button onClick={() => fileInputRef.current.click()} className="text-[10px] bg-brand-600 text-white px-2 py-1 rounded hover:bg-brand-700 flex items-center gap-1"><Icon name="FileCsv"/> 업로드</button><button onClick={handleFileDownload} className="text-[10px] bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 flex items-center gap-1"><Icon name="DownloadSimple"/> 다운</button></div><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} /></div>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="고객명 검색..." value={search} onChange={e => setSearch(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">{allCustomers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold dark:bg-brand-900/30 dark:text-brand-400' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span className="truncate">{c}</span>{customerDB[c] && <Icon name="CheckCircle" size={10} className="text-emerald-500"/>}</button>))}</div>
                    </div>
                    <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                        {selectedCustomer ? (
                            <>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-4"><h3 className="text-sm font-bold mb-4 flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2"><div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center"><Icon name="User"/></div>{selectedCustomer} 님의 정보</h3><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-slate-500 block mb-1">수령인</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.recipientName || ''} onChange={e => handleUpdateCustomer('recipientName', e.target.value)} /></div><div><label className="text-xs text-slate-500 block mb-1">연락처</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.phone || ''} onChange={e => handleUpdateCustomer('phone', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">주소</label><div className="flex gap-2 mb-1"><input className="flex-1 p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.addressText || ''} onChange={e => handleUpdateCustomer('addressText', e.target.value)} /><button onClick={() => new daum.Postcode({ oncomplete: (data) => { handleUpdateCustomer('zipCode', data.zonecode); handleUpdateCustomer('addressText', data.address); } }).open()} className="bg-slate-100 px-3 rounded text-xs hover:bg-slate-200">검색</button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={currentInfo.addressDetail || ''} onChange={e => handleUpdateCustomer('addressDetail', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">배송메모</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.shippingMemo || ''} onChange={e => handleUpdateCustomer('shippingMemo', e.target.value)} /></div></div></div>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex-1 flex flex-col overflow-hidden"><div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="Clock"/> 주문 이력</h3></div><div className="flex-1 overflow-y-auto"><table className="w-full text-xs text-left"><thead className="bg-slate-50 dark:bg-dark-input text-slate-500 border-b dark:border-slate-700 sticky top-0"><tr><th className="p-2">날짜</th><th className="p-2">상품명</th><th className="p-2">수량</th><th className="p-2 text-right">금액</th><th className="p-2 text-center">상태</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-800">{customerOrders.map(o => (<tr key={o.id}><td className="p-2 text-slate-400">{new Date(o.id).toLocaleDateString()}</td><td className="p-2 font-bold">{o.product}</td><td className="p-2">{o.quantity}</td><td className="p-2 text-right font-mono">{o.price.toLocaleString()}</td><td className="p-2 text-center"><span className={`px-2 py-0.5 rounded-full ${o.isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{o.isPaid ? '결제완료' : '미결제'}</span></td></tr>))}{customerOrders.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">주문 내역이 없습니다.</td></tr>}</tbody></table></div></div>
                            </>
                        ) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-400"><Icon name="User" size={48} className="mb-2 opacity-20"/><p>왼쪽 목록에서 고객을 선택하세요.</p></div>)}
                    </div>
                </div>
            );
        };
        const StatementTab = ({ orders, quickShipping, customerDB, categoryOrder }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedSite, setSelectedSite] = useState('all');
            const [printLayout, setPrintLayout] = useState('single');
            const [printMode, setPrintMode] = useState('single'); // 'single' (individual) or 'batch' (site-wise)
            const [isEditMode, setIsEditMode] = useState(false);

            const customers = useMemo(() => { 
                const unique = [...new Set(orders.map(o => o.customer))]; 
                return unique.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).sort(); 
            }, [orders, searchTerm]);
            
            // Filter customers for BATCH print based on selected Site
            const batchCustomers = useMemo(() => {
                if (printMode !== 'batch') return [];
                const unique = [...new Set(orders.map(o => o.customer))];
                return unique.filter(c => {
                    // This logic assumes we can determine site from orders. 
                    // Since orders don't store site directly in this version, we might need to rely on categoryOrder or pass productCategories.
                    // For simplicity, let's assume if any order matches the site or if site is 'all'.
                    // In a real app, orders should have 'site' property. 
                    // Let's filter by customer name search for batch as well.
                    return c.toLowerCase().includes(searchTerm.toLowerCase());
                }).sort();
            }, [orders, searchTerm, printMode, selectedSite]); // selectedSite dependency added for future logic expansion

            const SingleReceipt = ({ customerName }) => {
                const targetOrders = orders.filter(o => o.customer === customerName);
                const productTotal = targetOrders.reduce((sum, o) => sum + o.price, 0);
                const shipFee = targetOrders.length > 0 ? (targetOrders[0].customShippingFee ?? quickShipping) : 0;
                const grandTotal = productTotal + shipFee;
                const info = customerDB[customerName] || {};
                
                return (
                    <div className={`bg-white p-8 rounded-lg w-[400px] receipt-container text-slate-800 page-break mb-8`} contentEditable={isEditMode} suppressContentEditableWarning={true}>
                        <div className="flex justify-between items-end mb-6"><div><p className="text-xs text-slate-500 mb-1">To.</p><h3 className="text-lg font-bold">{customerName} 님</h3><p className="text-xs text-slate-500 mt-1">{info.phone || ''}</p><p className="text-xs text-slate-500">{info.addressText || ''} {info.addressDetail || ''}</p></div><div className="text-right"><p className="text-xs text-slate-500">Date</p><p className="text-sm font-mono">{new Date().toLocaleDateString()}</p></div></div>
                        <table className="w-full text-sm mb-6"><thead className="border-b border-slate-200"><tr><th className="text-left py-2">상품명</th><th className="text-center py-2 w-12">수량</th><th className="text-right py-2 w-20">금액</th></tr></thead><tbody className="divide-y divide-slate-100">{targetOrders.map(o => (<tr key={o.id}><td className="py-2">{o.product}</td><td className="py-2 text-center">{o.quantity}</td><td className="py-2 text-right font-mono">{o.price.toLocaleString()}</td></tr>))}</tbody></table>
                        <div className="border-t-2 border-slate-800 pt-4 space-y-2"><div className="flex justify-between text-sm"><span>상품 합계</span><span className="font-mono">{productTotal.toLocaleString()}원</span></div><div className="flex justify-between text-sm"><span>배송비</span><span className="font-mono">{shipFee.toLocaleString()}원</span></div><div className="flex justify-between text-xl font-black mt-4 pt-2 border-t border-slate-200"><span>Total</span><span>{grandTotal.toLocaleString()}원</span></div></div>
                        <div className="mt-8 text-center text-xs text-slate-400">감사합니다. 또 이용해주세요!<br/>강은지 주문서 PRO</div>
                    </div>
                );
            };

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden no-print">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex gap-2 mb-2">
                                <button onClick={()=>setPrintMode('single')} className={`flex-1 py-1 text-xs rounded border ${printMode==='single'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>개별 인쇄</button>
                                <button onClick={()=>setPrintMode('batch')} className={`flex-1 py-1 text-xs rounded border ${printMode==='batch'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>일괄 인쇄</button>
                            </div>
                            <select className="w-full bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none py-1 px-2" value={selectedSite} onChange={e=>setSelectedSite(e.target.value)}>
                                <option value="all">전체 사이트</option>
                                {categoryOrder.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder={printMode==='batch'?"필터링할 고객 검색...":"영수증 발급할 고객 검색..."} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                            <div className="flex gap-2 text-xs font-bold text-slate-500 mt-2">
                                <label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='single'} onChange={()=>setPrintLayout('single')}/> A4 1장 1개</label>
                                <label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='double'} onChange={()=>setPrintLayout('double')}/> A4 1장 2개</label>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">
                            {printMode === 'single' 
                                ? customers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600'}`}><span className="truncate">{c}</span><Icon name="CaretRight" size={10} className="opacity-50"/></button>))
                                : <div className="p-3 text-xs text-slate-500 text-center">총 {batchCustomers.length}명의 고객이<br/>인쇄 대기 중입니다.</div>
                            }
                        </div>
                    </div>
                    <div className="flex-1 bg-slate-100 dark:bg-dark-bg rounded-lg border border-slate-200 dark:border-dark-border flex flex-col items-center justify-center p-8 overflow-y-auto relative">
                        {((printMode === 'single' && selectedCustomer) || (printMode === 'batch' && batchCustomers.length > 0)) ? (
                            <div className="flex flex-col gap-4 items-center w-full h-full justify-center">
                                {/* Controls */}
                                <div className="no-print flex gap-2 mb-4">
                                    <button onClick={()=>setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-md font-bold text-xs flex items-center gap-2 ${isEditMode ? 'bg-amber-500 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}><Icon name={isEditMode?"CheckCircle":"Pencil"}/> {isEditMode ? '수정 완료' : '내용 수정하기'}</button>
                                    <button onClick={()=>window.print()} className="bg-slate-800 text-white px-4 py-2 rounded-md font-bold hover:bg-slate-700 flex items-center gap-2 text-xs"><Icon name="Printer"/> 인쇄하기</button>
                                </div>

                                {/* Screen Preview (Single Only or First of Batch) */}
                                <div className="no-print shadow-lg rounded-lg overflow-hidden border border-slate-200 bg-white">
                                    <SingleReceipt customerName={printMode === 'single' ? selectedCustomer : batchCustomers[0]} />
                                </div>
                                {printMode === 'batch' && <div className="no-print text-xs text-slate-400 mt-2">...외 {batchCustomers.length - 1}명의 영수증이 인쇄됩니다.</div>}

                                {/* Print Area (Hidden on Screen) */}
                                <div className="print-area hidden">
                                    {(printMode === 'single' ? [selectedCustomer] : batchCustomers).map((c, i) => (
                                        <div key={i}>
                                            {printLayout === 'single' ? (
                                                <div className="flex justify-center items-center h-[100vh] page-break"><SingleReceipt customerName={c} /></div>
                                            ) : (
                                                <div className="flex flex-col justify-between h-[100vh] py-10 page-break">
                                                    <div className="flex justify-center"><SingleReceipt customerName={c} /></div>
                                                    <div className="border-b border-dashed border-slate-400 w-full my-4"></div>
                                                    <div className="flex justify-center"><SingleReceipt customerName={c} /></div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (<div className="text-center text-slate-400"><Icon name="Receipt" size={64} className="mb-4 opacity-20 inline-block"/><p>대상이 선택되지 않았습니다.</p></div>)}
                    </div>
                </div>
            );
        };
        const StatsTab = ({ orders, productCategories }) => {
            const stats = useMemo(() => {
                const totalRev = orders.reduce((acc, o) => acc + o.price, 0);
                const totalQty = orders.reduce((acc, o) => acc + o.quantity, 0);
                const orderCount = orders.length;
                const avgOrderValue = orderCount > 0 ? totalRev / orderCount : 0;
                
                const productSales = {};
                const customerSales = {};
                const siteSales = {};

                orders.forEach(o => {
                    // Products
                    if (!productSales[o.product]) productSales[o.product] = { name: o.product, qty: 0, rev: 0 };
                    productSales[o.product].qty += o.quantity;
                    productSales[o.product].rev += o.price;

                    // Customers
                    if (!customerSales[o.customer]) customerSales[o.customer] = { name: o.customer, count: 0, rev: 0 };
                    customerSales[o.customer].count += 1;
                    customerSales[o.customer].rev += o.price;

                    // Sites
                    const site = productCategories[o.product] || '기본 창고';
                    if (!siteSales[site]) siteSales[site] = { name: site, rev: 0 };
                    siteSales[site].rev += o.price;
                });

                return {
                    totalRev, totalQty, orderCount, avgOrderValue,
                    topProducts: Object.values(productSales).sort((a,b) => b.rev - a.rev).slice(0, 5),
                    topCustomers: Object.values(customerSales).sort((a,b) => b.rev - a.rev).slice(0, 5),
                    topSites: Object.values(siteSales).sort((a,b) => b.rev - a.rev)
                };
            }, [orders, productCategories]);

            return (
                <div className="p-4 tab-content overflow-y-auto h-full flex flex-col gap-4">
                    {/* Key Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white dark:bg-dark-card p-4 rounded-lg shadow-sm border border-slate-200 dark:border-dark-border">
                            <div className="text-slate-500 text-xs font-bold uppercase mb-1">총 매출</div>
                            <div className="text-2xl font-bold text-brand-600">{stats.totalRev.toLocaleString()}원</div>
                        </div>
                        <div className="bg-white dark:bg-dark-card p-4 rounded-lg shadow-sm border border-slate-200 dark:border-dark-border">
                            <div className="text-slate-500 text-xs font-bold uppercase mb-1">총 주문량</div>
                            <div className="text-2xl font-bold text-blue-600">{stats.totalQty.toLocaleString()}개 <span className="text-sm text-slate-400">({stats.orderCount}건)</span></div>
                        </div>
                        <div className="bg-white dark:bg-dark-card p-4 rounded-lg shadow-sm border border-slate-200 dark:border-dark-border">
                            <div className="text-slate-500 text-xs font-bold uppercase mb-1">평균 객단가</div>
                            <div className="text-2xl font-bold text-emerald-600">{Math.round(stats.avgOrderValue).toLocaleString()}원</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {/* Top Products */}
                        <div className="bg-white dark:bg-dark-card rounded-lg shadow-sm border border-slate-200 dark:border-dark-border p-4">
                            <h3 className="text-sm font-bold mb-3 flex items-center gap-2"><Icon name="Trophy" className="text-amber-500"/> 인기 상품 TOP 5</h3>
                            <div className="space-y-3">
                                {stats.topProducts.map((p, i) => (
                                    <div key={p.name} className="flex items-center justify-between text-xs">
                                        <div className="flex items-center gap-2">
                                            <div className="w-5 h-5 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center font-bold text-slate-500">{i+1}</div>
                                            <span className="font-bold">{p.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block font-bold">{p.rev.toLocaleString()}원</span>
                                            <span className="text-slate-400">{p.qty}개</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Top Customers */}
                        <div className="bg-white dark:bg-dark-card rounded-lg shadow-sm border border-slate-200 dark:border-dark-border p-4">
                            <h3 className="text-sm font-bold mb-3 flex items-center gap-2"><Icon name="User" className="text-blue-500"/> 우수 고객 TOP 5</h3>
                            <div className="space-y-3">
                                {stats.topCustomers.map((c, i) => (
                                    <div key={c.name} className="flex items-center justify-between text-xs">
                                        <div className="flex items-center gap-2">
                                            <div className="w-5 h-5 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center font-bold text-slate-500">{i+1}</div>
                                            <span className="font-bold">{c.name}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block font-bold">{c.rev.toLocaleString()}원</span>
                                            <span className="text-slate-400">{c.count}회 주문</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [activeTab, setActiveTab] = useState('order'); 
            const [currentSite, setCurrentSite] = useState(() => localStorage.getItem('currentSite') || '기본 창고');
            const [converterTab, setConverterTab] = useState('general');
            const [batchProduct, setBatchProduct] = useState('');
            const [batchPrice, setBatchPrice] = useState('');
            const [batchCode, setBatchCode] = useState('');
            const [selectedCustomerFolder, setSelectedCustomerFolder] = useState('all');
            const [folderSearch, setFolderSearch] = useState('');

            // NEW: Message Panel States
            const [manualMessage, setManualMessage] = useState('');

            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [productCategories, setProductCategories] = useState(() => JSON.parse(localStorage.getItem('productCategories')) || {});
            const [productNumbers, setProductNumbers] = useState(() => JSON.parse(localStorage.getItem('productNumbers')) || {});
            const [categoryOrder, setCategoryOrder] = useState(() => JSON.parse(localStorage.getItem('categoryOrder')) || []);
            const [customerDB, setCustomerDB] = useState(() => JSON.parse(localStorage.getItem('customerDB')) || {}); 
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            const [csRecords, setCsRecords] = useState(() => JSON.parse(localStorage.getItem('csRecords')) || []);
            const [schedules, setSchedules] = useState(() => JSON.parse(localStorage.getItem('schedules')) || []); // NEW Schedule State
            
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('googleScriptUrl') || '');
            const [shippingFee, setShippingFee] = useState(4000);
            const [filterText, setFilterText] = useState('');
            const [quickCode, setQuickCode] = useState('');
            const [quickName, setQuickName] = useState('');
            const [quickPrice, setQuickPrice] = useState('');
            const [quickShipping, setQuickShipping] = useState(4000); // 사용자 입력/기본 배송비
            const [speedInput, setSpeedInput] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [toast, setToast] = useState(null);
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const [editingShippingId, setEditingShippingId] = useState(null); 
            const [unpaidFilter, setUnpaidFilter] = useState(null); 
            const [isExcelMenuOpen, setIsExcelMenuOpen] = useState(false);
            const [isReceiptModalOpen, setIsReceiptModalOpen] = useState(false);
            const [focusedOrderId, setFocusedOrderId] = useState(null);
            const fileInputRef = useRef(null);
            const customerFileRef = useRef(null);
            const excelMenuRef = useRef(null); 

            useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('productCategories', JSON.stringify(productCategories)); }, [productCategories]);
            useEffect(() => { localStorage.setItem('productNumbers', JSON.stringify(productNumbers)); }, [productNumbers]);
            useEffect(() => { localStorage.setItem('categoryOrder', JSON.stringify(categoryOrder)); }, [categoryOrder]);
            useEffect(() => { localStorage.setItem('customerDB', JSON.stringify(customerDB)); }, [customerDB]);
            useEffect(() => { localStorage.setItem('csRecords', JSON.stringify(csRecords)); }, [csRecords]);
            useEffect(() => { localStorage.setItem('schedules', JSON.stringify(schedules)); }, [schedules]); // NEW
            useEffect(() => { localStorage.setItem('googleScriptUrl', googleScriptUrl); }, [googleScriptUrl]);
            useEffect(() => { localStorage.setItem('currentSite', currentSite); }, [currentSite]);
            useEffect(() => { const handleClickOutside = (event) => { if (excelMenuRef.current && !excelMenuRef.current.contains(event.target)) { setIsExcelMenuOpen(false); } }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);

            const recentProducts = useMemo(() => Object.entries(productHistory).reverse().slice(0, 50), [productHistory]);
            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 2500); };
            const handleRecentProductClick = (name, price) => {
                if (activeTab === 'order' && focusedOrderId) {
                     // Check if focused order needs update
                     setOrders(prev => prev.map(o => {
                         if (o.id === focusedOrderId) {
                             const site = productCategories[name] || currentSite;
                             const code = productNumbers[name] || '';
                             return { ...o, product: name, price: o.quantity * price };
                         }
                         return o;
                     }));
                     showToast("선택된 주문의 상품이 업데이트되었습니다.");
                } else {
                    if (converterTab === 'batch') { setBatchProduct(name); setBatchPrice(price); } else { setQuickName(name); setQuickPrice(price); }
                }
            };

            const handleQuickAddOrder = () => {
                if(quickName.trim()) {
                     const pName = quickName.trim();
                     const pPrice = Number(quickPrice);
                     const pSite = currentSite; 
                     const pCode = quickCode.trim();
                     setProductHistory(prev => ({...prev, [pName]: pPrice}));
                     setProductCategories(prev => ({...prev, [pName]: pSite}));
                     setProductNumbers(prev => ({...prev, [pName]: pCode}));
                     setCategoryOrder(prev => prev.includes(pSite) ? prev : [...prev, pSite]);
                }
                setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: quickName || '', quantity: 1, price: Number(quickPrice) || 0, customShippingFee: Number(quickShipping) }), ...prev]);
                showToast("주문이 추가되었습니다.");
            };

            const handleUpdateOrder = (id, field, value) => { 
                setOrders(prev => prev.map(o => { 
                    if (o.id !== id) return o; 
                    let updates = { [field]: value };
                    if (field === 'quantity') updates.price = value * (productHistory[o.product] || Number(quickPrice) || 0);
                    if (field === 'product') updates.price = o.quantity * (productHistory[value] || 0);
                    if (field === 'price' && o.product) setProductHistory(h => ({...h, [o.product]: value/o.quantity}));
                    const newPrice = updates.price ?? o.price;
                    if (field === 'deposit') { const rem = Math.max(0, newPrice - value); updates.cardAmount = rem; updates.isCardPaid = rem > 0; }
                    
                    return sanitizeOrder({ ...o, ...updates }); 
                })); 
            };

            const handleUpdateProductCategory = (productName, newCategory) => {
                if (!productName) return;
                setProductCategories(prev => ({ ...prev, [productName]: newCategory }));
                setCategoryOrder(prev => prev.includes(newCategory) ? prev : [...prev, newCategory]);
            };

            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            
            // [MODIFIED] Deposit Logic for manual input / setting
            const handleAutoDepositFull = (id) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const price = o.price;
                    const currentDeposit = o.deposit;
                    
                    // 우클릭 시 인라인 편집 토글
                    if (window.event && window.event.type === 'contextmenu') {
                        window.event.preventDefault();
                        handleToggleAmountEdit(id);
                        return o;
                    }
                    
                    // 기본 클릭: 현금 완납 토글 (카드 금액이 0인 경우만)
                    const nextDeposit = (currentDeposit === price && o.cardAmount === 0) ? 0 : price; // 완납 상태에서 해제 또는 완납
                    
                    return sanitizeOrder({ 
                        ...o, 
                        deposit: nextDeposit, 
                        isPaid: nextDeposit > 0 ? true : false // 물품 금액을 현금으로 채웠을 때만 isPaid
                    });
                }));
            };

            // [MODIFIED] Card amount setting logic (focusing on manual entry for later settlement)
            const handleSetCardAmount = (id, amount) => { 
                setOrders(prev => prev.map(o => { 
                    if (o.id !== id) return o;
                    const newAmount = Number(amount) || 0;
                    
                    return sanitizeOrder({ 
                        ...o, 
                        cardAmount: newAmount, 
                        isCardPaid: newAmount > 0, // 카드 금액이 있으면 후불 결제 플래그
                        isPaid: (o.deposit + newAmount) >= o.price // 물품 금액 기준 완납 체크
                    });
                }));
            };

            // [MODIFIED] 현금 금액 설정 (인라인 편집)
            const handleSetDepositAmount = (id, amount) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const newAmount = Number(amount) || 0;
                    return sanitizeOrder({ ...o, deposit: newAmount, isPaid: (newAmount + o.cardAmount) >= o.price });
                }));
            };


            const handleToggleAmountEdit = (id) => { setEditingAmountId(id === editingAmountId ? null : id); setEditingShippingId(null); };
            const handleToggleShippingEdit = (id) => { setEditingShippingId(id === editingShippingId ? null : id); setEditingAmountId(null); };
            const handleToggleAddressEdit = (id) => { setEditingAddressId(id === editingAddressId ? null : id); };
            
            // [MODIFIED] Shipping Toggle Handler
            const handleShippingToggle = (id) => {
                const targetOrder = orders.find(o => o.id === id);
                if (!targetOrder) return;
                const customer = targetOrder.customer;
                const newStatus = !targetOrder.isShippingPaid;
                
                // 우클릭 시 개별 배송비 설정 토글
                if (window.event && window.event.type === 'contextmenu') {
                    window.event.preventDefault();
                    setEditingShippingId(id === editingShippingId ? null : id);
                    return;
                }
                
                // 기본 클릭: 배송비 결제 상태 토글
                setOrders(prev => prev.map(o => {
                    if (o.customer === customer) {
                        return sanitizeOrder({ ...o, isShippingPaid: newStatus });
                    }
                    return o;
                }));
            };

            const handlePriceBlur = (id, e) => {
                const val = e.target.value.replace(/,/g, '');
                const newPrice = Number(val);
                if (isNaN(newPrice)) return;
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const updated = { ...o, price: newPrice };
                    if (o.product && o.quantity > 0) {
                        const unitPrice = newPrice / o.quantity;
                        setProductHistory(ph => ({ ...ph, [o.product]: unitPrice }));
                    }
                    return sanitizeOrder(updated);
                }));
            };

            const getCSVString = (listData, mode) => { const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || '')); const firstIds = {}; list.forEach(o => { if (o.customer && !firstIds[o.customer]) firstIds[o.customer] = o.id; }); const clean = (val) => '"' + String(val || '').replace(/"/g, '""') + '"'; const cleanPhone = (val) => { if (!val) return '""'; const strVal = String(val); return "\"\u200B" + strVal + '"'; }; if (mode === 'invoice') { const excelHeaders = ['', '', '', '', '상품명', '수령인', '연락처', '주소', '배송메모', '', '메모', '우편번호', '']; const csv = [excelHeaders.join(',')].concat(list.map(o => { let quantitySuffix = ''; if (o.quantity >= 2) { quantitySuffix = ` ★${o.quantity}`; } const productName = `[${o.customer || '미지정'}] ${o.product}${quantitySuffix}`; return ['', '', '', '', clean(productName), clean(o.recipientName), cleanPhone(o.phone), clean((o.addressText||'') + ' ' + (o.addressDetail||'')), clean(o.shippingMemo), '', clean(o.memo), cleanPhone(o.zipCode), ''].join(','); })).join('\n'); return "\ufeff" + csv; } else { const headers = ['닉네임', '입금명', '상품명', '수량', '금액', '입금액(현금)', '카드결제액', '배송비', '미수금', '수령인', '연락처', '우편번호', '주소', '배송메모', '메모']; const csv = [headers.join(',')].concat(list.map(o => { const isFirst = firstIds[o.customer] === o.id; const ship = o.customShippingFee ?? quickShipping; const shipCharge = isFirst ? ship : 0; const unpaid = Math.max(0, (o.price + shipCharge) - (o.deposit + o.cardAmount + (isFirst && o.isShippingPaid ? ship : 0))); return [clean(o.customer), clean(o.phone), clean(o.product), o.quantity, o.price, clean(o.deposit), clean(o.cardAmount), clean(shipCharge), clean(unpaid), clean(o.recipientName), cleanPhone(o.phone), cleanPhone(o.zipCode), clean((o.addressText||'') + ' ' + (o.addressDetail||'')), clean(o.shippingMemo), clean(o.memo)].join(','); })).join('\n'); return "\ufeff" + csv; } };
            const handleDownloadCSV = (mode) => { const csvString = getCSVString(orders, mode); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const timestamp = new Date().toISOString().slice(0, 10); link.setAttribute('download', `${mode === 'invoice' ? '송장용_' : '전체주문_'}${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleDownloadProductCSV = () => { const summary = {}; orders.forEach(o => { const key = o.product || '미지정'; summary[key] = (summary[key] || 0) + o.quantity; }); const csvContent = "\ufeff상품명,수량\n" + Object.entries(summary).map(e => e.join(',')).join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', `발주리스트_${new Date().toISOString().slice(0, 10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleSetGoogleUrl = () => { const url = window.prompt("Google Apps Script 웹 앱 URL 입력:", googleScriptUrl); if (url !== null) { setGoogleScriptUrl(url.trim()); showToast("URL 저장 완료"); } };
            const handleLoadFromGoogle = async () => { if (!googleScriptUrl) { handleSetGoogleUrl(); return; } setIsSyncing(true); try { const res = await fetch(googleScriptUrl); const data = await res.json(); if (data.orders) { const rows = JSON.parse(data.orders); const headers = rows[0]; const loadedOrders = rows.slice(1).map(row => { const obj = {}; headers.forEach((h, i) => obj[h] = row[i]); return sanitizeOrder(obj); }); setOrders(loadedOrders); } if (data.products) setProductHistory(JSON.parse(data.products)); if (data.customers) { const custRows = JSON.parse(data.customers); const newDB = {}; custRows.slice(1).forEach(r => { newDB[r[0]] = { recipientName: r[1], phone: r[2], zipCode: r[3], addressText: r[4], shippingMemo: r[5] }; }); setCustomerDB(newDB); } showToast("불러오기 완료"); } catch (e) { showToast("실패: " + e.message, "error"); } finally { setIsSyncing(false); } };
            const handleSaveToGoogle = async () => { if (!googleScriptUrl) { handleSetGoogleUrl(); return; } setIsSyncing(true); try { const payload = { orders: JSON.stringify(orders), products: JSON.stringify(productHistory), customers: JSON.stringify(customerDB) }; const res = await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify(payload) }); const json = await res.json(); if (json.status === 'success') showToast("저장 완료"); else throw new Error(json.message || "Unknown Error"); } catch (e) { showToast("저장 실패", "error"); console.error(e); } finally { setIsSyncing(false); } };
            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`; a.download = `강은지_주문서_백업_${timestamp}.html`; a.click(); URL.revokeObjectURL(url); showToast('백업 완료'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const uploaded = results.data.map((row, i) => sanitizeOrder({ id: Date.now() + i, originalText: `UPLOAD: ${row['상품명']}`, customer: row['닉네임']?.trim(), product: row['상품명'], quantity: Number(row['수량']) || 1, price: Number(row['금액']?.replace(/,/g, '')) || 0, deposit: Number(row['입금액(현금)']), cardAmount: Number(row['카드결제액']), recipientName: row['수령인'], phone: row['연락처'], zipCode: row['우편번호'], addressText: row['주소'], shippingMemo: row['배송메모'], memo: row['메모'] })).filter(o => o.customer); setOrders(prev => [...uploaded, ...prev]); showToast(`${uploaded.length}건 업로드 완료`); } }); e.target.value = null; };
            const handleCustomerUploadClick = () => customerFileRef.current && customerFileRef.current.click();
            const handleCustomerFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['닉네임'] || row['Nickname'] || row['이름'] || row['성함']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['수령인'] || row['받는분'] || row['이름'] || nick.trim(), phone: row['연락처'] || row['전화번호'] || row['휴대폰'] || '', zipCode: row['우편번호'] || row['Zip'] || '', addressText: row['주소'] || row['Address'] || row['기본주소'] || '', addressDetail: row['상세주소'] || '', shippingMemo: row['배송메모'] || row['배송요청사항'] || row['메모'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`총 ${count}명 고객 등록 완료`, 'success'); } }); e.target.value = null; };
            const handleReset = () => { if (window.confirm("정말로 모든 주문 내역을 삭제하시겠습니까? (고객 데이터는 유지됩니다)")) { setOrders([]); showToast("초기화 완료", "error"); } };

            const firstOrderIds = useMemo(() => { 
                const ids = {}; 
                orders.forEach(o => { if (o.customer && !ids[o.customer]) ids[o.customer] = o.id; }); 
                return ids; 
            }, [orders]);
            
            // --- NEW: STATS CALCULATION MEMOIZED ---
            const stats = useMemo(() => {
                let totalRev = 0;
                let totalQty = 0;
                let productUnpaid = 0;
                let shipUnpaid = 0;
                const shippingCustomers = new Set();
                const processedCustomers = {};

                orders.forEach(o => {
                    totalRev += o.price;
                    totalQty += o.quantity;
                    
                    if (!o.customer) return;

                    // 그룹별 통계 계산 (고객별 한번만 계산되어야 하는 항목)
                    if (!processedCustomers[o.customer]) {
                        // 현재 주문과 같은 고객의 모든 주문 합산
                        const customerGroupOrders = orders.filter(groupO => groupO.customer === o.customer);
                        
                        // 고객 그룹 통계 계산
                        const groupProductTotal = customerGroupOrders.reduce((sum, item) => sum + item.price, 0);
                        const groupDeposit = customerGroupOrders.reduce((sum, item) => sum + item.deposit, 0);
                        const groupCard = customerGroupOrders.reduce((sum, item) => sum + item.cardAmount, 0);
                        const groupShipFee = o.customShippingFee ?? quickShipping;
                        
                        // 수정: 총 결제 금액에 배송비 토글 여부를 반영
                        const isShippingPaid = customerGroupOrders.some(item => item.isShippingPaid);
                        const groupTotalPaid = groupDeposit + groupCard + (isShippingPaid ? groupShipFee : 0); 
                        
                        const groupTotalRequired = groupProductTotal + groupShipFee;
                        
                        // 미수금 계산
                        const remaining = Math.max(0, groupTotalRequired - groupTotalPaid);
                        
                        // 배송 미수금 (배송비 결제 버튼이 눌리지 않았을 경우)
                        if (!isShippingPaid && groupShipFee > 0) {
                            shipUnpaid += groupShipFee;
                        }

                        // 물품 미수금 (총 미수금에서 배송비 미수금을 제외한 나머지)
                        const remainingAfterShipUnpaid = Math.max(0, remaining - (!isShippingPaid ? groupShipFee : 0));
                        productUnpaid += remainingAfterShipUnpaid;
                        
                        if (o.isAddressFilled) shippingCustomers.add(o.customer);

                        // 중복 계산 방지
                        processedCustomers[o.customer] = true;
                    }
                });

                return {
                    totalRev,
                    qty: totalQty,
                    shippingCount: shippingCustomers.size,
                    productUnpaid: productUnpaid,
                    shipUnpaid: shipUnpaid
                };
            }, [orders, quickShipping]);
            // --- END: STATS CALCULATION MEMOIZED ---


            const processTextLine = (text) => {
                if (!text) return null;
                const cleanText = text.trim();
                
                // --- BATCH MODE ---
                if (converterTab === 'batch') {
                    if (!cleanText.startsWith('@')) return null;
                    let customer = cleanText.substring(1).trim(); 
                    if (!customer) return null;
                    const product = batchProduct || '기본 상품'; 
                    const unitPrice = Number(batchPrice) || productHistory[product] || 0;
                    const quantity = 1; 
                    const price = quantity * unitPrice;
                    const crmData = customerDB[customer];
                    if (product && !productCategories[product]) { setProductCategories(prev => ({ ...prev, [product]: currentSite })); }
                    if (batchCode) { setProductNumbers(prev => ({...prev, [product]: batchCode})); }
                    if (unitPrice > 0) { setProductHistory(prev => ({...prev, [product]: unitPrice})); }

                    return sanitizeOrder({ id: Date.now() + Math.random(), originalText: text, customer, product, quantity, price, recipientName: crmData?.recipientName || '', phone: crmData?.phone || '', zipCode: crmData?.zipCode || '', addressText: crmData?.addressText || '', shippingMemo: crmData?.shippingMemo || '', isCRM: !!crmData });
                }
                
                // --- GENERAL MODE (Speed Entry) ---
                // Format: [닉네임] [상품명] [수량]
                const parts = cleanText.split(/\s+/);
                let customer = parts[0];
                customer = customer.replace(/^@/, '').replace(/[:.,]$/, '');
                
                let product = '';
                let quantity = 1;

                if (parts.length > 1) {
                    const productRaw = parts.slice(1).join(' ');
                    const qtyMatch = productRaw.match(/(\d+)\s*(?:개|set|ea|box)?$/i);
                    if (qtyMatch) {
                        quantity = parseInt(qtyMatch[1], 10);
                        // 상품명은 수량 정보를 제거한 나머지
                        product = productRaw.replace(qtyMatch[0], '').trim() || productRaw.replace(/(\s*(?:개|set|ea|box)?)$/i, '').trim(); 
                    } else {
                        // 수량 정보가 없으면 전체를 상품명으로 간주
                        product = productRaw.trim();
                    }
                } else {
                    // 닉네임만 주어진 경우, 기본 상품 사용
                    product = quickName || '기본 상품';
                }
                
                const unitPrice = productHistory[product] || 0;
                
                const price = quantity * unitPrice;
                const crmData = customerDB[customer];
                if (product && !productCategories[product]) { setProductCategories(prev => ({ ...prev, [product]: currentSite })); }
                
                return sanitizeOrder({ id: Date.now() + Math.random(), originalText: text, customer, product, quantity, price, recipientName: crmData?.recipientName || '', phone: crmData?.phone || '', zipCode: crmData?.zipCode || '', addressText: crmData?.addressText || '', shippingMemo: crmData?.shippingMemo || '', isCRM: !!crmData });
            };

            const handleParseOrders = () => {
                // 이 함수는 '일괄입력'에서만 사용됨
                if (converterTab !== 'batch' || !rawInput.trim()) { showToast('일괄입력 내용이 없습니다.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const lines = rawInput.split('\n').map(l => l.trim()).filter(Boolean);
                    const newOrders = [];
                    
                    // 기존 주문 목록에 있는 고객 닉네임 집합
                    const existingCustomersInOrders = new Set(orders.map(o => o.customer).filter(Boolean));
                    // 현재 입력에서 이미 처리된 고객 닉네임 집합
                    const processedCustomersInInput = new Set();

                    lines.forEach((line) => {
                        const order = processTextLine(line);
                        if (order && order.customer) {
                            const customerName = order.customer;
                            
                            // 1. 고객이 시스템 내 (기존 orders)에 없고, 이번 입력에서도 처음 나타난 경우 '첫 주문'으로 간주
                            const customerExists = existingCustomersInOrders.has(customerName);
                            const isFirstOrderInInput = !processedCustomersInInput.has(customerName);

                            const isFirstOrderInSystem = !customerExists && isFirstOrderInInput;

                            // 현재 입력에서 처리했음을 표시
                            processedCustomersInInput.add(customerName);

                            // 2. 배송비 및 결제 상태 설정
                            const shipFee = quickShipping;

                            newOrders.push(sanitizeOrder({ 
                                ...order, 
                                isShippingPaid: !isFirstOrderInSystem, // 첫 주문은 false (미수금 시작)
                                customShippingFee: shipFee, 
                            }));
                        } else if (order) {
                            newOrders.push(order); 
                        }
                    });
                    
                    setOrders(prev => [...newOrders, ...prev]);
                    setRawInput('');
                    setIsProcessing(false);
                    showToast(`${newOrders.length}건 일괄 등록 완료`);
                }, 100);
            };

            const handleSpeedInputSubmit = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    const lines = speedInput.split('\n').map(l => l.trim()).filter(Boolean);
                    if (lines.length === 0) return;

                    const newOrders = [];
                    // 기존 주문 목록에 있는 고객 닉네임 집합
                    const existingCustomersInOrders = new Set(orders.map(o => o.customer).filter(Boolean));
                    // 현재 입력에서 이미 처리된 고객 닉네임 집합
                    const processedCustomersInInput = new Set();
                    
                    lines.forEach((line) => {
                        const order = processTextLine(line);
                        if (order && order.customer) {
                            const customerName = order.customer;
                            
                            // 1. 고객이 시스템 내 (기존 orders)에 없고, 이번 입력에서도 처음 나타난 경우 '첫 주문'으로 간주
                            const customerExists = existingCustomersInOrders.has(customerName);
                            const isFirstOrderInInput = !processedCustomersInInput.has(customerName);

                            const isFirstOrderInSystem = !customerExists && isFirstOrderInInput;

                            // 현재 입력에서 처리했음을 표시
                            processedCustomersInInput.add(customerName);

                            // 2. 배송비 및 결제 상태 적용
                            const shipFee = quickShipping;

                            newOrders.push(sanitizeOrder({ 
                                ...order, 
                                isShippingPaid: !isFirstOrderInSystem, // 첫 주문은 false (미수금 시작)
                                customShippingFee: shipFee, // 적용될 배송비 설정
                            }));
                        } else if (order) {
                            newOrders.push(order); 
                        }
                    });
                    
                    if (newOrders.length > 0) {
                        setOrders(prev => [...newOrders, ...prev]);
                        setSpeedInput('');
                        showToast(`${newOrders.length}건 주문 추가 완료`, 'success');
                    }
                }
            };
            
            // Re-map handleSpeedInput to the new submit handler
            const handleSpeedInput = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter는 줄바꿈 허용
                    handleSpeedInputSubmit(e);
                }
            };


            const filteredOrders = useMemo(() => {
                let result = orders;
                if (filterText) {
                    const lower = filterText.toLowerCase();
                    result = result.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower)));
                }
                if (unpaidFilter) {
                    // 고객별 그룹화하여 미수금 상태 확인
                    const customerUnpaidStatus = {};
                    orders.forEach(o => {
                        const customer = o.customer || '미지정';
                        if (!customerUnpaidStatus[customer]) {
                            customerUnpaidStatus[customer] = {
                                productTotal: 0,
                                totalPaid: 0,
                                isShippingPaid: false,
                                shipFee: o.customShippingFee ?? quickShipping
                            };
                        }
                        customerUnpaidStatus[customer].productTotal += o.price;
                        customerUnpaidStatus[customer].totalPaid += o.deposit + o.cardAmount;
                        if (o.isShippingPaid) {
                            customerUnpaidStatus[customer].isShippingPaid = true;
                        }
                    });
                    
                    result = result.filter(o => {
                        const status = customerUnpaidStatus[o.customer || '미지정'];
                        if (!status) return false;

                        const totalRequired = status.productTotal + status.shipFee;
                        const remaining = Math.max(0, totalRequired - status.totalPaid);

                        if (unpaidFilter === 'ship') {
                            // 배송 미수금 필터: 배송비 결제 버튼이 눌리지 않았고 배송비가 0보다 클 때
                            return !status.isShippingPaid && status.shipFee > 0;
                        }
                        
                        if (unpaidFilter === 'cash') {
                            // 물품 미수금 필터: 전체 미수금에서 배송비 미수금을 제외하고도 남은 금액이 있을 때
                            const shipUnpaidAmount = (!status.isShippingPaid && status.shipFee > 0) ? status.shipFee : 0;
                            const productMissing = Math.max(0, remaining - shipUnpaidAmount);
                            return productMissing > 0;
                        }
                        
                        return true;
                    }).filter(o => o.customer === selectedCustomerFolder || selectedCustomerFolder === 'all'); // 필터링된 고객의 주문만 유지
                }

                // Sidebar Filtering
                if (selectedCustomerFolder !== 'all') {
                    result = result.filter(o => o.customer === selectedCustomerFolder);
                }

                return result;
            }, [orders, filterText, unpaidFilter, quickShipping, selectedCustomerFolder]);

            // Customer Folder Data (Left Sidebar)
            const customerFolders = useMemo(() => {
                let base = orders;
                if (folderSearch) {
                    const lower = folderSearch.toLowerCase();
                    base = base.filter(o => o.customer && o.customer.toLowerCase().includes(lower));
                }
                const map = {};
                base.forEach(o => {
                    const k = o.customer || '미지정';
                    if (!map[k]) map[k] = { name: k, count: 0, unpaid: false };
                    map[k].count++;
                    const paid = o.deposit + o.cardAmount;
                    const required = o.price; 
                    if (paid < required) map[k].unpaid = true; 
                });
                return Object.values(map).sort((a,b) => a.name.localeCompare(b.name));
            }, [orders, folderSearch]);

            const focusedOrder = useMemo(() => { return orders.find(o => o.id === focusedOrderId); }, [orders, focusedOrderId]);

            // Generate Order Message Template
            const generateOrderSummary = (targetCustomer) => {
                const custOrders = orders.filter(o => o.customer === targetCustomer);
                if (custOrders.length === 0) return '';
                let totalProduct = 0; let totalDeposit = 0; let totalCard = 0;
                
                // 배송비는 첫 주문에 설정된 값 (customShippingFee) 또는 기본 값 (quickShipping)
                const shipFee = custOrders.length > 0 ? (custOrders[0]?.customShippingFee ?? quickShipping) : 0;
                const isShipPaid = custOrders.some(o => o.isShippingPaid); 

                custOrders.forEach(o => {
                    totalProduct += o.price;
                    totalDeposit += o.deposit;
                    totalCard += o.cardAmount;
                });

                const cardSurcharge = Math.round(totalCard * 0.1);
                const totalPaid = totalDeposit + totalCard;

                // 총 필수 금액 계산: 물품 금액 + 배송비
                const totalRequired = totalProduct + shipFee;
                
                // 총 결제 금액: 현금 + 카드 + (배송비 결제 토글된 경우 배송비)
                const totalPaidWithShip = totalPaid + (isShipPaid ? shipFee : 0);
                
                // 미수금
                const remaining = Math.max(0, totalRequired - totalPaidWithShip);
                

                let text = `💙 ${targetCustomer} 님 💙\n\n`;
                custOrders.forEach(o => {
                    text += `${o.product} ${o.price.toLocaleString()}원`;
                    if (o.quantity > 1) text += ` (${o.quantity})`;
                    text += `\n`;
                });
                text += `배송비 ${shipFee.toLocaleString()}원\n`;
                text += `\n총 주문금액 ${totalRequired.toLocaleString()}원\n`;
                text += `------------------\n`;
                
                // --- 입금 확인 섹션 ---
                const isCompletelyPaid = remaining === 0;

                if (totalPaid > 0 || totalCard > 0 || isShipPaid) {
                    text += `[입금확인]\n`;
                    if (totalDeposit > 0) {
                        text += `${totalDeposit.toLocaleString()}원 (현금)\n`;
                    }
                    
                    if (totalCard > 0) {
                        // 카드 결제 시 10% 추가금 안내
                        text += `\n[카드 결제 안내]\n`;
                        text += `카드 결제 금액: ${totalCard.toLocaleString()}원\n`;
                        text += `10% 추가 금액: ${cardSurcharge.toLocaleString()}원\n`;
                        text += `👉 총 ${(totalCard + cardSurcharge).toLocaleString()}원 예정\n`;
                    }
                    
                    if (isShipPaid && shipFee > 0) {
                         text += `✅ 배송비 결제 완료 (${shipFee.toLocaleString()}원)\n`;
                    }
                    
                    if (isCompletelyPaid) {
                         text += `\n완납 확인! 감사합니다 😍\n`;
                    }
                    text += `------------------\n`; // 입금확인과 하단 안내 문구 사이에 구분선 추가
                }

                
                // --- 미입금 내역 섹션 ---
                if (remaining > 0) {
                    text += `\n[미입금 내역]\n`;
                    
                    const shipUnpaidAmount = (!isShipPaid && shipFee > 0) ? shipFee : 0;
                    const productMissing = Math.max(0, remaining - shipUnpaidAmount);

                    if (shipUnpaidAmount > 0) {
                        text += `❌ 배송비: ${shipUnpaidAmount.toLocaleString()}원\n`;
                    }
                    if (productMissing > 0) {
                        text += `❌ 물품비: ${productMissing.toLocaleString()}원\n`;
                    }
                    text += `\n👉 총 입금하실 금액: ${remaining.toLocaleString()}원\n`;
                    text += `\n카카오뱅크 김선정\n7942 18 01611\n\n`;
                    text += `입금 부탁드립니다 🙏\n`;
                    text += `------------------\n`; 
                }
                
                // --- 하단 안내 문구 ---
                text += `방송마다 1회\n`;
                text += `하단의 주문서(배송지입력) 필수!!\n\n`;
                text += `이미 참여한 설문 일 경우\n`;
                text += `▫ 답변 수정하기 \n`;
                text += `▫ 또는 설문 추가 참여\n\n`;
                text += `미입력이 많아 계속 안내하오니\n`;
                text += `양해부탁드립니다. \n`;
                
                return text;
            };

            const orderMessage = useMemo(() => {
                if (selectedCustomerFolder && selectedCustomerFolder !== 'all') {
                    return generateOrderSummary(selectedCustomerFolder);
                }
                if (focusedOrder) return generateOrderSummary(focusedOrder.customer);
                return '';
            }, [orders, selectedCustomerFolder, focusedOrder, quickShipping]);

            const handleSidebarClick = (customerName) => {
                setSelectedCustomerFolder(customerName);
                const msg = generateOrderSummary(customerName);
                // Set manual message to the generated summary when sidebar clicked
                setManualMessage(msg);
                navigator.clipboard.writeText(msg);
                showToast("주문서가 복사되었습니다.");
            };

            // Sync generated order message to manual message when generated changes (and user hasn't edited, or force sync?)
            // A simple strategy: always update manual message when the underlying data for generation changes, 
            // effectively resetting edits if data changes. This is common for this type of UI.
            useEffect(() => {
                setManualMessage(orderMessage);
            }, [orderMessage]);

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700 dark:text-gray-300">
                    <header className="h-10 bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-3 shrink-0 shadow-sm z-50">
                        <div className="flex items-center gap-2"><div className="bg-brand-700 text-white p-0.5 rounded"><Icon name="Lightning" size={14} weight="fill"/></div><span className="font-bold text-xs tracking-tight text-slate-800 dark:text-white">주문관리 PRO</span></div>
                        <div className="flex items-center gap-2">
                            <div className="flex items-center bg-slate-100 dark:bg-dark-input rounded-sm p-0.5">
                                <ActionButton onClick={handleSetGoogleUrl} color="ghost" icon="Gear" text="" className="!px-1.5"/>
                                <ActionButton onClick={handleSaveToGoogle} color="ghost" icon="CloudArrowUp" text="저장" loading={isSyncing}/>
                                <div className="w-px h-3 bg-slate-300 dark:bg-slate-600 mx-0.5"></div>
                                <ActionButton onClick={handleLoadFromGoogle} color="ghost" icon="CloudArrowDown" text="불러오기" loading={isSyncing}/>
                            </div>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-500"><Icon name={isDarkMode ? "Sun" : "Moon"} size={14}/></button>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <ActionButton onClick={handleCustomerUploadClick} color="brand" icon="AddressBook" text="고객"/>
                            <input type="file" ref={customerFileRef} onChange={handleCustomerFileUpload} accept=".csv" style={{display:'none'}}/>
                            <div className="relative" ref={excelMenuRef}>
                                <ActionButton onClick={()=>setIsExcelMenuOpen(!isExcelMenuOpen)} color="ghost" icon="FileXls" text="엑셀"/>
                                {isExcelMenuOpen && (
                                    <div className="absolute top-full right-0 mt-1 w-32 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border shadow-soft rounded-md z-50 py-1">
                                        <button onClick={()=>{handleDownloadCSV('full'); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="FileXls" className="text-accent-teal"/> 전체</button>
                                        <button onClick={()=>{handleDownloadCSV('invoice'); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="Truck" className="text-brand-600"/> 송장</button>
                                        <button onClick={()=>{handleDownloadProductCSV(); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 border-t border-slate-100 dark:border-dark-border mt-0.5 pt-0.5 text-slate-700 dark:text-gray-300"><Icon name="List" className="text-accent-amber"/> 발주</button>
                                    </div>
                                )}
                            </div>
                            <ActionButton onClick={handleDownloadHTML} color="white" icon="FloppyDisk" text="백업"/>
                            <ActionButton onClick={handleUploadClick} color="white" icon="UploadSimple" text="복원"/>
                            <ActionButton onClick={handleReset} color="ghost" icon="Eraser" text="초기화"/>
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                        </div>
                    </header>
                    
                    <TabNavigation activeTab={activeTab} onTabChange={setActiveTab} />
                    
                    <main className="flex-1 flex flex-col p-2 gap-2 overflow-hidden bg-[#f5f7fa] dark:bg-dark-bg">
                        {activeTab === 'home' && <HomeTab schedules={schedules} setSchedules={setSchedules} showToast={showToast} />}
                        {activeTab === 'product' && <ProductTab productHistory={productHistory} setProductHistory={setProductHistory} productCategories={productCategories} setProductCategories={setProductCategories} productNumbers={productNumbers} setProductNumbers={setProductNumbers} categoryOrder={categoryOrder} setCategoryOrder={setCategoryOrder} setOrders={setOrders} showToast={showToast} />}
                        {activeTab === 'order' && (
                            <>
                                <div className="shrink-0"><SummarySection stats={stats} handleUnpaidFilterClick={(t)=>setUnpaidFilter(unpaidFilter===t?null:t)} unpaidFilter={unpaidFilter}/></div>
                                <div className="shrink-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-[1.2fr_0.8fr_1.2fr_0.8fr] gap-2 h-64">
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col shadow-soft overflow-hidden">
                                        <div className="flex items-center justify-between px-2 pt-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20">
                                            <div className="flex gap-1">
                                                <button onClick={()=>setConverterTab('general')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${converterTab==='general' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>스피드입력</button>
                                                <button onClick={()=>setConverterTab('batch')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${converterTab==='batch' ? 'bg-white dark:bg-dark-card text-accent-rose border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>일괄입력</button>
                                            </div>
                                            <div className="pb-1 pr-1 text-slate-400"><Icon name="ClipboardList"/></div>
                                        </div>
                                        <div className="flex-1 p-2 flex flex-col gap-2 overflow-y-auto">
                                            {converterTab === 'general' ? (
                                                // 스피드 입력 - 입력 칸만 크게 남기고 변환하기 버튼 제거 (Enter 등록)
                                                <div className="relative flex-1 flex flex-col">
                                                    <textarea 
                                                        className="flex-1 w-full p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md text-xs outline-none focus:ring-2 focus:ring-blue-500 font-bold placeholder-blue-300 dark:placeholder-blue-700 transition-all resize-none min-h-[120px]" 
                                                        placeholder="스피드 주문 (예: 홍길동 사과 1)&#13;&#10;여러 줄 입력 가능, Enter 키로 등록" 
                                                        value={speedInput} 
                                                        onChange={e => setSpeedInput(e.target.value)} 
                                                        onKeyDown={handleSpeedInput} 
                                                        rows={6} // Increased rows for height
                                                    ></textarea>
                                                    <div className="absolute top-3 left-3 text-blue-400"><Icon name="Lightning" weight="fill" size={14}/></div>
                                                </div>
                                            ) : (
                                                // 일괄 입력 (기존 로직 유지)
                                                <>
                                                    <div className="flex gap-1 animate-fade-in">
                                                        <input className="w-10 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs text-center font-mono outline-none focus:border-rose-400" placeholder="코드" value={batchCode} onChange={e=>setBatchCode(e.target.value)} />
                                                        <input className="flex-1 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs font-bold outline-none focus:border-rose-400" placeholder="일괄 상품명 (예: 사과즙)" value={batchProduct} onChange={e=>setBatchProduct(e.target.value)} />
                                                        <input className="w-20 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs text-right font-bold outline-none focus:border-rose-400" placeholder="가격" type="number" value={batchPrice} onChange={e=>setBatchPrice(e.target.value)} />
                                                    </div>
                                                    <textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-md resize-none text-xs font-mono focus:border-rose-400 outline-none transition-all text-slate-700 dark:text-gray-200 placeholder-slate-400" placeholder="닉네임만 입력 (잡담 무시됨)&#13;&#10;@홍길동&#13;&#10;@김철수&#13;&#10;@박영희" value={rawInput} onChange={e => setRawInput(e.target.value)}></textarea>
                                                    <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-1.5 bg-rose-600 hover:bg-rose-700 text-white rounded-md text-xs font-bold transition-colors flex justify-center items-center gap-1 shadow-sm h-8">{isProcessing ? '처리 중...' : '일괄 등록하기'}</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                        <div className="flex justify-between items-center mb-1 px-1"><h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="Tag" className="text-brand-500"/> 최근 등록 상품 (클릭시 자동입력)</h3></div>
                                        <div className="flex-1 overflow-y-auto p-1 space-y-1">
                                            {recentProducts.length > 0 ? recentProducts.map(([name, price], i) => (
                                                <div key={i} onClick={() => handleRecentProductClick(name, price)} className="flex justify-between items-center text-xs p-1.5 bg-slate-50 dark:bg-dark-input rounded border border-slate-100 dark:border-slate-800 cursor-pointer hover:bg-brand-50 dark:hover:bg-slate-700 transition-colors group">
                                                    <span className="font-bold truncate flex-1 text-slate-700 dark:text-slate-300 group-hover:text-brand-600 dark:group-hover:text-brand-400" title={name}>{name}</span>
                                                    <span className="font-mono text-slate-500 text-[10px]">{price.toLocaleString()}원</span>
                                                </div>
                                            )) : <div className="h-full flex items-center justify-center text-slate-400 text-xs">최근 등록된 상품이 없습니다.</div>}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-1 h-full overflow-hidden">
                                        <AddressAdminPanel selectedOrder={focusedOrder} handleUpdateOrderBatch={(id, up) => setOrders(p => p.map(o => o.id===id ? {...o, ...up} : o))} showToast={showToast} />
                                    </div>
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                        <div className="flex justify-between items-center mb-1 px-1">
                                            <h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="ChatText" className="text-accent-amber"/> 카카오톡 주문서</h3>
                                            <button onClick={() => { navigator.clipboard.writeText(manualMessage); showToast("주문서가 복사되었습니다."); }} className="text-[10px] bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 px-2 py-0.5 rounded text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="Copy"/> 복사하기</button>
                                        </div>
                                        <textarea className="flex-1 w-full p-2 bg-yellow-50/50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/20 rounded-md resize-none text-xs outline-none font-mono" value={manualMessage} onChange={e => setManualMessage(e.target.value)}></textarea>
                                    </div>
                                </div>

                                <div className="flex-1 flex gap-2 min-h-0">
                                    <div className="w-40 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                                        <div className="p-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-1">
                                            <div className="relative">
                                                <input className="w-full pl-6 pr-2 py-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="주문자 검색..." value={folderSearch} onChange={e => setFolderSearch(e.target.value)} />
                                                <div className="absolute left-1.5 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={10}/></div>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">
                                            <button onClick={() => setSelectedCustomerFolder('all')} className={`w-full text-left px-2 py-1.5 text-xs rounded transition-colors flex items-center justify-between ${selectedCustomerFolder === 'all' ? 'bg-blue-50 text-blue-600 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span>전체 보기</span></button>
                                            {customerFolders.map(c => (
                                                <button key={c.name} onClick={() => handleSidebarClick(c.name)} className={`w-full text-left px-2 py-1.5 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomerFolder === c.name ? 'bg-blue-50 text-blue-600 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}>
                                                    <span className="truncate flex-1">{c.name}</span>
                                                    <div className="flex items-center gap-1">{c.unpaid && <div className="w-1.5 h-1.5 rounded-full bg-rose-500"></div>}<span className="text-[10px] text-slate-400">{c.count}</span></div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col overflow-hidden shadow-soft min-h-0">
                                        <div className="p-1.5 border-b border-slate-100 dark:border-dark-border flex items-center justify-between gap-2">
                                            <div className="relative flex-1 max-w-sm"><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div><input className="w-full pl-7 pr-2 py-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs outline-none" placeholder="검색..." value={filterText} onChange={e => setFilterText(e.target.value)}/></div>
                                            <div className="flex items-center gap-1 ml-2">
                                                <div className="flex items-center bg-slate-100 dark:bg-slate-800 rounded-sm px-1 mr-1 border border-slate-200 dark:border-slate-700"><span className="text-[10px] text-slate-500 font-bold mr-1">현재:</span><select value={currentSite} onChange={e=>setCurrentSite(e.target.value)} className="bg-transparent text-xs font-bold text-brand-700 dark:text-brand-400 outline-none h-7 min-w-[80px]">{categoryOrder.length>0 ? categoryOrder.map(c=><option key={c} value={c}>{c}</option>) : <option value="기본 창고">기본 창고</option>}</select></div>
                                                <input type="number" className="w-16 h-7 px-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs outline-none focus:border-brand-500 text-right" placeholder="배송비" value={quickShipping} onChange={e=>setQuickShipping(e.target.value)} />
                                            </div>
                                        </div>
                                        <div className="grid grid-rows-compact gap-2 px-3 py-1.5 bg-slate-100/50 dark:bg-dark-bg border-b border-slate-200 text-[10px] font-bold text-slate-500 text-center"><div>상태</div><div className="text-left">닉네임</div><div className="text-left">코드</div><div className="text-left">상품명</div><div>수량</div><div class="text-right">금액</div><div>주소</div><div className="text-left">메모</div><div></div></div>
                                        <div className="flex-1 overflow-y-auto p-0">
                                            {filteredOrders.map((order, idx) => {
                                                const isFirst = firstOrderIds[order.customer] === order.id;
                                                const isCombinedPayment = order.deposit > 0 && order.cardAmount > 0;
                                                const cashButtonClass = order.deposit > 0 ? (isCombinedPayment ? 'bg-amber-100 text-amber-700 border-amber-200 font-bold' : 'bg-teal-50 text-teal-600 border-teal-200 font-bold') : 'bg-transparent text-slate-300 border-slate-200 hover:border-slate-300';

                                                return (
                                                    <div key={order.id} onClick={() => setFocusedOrderId(order.id)} className={`grid grid-rows-compact gap-2 px-3 py-1 items-center text-xs hover:bg-slate-50 dark:hover:bg-slate-800 border-b border-slate-100 dark:border-slate-800 cursor-pointer ${focusedOrderId === order.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`}>
                                                        <div className="flex justify-center gap-1 items-center">
                                                            
                                                            {/* 1. 배송비 토글 버튼 (가장 왼쪽) */}
                                                            {isFirst ? (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); handleShippingToggle(order.id); }} 
                                                                    onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleShippingEdit(order.id); }}
                                                                    className={`px-1.5 h-4.5 rounded-sm text-[9px] font-bold transition-all border ${order.isShippingPaid ? 'bg-sky-500 text-white border-sky-600' : 'bg-transparent text-slate-300 border-slate-200 hover:border-slate-300'}`}
                                                                    title={order.isShippingPaid ? "배송비 결제 완료 (클릭 시 미결제 처리)" : "배송비 미결제 (우클릭: 개별 설정)"}
                                                                >배송</button>
                                                            ) : <span className="w-[38px]"></span>} 

                                                            {/* 2. 현금 결제 버튼 */}
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleAutoDepositFull(order.id); }} 
                                                                onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleAmountEdit(order.id); }} // 우클릭 시 인라인 편집 토글
                                                                className={`px-1.5 h-4.5 rounded-sm text-[9px] border transition-all ${cashButtonClass}`}
                                                                title="현금 완납 또는 금액 입력"
                                                            >현금</button>
                                                            
                                                            {/* 3. 카드 결제 버튼 */}
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleToggleAmountEdit(order.id); }} 
                                                                onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleAmountEdit(order.id); }}
                                                                className={`px-1.5 h-4.5 rounded-sm text-[9px] border transition-all ${order.cardAmount > 0 ? 'bg-rose-50 text-rose-600 border-rose-200 font-bold' : 'bg-transparent text-slate-300 border-slate-200 hover:border-slate-300'}`}
                                                                title="카드 결제 금액 입력 (후불)"
                                                            >카드</button>
                                                        </div>
                                                        <div className="relative"><input className="w-full bg-transparent font-bold outline-none" value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} /></div>
                                                        <div className="relative"><input className="w-full bg-transparent font-mono outline-none text-slate-500" value={productNumbers[order.product] || ''} readOnly /></div>
                                                        <div className="relative"><ProductAutocomplete id={`prod-${idx}`} value={order.product} onChange={e => handleUpdateOrder(order.id, 'product', e.target.value)} onSelect={(n, p) => handleUpdateOrder(order.id, 'product', n)} priceMap={productHistory} /></div>
                                                        <div className="flex justify-center"><input type="number" className="w-full text-center bg-transparent font-bold outline-none" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', e.target.value)} /></div>
                                                        <div className="text-right"><input className="w-full text-right bg-transparent font-mono outline-none focus:border-b focus:border-blue-500 cursor-text" defaultValue={order.price.toLocaleString()} onBlur={(e) => handlePriceBlur(order.id, e)} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }} key={order.price} /></div>
                                                        <div className="flex justify-center"><div className={`w-5 h-5 rounded-sm flex items-center justify-center cursor-default ${order.isAddressFilled ? 'bg-brand-600 text-white' : 'text-slate-300 bg-slate-100 dark:bg-slate-800'}`}><Icon name="MapPin" size={10}/></div></div>
                                                        <div><input className="w-full bg-transparent text-slate-500 outline-none" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} /></div>
                                                        <div className="flex justify-end"><button onClick={(e) => { e.stopPropagation(); handleDelete(order.id); }} className="text-slate-300 hover:text-rose-500"><Icon name="X" size={10}/></button></div>
                                                        
                                                        {/* Inline Edit Panels */}
                                                        {editingAmountId === order.id && (
                                                            <div className="col-span-full p-2 bg-slate-50 flex gap-2 justify-start pl-4 items-center border-y border-slate-100" onClick={e=>e.stopPropagation()}>
                                                                <span className="text-[10px] text-slate-500 font-bold">현금:</span>
                                                                <input 
                                                                    type="number" 
                                                                    placeholder="현금 금액" 
                                                                    className="w-20 p-1 border rounded text-xs text-right font-mono outline-none focus:border-brand-500" 
                                                                    value={order.deposit} 
                                                                    onChange={e => handleSetDepositAmount(order.id, e.target.value)} 
                                                                    onBlur={() => handleToggleAmountEdit(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') handleToggleAmountEdit(null); }}
                                                                />
                                                                <span className="text-[10px] text-slate-500 font-bold ml-4">카드:</span>
                                                                <input 
                                                                    type="number" 
                                                                    placeholder="카드 금액" 
                                                                    className="w-20 p-1 border rounded text-xs text-right font-mono outline-none focus:border-rose-500" 
                                                                    value={order.cardAmount} 
                                                                    onChange={e => handleSetCardAmount(order.id, e.target.value)}
                                                                    onBlur={() => handleToggleAmountEdit(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') handleToggleAmountEdit(null); }}
                                                                />
                                                            </div>
                                                        )}
                                                        {editingShippingId === order.id && (
                                                            <div className="col-span-full p-1.5 bg-brand-50 dark:bg-brand-900/20 border-y border-brand-100 dark:border-brand-800 flex gap-2 justify-start pl-4 items-center animate-fade-in shadow-inner" onClick={e=>e.stopPropagation()}>
                                                                <span className="text-[10px] font-bold text-brand-600 dark:text-brand-300">개별 배송비:</span>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-16 p-0.5 rounded-sm border border-brand-200 text-right font-bold text-xs text-brand-700 outline-none" 
                                                                    value={order.customShippingFee ?? quickShipping} 
                                                                    onChange={e => handleUpdateOrder(order.id, 'customShippingFee', Number(e.target.value))} 
                                                                    onBlur={() => setEditingShippingId(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') setEditingShippingId(null); }}
                                                                />
                                                                <button onClick={() => handleUpdateOrder(order.id, 'customShippingFee', null)} className="text-[10px] bg-white text-brand-600 px-2 py-0.5 rounded-sm border border-brand-200 hover:bg-brand-50">기본값</button>
                                                                <button onClick={() => setEditingShippingId(null)} className="text-[10px] bg-brand-600 text-white px-2 py-0.5 rounded-sm hover:bg-brand-700 ml-1">확인</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                        {activeTab === 'customer' && <CustomerTab customerDB={customerDB} setCustomerDB={setCustomerDB} orders={orders} showToast={showToast} />}
                        {activeTab === 'statement' && <StatementTab orders={orders} quickShipping={quickShipping} customerDB={customerDB} categoryOrder={categoryOrder} />}
                        {activeTab === 'inquiry' && <InquiryTab csRecords={csRecords} setCsRecords={setCsRecords} showToast={showToast} sites={categoryOrder} />}
                        {activeTab === 'stats' && <StatsTab orders={orders} productCategories={productCategories} />}
                    </main>
                    
                    {toast && <div className="fixed top-6 right-6 px-4 py-2.5 bg-slate-800 text-white rounded-md shadow-lg flex items-center gap-2 animate-fade-in z-[100]"><Icon name="CheckCircle" size={14} weight="fill"/><span className="text-xs">{toast.message}</span></div>}
                </div>
            );
        };
        
        try { ReactDOM.createRoot(document.getElementById('root')).render(<App />); } catch (e) { document.body.innerHTML = `<div style="color:red;padding:20px">${e.message}</div>`; }
    </script>
</body>
</html>
