<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (ì·¨ì†Œ/ìˆ˜ì • ê¸°ëŠ¥íƒ‘ì¬)</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .selected-chat { background-color: #ebf8ff; border-left: 4px solid #3182ce; opacity: 0.7; }
        .badge-pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        /* ì·¨ì†Œì„  ìŠ¤íƒ€ì¼ */
        .cancelled-item { text-decoration: line-through; color: #9ca3af; background-color: #f3f4f6; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // âœ… ì‚¬ì¥ë‹˜ì´ ì£¼ì‹  URLë¡œ ê³ ì • ì™„ë£Œ!
        const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbzEyrsKZPDtOqXHfjWhnINxtLPIj3q0CdLsNyIxViBP-bEVnxs5dN1ZFrR7zPFVFYA6FA/exec";

        const Icon = ({ name, className="" }) => <i className={`ph ph-${name} ${className}`}></i>;

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const LiveTab = ({ orders, setOrders, productHistory, setProductHistory, quickShipping, setQuickShipping, shippingOverrides, setShippingOverrides, bankAccount, setBankAccount, googleScriptUrl }) => {
            const [chats, setChats] = useState([]);
            const [deposits, setDeposits] = useState([]);
            const [clickedChats, setClickedChats] = useState(new Set());
            const [selectedNick, setSelectedNick] = useState(null); 
            const [matchedDeposits, setMatchedDeposits] = useState(new Set());
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: '' }); 

            const fetchData = async () => {
                if (!googleScriptUrl || googleScriptUrl.includes("ì—¬ê¸°ì—")) {
                    setConnectionStatus({ code: 'error_url', msg: 'ì£¼ì†Œ ë¯¸ì…ë ¥' });
                    return;
                }

                try {
                    const res = await fetch(googleScriptUrl);
                    if (!res.ok) throw new Error(`HTTP ì—ëŸ¬: ${res.status}`);
                    const text = await res.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error("ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜ (ê¶Œí•œ í™•ì¸ í•„ìš”)");
                    }
                    
                    if (data.chats) {
                        setChats(data.chats);
                        if (data.chats.length === 0) setConnectionStatus({ code: 'warning_empty', msg: 'ë°ì´í„° 0ê±´' });
                        else setConnectionStatus({ code: 'success', msg: 'ì—°ê²° ì„±ê³µ' });
                    }
                    if (data.deposits) setDeposits(data.deposits);
                    if (data.error_yt) console.error("ìœ íŠœë¸Œ ì‹œíŠ¸ ì—ëŸ¬:", data.error_yt);

                } catch (e) {
                    console.error("ì—°ê²° ì‹¤íŒ¨:", e);
                    setConnectionStatus({ code: 'error_fetch', msg: e.message });
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [googleScriptUrl]);

            const addOrderLogic = (nickname, content) => {
                const initialProduct = content || '';
                const initialPrice = productHistory[initialProduct] || 0;
                setOrders(prev => {
                    // ì·¨ì†Œë˜ì§€ ì•Šì€ ë™ì¼ ìƒí’ˆì´ ìˆëŠ”ì§€ í™•ì¸
                    const existIdx = prev.findIndex(o => o.customer === nickname && o.product === initialProduct && !o.isCancelled);
                    setSelectedNick(nickname);
                    setSearchTerm(''); 
                    if (existIdx >= 0) {
                        const next = [...prev];
                        next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + 1, price: (next[existIdx].quantity + 1) * initialPrice };
                        return next;
                    }
                    return [{ id: Date.now(), customer: nickname, product: initialProduct, quantity: 1, price: initialPrice, deposit: 0, originalText: content, isCancelled: false }, ...prev];
                });
            };

            const handleChatClick = (chat) => { setClickedChats(prev => new Set(prev).add(chat.id)); addOrderLogic(chat.nickname, chat.content); };
            const handleManualSubmit = (e) => { e.preventDefault(); if (!manualNick.trim()) return alert("ë‹‰ë„¤ì„!"); addOrderLogic(manualNick, manualProduct); setManualProduct(''); };
            
            const handleDepositClick = (deposit, index) => {
                if (matchedDeposits.has(index)) return;
                if (!selectedNick) return alert("ì˜¤ë¥¸ìª½ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                const depositAmount = Number(deposit.amount);
                setOrders(prev => {
                    const targetOrders = prev.filter(o => o.customer === selectedNick);
                    const otherOrders = prev.filter(o => o.customer !== selectedNick);
                    if (targetOrders.length === 0) return prev;
                    const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                    return [...updatedTargets, ...otherOrders];
                });
                setMatchedDeposits(prev => new Set(prev).add(index));
            };

            const handleProductChange = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id === id) {
                        const newOrder = { ...o, [field]: value };
                        if (field === 'product' && productHistory[value]) newOrder.price = newOrder.quantity * productHistory[value];
                        if (field === 'price' && o.product) { const unitPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: unitPrice })); }
                        return newOrder;
                    } return o;
                }));
            };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            
            // [NEW] ë‹‰ë„¤ì„ ìˆ˜ì • ê¸°ëŠ¥
            const handleNicknameEdit = (oldNick) => {
                const newNick = prompt(`'${oldNick}'ë‹˜ì˜ ë‹‰ë„¤ì„ì„ ë¬´ì—‡ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`, oldNick);
                if (newNick && newNick !== oldNick) {
                    setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o));
                    if (shippingOverrides[oldNick]) {
                        const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] };
                        delete newOverrides[oldNick];
                        setShippingOverrides(newOverrides);
                    }
                    if (selectedNick === oldNick) setSelectedNick(newNick);
                }
            };

            // [NEW] ì£¼ë¬¸ ì·¨ì†Œ í† ê¸€ ê¸°ëŠ¥
            const handleOrderCancel = (id) => {
                setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o));
            };

            // [NEW] ì£¼ë¬¸ ì‚­ì œ ê¸°ëŠ¥
            const handleOrderDelete = (id) => {
                if(confirm("ì´ ì£¼ë¬¸ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    setOrders(prev => prev.filter(o => o.id !== id));
                }
            };

            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance) => {
                // ì·¨ì†Œë˜ì§€ ì•Šì€ í•­ëª©ë§Œ ë³µì‚¬
                const activeItems = items.filter(i => !i.isCancelled);
                const itemListText = activeItems.map(i => `- ${i.product} ${i.quantity}ê°œ`).join('\n');
                const isPaid = balance >= 0;
                let msg = `[ì£¼ë¬¸ì„œ] ${nick}ë‹˜\n\nğŸ“¦ ì£¼ë¬¸ ë‚´ì—­\n${itemListText}\n\n`;
                msg += `ğŸ’° ì´ ê¸ˆì•¡: ${grandTotal.toLocaleString()}ì›\n`;
                if (depositTotal > 0) msg += `ğŸ’¸ ì…ê¸ˆ í™•ì¸: ${depositTotal.toLocaleString()}ì›\n`;
                if (isPaid) { msg += `âœ… ì™„ë‚©ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.`; if (balance > 0) msg += ` (ì”ì•¡ ${balance.toLocaleString()}ì›ì€ ì ë¦½)`; } 
                else { msg += `------------------\nğŸ”º ë¯¸ì…ê¸ˆì•¡: ${Math.abs(balance).toLocaleString()}ì›\n------------------\nğŸ¦ ê³„ì¢Œ: ${bankAccount}\nì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ˜Š`; }
                navigator.clipboard.writeText(msg).then(() => alert(`${nick}ë‹˜ ì£¼ë¬¸ì„œ ë³µì‚¬ ì™„ë£Œ!`));
            };

            const filteredGroupedOrders = useMemo(() => {
                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                return Object.entries(groups).filter(([nick, items]) => {
                    if (searchTerm && !nick.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                    
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    
                    // ì·¨ì†Œëœ ì£¼ë¬¸ì€ ê³„ì‚°ì—ì„œ ì œì™¸
                    const activeItems = items.filter(i => !i.isCancelled);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    
                    // ëª¨ë“  ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìœ¼ë©´ ë°°ì†¡ë¹„ë„ 0ì› ì²˜ë¦¬
                    const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                    
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + finalShipping;
                    const balance = depositTotal - grandTotal;
                    
                    const isPaid = balance >= 0 && depositTotal > 0;
                    if (filterStatus === 'unpaid' && isPaid) return false;
                    if (filterStatus === 'paid' && !isPaid) return false;
                    return true;
                });
            }, [orders, searchTerm, filterStatus, shippingOverrides, quickShipping]);

            const StatusMessage = () => {
                const { code, msg } = connectionStatus;
                if (code === 'error_fetch') return <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-2 m-2 text-xs">âš ï¸ ì—°ê²° ì‹¤íŒ¨: {msg}</div>;
                if (code === 'warning_empty') return <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 m-2 text-xs">â„¹ï¸ ë°ì´í„° 0ê±´ (ì‹œíŠ¸ ì´ë¦„ Sheet1 í™•ì¸ í•„ìš”)</div>;
                return null;
            };

            return (
                <div className="flex h-full gap-2 p-2 overflow-hidden">
                    <datalist id="product-list">{Object.keys(productHistory).map(name => <option key={name} value={name} />)}</datalist>
                    
                    {/* [ì™¼ìª½] */}
                    <div className="w-5/12 flex flex-col gap-2">
                        <div className="flex-1 bg-white border rounded-lg shadow-sm flex flex-col overflow-hidden">
                            <div className="p-2 bg-red-50 border-b font-bold text-red-600 flex flex-col gap-1">
                                <div className="flex justify-between items-center"><span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span></div>
                                <div className="flex items-center gap-2 text-xs text-gray-500 font-normal mt-1">
                                    <span>ë°°ì†¡ë¹„: <input type="number" value={quickShipping} onChange={(e)=>setQuickShipping(Number(e.target.value))} className="w-12 border rounded px-1 text-right" />ì›</span>
                                    <span>| ê³„ì¢Œ: <input type="text" value={bankAccount} onChange={(e)=>setBankAccount(e.target.value)} className="w-32 border rounded px-1" placeholder="ê³„ì¢Œ ì…ë ¥" /></span>
                                </div>
                            </div>
                            <StatusMessage />
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {chats.map(chat => (
                                    <div key={chat.id} onClick={() => handleChatClick(chat)} className={`p-2 border rounded cursor-pointer hover:bg-gray-50 transition-all ${clickedChats.has(chat.id) ? 'selected-chat' : 'bg-white'}`}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="font-bold text-gray-700">{chat.nickname}</span>
                                            <span className="text-gray-400">{chat.time ? new Date(chat.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                        </div>
                                        <div className="text-sm text-gray-800">{chat.content}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="h-1/3 bg-white border rounded-lg shadow-sm flex flex-col overflow-hidden">
                            <div className="p-2 bg-yellow-50 border-b font-bold text-yellow-700 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="money" weight="fill"/> ì…ê¸ˆ ë‚´ì—­</span>
                                <span className="text-xs text-gray-500">{selectedNick ? `ğŸ¯ '${selectedNick}'ë‹˜ ì„ íƒë¨` : "ë‹‰ë„¤ì„ ì„ íƒ í•„ìš”"}</span>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1 bg-yellow-50/30">
                                {deposits.map((d, i) => {
                                    const isUsed = matchedDeposits.has(i);
                                    const isSuggested = selectedNick && d.name.includes(selectedNick.replace(/ /g,''));
                                    return (
                                        <div key={i} onClick={() => handleDepositClick(d, i)} className={`flex justify-between p-2 border rounded cursor-pointer transition-all ${isUsed ? 'opacity-40 bg-gray-100 line-through' : ''} ${isSuggested && !isUsed ? 'bg-yellow-100 border-yellow-400 ring-1' : 'bg-white hover:bg-yellow-50'}`}>
                                            <span className="text-gray-700">{d.name}</span>
                                            <span className="font-mono text-blue-600">+{Number(d.amount).toLocaleString()}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* [ì˜¤ë¥¸ìª½] */}
                    <div className="w-7/12 bg-gray-100 border rounded-lg flex flex-col overflow-hidden">
                        <div className="p-2 bg-white border-b font-bold text-indigo-700 shadow-sm flex flex-col gap-2">
                            <div className="flex justify-between items-center">
                                <span>ğŸ“¦ ì£¼ë¬¸ì„œ ({filteredGroupedOrders.length}ëª…)</span>
                                <div className="flex bg-gray-100 rounded p-0.5 gap-0.5 text-xs">
                                    <button onClick={()=>setFilterStatus('all')} className={`px-2 py-1 rounded ${filterStatus==='all' ? 'bg-white shadow text-indigo-600 font-bold':'text-gray-500'}`}>ì „ì²´</button>
                                    <button onClick={()=>setFilterStatus('unpaid')} className={`px-2 py-1 rounded ${filterStatus==='unpaid' ? 'bg-white shadow text-red-600 font-bold':'text-gray-500'}`}>ğŸ”ºë¯¸ì…ê¸ˆ</button>
                                    <button onClick={()=>setFilterStatus('paid')} className={`px-2 py-1 rounded ${filterStatus==='paid' ? 'bg-white shadow text-green-600 font-bold':'text-gray-500'}`}>âœ…ì™„ë‚©</button>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1 flex gap-2 items-center bg-indigo-50 p-2 rounded border border-indigo-100">
                                    <span className="text-xs font-bold text-indigo-600 whitespace-nowrap">ğŸ–ï¸ ì¶”ê°€:</span>
                                    <form onSubmit={handleManualSubmit} className="flex gap-1 w-full">
                                        <input type="text" placeholder="ë‹‰ë„¤ì„" value={manualNick} onChange={e => setManualNick(e.target.value)} className="w-24 border rounded px-2 py-1 text-sm outline-none" />
                                        <input type="text" list="product-list" placeholder="ìƒí’ˆëª…" value={manualProduct} onChange={e => setManualProduct(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm outline-none" />
                                        <button type="submit" className="bg-indigo-600 text-white px-2 py-1 rounded text-sm font-bold hover:bg-indigo-700">ï¼‹</button>
                                    </form>
                                </div>
                                <div className="w-1/3 relative">
                                    <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                    <input type="text" placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full h-full pl-8 pr-2 border rounded text-sm outline-none" />
                                    {searchTerm && <button onClick={()=>setSearchTerm('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill"/></button>}
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-3">
                            {filteredGroupedOrders.map(([nick, items]) => {
                                const isSelected = selectedNick === nick;
                                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                                
                                // í™œì„± ì•„ì´í…œë§Œ ê³„ì‚°
                                const activeItems = items.filter(i => !i.isCancelled);
                                const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                                const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                                
                                // ë‹¤ ì·¨ì†Œí–ˆìœ¼ë©´ ë°°ì†¡ë¹„ë„ 0ì›
                                const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                                const grandTotal = productTotal + finalShipping;
                                const balance = depositTotal - grandTotal;
                                
                                let statusBadge;
                                if (depositTotal === 0) statusBadge = <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded text-xs font-bold">ë¯¸ì…ê¸ˆ</span>;
                                else if (balance >= 0) statusBadge = <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">âœ… ì™„ë‚©</span>;
                                else statusBadge = <span className="bg-orange-100 text-orange-600 px-2 py-0.5 rounded text-xs font-bold badge-pulse">ğŸ”º {Math.abs(balance).toLocaleString()}ì› ë¶€ì¡±</span>;

                                return (
                                    <div key={nick} onClick={() => setSelectedNick(prev => prev === nick ? null : nick)} className={`bg-white rounded-xl border shadow-sm transition-all overflow-hidden cursor-pointer ${isSelected ? 'ring-2 ring-indigo-500 shadow-md' : 'hover:border-indigo-300'}`}>
                                        <div className={`p-3 flex justify-between items-center ${isSelected ? 'bg-indigo-50' : 'bg-gray-50'} border-b`}>
                                            <div className="flex items-center gap-2 group">
                                                <span className="font-bold text-lg text-gray-800">{nick}</span>
                                                {/* âœï¸ ë‹‰ë„¤ì„ ìˆ˜ì • ë²„íŠ¼ */}
                                                <button onClick={(e)=>{e.stopPropagation(); handleNicknameEdit(nick);}} className="text-gray-400 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="pencil-simple" weight="bold"/></button>
                                                <span className="text-xs bg-white border px-1.5 rounded text-gray-500">{items.length}ê±´</span>
                                            </div>
                                            <div className="text-right flex items-center gap-3">
                                                <div className="text-xs text-gray-500 text-right"><div>ìƒí’ˆ {productTotal.toLocaleString()} + ë°°ì†¡ {finalShipping.toLocaleString()}</div><div className="font-bold text-lg font-mono text-gray-800">{grandTotal.toLocaleString()}ì›</div></div>
                                                <div className="flex flex-col gap-1 items-end">{statusBadge}<button onClick={(e) => { e.stopPropagation(); copyOrderSheet(nick, items, grandTotal, depositTotal, balance); }} className="bg-yellow-300 hover:bg-yellow-400 text-black px-2 py-1 rounded text-xs font-bold flex items-center gap-1 shadow-sm"><Icon name="chat-circle-dots" weight="fill"/> ì¹´í†¡ë³µì‚¬</button></div>
                                            </div>
                                        </div>
                                        <div className="p-2 space-y-1">
                                            {items.map((item, idx) => (
                                                <div key={idx} className={`flex justify-between items-center text-sm p-1.5 hover:bg-gray-50 rounded group ${item.isCancelled ? 'cancelled-item' : ''}`}>
                                                    <div className="flex-1 flex gap-2 items-center">
                                                        <input type="text" list="product-list" value={item.product} onChange={(e) => handleProductChange(item.id, 'product', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-full border-b border-dashed border-gray-300 bg-transparent focus:border-indigo-500 focus:bg-white outline-none px-1 py-0.5" placeholder="ìƒí’ˆëª…" disabled={item.isCancelled} />
                                                    </div>
                                                    <div className="flex items-center gap-2 pl-2">
                                                        <span className="font-bold text-indigo-600 bg-indigo-50 px-2 rounded text-xs shrink-0">{item.quantity}ê°œ</span>
                                                        <input type="number" value={item.price} onChange={(e) => handleProductChange(item.id, 'price', e.target.value)} onClick={(e) => e.stopPropagation()} className="w-20 text-right font-mono text-gray-500 border-b border-transparent hover:border-gray-300 focus:border-indigo-500 bg-transparent outline-none" disabled={item.isCancelled} />
                                                        
                                                        {/* ğŸš« ì·¨ì†Œ / ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ */}
                                                        <div className="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderCancel(item.id);}} className={`p-1 rounded ${item.isCancelled ? 'bg-gray-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600'}`} title={item.isCancelled ? "ì·¨ì†Œ ë³µêµ¬" : "ì£¼ë¬¸ ì·¨ì†Œ"}>
                                                                <Icon name={item.isCancelled ? "arrow-u-up-left" : "prohibit"} weight="bold"/>
                                                            </button>
                                                            <button onClick={(e)=>{e.stopPropagation(); handleOrderDelete(item.id);}} className="p-1 rounded bg-gray-200 text-gray-600 hover:bg-red-500 hover:text-white" title="ì™„ì „ ì‚­ì œ">
                                                                <Icon name="trash" weight="bold"/>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="flex justify-end items-center gap-2 px-2 py-1 text-xs text-gray-400">ë°°ì†¡ë¹„ ìˆ˜ì •: <input type="number" value={currentShipping} onClick={(e)=>e.stopPropagation()} onChange={(e)=>handleShippingChange(nick, e.target.value)} className="w-12 text-right border rounded bg-white px-1 focus:ring-1 focus:ring-indigo-500" /></div>
                                            {depositTotal > 0 && (<div className="mt-2 pt-2 border-t border-dashed flex justify-between text-sm text-green-600 font-bold px-2"><span>â”” ì…ê¸ˆí™•ì¸ì•¡</span><span>{depositTotal.toLocaleString()}ì›</span></div>)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const OrderManagementTab = ({ orders, shippingOverrides, quickShipping }) => {
            const handleExportProducts = () => {
                const summary = {}; orders.forEach(o => { 
                    if(o.isCancelled) return; // ì·¨ì†Œëœ ê±´ ì œì™¸
                    const name = o.product || '(ìƒí’ˆëª… ì—†ìŒ)'; if (!summary[name]) summary[name] = 0; summary[name] += Number(o.quantity); 
                });
                const data = Object.entries(summary).map(([product, qty]) => ({ 'ìƒí’ˆëª…': product, 'ì´í•„ìš”ìˆ˜ëŸ‰': qty }));
                downloadExcel(data, 'ìƒí’ˆë³„_ë°œì£¼ë¦¬ìŠ¤íŠ¸');
            };
            const handleExportCustomers = () => {
                const groups = {}; orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                const data = Object.entries(groups).map(([nick, items]) => {
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    
                    const activeItems = items.filter(i => !i.isCancelled);
                    if(activeItems.length === 0) return null; // ì·¨ì†Œëœ ì£¼ë¬¸ë§Œ ìˆìœ¼ë©´ ì—‘ì…€ì—ì„œ ëºŒ

                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + currentShipping;
                    const balance = depositTotal - grandTotal;
                    const itemSummary = activeItems.map(i => `${i.product}(${i.quantity})`).join(', ');
                    return { 'ë‹‰ë„¤ì„': nick, 'ì£¼ë¬¸ë‚´ì—­': itemSummary, 'ìƒí’ˆí•©ê³„': productTotal, 'ë°°ì†¡ë¹„': currentShipping, 'ì´ì£¼ë¬¸ê¸ˆì•¡': grandTotal, 'ì…ê¸ˆí™•ì¸ì•¡': depositTotal, 'ì”ì•¡(ë¯¸ìˆ˜ê¸ˆ)': -balance, 'ìƒíƒœ': balance >= 0 ? 'ì™„ë‚©' : 'ë¯¸ë‚©' };
                }).filter(d => d !== null);
                downloadExcel(data, 'ê³ ê°ë³„_ì •ì‚°ë¦¬ìŠ¤íŠ¸');
            };
            return (
                <div className="flex flex-col items-center justify-center h-full p-10 gap-6">
                    <div className="bg-white p-8 rounded-xl shadow-lg border text-center w-full max-w-md">
                        <div className="text-4xl mb-4">ğŸ“¦</div><h2 className="text-xl font-bold mb-2">ë°œì£¼ìš© í’ˆëª© ì§‘ê³„</h2><p className="text-gray-500 mb-6 text-sm">ì–´ë–¤ ìƒí’ˆì´ ëª‡ ê°œ í•„ìš”í•œì§€ ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.</p>
                        <button onClick={handleExportProducts} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"><Icon name="file-xls" weight="fill" size={20}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div className="bg-white p-8 rounded-xl shadow-lg border text-center w-full max-w-md">
                        <div className="text-4xl mb-4">ğŸ‘¥</div><h2 className="text-xl font-bold mb-2">ê³ ê°ë³„ ì •ì‚° ë¦¬ìŠ¤íŠ¸</h2><p className="text-gray-500 mb-6 text-sm">ë‹‰ë„¤ì„ë³„ ì£¼ë¬¸, ì…ê¸ˆ, ë°°ì†¡ë¹„ë¥¼ ì •ë¦¬í•´ë“œë¦½ë‹ˆë‹¤.</p>
                        <button onClick={handleExportCustomers} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2"><Icon name="file-xls" weight="fill" size={20}/> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            const [activeTab, setActiveTab] = useState('live');
            const [quickShipping, setQuickShipping] = useState(4000); 
            const [bankAccount, setBankAccount] = useState(() => localStorage.getItem('bankAccount') || "ì¹´ì¹´ì˜¤ë±…í¬ 000-0000-0000");
            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [shippingOverrides, setShippingOverrides] = useState(() => JSON.parse(localStorage.getItem('shippingOverrides')) || {});

            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('bankAccount', bankAccount); }, [bankAccount]);
            useEffect(() => { localStorage.setItem('shippingOverrides', JSON.stringify(shippingOverrides)); }, [shippingOverrides]);

            const tabs = [{ id: 'live', label: 'ğŸ¥ ë¼ì´ë¸Œê´€ì œ', icon: 'monitor-play' }, { id: 'manage', label: 'ğŸ“Š ì£¼ë¬¸ê´€ë¦¬(ì—‘ì…€)', icon: 'file-xls' }];

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700">
                    <header className="h-12 bg-indigo-900 text-white flex items-center justify-between px-4 shrink-0 shadow-md">
                        <div className="font-bold text-lg flex items-center gap-2"><Icon name="lightning" className="text-yellow-400" weight="fill"/> ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO</div>
                        <div className="flex bg-indigo-800 rounded p-1 gap-1">
                            {tabs.map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1 transition-all ${activeTab === tab.id ? 'bg-white text-indigo-900 shadow' : 'text-indigo-300 hover:text-white'}`}><Icon name={tab.icon} weight="bold"/> {tab.label}</button>
                            ))}
                        </div>
                    </header>
                    <main className="flex-1 overflow-hidden bg-gray-100">
                        {activeTab === 'live' && (<LiveTab orders={orders} setOrders={setOrders} productHistory={productHistory} setProductHistory={setProductHistory} quickShipping={quickShipping} setQuickShipping={setQuickShipping} shippingOverrides={shippingOverrides} setShippingOverrides={setShippingOverrides} bankAccount={bankAccount} setBankAccount={setBankAccount} googleScriptUrl={GOOGLE_API_URL} />)}
                        {activeTab === 'manage' && (<OrderManagementTab orders={orders} shippingOverrides={shippingOverrides} quickShipping={quickShipping} />)}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
