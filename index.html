<html lang="ko" class="antialiased"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강은지 주문서 PRO (Lite) - v2.18 (중복제거/절취선고정)</title>
    
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparser.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'],
                        mono: ['Pretendard', 'monospace'],
                    },
                    colors: {
                        brand: { 50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1', 500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43' },
                        accent: { rose: '#d64545', teal: '#3ebd93', amber: '#f0b429', indigo: '#5c7cfa' },
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        dark: { bg: '#121212', card: '#1e1e1e', border: '#2c2c2c', input: '#252525' }
                    },
                    boxShadow: { 'soft': '0 1px 3px 0 rgba(0, 0, 0, 0.05)', 'inner-soft': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.03)' },
                    fontSize: { 'xxs': '0.65rem' },
                    animation: { spin: 'spin 1s linear infinite' },
                    screens: {
                        'print': {'raw': 'print'},
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
        body { font-family: 'NanumSquareNeo', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f5f7fa; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        *:focus { outline: none !important; }
        
        .grid-rows-compact { grid-template-columns: 75px 100px 70px 1.8fr 50px 80px 30px 1fr 30px; }
        .dragging { opacity: 0.5; border: 2px dashed #627d98; }
        
        /* --- 인쇄 전용 스타일 --- */
        @media print {
            @page { 
                size: A4; 
                margin: 0 !important;
            }
            
            html, body {
                width: 210mm;
                height: 297mm;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
            }

            /* 모든 요소 숨김 */
            body * {
                visibility: hidden;
            }

            /* 인쇄 영역 클래스(.print-section)와 그 자식들만 표시 */
            .print-section, .print-section * {
                visibility: visible !important;
            }

            /* 인쇄 영역 위치 강제 고정 */
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }

            .no-print { display: none !important; }

            .page-break { 
                page-break-after: always !important;
                break-after: page !important;
            }

            .a4-page-print {
                width: 210mm !important;
                height: 297mm !important;
                page-break-after: always !important;
                overflow: hidden !important;
                background: white !important;
                position: relative !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .a4-page-print:last-child {
                page-break-after: auto !important;
            }
        }

        .tab-content { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
        [contenteditable="true"]:focus { outline: 2px dashed #627d98; background-color: rgba(98, 125, 152, 0.05); border-radius: 4px; padding: 2px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 300px; max-width: 90%; }
        .dark .modal-content { background: #1e1e1e; border: 1px solid #333; color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        const parseNum = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            const firstLine = String(val).split('\n')[0].replace(/,/g, '');
            const num = parseFloat(firstLine);
            return isNaN(num) ? 0 : num;
        };

        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            
            const rawPrice = parseNum(order.price !== undefined ? order.price : 0);
            const rawQty = parseNum(order.quantity !== undefined ? order.quantity : 1);

            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: rawQty,
                price: rawPrice,
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                addressDetail: order.addressDetail || '',
                shippingMemo: order.shippingMemo || '',
                isCRM: !!order.isCRM,
            };
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 14, className = "", weight = "regular", spin = false }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls", Sun: "ph-sun", Lightning: "ph-lightning",
                Star: "ph-star", Users: "ph-users", AddressBook: "ph-address-book", CloudArrowUp: "ph-cloud-arrow-up", CloudArrowDown: "ph-cloud-arrow-down",
                Gear: "ph-gear", Spinner: "ph-spinner", Printer: "ph-printer", House: "ph-house",
                Tag: "ph-tag", ChatCircle: "ph-chat-circle", ChartPie: "ph-chart-pie", Warehouse: "ph-warehouse",
                Folder: "ph-folder", FolderOpen: "ph-folder-open", CaretUp: "ph-caret-up", Headset: "ph-headset",
                ArrowCounterClockwise: "ph-arrow-counter-clockwise", ArrowsLeftRight: "ph-arrows-left-right", Calendar: "ph-calendar",
                DotsSixVertical: "ph-dots-six-vertical", ChatText: "ph-chat-text", Link: "ph-link", Robot: "ph-robot", UserFocus: "ph-user-focus",
                FileCsv: "ph-file-csv", CaretRight: "ph-caret-right", DownloadSimple: "ph-download-simple", CaretLeft: "ph-caret-left",
                Trophy: "ph-trophy", PaperPlaneTilt: "ph-paper-plane-tilt"
            };
            const weightClass = weight === 'bold' ? 'ph-bold' : (weight === 'fill' ? 'ph-fill' : 'ph');
            const spinClass = spin ? 'animate-spin' : '';
            return <i className={`${weightClass} ${map[name] || 'ph-question'} ${className} ${spinClass}`} style={{ fontSize: size }}></i>;
        });

        const ActionButton = React.memo(({ onClick, color, icon, text, active, className, loading }) => {
            const base = "px-2 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-all border shadow-sm h-7";
            const colors = {
                brand: "bg-brand-600 text-white border-brand-700 hover:bg-brand-700",
                white: "bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border-slate-200 dark:border-dark-border hover:bg-slate-50 hover:text-brand-700",
                dark: "bg-brand-800 text-white border-brand-900 hover:bg-brand-900",
                ghost: "bg-transparent text-slate-500 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800",
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${colors[color] || colors.white} ${active ? 'ring-1 ring-brand-500' : ''} ${className} ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                    {loading ? <Icon name="Spinner" size={12} spin={true}/> : <Icon name={icon} size={12} weight="bold"/>} {text}
                </button>
            );
        });

        // --- DASHBOARD COMPONENT ---
        const SummarySection = React.memo(({ stats, handleUnpaidFilterClick, unpaidFilter }) => {
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm w-full grid grid-cols-4 divide-x divide-slate-100 dark:divide-slate-700 h-auto overflow-hidden">
                    <div className="px-4 py-1 flex flex-col justify-center items-start text-left min-w-0">
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider block mb-0.5">총 예상 매출</span>
                        <div className="flex items-baseline gap-1">
                            <span className="text-3xl font-extrabold text-blue-900 dark:text-blue-100 font-mono tracking-tight truncate">{stats.totalRev.toLocaleString()}</span>
                            <span className="text-sm text-slate-400 font-bold">원</span>
                        </div>
                    </div>
                    <div className="px-4 py-1 flex flex-col justify-center gap-0 min-w-0">
                        <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                            <div className="flex items-center gap-2 text-slate-500"><Icon name="Money" size={16} className="text-amber-500" weight="bold"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">현금</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalCash.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                            <div className="flex items-center gap-2 text-slate-500"><Icon name="CreditCard" size={16} className="text-purple-500" weight="bold"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">카드</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalCard.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center text-slate-600 dark:text-slate-300">
                            <div className="flex items-center gap-2 text-slate-500"><Icon name="Truck" size={16} className="text-sky-500" weight="bold"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">배송</span></div><span className="font-bold text-lg font-mono leading-none">{stats.totalShipping.toLocaleString()}</span>
                        </div>
                    </div>
                    <div className="px-4 py-1 flex flex-col justify-center gap-1 min-w-0">
                        <div className="flex justify-between items-center text-slate-700 dark:text-slate-300 px-1 py-0.5">
                            <div className="flex items-center gap-2 text-slate-500"><Icon name="Package" size={18} className="text-indigo-500" weight="fill"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">주문</span></div><span className="font-bold font-mono text-xl leading-none">{stats.qty}<span className="text-xs font-normal text-slate-400 ml-0.5">개</span></span>
                        </div>
                        <div className="flex justify-between items-center text-slate-700 dark:text-slate-300 px-1 py-0.5">
                            <div className="flex items-center gap-2 text-slate-500"><Icon name="PaperPlaneTilt" size={18} className="text-teal-500" weight="fill"/><span className="text-sm font-bold text-slate-600 dark:text-slate-400">배송</span></div><span className="font-bold font-mono text-xl leading-none">{stats.shippingCount}<span className="text-xs font-normal text-slate-400 ml-0.5">건</span></span>
                        </div>
                    </div>
                    <div className="px-4 py-1 flex flex-col justify-center gap-1 min-w-0">
                        <div className={`flex justify-between items-center text-sm px-2 py-0.5 rounded cursor-pointer transition-all ${unpaidFilter === 'cash' ? 'bg-rose-500 text-white font-bold shadow-md transform scale-[1.02]' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`} onClick={() => handleUnpaidFilterClick('cash')}>
                            <div className="flex items-center gap-2"><Icon name="HandCoins" size={18} className={unpaidFilter === 'cash' ? 'text-white' : 'text-rose-500'} weight="fill"/><span className={`${unpaidFilter === 'cash' ? 'text-white' : 'text-slate-600 dark:text-slate-400'} font-bold text-sm`}>물품미수금</span></div><span className={`font-mono text-lg leading-none ${unpaidFilter !== 'cash' && stats.productUnpaid > 0 ? 'text-rose-600 font-bold' : ''}`}>{stats.productUnpaid.toLocaleString()}</span>
                        </div>
                        <div className={`flex justify-between items-center text-sm px-2 py-0.5 rounded cursor-pointer transition-all ${unpaidFilter === 'ship' ? 'bg-orange-500 text-white font-bold shadow-md transform scale-[1.02]' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`} onClick={() => handleUnpaidFilterClick('ship')}>
                            <div className="flex items-center gap-2"><Icon name="Truck" size={18} className={unpaidFilter === 'ship' ? 'text-white' : 'text-orange-500'} weight="fill"/><span className={`${unpaidFilter === 'ship' ? 'text-white' : 'text-slate-600 dark:text-slate-400'} font-bold text-sm`}>배송미수금</span></div><span className={`font-mono text-lg leading-none ${unpaidFilter !== 'ship' && stats.shipUnpaid > 0 ? 'text-orange-600 font-bold' : ''}`}>{stats.shipUnpaid.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            );
        });

        const TabNavigation = ({ activeTab, onTabChange }) => {
            const tabs = [
                { id: 'order', label: '주문관리', icon: 'ClipboardList' },
                { id: 'customer', label: '고객관리', icon: 'User' },
                { id: 'statement', label: '구매내역서', icon: 'Receipt' },
            ];
            return (
                <div className="flex items-end px-2 pt-1 border-b border-slate-200 dark:border-dark-border bg-white dark:bg-dark-card shrink-0 gap-1 overflow-x-auto no-scrollbar">
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => onTabChange(tab.id)} className={`flex items-center gap-1.5 px-3 py-2 text-xs font-bold rounded-t-lg transition-all border-t border-x relative top-[1px] ${activeTab === tab.id ? 'bg-[#f5f7fa] dark:bg-dark-bg border-slate-200 dark:border-dark-border border-b-[#f5f7fa] dark:border-b-dark-bg text-brand-600 dark:text-brand-400 z-10' : 'bg-slate-50 dark:bg-dark-input border-transparent text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'}`}>
                            <Icon name={tab.icon} size={14} weight={activeTab === tab.id ? 'fill' : 'regular'} /><span>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const AddressAdminPanel = ({ selectedOrder, handleUpdateOrderBatch, showToast }) => {
            const [localAddr, setLocalAddr] = useState({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' });
            const [tab, setTab] = useState('input');
            const [rawText, setRawText] = useState('');
            useEffect(() => { if (selectedOrder) { setLocalAddr({ recipientName: selectedOrder.recipientName || '', phone: selectedOrder.phone || '', addressText: selectedOrder.addressText || '', addressDetail: selectedOrder.addressDetail || '', shippingMemo: selectedOrder.shippingMemo || '' }); setRawText(''); } else { setLocalAddr({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' }); } }, [selectedOrder]);
            const handleChange = (field, val) => setLocalAddr(prev => ({...prev, [field]: val}));
            const handleSave = () => { if (!selectedOrder) return; handleUpdateOrderBatch(selectedOrder.id, localAddr); showToast('주소 정보 저장 완료'); };
            const handlePostcode = () => { try { new daum.Postcode({ oncomplete: function(data) { setLocalAddr(prev => ({ ...prev, zipCode: data.zonecode, addressText: data.address, addressDetail: '' })); } }).open(); } catch(e) { showToast("팝업이 차단되었습니다.", "error"); } };
            const handleParseRaw = () => { if (!rawText.trim()) return; let text = rawText; let name = '', phone = '', address = '', memo = ''; const phoneMatch = text.match(/(01[016789])[- .]?(\d{3,4})[- .]?(\d{4})/); if (phoneMatch) { phone = phoneMatch[0]; text = text.replace(phone, ''); } const zipMatch = text.match(/\d{5}/); if(zipMatch) text = text.replace(zipMatch[0], ''); const lines = text.split('\n').map(l => l.trim()).filter(Boolean); lines.forEach(line => { if (line.match(/^(이름|수령인|받는분):?/)) name = line.replace(/^(이름|수령인|받는분):?/, '').trim();else if (line.match(/^(주소|배송지):?/)) address = line.replace(/^(주소|배송지):?/, '').trim();else if (line.match(/^(메모|요청사항):?/)) memo = line.replace(/^(메모|요청사항):?/, '').trim(); }); if (!name && lines.length > 0) name = lines[0]; if (!address && lines.length > 1) address = lines.find(l => l !== name && l.match(/[시도구군길로]/)) || lines[1]; setLocalAddr(prev => ({ ...prev, recipientName: name || prev.recipientName, phone: phone || prev.phone, addressText: address || prev.addressText, shippingMemo: memo || prev.shippingMemo })); setTab('edit'); showToast("정보가 입력되었습니다."); };
            
            if (!selectedOrder) { return (<div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col h-full shadow-soft items-center justify-center text-slate-400 text-xs"><Icon name="MapPin" size={24} className="mb-2 opacity-50"/><p>주문을 선택해주세요</p></div>); }
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col h-full shadow-soft overflow-hidden">
                    <div className="flex items-center justify-between px-2 pt-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 shrink-0"><div className="flex gap-1"><button onClick={()=>setTab('input')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='input' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>정보 붙여넣기</button><button onClick={()=>setTab('edit')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='edit' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>상세 수정</button></div><span className="text-[9px] text-slate-400 font-mono pb-1 pr-1">#{selectedOrder.id.toString().slice(-4)}</span></div>
                    <div className="flex-1 overflow-y-auto p-2">{tab === 'input' ? (<div className="h-full flex flex-col gap-2"><textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs resize-none outline-none focus:border-brand-500 placeholder-slate-400" placeholder={`예시:\n홍길동\n010-1234-5678\n서울시 강남구...`} value={rawText} onChange={e => setRawText(e.target.value)}></textarea><button onClick={handleParseRaw} className="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white rounded text-xs font-bold transition-colors">자동 입력</button></div>) : (<div className="space-y-2"><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">수령인</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.recipientName} onChange={e=>handleChange('recipientName', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">연락처</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.phone} onChange={e=>handleChange('phone', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">주소</label><div className="flex-1 flex flex-col gap-1"><div className="relative w-full"><input className="w-full p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 pr-6" value={localAddr.addressText} onChange={e=>handleChange('addressText', e.target.value)} /><button onClick={handlePostcode} className="absolute right-1 top-1 text-slate-400 hover:text-brand-600"><Icon name="Search" size={10}/></button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={localAddr.addressDetail} onChange={e=>handleChange('addressDetail', e.target.value)} /></div></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">배송메모</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.shippingMemo} onChange={e=>handleChange('shippingMemo', e.target.value)} /></div><div className="pt-2 text-right"><button onClick={handleSave} className="bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors shadow-sm">저장</button></div></div>)}</div></div>
            );
        };

        const CustomerTab = ({ customerDB, setCustomerDB, orders, showToast }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [search, setSearch] = useState('');
            const fileInputRef = useRef(null);
            const allCustomers = useMemo(() => { const orderCustomers = new Set(orders.map(o => o.customer)); const dbCustomers = Object.keys(customerDB); const merged = new Set([...orderCustomers, ...dbCustomers]); return Array.from(merged).filter(c => c && c.toLowerCase().includes(search.toLowerCase())).sort(); }, [orders, customerDB, search]);
            const customerOrders = useMemo(() => { if (!selectedCustomer) return []; return orders.filter(o => o.customer === selectedCustomer).sort((a,b) => b.id - a.id); }, [orders, selectedCustomer]);
            const handleUpdateCustomer = (field, value) => { if (!selectedCustomer) return; setCustomerDB(prev => ({ ...prev, [selectedCustomer]: { ...prev[selectedCustomer], [field]: value } })); };
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['닉네임'] || row['Nickname'] || row['이름'] || row['성함']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['수령인'] || row['받는분'] || row['이름'] || nick.trim(), phone: row['연락처'] || row['전화번호'] || row['휴대폰'] || '', zipCode: row['우편번호'] || row['Zip'] || '', addressText: row['주소'] || row['Address'] || row['기본주소'] || '', addressDetail: row['상세주소'] || '', shippingMemo: row['배송메모'] || row['배송요청사항'] || row['메모'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`총 ${count}명 고객 등록 완료`, 'success'); } }); e.target.value = null; };
            const handleFileDownload = () => { const rows = Object.entries(customerDB).map(([nick, info]) => ({ '닉네임': nick, '수령인': info.recipientName, '연락처': info.phone, '우편번호': info.zipCode, '주소': info.addressText, '상세주소': info.addressDetail, '배송메모': info.shippingMemo })); const csv = Papa.unparse(rows); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', `고객목록_${new Date().toISOString().slice(0, 10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const currentInfo = customerDB[selectedCustomer] || {};

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="AddressBook" size={14}/> 고객 목록</h3><div className="flex gap-1"><button onClick={() => fileInputRef.current.click()} className="text-[10px] bg-brand-600 text-white px-2 py-1 rounded hover:bg-brand-700 flex items-center gap-1"><Icon name="FileCsv"/> 업로드</button><button onClick={handleFileDownload} className="text-[10px] bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 flex items-center gap-1"><Icon name="DownloadSimple"/> 다운</button></div><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} /></div>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="고객명 검색..." value={search} onChange={e => setSearch(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">{allCustomers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold dark:bg-brand-900/30 dark:text-brand-400' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span className="truncate">{c}</span>{customerDB[c] && <Icon name="CheckCircle" size={10} className="text-emerald-500"/>}</button>))}</div>
                    </div>
                    <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                        {selectedCustomer ? (
                            <>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-4"><h3 className="text-sm font-bold mb-4 flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2"><div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center"><Icon name="User"/></div>{selectedCustomer} 님의 정보</h3><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-slate-500 block mb-1">수령인</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.recipientName || ''} onChange={e => handleUpdateCustomer('recipientName', e.target.value)} /></div><div><label className="text-xs text-slate-500 block mb-1">연락처</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.phone || ''} onChange={e => handleUpdateCustomer('phone', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">주소</label><div className="flex gap-2 mb-1"><input className="flex-1 p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.addressText || ''} onChange={e => handleUpdateCustomer('addressText', e.target.value)} /><button onClick={() => { try { new daum.Postcode({ oncomplete: (data) => { handleUpdateCustomer('zipCode', data.zonecode); handleUpdateCustomer('addressText', data.address); } }).open(); } catch(e) { showToast("주소 검색 팝업 차단됨", "error"); } }} className="bg-slate-100 px-3 rounded text-xs hover:bg-slate-200">검색</button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={currentInfo.addressDetail || ''} onChange={e => handleUpdateCustomer('addressDetail', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">배송메모</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.shippingMemo || ''} onChange={e => handleUpdateCustomer('shippingMemo', e.target.value)} /></div></div></div>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex-1 flex flex-col overflow-hidden"><div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="Clock"/> 주문 이력</h3></div><div className="flex-1 overflow-y-auto"><table className="w-full text-xs text-left"><thead className="bg-slate-50 dark:bg-dark-input text-slate-500 border-b dark:border-slate-700 sticky top-0"><tr><th className="p-2">날짜</th><th className="p-2">상품명</th><th className="p-2">수량</th><th className="p-2 text-right">금액</th><th className="p-2 text-center">상태</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-800">{customerOrders.map(o => (<tr key={o.id}><td className="p-2 text-slate-400">{new Date(o.id).toLocaleDateString()}</td><td className="p-2 font-bold">{o.product}</td><td className="p-2">{o.quantity}</td><td className="p-2 text-right font-mono">{o.price.toLocaleString()}</td><td className="p-2 text-center"><span className={`px-2 py-0.5 rounded-full ${o.isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{o.isPaid ? '결제완료' : '미결제'}</span></td></tr>))}{customerOrders.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">주문 내역이 없습니다.</td></tr>}</tbody></table></div></div>
                            </>
                        ) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-400"><Icon name="User" size={48} className="mb-2 opacity-20"/><p>왼쪽 목록에서 고객을 선택하세요.</p></div>)}
                    </div>
                </div>
            );
        };

        const StatementTab = ({ orders, quickShipping, customerDB, categoryOrder }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedSite, setSelectedSite] = useState('all');
            const [printLayout, setPrintLayout] = useState('single');
            const [printMode, setPrintMode] = useState('single'); 

            const customers = useMemo(() => { const unique = [...new Set(orders.map(o => o.customer))]; return unique.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).sort(); }, [orders, searchTerm]);
            const batchCustomers = useMemo(() => { if (printMode !== 'batch') return []; const unique = [...new Set(orders.map(o => o.customer))]; return unique.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).sort(); }, [orders, searchTerm, printMode, selectedSite]); 

            const SingleReceipt = ({ customerName }) => {
                const targetOrders = orders.filter(o => o.customer === customerName);
                const productTotal = targetOrders.reduce((sum, o) => sum + parseNum(o.price), 0);
                const mainOrder = targetOrders.reduce((oldest, current) => (current.id < oldest.id ? current : oldest), targetOrders[0]);
                const shipFee = (mainOrder && mainOrder.customShippingFee !== null && mainOrder.customShippingFee !== undefined) ? Number(mainOrder.customShippingFee) : Number(quickShipping);
                const grandTotal = productTotal + shipFee;
                const info = customerDB[customerName] || {};
                
                return (
                    <div className={`bg-white text-black text-[11px] print:text-[10px] font-sans leading-tight flex flex-col w-full h-full`}>
                        <div className="flex justify-between items-end mb-1 border-b-0 shrink-0">
                            <div>
                                <h3 className="text-base font-bold">{customerName} 님</h3>
                                <div className="flex flex-col gap-0">
                                    <p className="text-[11px] print:text-[10px] text-slate-500 mt-0">{info.phone || ''}</p>
                                    <p className="text-[11px] print:text-[10px] text-slate-500">{info.addressText || ''} {info.addressDetail || ''}</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-mono text-slate-400">{new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-hidden">
                            <table className="w-full mb-1 text-[11px] print:text-[10px] table-fixed">
                                <colgroup>
                                    <col className="w-[58%]" />
                                    <col className="w-[17%]" />
                                    <col className="w-[25%]" />
                                </colgroup>
                                <thead className="border-b border-black">
                                    <tr>
                                        <th className="text-left py-1">상품명</th>
                                        <th className="text-center py-1">수량</th>
                                        <th className="text-right py-1">금액</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-200">
                                    {targetOrders.map(o => (
                                        <tr key={o.id} className="align-top">
                                            <td className="py-0.5 break-keep pr-1">{o.product}</td>
                                            <td className="py-0.5 text-center whitespace-nowrap">{o.quantity}</td>
                                            <td className="py-0.5 text-right font-mono whitespace-nowrap">{parseNum(o.price).toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        <div className="mt-auto pt-1 border-t border-black space-y-0.5 shrink-0">
                            <div className="flex justify-between text-[11px] print:text-[10px]"><span>상품 합계</span><span className="font-mono">{productTotal.toLocaleString()}원</span></div>
                            <div className="flex justify-between text-[11px] print:text-[10px]"><span>배송비</span><span className="font-mono">{shipFee.toLocaleString()}원</span></div>
                            <div className="flex justify-between text-sm font-black mt-1 pt-1 border-t border-slate-400"><span>Total</span><span>{grandTotal.toLocaleString()}원</span></div>
                        </div>
                    </div>
                );
            };

            const A4Page = ({ children, className = "" }) => (
                <div className={`a4-page-print bg-white shadow-lg mx-auto mb-8 box-border flex flex-col w-[210mm] h-[297mm] overflow-hidden ${className}`}>
                    {children}
                </div>
            );

            const pages = useMemo(() => {
                const targetList = printMode === 'single' ? (selectedCustomer ? [selectedCustomer] : []) : batchCustomers;
                const result = [];
                
                if (printLayout === 'single') {
                    targetList.forEach(c => result.push([c]));
                } else {
                    let currentChunk = [];
                    const LINES_THRESHOLD = 15; 
                    
                    targetList.forEach(customer => {
                         const itemCount = orders.filter(o => o.customer === customer).length;
                         const isLong = itemCount > LINES_THRESHOLD;

                         if (isLong) {
                             if (currentChunk.length > 0) {
                                 result.push(currentChunk);
                                 currentChunk = [];
                             }
                             result.push([customer]);
                         } else {
                             currentChunk.push(customer);
                             if (currentChunk.length === 2) {
                                 result.push(currentChunk);
                                 currentChunk = [];
                             }
                         }
                    });
                    if (currentChunk.length > 0) {
                        result.push(currentChunk);
                    }
                }
                return result;
            }, [printMode, selectedCustomer, batchCustomers, printLayout, orders]);

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden no-print">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex gap-2 mb-2"><button onClick={()=>setPrintMode('single')} className={`flex-1 py-1 text-xs rounded border ${printMode==='single'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>개별 인쇄</button><button onClick={()=>setPrintMode('batch')} className={`flex-1 py-1 text-xs rounded border ${printMode==='batch'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>일괄 인쇄</button></div>
                            
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder={printMode==='batch'?"필터링할 고객 검색...":"영수증 발급할 고객 검색..."} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                            <div className="flex gap-2 text-xs font-bold text-slate-500 mt-2"><label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='single'} onChange={()=>setPrintLayout('single')}/> A4 1장 1개</label><label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='double'} onChange={()=>setPrintLayout('double')}/> A4 1장 2개</label></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">{printMode === 'single' ? customers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600'}`}><span className="truncate">{c}</span><Icon name="CaretRight" size={10} className="opacity-50"/></button>)) : <div className="p-3 text-xs text-slate-500 text-center">총 {batchCustomers.length}명의 고객이<br/>인쇄 대기 중입니다.</div>}</div>
                    </div>
                    <div className="flex-1 bg-slate-100 dark:bg-dark-bg rounded-lg border border-slate-200 dark:border-dark-border flex flex-col items-center p-8 overflow-y-auto relative">
                        <div className="no-print flex gap-2 mb-4 sticky top-0 z-10">
                            <button onClick={()=>window.print()} className="bg-slate-800 text-white px-4 py-2 rounded-md font-bold hover:bg-slate-700 flex items-center gap-2 text-xs"><Icon name="Printer"/> 인쇄하기</button>
                        </div>

                        {/* 화면 미리보기 & 인쇄 영역 (중복 제거됨) */}
                        <div className="print-section">
                             {pages.length > 0 ? pages.map((pageCustomers, pageIdx) => {
                                // 2장 모아찍기일 때 padding을 제거하고 내부에서 50% 높이로 분할
                                const isDouble = printLayout === 'double';
                                const pageClass = isDouble
                                    ? "justify-start items-start p-0"  // padding 0 for double
                                    : "justify-center items-center p-[10mm]"; // standard padding for single
                                
                                return (
                                <A4Page key={pageIdx} className={pageClass}>
                                    {pageCustomers.map((customer, cIdx) => (
                                        <React.Fragment key={customer}>
                                            <div className={isDouble ? 
                                                `w-full h-[50%] px-[10mm] py-[5mm] flex flex-col box-border ${cIdx === 0 ? 'border-b-2 border-dashed border-slate-300' : ''}` : 
                                                "w-full"
                                            }>
                                                <SingleReceipt customerName={customer} />
                                            </div>
                                        </React.Fragment>
                                    ))}
                                </A4Page>
                             )}) : (
                                <div className="flex flex-col items-center justify-center text-slate-400 h-[50vh]">
                                    <Icon name="Receipt" size={64} className="mb-4 opacity-20"/>
                                    <p>대상이 선택되지 않았습니다.</p>
                                </div>
                             )}
                        </div>
                    </div>
                </div>
            );
        };
