<!DOCTYPE html>
<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¹”ë¡œ ì£¼ë¬¸ì„œ PRO (ìë™ì €ì¥)</title>
    
    <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'] },
                    colors: { brand: { 50: '#f0f4f8', 500: '#627d98', 600: '#486581', 700: '#334e68' }, kakao: '#FEE500' }
                }
            }
        }
    </script>
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        body { font-family: 'NanumSquareNeo', sans-serif; background-color: #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .processed-chat { text-decoration: line-through; background-color: #f3f4f6 !important; color: #9ca3af !important; border-color: #e5e7eb !important; opacity: 0.6; }
        .selected-chat-active { border-left: 4px solid #3182ce; background-color: #ebf8ff; }
        .badge-pulse { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); } 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); } }
        .cancelled-item { text-decoration: line-through; color: #9ca3af; background-color: #f3f4f6; }
        
        .keyword-detected { border: 2px solid #3b82f6; background-color: #eff6ff; }
        .keyword-badge { background-color: #3b82f6; color: white; padding: 2px 6px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 2px; }
        
        /* ë³µì‚¬ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes copySuccess { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .copy-anim { animation: copySuccess 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // âœ… URL ê³ ì •
        const GOOGLE_API_URL = "https://script.google.com/macros/s/AKfycbw2kxALNMEKEKZJOqi19hlZc5vU7ebCuUP0rQQpEEdxirZTDSCBPY0pjSr_kql5NtHVDw/exec";
        
        // âœ… ê³„ì¢Œë²ˆí˜¸ ê³ ì •
        const FIXED_BANK_ACCOUNT = "ì¹´ì¹´ì˜¤ë±…í¬ ê¹€ì„ ì •\n7942 18 01611";

        const Icon = ({ name, className="" }) => <i className={`ph ph-${name} ${className}`}></i>;

        const downloadExcel = (data, fileName) => {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString()}.xlsx`);
        };

        const LiveTab = ({ 
            orders, setOrders, 
            productHistory, setProductHistory, 
            quickShipping, setQuickShipping, 
            shippingOverrides, setShippingOverrides, 
            googleScriptUrl, 
            addresses, setAddresses, 
            cardPayments, setCardPayments, 
            resetAllStatus 
        }) => {
            const [chats, setChats] = useState([]);
            const [deposits, setDeposits] = useState([]);
            const [clickedChats, setClickedChats] = useState(new Set());
            const [selectedNick, setSelectedNick] = useState(null); 
            const [matchedDeposits, setMatchedDeposits] = useState(new Set());
            const [manualNick, setManualNick] = useState('');
            const [manualProduct, setManualProduct] = useState('');
            
            const [chatSearch, setChatSearch] = useState('');
            const [depositSearch, setDepositSearch] = useState('');
            const [orderSearch, setOrderSearch] = useState('');
            const [filterStatus, setFilterStatus] = useState('all');
            
            const [keywords, setKeywords] = useState(new Set()); 
            const [keywordInput, setKeywordInput] = useState('');
            const [showKeywordOnly, setShowKeywordOnly] = useState(false);

            const [connectionStatus, setConnectionStatus] = useState({ code: 'loading', msg: '' }); 
            const [copyStatus, setCopyStatus] = useState({});

            // [NEW] ìë™ ì €ì¥ ê´€ë ¨ ìƒíƒœ
            const [isSaving, setIsSaving] = useState(false);
            const [lastSavedTime, setLastSavedTime] = useState(null);

            // ë°ì´í„° ë¡œë”©
            const fetchData = async () => {
                if (!googleScriptUrl || googleScriptUrl.includes("ì—¬ê¸°ì—")) {
                    setConnectionStatus({ code: 'error_url', msg: 'ì£¼ì†Œ ë¯¸ì…ë ¥' });
                    return;
                }
                try {
                    const res = await fetch(googleScriptUrl);
                    if (!res.ok) throw new Error(`HTTP ì—ëŸ¬: ${res.status}`);
                    const text = await res.text();
                    let data;
                    try { data = JSON.parse(text); } catch (e) { throw new Error("ì‘ë‹µ ë°ì´í„° ì˜¤ë¥˜"); }
                    
                    if (data.chats) {
                        setChats(data.chats);
                        if (data.chats.length === 0) setConnectionStatus({ code: 'warning_empty', msg: 'ë°ì´í„° 0ê±´' });
                        else setConnectionStatus({ code: 'success', msg: 'ì—°ê²° ì„±ê³µ' });
                    }
                    if (data.deposits) setDeposits(data.deposits);
                    
                    if (data.error_yt) console.error("ìœ íŠœë¸Œ ì‹œíŠ¸ ì—ëŸ¬:", data.error_yt);

                } catch (e) {
                    console.error("ì—°ê²° ì‹¤íŒ¨:", e);
                    setConnectionStatus({ code: 'error_fetch', msg: e.message });
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [googleScriptUrl]);

            const findAddress = (nick) => {
                return addresses.find(a => a.nickname.trim() === nick.trim());
            };

            const handleAddKeyword = (e) => {
                e.preventDefault();
                if(!keywordInput.trim()) return;
                setKeywords(prev => new Set(prev).add(keywordInput.trim()));
                setKeywordInput('');
            };

            const handleRemoveKeyword = (keyword) => {
                setKeywords(prev => {
                    const next = new Set(prev);
                    next.delete(keyword);
                    return next;
                });
            };

            const toggleCardPayment = (nick) => {
                setCardPayments(prev => ({ ...prev, [nick]: !prev[nick] }));
            };

            // âœ… [ìˆ˜ì •] ìë™ ì €ì¥ í•¨ìˆ˜ (ì•Œë¦¼ì°½ ì—†ìŒ, ìƒíƒœ í‘œì‹œë§Œ)
            const autoSaveToGoogleSheet = async () => {
                if (Object.keys(orders).length === 0) return; // ì €ì¥í•  ê±° ì—†ìœ¼ë©´ íŒ¨ìŠ¤

                setIsSaving(true);
                let saveList = [];
                orders.forEach(o => {
                    if (o.isCancelled) return;
                    const addr = findAddress(o.customer) || {};
                    const currentShipping = shippingOverrides[o.customer] !== undefined ? shippingOverrides[o.customer] : Number(quickShipping);
                    
                    // ì´í•©ê³„ ê³„ì‚° (ì£¼ë¬¸ìë³„ í•©ê³„ ì•„ë‹˜, ë‹¨ìˆœíˆ ì €ì¥ìš© ë°ì´í„° êµ¬ì„±)
                    // ì •í™•í•œ ì •ì‚°ì€ ì—‘ì…€ ë‹¤ìš´ë¡œë“œë‚˜ í™”ë©´ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê° í•­ëª© ì €ì¥ì— ì§‘ì¤‘
                    const grandTotal = 0; // ì‹œíŠ¸ì—ì„œ ê³„ì‚°í•˜ê±°ë‚˜ í•„ìš”ì‹œ ë¡œì§ ì¶”ê°€

                    saveList.push({
                        nickname: o.customer,
                        product: o.product,
                        qty: o.quantity,
                        price: o.price,
                        deposit: o.deposit,
                        shipping: currentShipping, 
                        grandTotal: grandTotal, 
                        address: addr.address || '',
                        zipcode: addr.zipcode || '', 
                        phone: addr.phone || '',
                        realname: addr.realname || '',
                        memo: addr.memo || '' 
                    });
                });

                try {
                    const res = await fetch(googleScriptUrl, {
                        method: 'POST',
                        body: JSON.stringify(saveList)
                    });
                    const json = await res.json();
                    if(json.result === 'success') {
                        setLastSavedTime(new Date().toLocaleTimeString());
                    }
                } catch(e) {
                    console.error("ìë™ ì €ì¥ ì‹¤íŒ¨:", e);
                } finally {
                    setIsSaving(false);
                }
            };

            // âœ… [ìˆ˜ì •] 1ë¶„ë§ˆë‹¤ ìë™ ì €ì¥ ì‹¤í–‰
            useEffect(() => {
                const saveInterval = setInterval(() => {
                    autoSaveToGoogleSheet();
                }, 60000); // 60ì´ˆ
                return () => clearInterval(saveInterval);
            }, [orders, shippingOverrides, quickShipping]); 


            const addOrderLogic = (nickname, content, qty = 1) => {
                const initialProduct = content || '';
                const initialPrice = productHistory[initialProduct] || 0;
                setOrders(prev => {
                    const existIdx = prev.findIndex(o => o.customer === nickname && o.product === initialProduct && !o.isCancelled);
                    setSelectedNick(nickname);
                    setOrderSearch(''); 
                    if (existIdx >= 0) {
                        const next = [...prev];
                        next[existIdx] = { ...next[existIdx], quantity: next[existIdx].quantity + qty, price: (next[existIdx].quantity + qty) * initialPrice };
                        return next;
                    }
                    return [{ id: Date.now(), customer: nickname, product: initialProduct, quantity: qty, price: initialPrice, deposit: 0, originalText: content, isCancelled: false }, ...prev];
                });
            };

            const handleChatClick = (chat) => { 
                setClickedChats(prev => new Set(prev).add(chat.id));
                addOrderLogic(chat.nickname, chat.content, 1); 
            };

            const handleManualSubmit = (e) => { e.preventDefault(); if (!manualNick.trim()) return alert("ë‹‰ë„¤ì„!"); addOrderLogic(manualNick, manualProduct, 1); setManualProduct(''); };
            const handleDepositClick = (deposit, index) => {
                if (matchedDeposits.has(index)) return;
                if (!selectedNick) return alert("ì˜¤ë¥¸ìª½ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
                const depositAmount = Number(deposit.amount);
                setOrders(prev => {
                    const targetOrders = prev.filter(o => o.customer === selectedNick);
                    const otherOrders = prev.filter(o => o.customer !== selectedNick);
                    if (targetOrders.length === 0) return prev;
                    const updatedTargets = targetOrders.map((o, i) => { if (i === 0) return { ...o, deposit: (o.deposit || 0) + depositAmount }; return o; });
                    return [...updatedTargets, ...otherOrders];
                });
                setMatchedDeposits(prev => new Set(prev).add(index));
            };
            const handleProductChange = (id, field, value) => {
                setOrders(prev => prev.map(o => {
                    if (o.id === id) {
                        const newOrder = { ...o, [field]: value };
                        if (field === 'product' && productHistory[value]) newOrder.price = newOrder.quantity * productHistory[value];
                        if (field === 'price' && o.product) { const unitPrice = value / o.quantity; setProductHistory(h => ({ ...h, [o.product]: unitPrice })); }
                        return newOrder;
                    } return o;
                }));
            };
            const handleShippingChange = (nick, val) => { setShippingOverrides(prev => ({ ...prev, [nick]: Number(val) })); };
            const handleNicknameEdit = (oldNick) => {
                const newNick = prompt(`'${oldNick}'ë‹˜ì˜ ë‹‰ë„¤ì„ì„ ë¬´ì—‡ìœ¼ë¡œ ë³€ê²½í• ê¹Œìš”?`, oldNick);
                if (newNick && newNick !== oldNick) {
                    setOrders(prev => prev.map(o => o.customer === oldNick ? { ...o, customer: newNick } : o));
                    if (shippingOverrides[oldNick]) {
                        const newOverrides = { ...shippingOverrides, [newNick]: shippingOverrides[oldNick] };
                        delete newOverrides[oldNick];
                        setShippingOverrides(newOverrides);
                    }
                    if (selectedNick === oldNick) setSelectedNick(newNick);
                }
            };
            const handleOrderCancel = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, isCancelled: !o.isCancelled } : o)); };
            const handleOrderDelete = (id) => { if(confirm("ì´ ì£¼ë¬¸ì„ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) setOrders(prev => prev.filter(o => o.id !== id)); };

            // [ì¹´í†¡ ë³µì‚¬]
            const copyOrderSheet = (nick, items, grandTotal, depositTotal, balance, isCard) => {
                const activeItems = items.filter(i => !i.isCancelled);
                
                const itemListText = activeItems.map(i => `${i.product}(${i.quantity}ê°œ) ${Number(i.price).toLocaleString()}ì›`).join('\n');
                
                const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                
                let msg = `ğŸ’™ ${nick} ë‹˜ ğŸ’™\n\n\n`;
                msg += `${itemListText}\n`;
                msg += `ë°°ì†¡ë¹„ ${currentShipping.toLocaleString()}ì›\n\n`;
                msg += `ì´ ì£¼ë¬¸ê¸ˆì•¡ ${grandTotal.toLocaleString()}ì›\n\n`;
                msg += `------------------\n`;

                if (isCard) {
                    const cardBaseAmount = Math.abs(balance); 
                    const cardFee = cardBaseAmount * 0.1;     
                    const cardTotal = cardBaseAmount + cardFee; 

                    if (depositTotal > 0) {
                        msg += `[ì…ê¸ˆí™•ì¸]\n`;
                        msg += `${depositTotal.toLocaleString()}ì›\n\n`;
                    }
                    msg += `[ì¹´ë“œê²°ì œ]\n`;
                    msg += `ê¸ˆì•¡ ${cardBaseAmount.toLocaleString()}ì›\n`;
                    msg += `10%   ${cardFee.toLocaleString()}ì›\n`;
                    msg += `ğŸ‘‰ì´ ${cardTotal.toLocaleString()}ì› ì˜ˆì •\n\n`;
                    msg += `í•¸ë“œí°ë²ˆí˜¸ ë‚¨ê²¨ì£¼ì„¸ìš”ğŸŒ¸\n`;
                    msg += `------------------\n\n`;

                } else {
                    const isPaid = balance >= 0;

                    if (depositTotal > 0) {
                        msg += `[ì…ê¸ˆí™•ì¸]\n`;
                        msg += `${depositTotal.toLocaleString()}ì›\n\n`;
                        msg += `------------------\n\n`;
                    }

                    if (isPaid) {
                        msg += `ì™„ë‚© í™•ì¸! ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜\n`;
                        msg += `------------------\n\n`;
                    } else {
                        msg += `[ë¯¸ì…ê¸ˆ]\n`;
                        msg += `ì´ ì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡\n`;
                        msg += `ğŸ‘‰ ${Math.abs(balance).toLocaleString()}ì› \n\n`;
                        msg += `${FIXED_BANK_ACCOUNT}\n`; // ê³ ì •ëœ ê³„ì¢Œë²ˆí˜¸ ì‚¬ìš©
                        msg += `ì…ê¸ˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤ ğŸ™\n\n`;
                        msg += `------------------\n\n`;
                    }
                }

                msg += `ë°©ì†¡ë§ˆë‹¤ 1íšŒ\n`;
                msg += `í•˜ë‹¨ì˜ ì£¼ë¬¸ì„œ(ë°°ì†¡ì§€ì…ë ¥) í•„ìˆ˜!!\n\n`;
                msg += `ì´ë¯¸ ì°¸ì—¬í•œ ì„¤ë¬¸ ì¼ ê²½ìš°\n`;
                msg += `â–« ë‹µë³€ ìˆ˜ì •í•˜ê¸° \n`;
                msg += `â–« ë˜ëŠ” ì„¤ë¬¸ ì¶”ê°€ ì°¸ì—¬\n\n`;
                msg += `ë¯¸ì…ë ¥ì´ ë§ì•„ ê³„ì† ì•ˆë‚´í•©ë‹ˆë‹¤. \n`;
                msg += `ì–‘í•´ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;

                const textArea = document.createElement("textarea");
                textArea.value = msg;
                document.body.appendChild(textArea);
                textArea.select();
                try { 
                    document.execCommand('copy'); 
                    setCopyStatus(prev => ({ ...prev, [nick]: true }));
                    setTimeout(() => {
                        setCopyStatus(prev => ({ ...prev, [nick]: false }));
                    }, 2000);
                } catch (err) { alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err); }
                document.body.removeChild(textArea);
            };

            const filteredChats = useMemo(() => {
                let result = chats;
                if (showKeywordOnly) {
                    result = result.filter(c => {
                        const content = c.content.toLowerCase();
                        return [...keywords].some(k => content.includes(k.toLowerCase()));
                    });
                }
                if (chatSearch) {
                    result = result.filter(c => c.nickname.toLowerCase().includes(chatSearch.toLowerCase()) || c.content.toLowerCase().includes(chatSearch.toLowerCase()));
                }
                return result;
            }, [chats, chatSearch, showKeywordOnly, keywords]);

            const filteredDeposits = useMemo(() => {
                if (!depositSearch) return deposits;
                return deposits.filter(d => d.name.toLowerCase().includes(depositSearch.toLowerCase()) || String(d.amount).includes(depositSearch));
            }, [deposits, depositSearch]);

            const filteredGroupedOrders = useMemo(() => {
                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });
                return Object.entries(groups).filter(([nick, items]) => {
                    if (orderSearch && !nick.toLowerCase().includes(orderSearch.toLowerCase())) return false;
                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const activeItems = items.filter(i => !i.isCancelled);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const finalShipping = activeItems.length > 0 ? currentShipping : 0;
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + finalShipping;
                    const balance = grandTotal - depositTotal;
                    const isPaid = balance >= 0 && depositTotal > 0;
                    if (filterStatus === 'unpaid' && isPaid) return false;
                    if (filterStatus === 'paid' && !isPaid) return false;
                    return true;
                });
            }, [orders, orderSearch, filterStatus, shippingOverrides, quickShipping]);

            // ëŒ€ì‹œë³´ë“œ í†µê³„ ê³„ì‚°
            const dashboardStats = useMemo(() => {
                let totalSales = 0;
                let totalDeposit = 0;
                let totalUnpaid = 0;
                let totalCardExpected = 0;

                const groups = {};
                orders.forEach(o => { if (!groups[o.customer]) groups[o.customer] = []; groups[o.customer].push(o); });

                Object.entries(groups).forEach(([nick, items]) => {
                    const activeItems = items.filter(i => !i.isCancelled);
                    if (activeItems.length === 0) return;

                    const currentShipping = shippingOverrides[nick] !== undefined ? shippingOverrides[nick] : Number(quickShipping);
                    const productTotal = activeItems.reduce((sum, i) => sum + Number(i.price), 0);
                    const depositTotal = items.reduce((sum, i) => sum + (i.deposit || 0), 0);
                    const grandTotal = productTotal + currentShipping;
                    const balance = grandTotal - depositTotal; // ë¯¸ìˆ˜ê¸ˆ (ì–‘ìˆ˜)

                    totalSales += grandTotal;
                    totalDeposit += depositTotal;

                    if (balance > 0) {
                        if (cardPayments[nick]) {
                            const fee = balance * 0.1;
                            totalCardExpected += (balance + fee);
                        } else {
                            totalUnpaid += balance;
                        }
                    }
                });

                return { totalSales, totalDeposit, totalUnpaid, totalCardExpected };
            }, [orders, shippingOverrides, quickShipping, cardPayments]);

            const StatusMessage = () => {
                const { code, msg } = connectionStatus;
                if (code === 'error_url') return <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-2 m-2 text-xs">ğŸš¨ ì£¼ì†Œ ì—†ìŒ</div>;
                if (code === 'error_fetch') return <div className="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-2 m-2 text-xs">âš ï¸ ì—°ê²° ì‹¤íŒ¨: {msg}</div>;
                if (code === 'warning_empty') return <div className="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-2 m-2 text-xs">â„¹ï¸ ë°ì´í„° 0ê±´ (ì‹œíŠ¸ ì´ë¦„ Sheet1 í™•ì¸ í•„ìš”)</div>;
                return null;
            };

            return (
                <div className="flex h-full gap-2 p-2 overflow-hidden bg-gray-50 text-slate-800">
                    <datalist id="product-list">{Object.keys(productHistory).map(name => <option key={name} value={name} />)}</datalist>
                    
                    {/* [1. ëŒ“ê¸€ ì˜ì—­ (30%)] */}
                    <div className="w-[30%] flex flex-col bg-white border rounded-lg shadow-sm overflow-hidden">
                        <div className="p-2 bg-red-50 border-b flex flex-col gap-2">
                            <div className="font-bold text-red-600 flex items-center justify-between">
                                <span className="flex items-center gap-1"><Icon name="youtube-logo" weight="fill"/> ë¼ì´ë¸Œ ëŒ“ê¸€</span>
                                <span className="text-xs text-gray-500">{filteredChats.length}ê±´</span>
                            </div>
                            
                            {/* í‚¤ì›Œë“œ ë“±ë¡ì°½ */}
                            <div className="flex flex-col gap-2 bg-gray-50 p-2 rounded border border-gray-100">
                                <form onSubmit={handleAddKeyword} className="flex gap-1">
                                    <input 
                                        type="text" 
                                        value={keywordInput}
                                        onChange={(e) => setKeywordInput(e.target.value)}
                                        placeholder="í‚¤ì›Œë“œ ì¶”ê°€ (ì˜ˆ: 240, ì£¼ë¬¸)" 
                                        className="flex-1 text-xs border rounded px-2 py-1 outline-none focus:ring-1 focus:ring-blue-500" 
                                    />
                                    <button type="submit" className="bg-blue-500 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-600">ì¶”ê°€</button>
                                </form>
                                {/* í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ */}
                                {keywords.size > 0 && (
                                    <div className="flex flex-wrap gap-1 max-h-16 overflow-y-auto scrollbar-thin mt-1 p-1 bg-white border rounded">
                                        {[...keywords].map(k => (
                                            <span key={k} onClick={() => handleRemoveKeyword(k)} 
                                                className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[10px] cursor-pointer hover:bg-red-100 hover:text-red-600 flex items-center gap-1 shrink-0">
                                                {k} <Icon name="x" weight="bold"/>
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* í•„í„° ë²„íŠ¼ */}
                            <div className="flex gap-2">
                                <button onClick={()=>setShowKeywordOnly(!showKeywordOnly)} 
                                    className={`flex-1 px-2 py-1.5 text-xs rounded border flex justify-center items-center gap-1 ${showKeywordOnly ? 'bg-blue-100 text-blue-700 border-blue-300 font-bold' : 'bg-gray-50 text-gray-500'}`}>
                                    <Icon name={showKeywordOnly ? "check-square" : "square"} /> ğŸ¯ í‚¤ì›Œë“œë§Œ ë³´ê¸°
                                </button>
                            </div>

                            <div className="relative">
                                <Icon name="magnifying-glass" className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400"/>
                                <input type="text" placeholder="ë‹‰ë„¤ì„/ë‚´ìš© ê²€ìƒ‰" value={chatSearch} onChange={e => setChatSearch(e.target.value)} 
                                    className="w-full text-xs pl-7 pr-2 py-1.5 border rounded focus:ring-1 focus:ring-red-500 outline-none" />
                                {chatSearch && <button onClick={()=>setChatSearch('')} className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"><Icon name="x-circle" weight="fill" size={12}/></button>}
                            </div>
                        </div>
                        
                        <StatusMessage />

                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {filteredChats.map(chat => {
                                const isClicked = clickedChats.has(chat.id);
                                const isKeywordMatch = [...keywords].some(k => chat.content.includes(k));

                                return (
                                    <div key={chat.id} onClick={() => handleChatClick(chat)} 
                                         className={`p-2 border rounded cursor-pointer transition-all flex flex-col gap-1 
                                            ${isClicked ? 'processed-chat' : 'bg-white hover:bg-red-50 hover:border-red-200'}
                                            ${isKeywordMatch && !isClicked ? 'keyword-detected' : ''} 
                                         `}>
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className={`font-bold ${isClicked ? 'text-gray-500' : 'text-gray-700'}`}>{chat.nickname}</span>
                                            <span className="text-gray-400">{chat.time ? new Date(chat.time).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                        </div>
                                        <div className="text-sm">{chat.content}</div>
                                        {isKeywordMatch && !isClicked && (
                                             <div className="flex justify-between items-center mt-1">
                                                <span className="keyword-badge flex items-center gap-1"><Icon name="target" weight="fill"/> í‚¤ì›Œë“œë¨</span>
                                            </div>
                                        )}
                                    </div>
