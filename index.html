<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OM-PRO: 통합 주문 관리 시스템 (v2.2 Hotfix)</title>
    <!-- Vue 3 & Tailwind -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Excel Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Postcode (HTTPS 적용) -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .pro-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }

        .pro-input {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            color: #111827;
            transition: all 0.2s;
        }
        .pro-input:focus {
            background-color: #ffffff;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        
        .btn-secondary { background-color: #ffffff; border: 1px solid #d1d5db; color: #374151; }
        .btn-secondary:hover { background-color: #f3f4f6; }

        .toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(20px); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">
    <div id="app" class="h-full flex flex-col max-w-[1600px] mx-auto w-full">
        
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center z-10 shrink-0 relative">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-sm">
                    <i class="fas fa-check-double"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800 tracking-tight">OM-PRO <span class="text-blue-600">Manager</span></h1>
                    <p class="text-xs text-gray-400">Professional Order System v2.2</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button @click="openModal" class="btn-secondary px-3 py-1.5 rounded-md text-xs font-medium transition flex items-center hover:bg-gray-50">
                    <i class="fas fa-box text-gray-400 mr-2"></i>상품/단가
                </button>
                <button @click="backupData" class="btn-secondary px-3 py-1.5 rounded-md text-xs font-medium transition flex items-center hover:bg-gray-50">
                    <i class="fas fa-download text-gray-400 mr-2"></i>백업
                </button>
                <button @click="clearAllData" class="btn-secondary px-3 py-1.5 rounded-md text-xs font-medium text-red-600 hover:bg-red-50 border-red-100 transition flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i>초기화
                </button>
            </div>
        </header>

        <!-- Dashboard -->
        <section class="p-6 pb-2 grid grid-cols-1 md:grid-cols-4 gap-4 shrink-0">
            <!-- Total Revenue -->
            <div class="pro-card rounded-xl p-4 flex flex-col justify-between">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-semibold text-gray-500 uppercase">총 예상 매출</span>
                    <i class="fas fa-coins text-blue-100 bg-blue-600 rounded-full p-1.5 text-xs"></i>
                </div>
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ formatCurrency(dashboard.totalRevenue) }}</div>
                    <div class="text-xs text-gray-500 mt-1">
                        주문 <span class="font-bold text-gray-700">{{ dashboard.orderCount }}</span>건 / 
                        상품 <span class="font-bold text-gray-700">{{ dashboard.totalQty }}</span>개
                    </div>
                </div>
            </div>

            <!-- Revenue Breakdown -->
            <div class="pro-card rounded-xl p-4 flex flex-col justify-center gap-1.5 text-xs">
                <div class="flex justify-between items-center border-b border-dashed border-gray-100 pb-1">
                    <span class="text-gray-500"><i class="far fa-credit-card mr-1"></i>카드 결제</span>
                    <span class="font-bold text-gray-800">{{ formatCurrency(dashboard.cardRevenue) }}</span>
                </div>
                <div class="flex justify-between items-center border-b border-dashed border-gray-100 pb-1">
                    <span class="text-gray-500"><i class="far fa-money-bill-alt mr-1"></i>현금 입금</span>
                    <span class="font-bold text-gray-800">{{ formatCurrency(dashboard.cashRevenue) }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-500"><i class="fas fa-truck mr-1"></i>배송비 매출</span>
                    <span class="font-bold text-gray-800">{{ formatCurrency(dashboard.shippingRevenue) }}</span>
                </div>
            </div>

            <!-- Unpaid Status -->
            <div class="pro-card rounded-xl p-4 border-l-4 border-l-red-500 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition">
                    <i class="fas fa-exclamation-circle text-6xl text-red-600"></i>
                </div>
                <div class="text-xs font-bold text-red-500 uppercase mb-1 flex items-center">
                    미수금 알림 <span v-if="dashboard.totalUnpaid > 0" class="ml-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                </div>
                <div class="text-2xl font-bold text-red-600">{{ formatCurrency(dashboard.totalUnpaid) }}</div>
                <div class="text-xs text-gray-500 mt-1 flex gap-2">
                    <span class="bg-red-50 text-red-600 px-1.5 rounded">상품 {{ formatCurrency(dashboard.productUnpaid) }}</span>
                    <span class="bg-red-50 text-red-600 px-1.5 rounded">배송 {{ formatCurrency(dashboard.shippingUnpaid) }}</span>
                </div>
            </div>

            <!-- Export Actions -->
            <div class="pro-card rounded-xl p-4 flex flex-col gap-2 justify-center bg-white">
                <button @click="exportExcel('all')" class="w-full btn-primary py-2 rounded-lg text-sm font-bold shadow-sm flex justify-center items-center transition-transform active:scale-95">
                    <i class="fas fa-file-excel mr-2"></i> 전체 장부 다운로드
                </button>
                <div class="flex gap-2">
                    <button @click="exportExcel('invoice')" class="flex-1 btn-secondary py-1.5 rounded text-xs hover:text-green-600 hover:border-green-200">송장용</button>
                    <button @click="exportExcel('order')" class="flex-1 btn-secondary py-1.5 rounded text-xs hover:text-blue-600 hover:border-blue-200">발주용</button>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <main class="flex-1 flex gap-6 px-6 pb-6 overflow-hidden">
            <!-- Left: Input Panel -->
            <div class="w-[35%] flex flex-col gap-4">
                <!-- Smart Parse Area -->
                <div class="pro-card rounded-xl p-5 flex flex-col flex-1 shadow-sm relative">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="font-bold text-gray-800 flex items-center"><i class="fas fa-magic text-blue-500 mr-2"></i>스마트 주문 입력</h2>
                        <button @click="rawInput = ''" class="text-xs text-gray-400 hover:text-red-500"><i class="fas fa-eraser mr-1"></i>지우기</button>
                    </div>
                    <div class="relative flex-1 group">
                        <textarea v-model="rawInput" 
                            placeholder="주문 텍스트를 붙여넣으세요.&#13;&#10;자동으로 정보가 분류됩니다.&#13;&#10;&#13;&#10;예시) 홍길동 010-1234-5678 서울시... 티셔츠 1개"
                            class="w-full h-full pro-input rounded-lg p-4 resize-none text-sm leading-relaxed placeholder-gray-400"></textarea>
                        <button @click="processInput" class="absolute bottom-3 right-3 bg-gray-900 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg hover:bg-black transition-all flex items-center z-10">
                            <i class="fas fa-arrow-down mr-2"></i>분석 및 적용
                        </button>
                    </div>
                </div>

                <!-- Manual Input Form -->
                <div class="pro-card rounded-xl p-5 shadow-sm relative z-0">
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">수동 입력 / 수정</h3>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input v-model="manual.nickname" placeholder="닉네임/주문자" class="pro-input w-1/3 px-3 py-2 rounded-md text-xs">
                            <div class="relative flex-1">
                                <input v-model="manual.product" @input="filterProducts" placeholder="상품명 검색..." class="pro-input w-full px-3 py-2 rounded-md text-xs">
                                <!-- Autocomplete -->
                                <div v-if="showSuggestions && filteredProducts.length" class="absolute z-50 w-full bg-white border border-gray-200 rounded-md shadow-xl mt-1 max-h-40 overflow-y-auto">
                                    <div v-for="p in filteredProducts" @click="selectProduct(p)" class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-xs flex justify-between items-center border-b border-gray-50 last:border-0">
                                        <span class="font-medium text-gray-700">{{p.name}}</span>
                                        <span class="text-blue-600 font-bold">{{formatCurrency(p.price)}}</span>
                                    </div>
                                </div>
                            </div>
                            <input v-model.number="manual.qty" type="number" min="1" placeholder="수" class="pro-input w-14 px-2 py-2 rounded-md text-xs text-center">
                        </div>
                        
                        <div class="flex gap-2">
                            <input v-model="manual.receiver" placeholder="수령인" class="pro-input w-1/3 px-3 py-2 rounded-md text-xs">
                            <input v-model="manual.phone" placeholder="연락처" class="pro-input flex-1 px-3 py-2 rounded-md text-xs">
                        </div>
                        
                        <div class="flex gap-2">
                            <input v-model="manual.address" placeholder="주소" class="pro-input flex-1 px-3 py-2 rounded-md text-xs">
                            <button @click="openDaumPostcode" class="bg-gray-200 text-gray-600 px-3 rounded-md text-xs hover:bg-gray-300 font-medium whitespace-nowrap">주소검색</button>
                        </div>
                        
                        <button @click="addOrder" class="w-full btn-primary py-2.5 rounded-lg text-sm font-bold shadow-sm mt-1 transition-colors">
                            <i class="fas fa-plus mr-2"></i>추가
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Order Grid -->
            <div class="flex-1 pro-card rounded-xl flex flex-col shadow-sm overflow-hidden bg-white">
                <div class="px-5 py-3 border-b border-gray-200 flex justify-between items-center bg-gray-50/50">
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">LIVE</span>
                        <h3 class="font-bold text-gray-700">주문 현황 ({{ filteredOrderList.length }})</h3>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input v-model="searchQuery" placeholder="주문자, 전화번호 검색..." class="pl-9 pr-4 py-1.5 rounded-full border border-gray-300 text-xs w-64 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <!-- Table Header -->
                <div class="grid grid-cols-12 gap-2 px-4 py-2 bg-gray-100 border-b border-gray-200 text-[11px] font-bold text-gray-500 uppercase tracking-wider">
                    <div class="col-span-1 text-center">No</div>
                    <div class="col-span-2">주문자</div>
                    <div class="col-span-3">상품 / 단가</div>
                    <div class="col-span-2 text-right">결제 필요</div>
                    <div class="col-span-3 text-center">결제 처리</div>
                    <div class="col-span-1 text-center">관리</div>
                </div>

                <!-- Table Body -->
                <div class="flex-1 overflow-y-auto bg-white">
                    <div v-if="filteredOrderList.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-clipboard-list text-4xl mb-3 opacity-20"></i>
                        <p>등록된 주문이 없습니다.</p>
                    </div>
                    
                    <div v-else class="divide-y divide-gray-100">
                        <div v-for="(order, index) in filteredOrderList" :key="order.id" 
                            class="grid grid-cols-12 gap-2 px-4 py-3 items-center hover:bg-blue-50/30 transition-colors group text-xs">
                            
                            <div class="col-span-1 text-center text-gray-400 font-mono">{{ filteredOrderList.length - index }}</div>
                            
                            <div class="col-span-2 overflow-hidden">
                                <div class="font-bold text-gray-800 truncate" :title="order.nickname">{{ order.nickname }}</div>
                                <div class="text-[10px] text-gray-400 truncate">{{ order.phone || '-' }}</div>
                            </div>
                            
                            <div class="col-span-3">
                                <div class="font-medium text-gray-700 truncate flex items-center gap-1">
                                    {{ order.product }}
                                    <span class="bg-gray-100 text-gray-500 px-1 rounded text-[10px]">{{ order.qty }}개</span>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-0.5">
                                    @{{ formatCurrency(order.unitPrice) }} 
                                    <span v-if="getShippingMasterId(order.nickname) === order.id" class="ml-1 text-blue-600 bg-blue-50 px-1 rounded font-bold">배송비포함</span>
                                </div>
                            </div>

                            <div class="col-span-2 text-right">
                                <div class="font-bold text-gray-800">{{ formatCurrency(calculateOrderTotal(order)) }}</div>
                                <div class="font-bold mt-0.5" :class="calculateUnpaid(order) > 0 ? 'text-red-500' : 'text-green-600'">
                                    <span class="text-[10px] text-gray-400 font-normal mr-1">미수</span>
                                    {{ formatCurrency(calculateUnpaid(order)) }}
                                </div>
                            </div>

                            <div class="col-span-3 flex flex-col gap-1.5">
                                <div v-if="getShippingMasterId(order.nickname) === order.id" class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded border border-gray-200">
                                    <span class="text-[10px] text-gray-500"><i class="fas fa-truck text-gray-400 mr-1"></i>배송비 납부</span>
                                    <button @click="toggleShipping(order)" 
                                        class="relative inline-flex h-4 w-8 items-center rounded-full transition-colors focus:outline-none"
                                        :class="order.isShippingPaid ? 'bg-blue-600' : 'bg-gray-300'">
                                        <span class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform duration-200 ease-in-out ml-0.5"
                                            :class="order.isShippingPaid ? 'translate-x-4' : 'translate-x-0'"></span>
                                    </button>
                                </div>

                                <div class="flex gap-1">
                                    <input v-model.number="order.cardAmount" placeholder="카드" class="w-1/2 pro-input py-1 px-1.5 text-right text-[11px] rounded" @focus="$event.target.select()">
                                    <input v-model.number="order.depositAmount" placeholder="입금" class="w-1/2 pro-input py-1 px-1.5 text-right text-[11px] rounded" @focus="$event.target.select()">
                                </div>
                            </div>

                            <div class="col-span-1 flex justify-center items-center gap-2">
                                <button @click="copyOrderInfo(order)" class="text-gray-400 hover:text-blue-600 transition" title="주문서 복사">
                                    <i class="far fa-copy"></i>
                                </button>
                                <button @click="deleteOrder(order.id)" class="text-gray-400 hover:text-red-500 transition" title="삭제">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Product Modal (Fixed Z-Index & Safety) -->
        <div v-if="showProductModal" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="closeModal">
            <div class="bg-white rounded-xl shadow-2xl w-[400px] border border-gray-200 overflow-hidden transform transition-all">
                <div class="bg-gray-50 px-5 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">상품 및 단가 관리</h3>
                    <button @click="closeModal" class="text-gray-400 hover:text-red-500 p-1"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-5">
                    <div class="flex gap-2 mb-4">
                        <input v-model="newProduct.name" placeholder="새 상품명" class="pro-input flex-1 px-3 py-2 rounded-md text-xs">
                        <input v-model.number="newProduct.price" placeholder="단가" type="number" class="pro-input w-24 px-3 py-2 rounded-md text-xs">
                        <button @click="saveProduct" class="btn-primary px-3 rounded-md text-xs font-bold"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul class="h-64 overflow-y-auto space-y-1 pr-1 custom-scrollbar bg-gray-50/50 rounded p-1">
                        <li v-for="(p, i) in products" :key="i" class="flex justify-between items-center p-2.5 bg-white border border-gray-100 rounded-lg hover:border-blue-200 transition shadow-sm">
                            <span class="text-gray-700 font-medium text-xs truncate max-w-[180px]">{{ p.name }}</span>
                            <div class="flex items-center gap-3 shrink-0">
                                <span class="text-blue-600 font-bold text-xs">{{ formatCurrency(p.price) }}</span>
                                <button @click="removeProduct(i)" class="text-gray-300 hover:text-red-500 transition px-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="bg-gray-50 px-5 py-3 border-t border-gray-200 flex justify-between items-center">
                    <button @click="updateExistingOrders" class="text-xs text-blue-600 hover:underline hover:text-blue-800">단가 일괄 적용</button>
                    <button @click="closeModal" class="btn-secondary px-4 py-1.5 rounded-md text-xs hover:bg-gray-200 font-bold text-gray-700">닫기</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <transition name="toast">
            <div v-if="toast.show" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-[9999]">
                <i class="fas fa-check-circle text-green-400"></i>
                <span class="font-medium text-sm">{{ toast.message }}</span>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    orders: [],
                    products: [
                        { name: "데일리 슬랙스", price: 39000 },
                        { name: "오버핏 셔츠", price: 45000 },
                        { name: "기본 무지 티셔츠", price: 15000 }
                    ],
                    manual: { nickname: '', product: '', qty: 1, receiver: '', phone: '', address: '' },
                    rawInput: '',
                    searchQuery: '',
                    showProductModal: false,
                    showSuggestions: false,
                    newProduct: { name: '', price: '' },
                    defaultShippingCost: 3000,
                    toast: { show: false, message: '' }
                }
            },
            computed: {
                filteredProducts() {
                    if (!this.manual.product) return [];
                    if (!Array.isArray(this.products)) return []; // Safety Check
                    return this.products.filter(p => p.name.includes(this.manual.product));
                },
                filteredOrderList() {
                    const query = this.searchQuery.toLowerCase().trim();
                    return this.orders.filter(o => 
                        (o.nickname && o.nickname.toLowerCase().includes(query)) || 
                        (o.phone && o.phone.includes(query)) ||
                        (o.receiver && o.receiver.includes(query))
                    ).sort((a, b) => b.timestamp - a.timestamp); 
                },
                shippingMasterMap() {
                    const map = {};
                    const sorted = [...this.orders].sort((a, b) => a.timestamp - b.timestamp);
                    sorted.forEach(o => {
                        if (o.nickname && !map[o.nickname]) {
                            map[o.nickname] = o.id;
                        }
                    });
                    return map;
                },
                dashboard() {
                    let totalRevenue = 0, cardRevenue = 0, cashRevenue = 0, shippingRevenue = 0;
                    let productUnpaid = 0, shippingUnpaid = 0;
                    let totalQty = 0;

                    this.filteredOrderList.forEach(order => {
                        totalQty += order.qty;
                        
                        const itemPrice = order.unitPrice * order.qty;
                        const isShippingMaster = this.shippingMasterMap[order.nickname] === order.id;
                        const shippingCost = isShippingMaster ? this.defaultShippingCost : 0;

                        totalRevenue += itemPrice + shippingCost;
                        cardRevenue += order.cardAmount || 0;
                        cashRevenue += order.depositAmount || 0;

                        const totalRequired = itemPrice + shippingCost;
                        const totalPaid = (order.cardAmount || 0) + (order.depositAmount || 0);
                        let remainingDue = totalRequired - totalPaid;

                        let sUnpaid = 0;
                        if (isShippingMaster) {
                            if (!order.isShippingPaid) {
                                sUnpaid = this.defaultShippingCost;
                            } else {
                                shippingRevenue += this.defaultShippingCost;
                            }
                        }
                        
                        let pUnpaid = remainingDue - sUnpaid;
                        
                        shippingUnpaid += sUnpaid;
                        productUnpaid += pUnpaid;
                    });

                    return {
                        totalRevenue, cardRevenue, cashRevenue, shippingRevenue,
                        totalUnpaid: productUnpaid + shippingUnpaid,
                        productUnpaid, shippingUnpaid,
                        orderCount: this.filteredOrderList.length,
                        totalQty
                    };
                }
            },
            mounted() {
                this.loadState();
                window.addEventListener('beforeunload', this.saveState);
                setInterval(this.saveState, 5000);
            },
            methods: {
                openModal() {
                    this.showProductModal = true;
                },
                closeModal() {
                    this.showProductModal = false;
                },
                showToast(msg) {
                    this.toast.message = msg;
                    this.toast.show = true;
                    setTimeout(() => { this.toast.show = false; }, 2000);
                },
                formatCurrency(value) {
                    return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(value);
                },
                getShippingMasterId(nickname) {
                    return this.shippingMasterMap[nickname];
                },
                calculateOrderTotal(order) {
                    let total = order.unitPrice * order.qty;
                    if (this.getShippingMasterId(order.nickname) === order.id) {
                        total += this.defaultShippingCost;
                    }
                    return total;
                },
                calculateUnpaid(order) {
                    const totalRequired = this.calculateOrderTotal(order);
                    const paid = (order.cardAmount || 0) + (order.depositAmount || 0);
                    return totalRequired - paid;
                },
                toggleShipping(order) {
                    order.isShippingPaid = !order.isShippingPaid;
                },
                
                // Parsing
                processInput() {
                    const lines = this.rawInput.split('\n');
                    let addedCount = 0;
                    
                    let ctxNickname = '';
                    let ctxPhone = '';
                    let ctxAddress = '';
                    let ctxReceiver = '';

                    lines.forEach(line => {
                        const cleanLine = line.trim();
                        if(!cleanLine) return;

                        let nameMatch = cleanLine.match(/^([가-힣]{2,4})/);
                        let phoneMatch = cleanLine.match(/010[-.\s]?([0-9]{4})[-.\s]?([0-9]{4})/);
                        
                        if (nameMatch) {
                            ctxNickname = nameMatch[0];
                            ctxReceiver = nameMatch[0];
                        }
                        if (phoneMatch) {
                            ctxPhone = `010-${phoneMatch[1]}-${phoneMatch[2]}`;
                        }

                        let tempLine = cleanLine;
                        if (nameMatch) tempLine = tempLine.replace(nameMatch[0], '');
                        if (phoneMatch) tempLine = tempLine.replace(phoneMatch[0], '');
                        
                        let foundProduct = null;
                        if(Array.isArray(this.products)) {
                             foundProduct = this.products.find(p => cleanLine.includes(p.name));
                        }
                        
                        if (foundProduct) {
                            tempLine = tempLine.replace(foundProduct.name, '');
                            
                            let qty = 1;
                            let qtyMatch = cleanLine.match(/([0-9]+)\s*개/);
                            if (!qtyMatch) qtyMatch = cleanLine.match(/\s([0-9]+)\s*$/);
                            if (qtyMatch) qty = parseInt(qtyMatch[1]);

                            if (ctxNickname) {
                                this.addOrderDirect(ctxNickname, ctxPhone, ctxAddress, ctxReceiver, foundProduct.name, qty, foundProduct.price);
                                addedCount++;
                            }
                        }

                        let potentialAddress = tempLine.replace(/^[:\s]+/, '').trim();
                        if (potentialAddress.length > 2 && isNaN(potentialAddress)) {
                            ctxAddress = potentialAddress;
                            if (foundProduct && addedCount > 0) {
                                this.orders[this.orders.length - 1].address = ctxAddress;
                            }
                        }
                    });

                    if(addedCount > 0) {
                        this.rawInput = '';
                        this.showToast(`${addedCount}건 추가됨`);
                    } else {
                        alert("분석된 주문이 없습니다.");
                    }
                },
                addOrderDirect(nick, phone, addr, recv, prodName, qty, price) {
                    this.orders.push({
                        id: Date.now() + Math.random(),
                        timestamp: Date.now(),
                        nickname: nick,
                        product: prodName,
                        unitPrice: price,
                        qty: qty,
                        receiver: recv || nick,
                        phone: phone || '',
                        address: addr || '',
                        cardAmount: 0,
                        depositAmount: 0,
                        isShippingPaid: false,
                    });
                },

                filterProducts() {
                    this.showSuggestions = true;
                },
                selectProduct(p) {
                    this.manual.product = p.name;
                    this.showSuggestions = false;
                },
                addOrder() {
                    if (!this.manual.nickname) return alert("주문자 필수");
                    if (!this.manual.product) return alert("상품명 필수");
                    
                    const productInfo = this.products.find(p => p.name === this.manual.product) || { price: 0 };
                    
                    this.addOrderDirect(
                        this.manual.nickname, 
                        this.manual.phone, 
                        this.manual.address, 
                        this.manual.receiver, 
                        this.manual.product, 
                        this.manual.qty, 
                        productInfo.price
                    );
                    
                    this.manual.product = '';
                    this.manual.qty = 1;
                    this.showToast("주문 추가됨");
                },
                openDaumPostcode() {
                    new daum.Postcode({
                        oncomplete: (data) => {
                            let addr = data.roadAddress || data.jibunAddress;
                            if(data.buildingName) addr += ` (${data.buildingName})`;
                            this.manual.address = addr;
                        }
                    }).open();
                },
                saveProduct() {
                    if(this.newProduct.name && this.newProduct.price) {
                        this.products.push({...this.newProduct});
                        this.newProduct = { name: '', price: '' };
                    }
                },
                removeProduct(index) {
                    if(confirm("삭제하시겠습니까?")) {
                        this.products.splice(index, 1);
                    }
                },
                updateExistingOrders() {
                    if(!confirm("모든 주문 단가를 현재 상품가로 변경합니까?")) return;
                    let count = 0;
                    this.orders.forEach(o => {
                        const p = this.products.find(prod => prod.name === o.product);
                        if(p && o.unitPrice !== p.price) {
                            o.unitPrice = p.price;
                            count++;
                        }
                    });
                    this.showToast(`${count}건 업데이트`);
                },
                deleteOrder(id) {
                    if(confirm("삭제하시겠습니까?")) {
                        this.orders = this.orders.filter(o => o.id !== id);
                    }
                },
                copyOrderInfo(order) {
                    const unpaid = this.calculateUnpaid(order);
                    const total = this.calculateOrderTotal(order);
                    const text = `[주문] ${order.product} (${order.qty}개)\n합계: ${this.formatCurrency(total)}\n미수: ${this.formatCurrency(unpaid)}\n계좌: OO은행 123-456-7890`;
                    
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToast("복사 완료");
                    });
                },
                saveState() {
                    const data = {
                        orders: this.orders,
                        products: this.products
                    };
                    localStorage.setItem('omProData_v2.2', JSON.stringify(data));
                },
                loadState() {
                    try {
                        // v2.2 로드 시도
                        const saved = localStorage.getItem('omProData_v2.2');
                        if (saved) {
                            const data = JSON.parse(saved);
                            this.orders = Array.isArray(data.orders) ? data.orders : [];
                            this.products = Array.isArray(data.products) ? data.products : this.products;
                        } else {
                            // 이전 버전 마이그레이션 (v2.1 -> v2.2)
                            const old = localStorage.getItem('omProData_v2.1');
                            if(old) {
                                const data = JSON.parse(old);
                                this.orders = Array.isArray(data.orders) ? data.orders : [];
                                this.products = Array.isArray(data.products) ? data.products : this.products;
                            }
                        }
                        
                        // Safety Check: products가 깨졌을 경우 대비
                        if(!Array.isArray(this.products)) {
                            this.products = [
                                { name: "데일리 슬랙스", price: 39000 },
                                { name: "오버핏 셔츠", price: 45000 }
                            ];
                        }
                    } catch (e) {
                        console.error("Load Error:", e);
                        // 심각한 오류 시 초기화하여 앱 멈춤 방지
                        this.products = [
                            { name: "초기화된 상품A", price: 10000 }
                        ];
                    }
                },
                backupData() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({orders: this.orders, products: this.products}));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `OM-PRO_Backup_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                clearAllData() {
                    if(confirm("모든 데이터가 삭제됩니다.")) {
                        this.orders = [];
                        localStorage.removeItem('omProData_v2.2');
                        localStorage.removeItem('omProData_v2.1');
                        location.reload();
                    }
                },
                exportExcel(type) {
                    let data = [];
                    if (type === 'all') {
                        data = this.filteredOrderList.map(o => ({
                            '닉네임': o.nickname,
                            '상품명': o.product,
                            '수량': o.qty,
                            '단가': o.unitPrice,
                            '합계': o.unitPrice * o.qty,
                            '수령인': o.receiver,
                            '전화번호': `\u200B${o.phone}`,
                            '주소': o.address,
                            '카드결제': o.cardAmount || 0,
                            '현금입금': o.depositAmount || 0,
                            '배송비': this.getShippingMasterId(o.nickname) === o.id ? this.defaultShippingCost : 0,
                            '미수금': this.calculateUnpaid(o)
                        }));
                    } else if (type === 'invoice') {
                        data = this.filteredOrderList.map(o => ({
                            '수령인': o.receiver,
                            '전화번호': `\u200B${o.phone}`,
                            '주소': o.address,
                            '상품명': o.product,
                            '수량': o.qty,
                            '비고': `합배송: ${o.nickname}`
                        }));
                    } else if (type === 'order') {
                        const summary = {};
                        this.filteredOrderList.forEach(o => {
                            if (!summary[o.product]) summary[o.product] = 0;
                            summary[o.product] += o.qty;
                        });
                        data = Object.keys(summary).map(key => ({
                            '상품명': key,
                            '총수량': summary[key]
                        }));
                    }

                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "OrderData");
                    XLSX.writeFile(wb, `OM-PRO_${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
                }
            }
        });
    </script>
</body>
</html>
