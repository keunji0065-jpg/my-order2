<html lang="ko" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강은지 주문서 PRO (Lite)</title>
    
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/fill/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparser.min.js" crossorigin="anonymous"></script>
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['NanumSquareNeo', 'Pretendard', 'sans-serif'],
                        mono: ['Pretendard', 'monospace'],
                    },
                    colors: {
                        brand: { 50: '#f0f4f8', 100: '#d9e2ec', 200: '#bcccdc', 300: '#9fb3c8', 400: '#829ab1', 500: '#627d98', 600: '#486581', 700: '#334e68', 800: '#243b53', 900: '#102a43' },
                        accent: { rose: '#d64545', teal: '#3ebd93', amber: '#f0b429', indigo: '#5c7cfa' },
                        sky: { 50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        dark: { bg: '#121212', card: '#1e1e1e', border: '#2c2c2c', input: '#252525' }
                    },
                    boxShadow: { 'soft': '0 1px 3px 0 rgba(0, 0, 0, 0.05)', 'inner-soft': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.03)' },
                    fontSize: { 'xxs': '0.65rem' },
                    animation: { spin: 'spin 1s linear infinite' }
                }
            }
        }
    </script>
    
    <style>
        @import url("https://cdn.jsdelivr.net/gh/moonspam/NanumSquareNeo/nanumsquareneo.css");
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css");
        body { font-family: 'NanumSquareNeo', sans-serif; -webkit-font-smoothing: antialiased; background-color: #f5f7fa; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        *:focus { outline: none !important; }
        
        /* [수정] 위아래 정렬을 완벽하게 맞추기 위해 버튼 영역(첫 컬럼)을 고정 픽셀(120px)로 설정하고, 
        /* [수정] 버튼들이 작아졌으므로 첫 컬럼 너비 축소 (135px -> 115px) */
        .grid-rows-compact { grid-template-columns: 75px 100px 70px 1.8fr 50px 80px 30px 1fr 30px; }
        
        .dragging { opacity: 0.5; border: 2px dashed #627d98; }
        @media print {
            @page { margin: 0; size: auto; }
            body { background-color: white; color: black; }
            body * { visibility: hidden; height: 0; overflow: hidden; }
            .print-area, .print-area * { visibility: visible; height: auto; overflow: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .receipt-container { box-shadow: none !important; border: 1px solid #ccc !important; margin: 0 auto; width: 100%; max-width: 100%; page-break-inside: avoid; }
            .page-break { page-break-after: always; }
        }
        .tab-content { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
        [contenteditable="true"]:focus { outline: 2px dashed #627d98; background-color: rgba(98, 125, 152, 0.05); border-radius: 4px; padding: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- GLOBAL UTILITIES ---
        // [MODIFIED] Helper to safely extract number from potential string with newlines
        const parseNum = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            // Take first line, remove commas, parse float
            const firstLine = String(val).split('\n')[0].replace(/,/g, '');
            const num = parseFloat(firstLine);
            return isNaN(num) ? 0 : num;
        };

        const sanitizeOrder = (order) => {
            if (!order || typeof order !== 'object') return null;
            
            // Allow string inputs for multiline support in UI, but ensure numeric values for calculation
            const rawPrice = order.price !== undefined ? order.price : 0;
            const rawQty = order.quantity !== undefined ? order.quantity : 1;

            const sanitized = {
                id: order.id || Date.now() + Math.random(),
                customer: order.customer || '',
                product: order.product || '',
                quantity: rawQty, // Keep raw for display (might be string)
                price: rawPrice, // Keep raw for display
                deposit: Number(order.deposit) || 0,
                cardAmount: Number(order.cardAmount) || 0,
                isPaid: !!order.isPaid,
                isCardPaid: !!order.isCardPaid,
                isShippingPaid: !!order.isShippingPaid,
                customShippingFee: order.customShippingFee === null ? null : (Number(order.customShippingFee) || 0),
                memo: order.memo || '',
                originalText: order.originalText || '',
                recipientName: order.recipientName || '',
                phone: order.phone || '', 
                zipCode: order.zipCode || '',
                addressText: order.addressText || '',
                addressDetail: order.addressDetail || '',
                shippingMemo: order.shippingMemo || '',
                isCRM: !!order.isCRM,
            };
            sanitized.isAddressFilled = !!sanitized.recipientName && !!sanitized.phone && !!sanitized.addressText;
            return sanitized;
        };

        const Icon = React.memo(({ name, size = 14, className = "", weight = "regular", spin = false }) => {
            const map = {
                ClipboardList: "ph-clipboard-text", FileDown: "ph-download-simple", Trash2: "ph-trash", Plus: "ph-plus",
                Search: "ph-magnifying-glass", Youtube: "ph-youtube-logo", CheckCircle: "ph-check-circle", 
                ShoppingCart: "ph-shopping-cart", DollarSign: "ph-currency-dollar", CreditCard: "ph-credit-card",
                Truck: "ph-truck", Copy: "ph-copy", X: "ph-x", Pencil: "ph-pencil-simple",
                Moon: "ph-moon", FloppyDisk: "ph-floppy-disk", Clock: "ph-clock-countdown", Money: "ph-money", Package: "ph-package",
                ArrowRight: "ph-arrow-right", UploadSimple: "ph-upload-simple", Note: "ph-note-pencil", MapPin: "ph-map-pin",
                Address: "ph-map-pin", User: "ph-user", Brain: "ph-brain", ChartBar: "ph-chart-bar", WarningCircle: "ph-warning-circle",
                Wallet: "ph-wallet", TrendUp: "ph-trend-up", Coins: "ph-coins", Bank: "ph-bank", Receipt: "ph-receipt",
                HandCoins: "ph-hand-coins", Calculator: "ph-calculator", Eraser: "ph-eraser", List: "ph-list",
                CaretDown: "ph-caret-down", FileXls: "ph-file-xls", Sun: "ph-sun", Lightning: "ph-lightning",
                Star: "ph-star", Users: "ph-users", AddressBook: "ph-address-book", CloudArrowUp: "ph-cloud-arrow-up", CloudArrowDown: "ph-cloud-arrow-down",
                Gear: "ph-gear", Spinner: "ph-spinner", Printer: "ph-printer", Receipt: "ph-receipt", House: "ph-house",
                Tag: "ph-tag", ChatCircle: "ph-chat-circle", ChartPie: "ph-chart-pie", Warehouse: "ph-warehouse",
                Folder: "ph-folder", FolderOpen: "ph-folder-open", CaretUp: "ph-caret-up", Headset: "ph-headset",
                ArrowCounterClockwise: "ph-arrow-counter-clockwise", ArrowsLeftRight: "ph-arrows-left-right", Calendar: "ph-calendar",
                DotsSixVertical: "ph-dots-six-vertical", ChatText: "ph-chat-text", Link: "ph-link", Robot: "ph-robot", UserFocus: "ph-user-focus",
                FileCsv: "ph-file-csv", CaretRight: "ph-caret-right", DownloadSimple: "ph-download-simple", CaretLeft: "ph-caret-left",
                Trophy: "ph-trophy"
            };
            const weightClass = weight === 'bold' ? 'ph-bold' : (weight === 'fill' ? 'ph-fill' : 'ph');
            const spinClass = spin ? 'animate-spin' : '';
            return <i className={`${weightClass} ${map[name] || 'ph-question'} ${className} ${spinClass}`} style={{ fontSize: size }}></i>;
        });

        const ActionButton = React.memo(({ onClick, color, icon, text, active, className, loading }) => {
            const base = "px-2 py-1 rounded-sm text-xs font-bold flex items-center gap-1 transition-all border shadow-sm h-7";
            const colors = {
                brand: "bg-brand-600 text-white border-brand-700 hover:bg-brand-700",
                white: "bg-white dark:bg-dark-card text-slate-600 dark:text-slate-300 border-slate-200 dark:border-dark-border hover:bg-slate-50 hover:text-brand-700",
                dark: "bg-brand-800 text-white border-brand-900 hover:bg-brand-900",
                ghost: "bg-transparent text-slate-500 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800",
            };
            return (
                <button onClick={onClick} disabled={loading} className={`${base} ${colors[color] || colors.white} ${active ? 'ring-1 ring-brand-500' : ''} ${className} ${loading ? 'opacity-70 cursor-wait' : ''}`}>
                    {loading ? <Icon name="Spinner" size={12} spin={true}/> : <Icon name={icon} size={12} weight="bold"/>} {text}
                </button>
            );
        });

        const ProductAutocomplete = ({ value, onChange, id, onKeyDown }) => {
            return (
                <input 
                    id={id}
                    className="w-full bg-transparent font-bold outline-none" 
                    value={value} 
                    onChange={onChange} 
                    onKeyDown={onKeyDown}
                />
            );
        };

        // --- COMPONENT: Summary Section ---
        const SummarySection = React.memo(({ stats, handleUnpaidFilterClick, unpaidFilter }) => {
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-3 w-full flex flex-wrap md:flex-nowrap items-center justify-between gap-4 divide-y md:divide-y-0 md:divide-x divide-slate-100 dark:divide-slate-700">
                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[140px]">
                        <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="TrendUp" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">총 예상 매출</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-extrabold text-blue-900 dark:text-blue-100 font-mono">{stats.totalRev.toLocaleString()}</span>
                                <span className="text-xs text-slate-400">원</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[120px]">
                        <div className="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Package" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">총 주문량</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-lg font-bold text-slate-700 dark:text-slate-200 font-mono">{stats.qty}</span>
                                <span className="text-xs text-slate-400">개</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 px-2 flex items-center gap-3 min-w-[120px]">
                        <div className="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Truck" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">배송 건수</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-lg font-bold text-slate-700 dark:text-slate-200 font-mono">{stats.shippingCount}</span>
                                <span className="text-xs text-slate-400">건 (명)</span>
                            </div>
                        </div>
                    </div>

                    <div 
                        className={`flex-1 px-2 flex items-center gap-3 min-w-[140px] cursor-pointer transition-colors rounded-lg p-1 ${unpaidFilter === 'cash' ? 'bg-red-50 dark:bg-red-900/20 ring-1 ring-rose-200' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        onClick={() => handleUnpaidFilterClick('cash')}
                    >
                        <div className="w-10 h-10 bg-rose-100 text-rose-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Wallet" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">물품 미수금</span>
                            <span className={`text-lg font-bold font-mono ${stats.productUnpaid > 0 ? 'text-rose-600' : 'text-slate-700 dark:text-slate-200'}`}>{stats.productUnpaid.toLocaleString()}</span>
                        </div>
                    </div>

                    <div 
                        className={`flex-1 px-2 flex items-center gap-3 min-w-[140px] cursor-pointer transition-colors rounded-lg p-1 ${unpaidFilter === 'ship' ? 'bg-amber-50 dark:bg-amber-900/20 ring-1 ring-amber-200' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}
                        onClick={() => handleUnpaidFilterClick('ship')}
                    >
                        <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-md flex items-center justify-center shrink-0">
                            <Icon name="Truck" size={20} weight="bold"/>
                        </div>
                        <div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider block">배송 미수금</span>
                            <span className={`text-lg font-bold font-mono ${stats.shipUnpaid > 0 ? 'text-amber-600' : 'text-slate-700 dark:text-slate-200'}`}>{stats.shipUnpaid.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            );
        });

        // --- COMPONENT: Tab Navigation ---
        const TabNavigation = ({ activeTab, onTabChange }) => {
            const tabs = [
                { id: 'order', label: '주문관리', icon: 'ClipboardList' },
                { id: 'customer', label: '고객관리', icon: 'User' },
                { id: 'statement', label: '구매내역서', icon: 'Receipt' },
            ];

            return (
                <div className="flex items-end px-2 pt-1 border-b border-slate-200 dark:border-dark-border bg-white dark:bg-dark-card shrink-0 gap-1 overflow-x-auto no-scrollbar">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => onTabChange(tab.id)}
                            className={`flex items-center gap-1.5 px-3 py-2 text-xs font-bold rounded-t-lg transition-all border-t border-x relative top-[1px]
                                ${activeTab === tab.id 
                                    ? 'bg-[#f5f7fa] dark:bg-dark-bg border-slate-200 dark:border-dark-border border-b-[#f5f7fa] dark:border-b-dark-bg text-brand-600 dark:text-brand-400 z-10' 
                                    : 'bg-slate-50 dark:bg-dark-input border-transparent text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800'
                                }`}
                        >
                            <Icon name={tab.icon} size={14} weight={activeTab === tab.id ? 'fill' : 'regular'} />
                            <span>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        // --- OTHER COMPONENTS ---
        const AddressAdminPanel = ({ selectedOrder, handleUpdateOrderBatch, showToast }) => {
            const [localAddr, setLocalAddr] = useState({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' });
            const [tab, setTab] = useState('input'); const [rawText, setRawText] = useState('');
            useEffect(() => { if (selectedOrder) { setLocalAddr({ recipientName: selectedOrder.recipientName || '', phone: selectedOrder.phone || '', addressText: selectedOrder.addressText || '', addressDetail: selectedOrder.addressDetail || '', shippingMemo: selectedOrder.shippingMemo || '' }); setRawText(''); } else { setLocalAddr({ recipientName: '', phone: '', addressText: '', addressDetail: '', shippingMemo: '' }); } }, [selectedOrder]);
            const handleChange = (field, val) => setLocalAddr(prev => ({...prev, [field]: val}));
            const handleSave = () => { if (!selectedOrder) return; handleUpdateOrderBatch(selectedOrder.id, localAddr); showToast('주소 정보 저장 완료'); };
            const handlePostcode = () => { new daum.Postcode({ oncomplete: function(data) { setLocalAddr(prev => ({ ...prev, zipCode: data.zonecode, addressText: data.address, addressDetail: '' })); } }).open(); };
            const handleParseRaw = () => { if (!rawText.trim()) return; let text = rawText; let name = '', phone = '', address = '', memo = ''; const phoneMatch = text.match(/(01[016789])[- .]?(\d{3,4})[- .]?(\d{4})/); if (phoneMatch) { phone = phoneMatch[0]; text = text.replace(phone, ''); } const zipMatch = text.match(/\d{5}/); if(zipMatch) text = text.replace(zipMatch[0], ''); const lines = text.split('\n').map(l => l.trim()).filter(Boolean); lines.forEach(line => { if (line.match(/^(이름|수령인|받는분):?/)) name = line.replace(/^(이름|수령인|받는분):?/, '').trim();else if (line.match(/^(주소|배송지):?/)) address = line.replace(/^(주소|배송지):?/, '').trim();else if (line.match(/^(메모|요청사항):?/)) memo = line.replace(/^(메모|요청사항):?/, '').trim(); }); if (!name && lines.length > 0) name = lines[0]; if (!address && lines.length > 1) address = lines.find(l => l !== name && l.match(/[시도구군길로]/)) || lines[1]; setLocalAddr(prev => ({ ...prev, recipientName: name || prev.recipientName, phone: phone || prev.phone, addressText: address || prev.addressText, shippingMemo: memo || prev.shippingMemo })); setTab('edit'); showToast("정보가 입력되었습니다. 확인해주세요."); };
            
            if (!selectedOrder) { return (<div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col h-full shadow-soft items-center justify-center text-slate-400 text-xs"><Icon name="MapPin" size={24} className="mb-2 opacity-50"/><p>주문을 선택해주세요</p></div>); }
            return (
                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col h-full shadow-soft overflow-hidden">
                    <div className="flex items-center justify-between px-2 pt-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 shrink-0"><div className="flex gap-1"><button onClick={()=>setTab('input')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='input' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>정보 붙여넣기</button><button onClick={()=>setTab('edit')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${tab==='edit' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>상세 수정</button></div><span className="text-[9px] text-slate-400 font-mono pb-1 pr-1">#{selectedOrder.id.toString().slice(-4)}</span></div>
                    <div className="flex-1 overflow-y-auto p-2">{tab === 'input' ? (<div className="h-full flex flex-col gap-2"><textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs resize-none outline-none focus:border-brand-500 placeholder-slate-400" placeholder="예시:&#13;&#10;홍길동&#13;&#10;010-1234-5678&#13;&#10;서울시 강남구..." value={rawText} onChange={e => setRawText(e.target.value)}></textarea><button onClick={handleParseRaw} className="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white rounded text-xs font-bold transition-colors">자동 입력</button></div>) : (<div className="space-y-2"><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">수령인</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.recipientName} onChange={e=>handleChange('recipientName', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">연락처</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.phone} onChange={e=>handleChange('phone', e.target.value)} /></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">주소</label><div className="flex-1 flex flex-col gap-1"><div className="relative w-full"><input className="w-full p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500 pr-6" value={localAddr.addressText} onChange={e=>handleChange('addressText', e.target.value)} /><button onClick={handlePostcode} className="absolute right-1 top-1 text-slate-400 hover:text-brand-600"><Icon name="Search" size={10}/></button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={localAddr.addressDetail} onChange={e=>handleChange('addressDetail', e.target.value)} /></div></div><div className="flex items-center gap-2"><label className="w-12 text-xs text-slate-500 text-right">배송메모</label><input className="flex-1 p-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded text-xs outline-none focus:border-brand-500" value={localAddr.shippingMemo} onChange={e=>handleChange('shippingMemo', e.target.value)} /></div><div className="pt-2 text-right"><button onClick={handleSave} className="bg-brand-600 hover:bg-brand-700 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors shadow-sm">저장</button></div></div>)}</div></div>
            );
        };
       
        const CustomerTab = ({ customerDB, setCustomerDB, orders, showToast }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [search, setSearch] = useState('');
            const fileInputRef = useRef(null);
            const allCustomers = useMemo(() => { const orderCustomers = new Set(orders.map(o => o.customer)); const dbCustomers = Object.keys(customerDB); const merged = new Set([...orderCustomers, ...dbCustomers]); return Array.from(merged).filter(c => c && c.toLowerCase().includes(search.toLowerCase())).sort(); }, [orders, customerDB, search]);
            const customerOrders = useMemo(() => { if (!selectedCustomer) return []; return orders.filter(o => o.customer === selectedCustomer).sort((a,b) => b.id - a.id); }, [orders, selectedCustomer]);
            const handleUpdateCustomer = (field, value) => { if (!selectedCustomer) return; setCustomerDB(prev => ({ ...prev, [selectedCustomer]: { ...prev[selectedCustomer], [field]: value } })); };
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['닉네임'] || row['Nickname'] || row['이름'] || row['성함']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['수령인'] || row['받는분'] || row['이름'] || nick.trim(), phone: row['연락처'] || row['전화번호'] || row['휴대폰'] || '', zipCode: row['우편번호'] || row['Zip'] || '', addressText: row['주소'] || row['Address'] || row['기본주소'] || '', addressDetail: row['상세주소'] || '', shippingMemo: row['배송메모'] || row['배송요청사항'] || row['메모'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`총 ${count}명 고객 등록 완료`, 'success'); } }); e.target.value = null; };
            const handleFileDownload = () => { const rows = Object.entries(customerDB).map(([nick, info]) => ({ '닉네임': nick, '수령인': info.recipientName, '연락처': info.phone, '우편번호': info.zipCode, '주소': info.addressText, '상세주소': info.addressDetail, '배송메모': info.shippingMemo })); const csv = Papa.unparse(rows); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', `고객목록_${new Date().toISOString().slice(0, 10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const currentInfo = customerDB[selectedCustomer] || {};

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="AddressBook" size={14}/> 고객 목록</h3><div className="flex gap-1"><button onClick={() => fileInputRef.current.click()} className="text-[10px] bg-brand-600 text-white px-2 py-1 rounded hover:bg-brand-700 flex items-center gap-1"><Icon name="FileCsv"/> 업로드</button><button onClick={handleFileDownload} className="text-[10px] bg-slate-500 text-white px-2 py-1 rounded hover:bg-slate-600 flex items-center gap-1"><Icon name="DownloadSimple"/> 다운</button></div><input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} /></div>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="고객명 검색..." value={search} onChange={e => setSearch(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">{allCustomers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold dark:bg-brand-900/30 dark:text-brand-400' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span className="truncate">{c}</span>{customerDB[c] && <Icon name="CheckCircle" size={10} className="text-emerald-500"/>}</button>))}</div>
                    </div>
                    <div className="flex-1 flex flex-col gap-4 overflow-hidden">
                        {selectedCustomer ? (
                            <>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm p-4"><h3 className="text-sm font-bold mb-4 flex items-center gap-2 border-b border-slate-100 dark:border-slate-800 pb-2"><div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center"><Icon name="User"/></div>{selectedCustomer} 님의 정보</h3><div className="grid grid-cols-2 gap-4"><div><label className="text-xs text-slate-500 block mb-1">수령인</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.recipientName || ''} onChange={e => handleUpdateCustomer('recipientName', e.target.value)} /></div><div><label className="text-xs text-slate-500 block mb-1">연락처</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.phone || ''} onChange={e => handleUpdateCustomer('phone', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">주소</label><div className="flex gap-2 mb-1"><input className="flex-1 p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.addressText || ''} onChange={e => handleUpdateCustomer('addressText', e.target.value)} /><button onClick={() => new daum.Postcode({ oncomplete: (data) => { handleUpdateCustomer('zipCode', data.zonecode); handleUpdateCustomer('addressText', data.address); } }).open()} className="bg-slate-100 px-3 rounded text-xs hover:bg-slate-200">검색</button></div><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" placeholder="상세주소 (동/호수)" value={currentInfo.addressDetail || ''} onChange={e => handleUpdateCustomer('addressDetail', e.target.value)} /></div><div className="col-span-2"><label className="text-xs text-slate-500 block mb-1">배송메모</label><input className="w-full p-2 border rounded text-sm dark:bg-dark-input dark:border-slate-700" value={currentInfo.shippingMemo || ''} onChange={e => handleUpdateCustomer('shippingMemo', e.target.value)} /></div></div></div>
                                <div className="bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex-1 flex flex-col overflow-hidden"><div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20"><h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1"><Icon name="Clock"/> 주문 이력</h3></div><div className="flex-1 overflow-y-auto"><table className="w-full text-xs text-left"><thead className="bg-slate-50 dark:bg-dark-input text-slate-500 border-b dark:border-slate-700 sticky top-0"><tr><th className="p-2">날짜</th><th className="p-2">상품명</th><th className="p-2">수량</th><th className="p-2 text-right">금액</th><th className="p-2 text-center">상태</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-800">{customerOrders.map(o => (<tr key={o.id}><td className="p-2 text-slate-400">{new Date(o.id).toLocaleDateString()}</td><td className="p-2 font-bold">{o.product}</td><td className="p-2">{o.quantity}</td><td className="p-2 text-right font-mono">{o.price.toLocaleString()}</td><td className="p-2 text-center"><span className={`px-2 py-0.5 rounded-full ${o.isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>{o.isPaid ? '결제완료' : '미결제'}</span></td></tr>))}{customerOrders.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">주문 내역이 없습니다.</td></tr>}</tbody></table></div></div>
                            </>
                        ) : (<div className="flex-1 flex flex-col items-center justify-center text-slate-400"><Icon name="User" size={48} className="mb-2 opacity-20"/><p>왼쪽 목록에서 고객을 선택하세요.</p></div>)}
                    </div>
                </div>
            );
        };
        const StatementTab = ({ orders, quickShipping, customerDB, categoryOrder }) => {
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedSite, setSelectedSite] = useState('all');
            const [printLayout, setPrintLayout] = useState('single');
            const [printMode, setPrintMode] = useState('single'); // 'single' (individual) or 'batch' (site-wise)
            const [isEditMode, setIsEditMode] = useState(false);

            const customers = useMemo(() => { 
                const unique = [...new Set(orders.map(o => o.customer))]; 
                return unique.filter(c => c.toLowerCase().includes(searchTerm.toLowerCase())).sort(); 
            }, [orders, searchTerm]);
            
            // Filter customers for BATCH print based on selected Site
            const batchCustomers = useMemo(() => {
                if (printMode !== 'batch') return [];
                const unique = [...new Set(orders.map(o => o.customer))];
                return unique.filter(c => {
                    // This logic assumes we can determine site from orders. 
                    // Since orders don't store site directly in this version, we might need to rely on categoryOrder or pass productCategories.
                    // For simplicity, let's assume if any order matches the site or if site is 'all'.
                    // In a real app, orders should have 'site' property. 
                    // Let's filter by customer name search for batch as well.
                    return c.toLowerCase().includes(searchTerm.toLowerCase());
                }).sort();
            }, [orders, searchTerm, printMode, selectedSite]); // selectedSite dependency added for future logic expansion

            const SingleReceipt = ({ customerName }) => {
                const targetOrders = orders.filter(o => o.customer === customerName);
                const productTotal = targetOrders.reduce((sum, o) => sum + o.price, 0);
                
                // [FIXED] 배송비 계산: 해당 고객의 주문 중 "가장 오래된 주문(Main Order)"의 배송비를 우선 적용
                const mainOrder = targetOrders.reduce((oldest, current) => (current.id < oldest.id ? current : oldest), targetOrders[0]);
                const shipFee = (mainOrder && mainOrder.customShippingFee !== null && mainOrder.customShippingFee !== undefined) 
                    ? mainOrder.customShippingFee 
                    : Number(quickShipping);
                
                const grandTotal = productTotal + shipFee;
                const info = customerDB[customerName] || {};
                
                return (
                    <div className={`bg-white p-8 rounded-lg w-[400px] receipt-container text-slate-800 page-break mb-8`} contentEditable={isEditMode} suppressContentEditableWarning={true}>
                        <div className="flex justify-between items-end mb-6"><div><p className="text-xs text-slate-500 mb-1">To.</p><h3 className="text-lg font-bold">{customerName} 님</h3><p className="text-xs text-slate-500 mt-1">{info.phone || ''}</p><p className="text-xs text-slate-500">{info.addressText || ''} {info.addressDetail || ''}</p></div><div className="text-right"><p className="text-xs text-slate-500">Date</p><p className="text-sm font-mono">{new Date().toLocaleDateString()}</p></div></div>
                        <table className="w-full text-sm mb-6"><thead className="border-b border-slate-200"><tr><th className="text-left py-2">상품명</th><th className="text-center py-2 w-12">수량</th><th className="text-right py-2 w-20">금액</th></tr></thead><tbody className="divide-y divide-slate-100">{targetOrders.map(o => (<tr key={o.id}><td className="py-2">{o.product}</td><td className="py-2 text-center">{o.quantity}</td><td className="py-2 text-right font-mono">{parseNum(o.price).toLocaleString()}</td></tr>))}</tbody></table>
                        <div className="border-t-2 border-slate-800 pt-4 space-y-2"><div className="flex justify-between text-sm"><span>상품 합계</span><span className="font-mono">{productTotal.toLocaleString()}원</span></div><div className="flex justify-between text-sm"><span>배송비</span><span className="font-mono">{shipFee.toLocaleString()}원</span></div><div className="flex justify-between text-xl font-black mt-4 pt-2 border-t border-slate-200"><span>Total</span><span>{grandTotal.toLocaleString()}원</span></div></div>
                        <div className="mt-8 text-center text-xs text-slate-400">감사합니다. 또 이용해주세요!<br/>강은지 주문서 PRO</div>
                    </div>
                );
            };

            return (
                <div className="flex h-full tab-content gap-4 p-4">
                    <div className="w-64 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden no-print">
                        <div className="p-3 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-2">
                            <div className="flex gap-2 mb-2">
                                <button onClick={()=>setPrintMode('single')} className={`flex-1 py-1 text-xs rounded border ${printMode==='single'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>개별 인쇄</button>
                                <button onClick={()=>setPrintMode('batch')} className={`flex-1 py-1 text-xs rounded border ${printMode==='batch'?'bg-brand-600 text-white border-brand-600':'bg-white text-slate-600 border-slate-200'}`}>일괄 인쇄</button>
                            </div>
                            <select className="w-full bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none py-1 px-2" value={selectedSite} onChange={e=>setSelectedSite(e.target.value)}>
                                <option value="all">전체 사이트</option>
                                {categoryOrder.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <div className="relative"><input className="w-full pl-7 pr-2 py-1.5 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder={printMode==='batch'?"필터링할 고객 검색...":"영수증 발급할 고객 검색..."} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div></div>
                            <div className="flex gap-2 text-xs font-bold text-slate-500 mt-2">
                                <label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='single'} onChange={()=>setPrintLayout('single')}/> A4 1장 1개</label>
                                <label className="flex items-center gap-1"><input type="radio" name="layout" checked={printLayout==='double'} onChange={()=>setPrintLayout('double')}/> A4 1장 2개</label>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">
                            {printMode === 'single' 
                                ? customers.map(c => (<button key={c} onClick={() => setSelectedCustomer(c)} className={`w-full text-left px-3 py-2 text-xs rounded transition-colors flex items-center justify-between ${selectedCustomer === c ? 'bg-brand-50 text-brand-700 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600'}`}><span className="truncate">{c}</span><Icon name="CaretRight" size={10} className="opacity-50"/></button>))
                                : <div className="p-3 text-xs text-slate-500 text-center">총 {batchCustomers.length}명의 고객이<br/>인쇄 대기 중입니다.</div>
                            }
                        </div>
                    </div>
                    <div className="flex-1 bg-slate-100 dark:bg-dark-bg rounded-lg border border-slate-200 dark:border-dark-border flex flex-col items-center justify-center p-8 overflow-y-auto relative">
                        {((printMode === 'single' && selectedCustomer) || (printMode === 'batch' && batchCustomers.length > 0)) ? (
                            <div className="flex flex-col gap-4 items-center w-full h-full justify-center">
                                {/* Controls */}
                                <div className="no-print flex gap-2 mb-4">
                                    <button onClick={()=>setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-md font-bold text-xs flex items-center gap-2 ${isEditMode ? 'bg-amber-500 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}><Icon name={isEditMode?"CheckCircle":"Pencil"}/> {isEditMode ? '수정 완료' : '내용 수정하기'}</button>
                                    <button onClick={()=>window.print()} className="bg-slate-800 text-white px-4 py-2 rounded-md font-bold hover:bg-slate-700 flex items-center gap-2 text-xs"><Icon name="Printer"/> 인쇄하기</button>
                                </div>

                                {/* Screen Preview (Single Only or First of Batch) */}
                                <div className="no-print shadow-lg rounded-lg overflow-hidden border border-slate-200 bg-white">
                                    <SingleReceipt customerName={printMode === 'single' ? selectedCustomer : batchCustomers[0]} />
                                </div>
                                {printMode === 'batch' && <div className="no-print text-xs text-slate-400 mt-2">...외 {batchCustomers.length - 1}명의 영수증이 인쇄됩니다.</div>}

                                {/* Print Area (Hidden on Screen) */}
                                <div className="print-area hidden">
                                    {(printMode === 'single' ? [selectedCustomer] : batchCustomers).map((c, i) => (
                                        <div key={i}>
                                            {printLayout === 'single' ? (
                                                <div className="flex justify-center items-center h-[100vh] page-break"><SingleReceipt customerName={c} /></div>
                                            ) : (
                                                <div className="flex flex-col justify-between h-[100vh] py-10 page-break">
                                                    <div className="flex justify-center"><SingleReceipt customerName={c} /></div>
                                                    <div className="border-b border-dashed border-slate-400 w-full my-4"></div>
                                                    <div className="flex justify-center"><SingleReceipt customerName={c} /></div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (<div className="text-center text-slate-400"><Icon name="Receipt" size={64} className="mb-4 opacity-20 inline-block"/><p>대상이 선택되지 않았습니다.</p></div>)}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isDarkMode, setIsDarkMode] = useState(() => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [rawInput, setRawInput] = useState('');
            const [activeTab, setActiveTab] = useState('order'); 
            const [currentSite, setCurrentSite] = useState(() => localStorage.getItem('currentSite') || ''); // [MODIFIED] Default warehouse removed (empty string)
            const [converterTab, setConverterTab] = useState('general');
            const [batchProduct, setBatchProduct] = useState('');
            const [batchPrice, setBatchPrice] = useState('');
            const [batchCode, setBatchCode] = useState('');
            const [selectedCustomerFolder, setSelectedCustomerFolder] = useState('all');
            const [folderSearch, setFolderSearch] = useState('');

            // NEW: Message Panel States
            const [manualMessage, setManualMessage] = useState('');

            const [productHistory, setProductHistory] = useState(() => JSON.parse(localStorage.getItem('productHistory')) || {});
            const [productCategories, setProductCategories] = useState(() => JSON.parse(localStorage.getItem('productCategories')) || {});
            const [productNumbers, setProductNumbers] = useState(() => JSON.parse(localStorage.getItem('productNumbers')) || {});
            const [categoryOrder, setCategoryOrder] = useState(() => JSON.parse(localStorage.getItem('categoryOrder')) || []);
            const [customerDB, setCustomerDB] = useState(() => JSON.parse(localStorage.getItem('customerDB')) || {}); 
            const [orders, setOrders] = useState(() => JSON.parse(localStorage.getItem('youtubeOrders')) || []);
            
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('googleScriptUrl') || '');
            const [shippingFee, setShippingFee] = useState(4000);
            const [filterText, setFilterText] = useState('');
            const [quickCode, setQuickCode] = useState('');
            const [quickName, setQuickName] = useState('');
            const [quickPrice, setQuickPrice] = useState('');
            const [quickShipping, setQuickShipping] = useState(4000); // 사용자 입력/기본 배송비
            const [speedInput, setSpeedInput] = useState('');
            const [isProcessing, setIsProcessing] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [toast, setToast] = useState(null);
            const [editingAmountId, setEditingAmountId] = useState(null);
            const [editingAddressId, setEditingAddressId] = useState(null); 
            const [editingShippingId, setEditingShippingId] = useState(null); 
            const [unpaidFilter, setUnpaidFilter] = useState(null); 
            const [isExcelMenuOpen, setIsExcelMenuOpen] = useState(false);
            const [isReceiptModalOpen, setIsReceiptModalOpen] = useState(false);
            const [focusedOrderId, setFocusedOrderId] = useState(null);
            const [editSource, setEditSource] = useState(null); // [NEW] Track edit source ('card' etc)

            const fileInputRef = useRef(null);
            const customerFileRef = useRef(null);
            const excelMenuRef = useRef(null); 

            useEffect(() => { if (isDarkMode) document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark'); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('youtubeOrders', JSON.stringify(orders)); }, [orders]);
            useEffect(() => { localStorage.setItem('productHistory', JSON.stringify(productHistory)); }, [productHistory]);
            useEffect(() => { localStorage.setItem('productCategories', JSON.stringify(productCategories)); }, [productCategories]);
            useEffect(() => { localStorage.setItem('productNumbers', JSON.stringify(productNumbers)); }, [productNumbers]);
            useEffect(() => { localStorage.setItem('categoryOrder', JSON.stringify(categoryOrder)); }, [categoryOrder]);
            useEffect(() => { localStorage.setItem('customerDB', JSON.stringify(customerDB)); }, [customerDB]);
            useEffect(() => { localStorage.setItem('googleScriptUrl', googleScriptUrl); }, [googleScriptUrl]);
            useEffect(() => { localStorage.setItem('currentSite', currentSite); }, [currentSite]);
            useEffect(() => { const handleClickOutside = (event) => { if (excelMenuRef.current && !excelMenuRef.current.contains(event.target)) { setIsExcelMenuOpen(false); } }; document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside); }, []);

            const recentProducts = useMemo(() => Object.entries(productHistory).reverse().slice(0, 50), [productHistory]);
            const showToast = (message, type = 'success') => { setToast({ message, type }); setTimeout(() => setToast(null), 2500); };
            const handleRecentProductClick = (name, price) => {
                if (activeTab === 'order' && focusedOrderId) {
                     // Check if focused order needs update
                     setOrders(prev => prev.map(o => {
                         if (o.id === focusedOrderId) {
                             const site = productCategories[name] || currentSite;
                             const code = productNumbers[name] || '';
                             return { ...o, product: name, price: o.quantity * price };
                         }
                         return o;
                     }));
                     showToast("선택된 주문의 상품이 업데이트되었습니다.");
                } else {
                    if (converterTab === 'batch') { setBatchProduct(name); setBatchPrice(price); } else { setQuickName(name); setQuickPrice(price); }
                }
            };

            const handleQuickAddOrder = () => {
                if(quickName.trim()) {
                     const pName = quickName.trim();
                     const pPrice = Number(quickPrice);
                     const pSite = currentSite; 
                     const pCode = quickCode.trim();
                     setProductHistory(prev => ({...prev, [pName]: pPrice}));
                     setProductCategories(prev => ({...prev, [pName]: pSite}));
                     setProductNumbers(prev => ({...prev, [pName]: pCode}));
                     setCategoryOrder(prev => prev.includes(pSite) ? prev : [...prev, pSite]);
                }
                setOrders(prev => [sanitizeOrder({ id: Date.now(), customer: '', product: quickName || '', quantity: 1, price: Number(quickPrice) || 0, customShippingFee: Number(quickShipping) }), ...prev]);
                showToast("주문이 추가되었습니다.");
            };

            const handleUpdateOrder = (id, field, value) => { 
                setOrders(prev => prev.map(o => { 
                    if (o.id !== id) return o; 
                    let updates = { [field]: value };
                    
                    // [MODIFIED] Use parseNum for calculations as values can be strings now
                    const numValue = parseNum(value);
                    
                    if (field === 'quantity') {
                        const unitPrice = productHistory[o.product] || 0;
                        // Only auto-update price if it seems calculated (simple logic) or always?
                        // Let's simple update price based on history if available
                        if (unitPrice > 0) updates.price = numValue * unitPrice;
                    }
                    if (field === 'product') {
                        const unitPrice = productHistory[value] || 0;
                        updates.price = parseNum(o.quantity) * unitPrice;
                    }
                    if (field === 'price' && o.product) {
                         const qty = parseNum(o.quantity);
                         if (qty > 0) {
                             setProductHistory(h => ({...h, [o.product]: numValue/qty}));
                         }
                    }
                    // Also update productNumbers map if code changes
                    if (field === 'codeInput') {
                        // Special field name for the code input
                        setProductNumbers(prev => ({...prev, [o.product]: value}));
                        return o; // Don't update order itself, just the map (re-render will show new code)
                    }

                    return sanitizeOrder({ ...o, ...updates }); 
                })); 
            };

            const handleDelete = (id) => setOrders(prev => prev.filter(o => o.id !== id));
            
            // [MODIFIED] Deposit Logic for manual input / setting
            const handleAutoDepositFull = (id) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const price = parseNum(o.price);
                    const currentDeposit = o.deposit;
                    
                    // 우클릭 시 인라인 편집 토글
                    if (window.event && window.event.type === 'contextmenu') {
                        window.event.preventDefault();
                        handleToggleAmountEdit(id);
                        return o;
                    }
                    
                    // 기본 클릭: 현금 완납 토글
                    const isFullCash = currentDeposit === price && o.cardAmount === 0;
                    const nextDeposit = isFullCash ? 0 : price;
                    
                    return sanitizeOrder({ 
                        ...o, 
                        deposit: nextDeposit,
                        cardAmount: isFullCash ? o.cardAmount : 0, 
                        isPaid: nextDeposit > 0 ? true : false 
                    });
                }));
            };

            // [NEW] Card Toggle Logic (Left Click: Full Card, Right Click: Manual)
            const handleAutoCardFull = (id) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const price = parseNum(o.price);
                    
                    // 우클릭 시 인라인 편집 토글
                    if (window.event && window.event.type === 'contextmenu') {
                        window.event.preventDefault();
                        handleToggleAmountEdit(id, 'card'); // Pass 'card' as source
                        return o;
                    }

                    // 기본 클릭: 카드 완납 토글
                    const isFullCard = o.cardAmount === price && o.deposit === 0;
                    const nextCard = isFullCard ? 0 : price;

                    return sanitizeOrder({ 
                        ...o, 
                        cardAmount: nextCard,
                        deposit: isFullCard ? o.deposit : 0, 
                        isCardPaid: nextCard > 0, 
                        isPaid: nextCard > 0
                    });
                }));
            };

            const handleSetCardAmount = (id, amount) => { 
                setOrders(prev => prev.map(o => { 
                    if (o.id !== id) return o;
                    const newAmount = Number(amount) || 0;
                    const price = parseNum(o.price);
                    
                    return sanitizeOrder({ 
                        ...o, 
                        cardAmount: newAmount, 
                        isCardPaid: newAmount > 0, 
                        isPaid: (o.deposit + newAmount) >= price 
                    });
                }));
            };

            const handleSetDepositAmount = (id, amount) => {
                setOrders(prev => prev.map(o => {
                    if (o.id !== id) return o;
                    const newAmount = Number(amount) || 0;
                    const price = parseNum(o.price);
                    return sanitizeOrder({ ...o, deposit: newAmount, isPaid: (newAmount + o.cardAmount) >= price });
                }));
            };


            const handleToggleAmountEdit = (id, source = null) => { 
                setEditingAmountId(id === editingAmountId ? null : id); 
                setEditSource(source);
                setEditingShippingId(null); 
            };
            
            const handleToggleShippingEdit = (id) => { setEditingShippingId(id === editingShippingId ? null : id); setEditingAmountId(null); };
            const handleToggleAddressEdit = (id) => { setEditingAddressId(id === editingAddressId ? null : id); };
            
            const handleShippingToggle = (id) => {
                const targetOrder = orders.find(o => o.id === id);
                if (!targetOrder) return;
                const customer = targetOrder.customer;
                const newStatus = !targetOrder.isShippingPaid;
                
                if (window.event && window.event.type === 'contextmenu') {
                    window.event.preventDefault();
                    setEditingShippingId(id === editingShippingId ? null : id);
                    return;
                }
                
                setOrders(prev => prev.map(o => {
                    if (o.customer === customer) {
                        return sanitizeOrder({ ...o, isShippingPaid: newStatus });
                    }
                    return o;
                }));
            };

            // [NEW] Excel-like Navigation: Enter moves focus to next row's cell
            const handleGridKeyDown = (e, field, idx) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextId = `cell-${field}-${idx + 1}`;
                    const nextEl = document.getElementById(nextId);
                    if (nextEl) {
                        nextEl.focus();
                        nextEl.select(); // Optional: select text in next cell like Excel
                    }
                }
            };

            const handlePriceBlur = (id, e) => {
                // Formatting logic moved to render or sanitize?
                // Actually, if we want to format "1000" to "1,000", we can do it here by updating state with formatted string?
                // But we are using textarea which allows newlines. Formatting might kill newlines.
                // Let's just keep the value as is for now to support multiline text.
            };

            const getCSVString = (listData, mode) => { 
                const list = [...listData].map(sanitizeOrder).sort((a, b) => (a.customer || '').localeCompare(b.customer || '')); 
                
                const firstIds = {}; 
                list.forEach(o => { 
                    if (o.customer) {
                        if (!firstIds[o.customer] || o.id < firstIds[o.customer]) {
                            firstIds[o.customer] = o.id;
                        }
                    }
                }); 
                
                const clean = (val) => '"' + String(val || '').replace(/"/g, '""') + '"'; 
                const cleanPhone = (val) => { if (!val) return '""'; const strVal = String(val); return "\"\u200B" + strVal + '"'; }; 
                if (mode === 'invoice') { 
                    const excelHeaders = ['', '', '', '', '상품명', '수령인', '연락처', '주소', '배송메모', '', '메모', '우편번호', '']; 
                    const csv = [excelHeaders.join(',')].concat(list.map(o => { 
                        let quantitySuffix = ''; 
                        const qtyNum = parseNum(o.quantity);
                        if (qtyNum >= 2) { quantitySuffix = ` ★${qtyNum}`; } 
                        const productName = `[${o.customer || '미지정'}] ${o.product}${quantitySuffix}`; 
                        return ['', '', '', '', clean(productName), clean(o.recipientName), cleanPhone(o.phone), clean((o.addressText||'') + ' ' + (o.addressDetail||'')), clean(o.shippingMemo), '', clean(o.memo), cleanPhone(o.zipCode), ''].join(','); 
                    })).join('\n'); 
                    return "\ufeff" + csv; 
                } else { 
                    const headers = ['닉네임', '입금명', '상품명', '수량', '금액', '입금액(현금)', '카드결제액', '배송비', '미수금', '수령인', '연락처', '우편번호', '주소', '배송메모', '메모']; 
                    const csv = [headers.join(',')].concat(list.map(o => { 
                        const isFirst = firstIds[o.customer] === o.id; 
                        const ship = o.customShippingFee ?? quickShipping; 
                        const shipCharge = isFirst ? ship : 0; 
                        const priceNum = parseNum(o.price);
                        const unpaid = Math.max(0, (priceNum + shipCharge) - (o.deposit + o.cardAmount + (isFirst && o.isShippingPaid ? ship : 0))); 
                        return [clean(o.customer), clean(o.phone), clean(o.product), o.quantity, priceNum, clean(o.deposit), clean(o.cardAmount), clean(shipCharge), clean(unpaid), clean(o.recipientName), cleanPhone(o.phone), cleanPhone(o.zipCode), clean((o.addressText||'') + ' ' + (o.addressDetail||'')), clean(o.shippingMemo), clean(o.memo)].join(','); 
                    })).join('\n'); 
                    return "\ufeff" + csv; 
                } 
            };
            const handleDownloadCSV = (mode) => { const csvString = getCSVString(orders, mode); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const timestamp = new Date().toISOString().slice(0, 10); link.setAttribute('download', `${mode === 'invoice' ? '송장용_' : '전체주문_'}${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleDownloadProductCSV = () => { const summary = {}; orders.forEach(o => { const key = o.product || '미지정'; summary[key] = (summary[key] || 0) + parseNum(o.quantity); }); const csvContent = "\ufeff상품명,수량\n" + Object.entries(summary).map(e => e.join(',')).join('\n'); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.setAttribute('download', `발주리스트_${new Date().toISOString().slice(0, 10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
            const handleSetGoogleUrl = () => { const url = window.prompt("Google Apps Script 웹 앱 URL 입력:", googleScriptUrl); if (url !== null) { setGoogleScriptUrl(url.trim()); showToast("URL 저장 완료"); } };
            const handleLoadFromGoogle = async () => { if (!googleScriptUrl) { handleSetGoogleUrl(); return; } setIsSyncing(true); try { const res = await fetch(googleScriptUrl); const data = await res.json(); if (data.orders) { const rows = JSON.parse(data.orders); const headers = rows[0]; const loadedOrders = rows.slice(1).map(row => { const obj = {}; headers.forEach((h, i) => obj[h] = row[i]); return sanitizeOrder(obj); }); setOrders(loadedOrders); } if (data.products) setProductHistory(JSON.parse(data.products)); if (data.customers) { const custRows = JSON.parse(data.customers); const newDB = {}; custRows.slice(1).forEach(r => { newDB[r[0]] = { recipientName: r[1], phone: r[2], zipCode: r[3], addressText: r[4], shippingMemo: r[5] }; }); setCustomerDB(newDB); } showToast("불러오기 완료"); } catch (e) { showToast("실패: " + e.message, "error"); } finally { setIsSyncing(false); } };
            const handleSaveToGoogle = async () => { if (!googleScriptUrl) { handleSetGoogleUrl(); return; } setIsSyncing(true); try { const payload = { orders: JSON.stringify(orders), products: JSON.stringify(productHistory), customers: JSON.stringify(customerDB) }; const res = await fetch(googleScriptUrl, { method: 'POST', body: JSON.stringify(payload) }); const json = await res.json(); if (json.status === 'success') showToast("저장 완료"); else throw new Error(json.message || "Unknown Error"); } catch (e) { showToast("저장 실패", "error"); console.error(e); } finally { setIsSyncing(false); } };
            const handleDownloadHTML = () => { const blob = new Blob([document.documentElement.outerHTML], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_${date.getHours().toString().padStart(2,'0')}${date.getMinutes().toString().padStart(2,'0')}`; a.download = `강은지_주문서_백업_${timestamp}.html`; a.click(); URL.revokeObjectURL(url); showToast('백업 완료'); };
            const handleUploadClick = () => fileInputRef.current && fileInputRef.current.click();
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const uploaded = results.data.map((row, i) => sanitizeOrder({ id: Date.now() + i, originalText: `UPLOAD: ${row['상품명']}`, customer: row['닉네임']?.trim(), product: row['상품명'], quantity: Number(row['수량']) || 1, price: Number(row['금액']?.replace(/,/g, '')) || 0, deposit: Number(row['입금액(현금)']), cardAmount: Number(row['카드결제액']), recipientName: row['수령인'], phone: row['연락처'], zipCode: row['우편번호'], addressText: row['주소'], shippingMemo: row['배송메모'], memo: row['메모'] })).filter(o => o.customer); setOrders(prev => [...uploaded, ...prev]); showToast(`${uploaded.length}건 업로드 완료`); } }); e.target.value = null; };
            const handleCustomerUploadClick = () => customerFileRef.current && customerFileRef.current.click();
            const handleCustomerFileUpload = (e) => { const file = e.target.files[0]; if (!file) return; Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => { const newDB = { ...customerDB }; let count = 0; results.data.forEach(row => { const nick = row['닉네임'] || row['Nickname'] || row['이름'] || row['성함']; if (nick && nick.trim()) { newDB[nick.trim()] = { recipientName: row['수령인'] || row['받는분'] || row['이름'] || nick.trim(), phone: row['연락처'] || row['전화번호'] || row['휴대폰'] || '', zipCode: row['우편번호'] || row['Zip'] || '', addressText: row['주소'] || row['Address'] || row['기본주소'] || '', addressDetail: row['상세주소'] || '', shippingMemo: row['배송메모'] || row['배송요청사항'] || row['메모'] || '' }; count++; } }); setCustomerDB(newDB); showToast(`총 ${count}명 고객 등록 완료`, 'success'); } }); e.target.value = null; };
            const handleReset = () => { if (window.confirm("정말로 모든 주문 내역을 삭제하시겠습니까? (고객 데이터는 유지됩니다)")) { setOrders([]); showToast("초기화 완료", "error"); } };

            const firstOrderIds = useMemo(() => { 
                const ids = {}; 
                orders.forEach(o => { 
                    if (o.customer) {
                        if (!ids[o.customer] || o.id < ids[o.customer]) {
                            ids[o.customer] = o.id;
                        }
                    }
                }); 
                return ids; 
            }, [orders]);
            
            // --- NEW: STATS CALCULATION MEMOIZED ---
            const stats = useMemo(() => {
                let totalRev = 0;
                let totalQty = 0;
                let productUnpaid = 0;
                let shipUnpaid = 0;
                const shippingCustomers = new Set();
                const processedCustomers = {};

                orders.forEach(o => {
                    // [MODIFIED] Use parseNum
                    const priceVal = parseNum(o.price);
                    totalRev += priceVal;
                    totalQty += parseNum(o.quantity);
                    
                    if (!o.customer) return;

                    // 그룹별 통계 계산 (고객별 한번만 계산되어야 하는 항목)
                    if (!processedCustomers[o.customer]) {
                        // 현재 주문과 같은 고객의 모든 주문 합산
                        const customerGroupOrders = orders.filter(groupO => groupO.customer === o.customer);
                        
                        // 고객 그룹 통계 계산
                        const groupProductTotal = customerGroupOrders.reduce((sum, item) => sum + parseNum(item.price), 0);
                        const groupDeposit = customerGroupOrders.reduce((sum, item) => sum + item.deposit, 0);
                        const groupCard = customerGroupOrders.reduce((sum, item) => sum + item.cardAmount, 0);
                        
                        // [FIXED] 배송비 계산: 해당 고객의 주문 중 "가장 오래된 주문(Main Order)"의 배송비를 우선 적용
                        const mainOrder = customerGroupOrders.reduce((oldest, current) => (current.id < oldest.id ? current : oldest), customerGroupOrders[0]);
                        const groupShipFee = (mainOrder.customShippingFee !== null && mainOrder.customShippingFee !== undefined) 
                            ? mainOrder.customShippingFee 
                            : Number(quickShipping);
                        
                        // [MODIFIED] 통계에서 배송비 결제 여부 판단: 가장 오래된 주문(Main Order)의 상태를 기준으로 함
                        const isShippingPaid = mainOrder.isShippingPaid;

                        const groupTotalPaid = groupDeposit + groupCard + (isShippingPaid ? groupShipFee : 0); 
                        
                        const groupTotalRequired = groupProductTotal + groupShipFee;
                        
                        // 미수금 계산
                        const remaining = Math.max(0, groupTotalRequired - groupTotalPaid);
                        
                        // 배송 미수금 (배송비 결제 버튼이 눌리지 않았을 경우)
                        if (!isShippingPaid && groupShipFee > 0) {
                            shipUnpaid += groupShipFee;
                        }

                        // 물품 미수금 (총 미수금에서 배송비 미수금을 제외한 나머지)
                        const remainingAfterShipUnpaid = Math.max(0, remaining - (!isShippingPaid ? groupShipFee : 0));
                        productUnpaid += remainingAfterShipUnpaid;
                        
                        // [MODIFIED] 배송 건수: 중복되지 않는 닉네임 수 (배송비 유무 상관없음)
                        shippingCustomers.add(o.customer);

                        // 중복 계산 방지
                        processedCustomers[o.customer] = true;
                    }
                });

                return {
                    totalRev,
                    qty: totalQty,
                    shippingCount: shippingCustomers.size,
                    productUnpaid: productUnpaid,
                    shipUnpaid: shipUnpaid
                };
            }, [orders, quickShipping]);
            // --- END: STATS CALCULATION MEMOIZED ---

            // ... (나머지 코드는 동일하게 유지)

            const processTextLine = (text) => {
                if (!text) return null;
                const cleanText = text.trim();
                
                // --- BATCH MODE ---
                if (converterTab === 'batch') {
                    if (!cleanText.startsWith('@')) return null;
                    let customer = cleanText.substring(1).trim(); 
                    if (!customer) return null;
                    const product = batchProduct || '기본 상품'; 
                    const unitPrice = Number(batchPrice) || productHistory[product] || 0;
                    const quantity = 1; 
                    const price = quantity * unitPrice;
                    const crmData = customerDB[customer];
                    if (product && !productCategories[product]) { setProductCategories(prev => ({ ...prev, [product]: currentSite })); }
                    if (batchCode) { setProductNumbers(prev => ({...prev, [product]: batchCode})); }
                    if (unitPrice > 0) { setProductHistory(prev => ({...prev, [product]: unitPrice})); }

                    return sanitizeOrder({ id: Date.now() + Math.random(), originalText: text, customer, product, quantity, price, recipientName: crmData?.recipientName || '', phone: crmData?.phone || '', zipCode: crmData?.zipCode || '', addressText: crmData?.addressText || '', shippingMemo: crmData?.shippingMemo || '', isCRM: !!crmData });
                }
                
                // --- GENERAL MODE (Speed Entry) ---
                // Format: [닉네임] [상품명] [수량]
                const parts = cleanText.split(/\s+/);
                let customer = parts[0];
                customer = customer.replace(/^@/, '').replace(/[:.,]$/, '');
                
                let product = '';
                let quantity = 1;

                if (parts.length > 1) {
                    const productRaw = parts.slice(1).join(' ');
                    const qtyMatch = productRaw.match(/(\d+)\s*(?:개|set|ea|box)?$/i);
                    if (qtyMatch) {
                        quantity = parseInt(qtyMatch[1], 10);
                        // 상품명은 수량 정보를 제거한 나머지
                        product = productRaw.replace(qtyMatch[0], '').trim() || productRaw.replace(/(\s*(?:개|set|ea|box)?)$/i, '').trim(); 
                    } else {
                        // 수량 정보가 없으면 전체를 상품명으로 간주
                        product = productRaw.trim();
                    }
                } else {
                    // 닉네임만 주어진 경우, 기본 상품 사용
                    product = quickName || '기본 상품';
                }
                
                const unitPrice = productHistory[product] || 0;
                
                const price = quantity * unitPrice;
                const crmData = customerDB[customer];
                if (product && !productCategories[product]) { setProductCategories(prev => ({ ...prev, [product]: currentSite })); }
                
                return sanitizeOrder({ id: Date.now() + Math.random(), originalText: text, customer, product, quantity, price, recipientName: crmData?.recipientName || '', phone: crmData?.phone || '', zipCode: crmData?.zipCode || '', addressText: crmData?.addressText || '', shippingMemo: crmData?.shippingMemo || '', isCRM: !!crmData });
            };

            const handleParseOrders = () => {
                // 이 함수는 '일괄입력'에서만 사용됨
                if (converterTab !== 'batch' || !rawInput.trim()) { showToast('일괄입력 내용이 없습니다.', 'error'); return; }
                setIsProcessing(true);
                setTimeout(() => {
                    const lines = rawInput.split('\n').map(l => l.trim()).filter(Boolean);
                    const newOrders = [];
                    
                    // 기존 주문 목록에 있는 고객 닉네임 집합
                    const existingCustomersInOrders = new Set(orders.map(o => o.customer).filter(Boolean));
                    // 현재 입력에서 이미 처리된 고객 닉네임 집합
                    const processedCustomersInInput = new Set();

                    lines.forEach((line) => {
                        const order = processTextLine(line);
                        if (order && order.customer) {
                            const customerName = order.customer;
                            
                            // 1. 고객이 시스템 내 (기존 orders)에 없고, 이번 입력에서도 처음 나타난 경우 '첫 주문'으로 간주
                            const customerExists = existingCustomersInOrders.has(customerName);
                            const isFirstOrderInInput = !processedCustomersInInput.has(customerName);

                            const isFirstOrderInSystem = !customerExists && isFirstOrderInInput;

                            // 현재 입력에서 처리했음을 표시
                            processedCustomersInInput.add(customerName);

                            // 2. 배송비 및 결제 상태 설정
                            const shipFee = quickShipping;

                            newOrders.push(sanitizeOrder({ 
                                ...order, 
                                isShippingPaid: !isFirstOrderInSystem, // 첫 주문은 false (미수금 시작)
                                customShippingFee: isFirstOrderInSystem ? shipFee : null, // [MODIFIED] 첫 주문만 배송비 부여, 추가 주문은 null (기존 주문 배송비 유지)
                            }));
                        } else if (order) {
                            newOrders.push(order); 
                        }
                    });
                    
                    setOrders(prev => [...newOrders, ...prev]);
                    setRawInput('');
                    setIsProcessing(false);
                    showToast(`${newOrders.length}건 일괄 등록 완료`);
                }, 100);
            };

            const handleSpeedInputSubmit = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    const lines = speedInput.split('\n').map(l => l.trim()).filter(Boolean);
                    if (lines.length === 0) return;

                    const newOrders = [];
                    // 기존 주문 목록에 있는 고객 닉네임 집합
                    const existingCustomersInOrders = new Set(orders.map(o => o.customer).filter(Boolean));
                    // 현재 입력에서 이미 처리된 고객 닉네임 집합
                    const processedCustomersInInput = new Set();
                    
                    lines.forEach((line) => {
                        const order = processTextLine(line);
                        if (order && order.customer) {
                            const customerName = order.customer;
                            
                            // 1. 고객이 시스템 내 (기존 orders)에 없고, 이번 입력에서도 처음 나타난 경우 '첫 주문'으로 간주
                            const customerExists = existingCustomersInOrders.has(customerName);
                            const isFirstOrderInInput = !processedCustomersInInput.has(customerName);

                            const isFirstOrderInSystem = !customerExists && isFirstOrderInInput;

                            // 현재 입력에서 처리했음을 표시
                            processedCustomersInInput.add(customerName);

                            // 2. 배송비 및 결제 상태 적용
                            const shipFee = quickShipping;

                            newOrders.push(sanitizeOrder({ 
                                ...order, 
                                isShippingPaid: !isFirstOrderInSystem, // 첫 주문은 false (미수금 시작)
                                customShippingFee: isFirstOrderInSystem ? shipFee : null, // [MODIFIED] 첫 주문만 배송비 부여, 추가 주문은 null (기존 주문 배송비 유지)
                            }));
                        } else if (order) {
                            newOrders.push(order); 
                        }
                    });
                    
                    if (newOrders.length > 0) {
                        setOrders(prev => [...newOrders, ...prev]);
                        setSpeedInput('');
                        showToast(`${newOrders.length}건 주문 추가 완료`, 'success');
                    }
                }
            };
            
            // Re-map handleSpeedInput to the new submit handler
            const handleSpeedInput = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enter는 줄바꿈 허용
                    handleSpeedInputSubmit(e);
                }
            };


            const filteredOrders = useMemo(() => {
                let result = orders;
                
                // 1. 텍스트 검색 필터
                if (filterText) {
                    const lower = filterText.toLowerCase();
                    result = result.filter(o => (o.customer && o.customer.toLowerCase().includes(lower)) || (o.product && o.product.toLowerCase().includes(lower)));
                }

                // [수정] 2. 미수금 필터 로직 개선 (통계 로직과 동일하게 고객 단위로 정확히 계산)
                if (unpaidFilter) {
                    // 전체 주문을 순회하며 고객별 그룹화 데이터 생성 (검색 필터 전의 전체 데이터 기준)
                    const customerStats = {};
                    
                    orders.forEach(o => {
                        const customer = o.customer || '미지정';
                        if (!customerStats[customer]) {
                            customerStats[customer] = {
                                orders: [],
                                productTotal: 0,
                                totalDeposit: 0,
                                totalCard: 0
                            };
                        }
                        customerStats[customer].orders.push(o);
                        customerStats[customer].productTotal += parseNum(o.price);
                        customerStats[customer].totalDeposit += o.deposit;
                        customerStats[customer].totalCard += o.cardAmount;
                    });

                    // 각 고객별로 미수금 상태 판별하여 필터링 대상 고객 목록 추출
                    const eligibleCustomers = new Set();
                    
                    Object.entries(customerStats).forEach(([customer, data]) => {
                        if (data.orders.length === 0) return;

                        // 가장 오래된 주문 찾기 (배송비 및 결제 상태 기준)
                        const mainOrder = data.orders.reduce((oldest, current) => (current.id < oldest.id ? current : oldest), data.orders[0]);
                        
                        const shipFee = (mainOrder.customShippingFee !== null && mainOrder.customShippingFee !== undefined) 
                            ? mainOrder.customShippingFee 
                            : Number(quickShipping);
                        
                        const isShippingPaid = mainOrder.isShippingPaid;

                        // 총 납부액 (현금 + 카드 + 배송비결제분)
                        const totalPaid = data.totalDeposit + data.totalCard + (isShippingPaid ? shipFee : 0);
                        // 총 필요금액 (물품 + 배송비)
                        const totalRequired = data.productTotal + shipFee;
                        // 총 미수금
                        const remaining = Math.max(0, totalRequired - totalPaid);

                        // 필터 조건 검사
                        if (unpaidFilter === 'ship') {
                            // 배송 미수금 필터: 배송비가 결제되지 않았고, 배송비가 0원보다 큰 경우
                            // (단순히 버튼 상태만 보는 것이 아니라 실제 미수금이 있는지 확인)
                            if (!isShippingPaid && shipFee > 0) {
                                eligibleCustomers.add(customer);
                            }
                        } else if (unpaidFilter === 'cash') {
                            // 물품 미수금 필터: 총 미수금에서 배송비 미수금을 제외하고도 남은 금액이 있는 경우
                            const shipUnpaidAmount = (!isShippingPaid && shipFee > 0) ? shipFee : 0;
                            const productMissing = Math.max(0, remaining - shipUnpaidAmount);
                            
                            if (productMissing > 0) {
                                eligibleCustomers.add(customer);
                            }
                        }
                    });

                    // 위에서 선별된 고객의 주문만 남김
                    result = result.filter(o => eligibleCustomers.has(o.customer || '미지정'));
                }

                // 3. 사이드바 폴더 필터
                if (selectedCustomerFolder !== 'all') {
                    result = result.filter(o => o.customer === selectedCustomerFolder);
                }

                return result;
            }, [orders, filterText, unpaidFilter, quickShipping, selectedCustomerFolder]);

            // Customer Folder Data (Left Sidebar)
            const customerFolders = useMemo(() => {
                let base = orders;
                if (folderSearch) {
                    const lower = folderSearch.toLowerCase();
                    base = base.filter(o => o.customer && o.customer.toLowerCase().includes(lower));
                }
                const map = {};
                base.forEach(o => {
                    const k = o.customer || '미지정';
                    if (!map[k]) map[k] = { name: k, count: 0, unpaid: false };
                    map[k].count++;
                    const paid = o.deposit + o.cardAmount;
                    const required = parseNum(o.price); 
                    if (paid < required) map[k].unpaid = true; 
                });
                return Object.values(map).sort((a,b) => a.name.localeCompare(b.name));
            }, [orders, folderSearch]);

            const focusedOrder = useMemo(() => { return orders.find(o => o.id === focusedOrderId); }, [orders, focusedOrderId]);

            // Generate Order Message Template
            const generateOrderSummary = (targetCustomer) => {
                const custOrders = orders.filter(o => o.customer === targetCustomer);
                if (custOrders.length === 0) return '';
                let totalProduct = 0; let totalDeposit = 0; let totalCard = 0;
                
                // [FIXED] 배송비 계산: 해당 고객의 주문 중 "가장 오래된 주문(Main Order)"의 배송비를 우선 적용
                const mainOrder = custOrders.reduce((oldest, current) => (current.id < oldest.id ? current : oldest), custOrders[0]);
                const shipFee = (mainOrder && mainOrder.customShippingFee !== null && mainOrder.customShippingFee !== undefined) 
                    ? mainOrder.customShippingFee 
                    : Number(quickShipping);
                
                const isShipPaid = custOrders.some(o => o.isShippingPaid); 

                custOrders.forEach(o => {
                    totalProduct += parseNum(o.price);
                    totalDeposit += o.deposit;
                    totalCard += o.cardAmount;
                });

                const cardSurcharge = Math.round(totalCard * 0.1);
                const totalPaid = totalDeposit + totalCard;

                // 총 필수 금액 계산: 물품 금액 + 배송비
                const totalRequired = totalProduct + shipFee;
                
                // 총 결제 금액: 현금 + 카드 + (배송비 결제 토글된 경우 배송비)
                const totalPaidWithShip = totalPaid + (isShipPaid ? shipFee : 0);
                
                // 미수금
                const remaining = Math.max(0, totalRequired - totalPaidWithShip);
                

                let text = `💙 ${targetCustomer} 님 💙\n\n`;
                custOrders.forEach(o => {
                    const priceVal = parseNum(o.price);
                    text += `${o.product} ${priceVal.toLocaleString()}원`;
                    if (parseNum(o.quantity) > 1) text += ` (${o.quantity})`;
                    text += `\n`;
                });
                text += `배송비 ${shipFee.toLocaleString()}원\n`;
                text += `\n총 주문금액 ${totalRequired.toLocaleString()}원\n`;
                text += `------------------\n`;
                
                // --- 입금 확인 섹션 ---
                const isCompletelyPaid = remaining === 0;

                if (totalPaid > 0 || totalCard > 0 || isShipPaid) {
                    text += `[입금확인]\n`;
                    if (totalDeposit > 0) {
                        text += `${totalDeposit.toLocaleString()}원 (현금)\n`;
                    }
                    
                    if (totalCard > 0) {
                        // 카드 결제 시 10% 추가금 안내
                        text += `\n[카드 결제 안내]\n`;
                        text += `카드 결제 금액: ${totalCard.toLocaleString()}원\n`;
                        text += `10% 추가 금액: ${cardSurcharge.toLocaleString()}원\n`;
                        text += `👉 총 ${(totalCard + cardSurcharge).toLocaleString()}원 예정\n`;
                    }
                    
                    if (isShipPaid && shipFee > 0) {
                         text += `✅ 배송비 결제 완료 (${shipFee.toLocaleString()}원)\n`;
                    }
                    
                    if (isCompletelyPaid) {
                         text += `\n완납 확인! 감사합니다 😍\n`;
                    }
                    text += `------------------\n`; // 입금확인과 하단 안내 문구 사이에 구분선 추가
                }

                
                // --- 미입금 내역 섹션 ---
                if (remaining > 0) {
                    text += `\n[미입금 내역]\n`;
                    
                    const shipUnpaidAmount = (!isShipPaid && shipFee > 0) ? shipFee : 0;
                    const productMissing = Math.max(0, remaining - shipUnpaidAmount);

                    if (shipUnpaidAmount > 0) {
                        text += `❌ 배송비: ${shipUnpaidAmount.toLocaleString()}원\n`;
                    }
                    if (productMissing > 0) {
                        text += `❌ 물품비: ${productMissing.toLocaleString()}원\n`;
                    }
                    text += `\n👉 총 입금하실 금액: ${remaining.toLocaleString()}원\n`;
                    text += `\n카카오뱅크 김선정\n7942 18 01611\n\n`;
                    text += `입금 부탁드립니다 🙏\n`;
                    text += `------------------\n`; 
                }
                
                // --- 하단 안내 문구 ---
                text += `방송마다 1회\n`;
                text += `하단의 주문서(배송지입력) 필수!!\n\n`;
                text += `이미 참여한 설문 일 경우\n`;
                text += `▫ 답변 수정하기 \n`;
                text += `▫ 또는 설문 추가 참여\n\n`;
                text += `미입력이 많아 계속 안내하오니\n`;
                text += `양해부탁드립니다. \n`;
                
                return text;
            };

            const orderMessage = useMemo(() => {
                if (selectedCustomerFolder && selectedCustomerFolder !== 'all') {
                    return generateOrderSummary(selectedCustomerFolder);
                }
                if (focusedOrder) return generateOrderSummary(focusedOrder.customer);
                return '';
            }, [orders, selectedCustomerFolder, focusedOrder, quickShipping]);

            const handleSidebarClick = (customerName) => {
                setSelectedCustomerFolder(customerName);
                const msg = generateOrderSummary(customerName);
                // Set manual message to the generated summary when sidebar clicked
                setManualMessage(msg);
                navigator.clipboard.writeText(msg);
                showToast("주문서가 복사되었습니다.");
            };

            // Sync generated order message to manual message when generated changes (and user hasn't edited, or force sync?)
            // A simple strategy: always update manual message when the underlying data for generation changes, 
            // effectively resetting edits if data changes. This is common for this type of UI.
            useEffect(() => {
                setManualMessage(orderMessage);
            }, [orderMessage]);

            return (
                <div className="flex flex-col h-screen overflow-hidden text-slate-700 dark:text-gray-300">
                    <header className="h-10 bg-white dark:bg-dark-card border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-3 shrink-0 shadow-sm z-50">
                        <div className="flex items-center gap-2"><div className="bg-brand-700 text-white p-0.5 rounded"><Icon name="Lightning" size={14} weight="fill"/></div><span className="font-bold text-xs tracking-tight text-slate-800 dark:text-white">주문관리 PRO (Lite)</span></div>
                        <div className="flex items-center gap-2">
                            <div className="flex items-center bg-slate-100 dark:bg-dark-input rounded-sm p-0.5">
                                <ActionButton onClick={handleSetGoogleUrl} color="ghost" icon="Gear" text="" className="!px-1.5"/>
                                <ActionButton onClick={handleSaveToGoogle} color="ghost" icon="CloudArrowUp" text="저장" loading={isSyncing}/>
                                <div className="w-px h-3 bg-slate-300 dark:bg-slate-600 mx-0.5"></div>
                                <ActionButton onClick={handleLoadFromGoogle} color="ghost" icon="CloudArrowDown" text="불러오기" loading={isSyncing}/>
                            </div>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md text-slate-500"><Icon name={isDarkMode ? "Sun" : "Moon"} size={14}/></button>
                            <div className="h-3 w-px bg-slate-300 dark:bg-slate-700 mx-1"></div>
                            <ActionButton onClick={handleCustomerUploadClick} color="brand" icon="AddressBook" text="고객"/>
                            <input type="file" ref={customerFileRef} onChange={handleCustomerFileUpload} accept=".csv" style={{display:'none'}}/>
                            <div className="relative" ref={excelMenuRef}>
                                <ActionButton onClick={()=>setIsExcelMenuOpen(!isExcelMenuOpen)} color="ghost" icon="FileXls" text="엑셀"/>
                                {isExcelMenuOpen && (
                                    <div className="absolute top-full right-0 mt-1 w-32 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border shadow-soft rounded-md z-50 py-1">
                                        <button onClick={()=>{handleDownloadCSV('full'); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="FileXls" className="text-accent-teal"/> 전체</button>
                                        <button onClick={()=>{handleDownloadCSV('invoice'); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 text-slate-700 dark:text-gray-300"><Icon name="Truck" className="text-brand-600"/> 송장</button>
                                        <button onClick={()=>{handleDownloadProductCSV(); setIsExcelMenuOpen(false);}} className="w-full text-left px-3 py-1.5 text-[11px] hover:bg-slate-50 dark:hover:bg-dark-input flex items-center gap-2 border-t border-slate-100 dark:border-dark-border mt-0.5 pt-0.5 text-slate-700 dark:text-gray-300"><Icon name="List" className="text-accent-amber"/> 발주</button>
                                    </div>
                                )}
                            </div>
                            <ActionButton onClick={handleDownloadHTML} color="white" icon="FloppyDisk" text="백업"/>
                            <ActionButton onClick={handleUploadClick} color="white" icon="UploadSimple" text="복원"/>
                            <ActionButton onClick={handleReset} color="ghost" icon="Eraser" text="초기화"/>
                            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".csv" style={{display:'none'}} />
                        </div>
                    </header>
                    
                    <TabNavigation activeTab={activeTab} onTabChange={setActiveTab} />
                    
                    <main className="flex-1 flex flex-col p-2 gap-2 overflow-hidden bg-[#f5f7fa] dark:bg-dark-bg">
                        {activeTab === 'order' && (
                            <>
                                <div className="shrink-0"><SummarySection stats={stats} handleUnpaidFilterClick={(t)=>setUnpaidFilter(unpaidFilter===t?null:t)} unpaidFilter={unpaidFilter}/></div>
                                <div className="shrink-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-[1.2fr_0.8fr_1.2fr_0.8fr] gap-2 h-64">
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col shadow-soft overflow-hidden">
                                        <div className="flex items-center justify-between px-2 pt-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20">
                                            <div className="flex gap-1">
                                                <button onClick={()=>setConverterTab('general')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${converterTab==='general' ? 'bg-white dark:bg-dark-card text-brand-600 dark:text-brand-400 border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>스피드입력</button>
                                                <button onClick={()=>setConverterTab('batch')} className={`px-3 py-1.5 text-xs font-bold rounded-t-lg transition-all ${converterTab==='batch' ? 'bg-white dark:bg-dark-card text-accent-rose border-x border-t border-slate-200 dark:border-slate-700 border-b-white dark:border-b-dark-card -mb-px z-10' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'}`}>일괄입력</button>
                                            </div>
                                            <div className="pb-1 pr-1 text-slate-400"><Icon name="ClipboardList"/></div>
                                        </div>
                                        <div className="flex-1 p-2 flex flex-col gap-2 overflow-y-auto">
                                            {converterTab === 'general' ? (
                                                <div className="relative flex-1 flex flex-col">
                                                    <textarea 
                                                        className="flex-1 w-full p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md text-xs outline-none focus:ring-2 focus:ring-blue-500 font-bold placeholder-blue-300 dark:placeholder-blue-700 transition-all resize-none min-h-[120px]" 
                                                        placeholder="스피드 주문 (예: 홍길동 사과 1)&#13;&#10;여러 줄 입력 가능, Enter 키로 등록" 
                                                        value={speedInput} 
                                                        onChange={e => setSpeedInput(e.target.value)} 
                                                        onKeyDown={handleSpeedInput} 
                                                        rows={6}
                                                    ></textarea>
                                                    <div className="absolute top-3 left-3 text-blue-400"><Icon name="Lightning" weight="fill" size={14}/></div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex gap-1 animate-fade-in">
                                                        <input className="w-10 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs text-center font-mono outline-none focus:border-rose-400" placeholder="코드" value={batchCode} onChange={e=>setBatchCode(e.target.value)} />
                                                        <input className="flex-1 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs font-bold outline-none focus:border-rose-400" placeholder="일괄 상품명 (예: 사과즙)" value={batchProduct} onChange={e=>setBatchProduct(e.target.value)} />
                                                        <input className="w-20 bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 rounded px-2 py-1.5 text-xs text-right font-bold outline-none focus:border-rose-400" placeholder="가격" type="number" value={batchPrice} onChange={e=>setBatchPrice(e.target.value)} />
                                                    </div>
                                                    <textarea className="flex-1 w-full p-2 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-md resize-none text-xs font-mono focus:border-rose-400 outline-none transition-all text-slate-700 dark:text-gray-200 placeholder-slate-400" placeholder="닉네임만 입력 (잡담 무시됨)&#13;&#10;@홍길동&#13;&#10;@김철수&#13;&#10;@박영희" value={rawInput} onChange={e => setRawInput(e.target.value)}></textarea>
                                                    <button onClick={handleParseOrders} disabled={isProcessing} className="w-full py-1.5 bg-rose-600 hover:bg-rose-700 text-white rounded-md text-xs font-bold transition-colors flex justify-center items-center gap-1 shadow-sm h-8">{isProcessing ? '처리 중...' : '일괄 등록하기'}</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                        <div className="flex justify-between items-center mb-1 px-1"><h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="Tag" className="text-brand-500"/> 최근 등록 상품 (클릭시 자동입력)</h3></div>
                                        <div className="flex-1 overflow-y-auto p-1 space-y-1">
                                            {recentProducts.length > 0 ? recentProducts.map(([name, price], i) => (
                                                <div key={i} onClick={() => handleRecentProductClick(name, price)} className="flex justify-between items-center text-xs p-1.5 bg-slate-50 dark:bg-dark-input rounded border border-slate-100 dark:border-slate-800 cursor-pointer hover:bg-brand-50 dark:hover:bg-slate-700 transition-colors group">
                                                    <span className="font-bold truncate flex-1 text-slate-700 dark:text-slate-300 group-hover:text-brand-600 dark:group-hover:text-brand-400" title={name}>{name}</span>
                                                    <span className="font-mono text-slate-500 text-[10px]">{price.toLocaleString()}원</span>
                                                </div>
                                            )) : <div className="h-full flex items-center justify-center text-slate-400 text-xs">최근 등록된 상품이 없습니다.</div>}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-1 h-full overflow-hidden">
                                        <AddressAdminPanel selectedOrder={focusedOrder} handleUpdateOrderBatch={(id, up) => setOrders(p => p.map(o => o.id===id ? {...o, ...up} : o))} showToast={showToast} />
                                    </div>
                                    <div className="lg:col-span-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg p-2 flex flex-col shadow-soft">
                                        <div className="flex justify-between items-center mb-1 px-1">
                                            <h3 className="text-xs font-bold text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="ChatText" className="text-accent-amber"/> 카카오톡 주문서</h3>
                                            <button onClick={() => { navigator.clipboard.writeText(manualMessage); showToast("주문서가 복사되었습니다."); }} className="text-[10px] bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 px-2 py-0.5 rounded text-slate-600 dark:text-slate-300 flex items-center gap-1"><Icon name="Copy"/> 복사하기</button>
                                        </div>
                                        <textarea className="flex-1 w-full p-2 bg-yellow-50/50 dark:bg-yellow-900/10 border border-yellow-100 dark:border-yellow-900/20 rounded-md resize-none text-xs outline-none font-mono" value={manualMessage} onChange={e => setManualMessage(e.target.value)}></textarea>
                                    </div>
                                </div>

                                <div className="flex-1 flex gap-2 min-h-0">
                                    <div className="w-40 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg shadow-sm flex flex-col overflow-hidden">
                                        <div className="p-2 border-b border-slate-100 dark:border-slate-800 bg-slate-50/50 dark:bg-dark-input/20 flex flex-col gap-1">
                                            <div className="relative">
                                                <input className="w-full pl-6 pr-2 py-1 bg-white dark:bg-dark-input border border-slate-200 dark:border-slate-700 rounded text-xs outline-none focus:border-brand-500" placeholder="주문자 검색..." value={folderSearch} onChange={e => setFolderSearch(e.target.value)} />
                                                <div className="absolute left-1.5 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={10}/></div>
                                            </div>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-1 space-y-0.5">
                                            <button onClick={() => setSelectedCustomerFolder('all')} className={`w-full text-left px-2 py-1.5 text-xs rounded transition-colors flex items-center justify-between ${selectedCustomerFolder === 'all' ? 'bg-blue-50 text-blue-600 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}><span>전체 보기</span></button>
                                            {customerFolders.map(c => (
                                                <button key={c.name} onClick={() => handleSidebarClick(c.name)} className={`w-full text-left px-2 py-1.5 text-xs rounded transition-colors flex items-center justify-between group ${selectedCustomerFolder === c.name ? 'bg-blue-50 text-blue-600 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300'}`}>
                                                    <span className="truncate flex-1">{c.name}</span>
                                                    <div className="flex items-center gap-1">{c.unpaid && <div className="w-1.5 h-1.5 rounded-full bg-rose-500"></div>}<span className="text-[10px] text-slate-400">{c.count}</span></div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex-1 bg-white dark:bg-dark-card border border-slate-200 dark:border-dark-border rounded-lg flex flex-col overflow-hidden shadow-soft min-h-0">
                                        <div className="p-1.5 border-b border-slate-100 dark:border-dark-border flex items-center justify-between gap-2">
                                            <div className="relative flex-1 max-w-sm"><div className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"><Icon name="Search" size={12}/></div><input className="w-full pl-7 pr-2 py-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs outline-none" placeholder="검색..." value={filterText} onChange={e => setFilterText(e.target.value)}/></div>
                                            <div className="flex items-center gap-1 ml-2">
                                                <div className="flex items-center bg-slate-100 dark:bg-slate-800 rounded-sm px-1 mr-1 border border-slate-200 dark:border-slate-700"><span className="text-[10px] text-slate-500 font-bold mr-1">현재:</span><select value={currentSite} onChange={e=>setCurrentSite(e.target.value)} className="bg-transparent text-xs font-bold text-brand-700 dark:text-brand-400 outline-none h-7 min-w-[80px]">
                                                    <option value="">미지정</option>
                                                    {categoryOrder.map(c=><option key={c} value={c}>{c}</option>)}
                                                </select></div>
                                                <input type="number" className="w-16 h-7 px-1 bg-slate-50 dark:bg-dark-input border border-slate-200 dark:border-dark-border rounded-sm text-xs outline-none focus:border-brand-500 text-right" placeholder="배송비" value={quickShipping} onChange={e=>setQuickShipping(e.target.value)} />
                                            </div>
                                        </div>
                                        
                                        {/* [수정] 헤더와 바디의 정렬 불일치(스크롤바 문제) 해결을 위해 구조 변경: 헤더를 스크롤 영역 내부로 이동하여 sticky 처리 */}
                                        <div className="flex-1 overflow-y-auto p-0 relative">
                                            {/* Sticky Header */}
                                            {/* [수정] 헤더 높이/여백 축소 (py-2 -> py-1) */}
                                            <div className="grid grid-rows-compact gap-2 px-3 py-1 bg-slate-100 dark:bg-dark-card border-b border-slate-200 dark:border-slate-700 text-[10px] font-bold text-slate-500 text-center sticky top-0 z-10 shadow-sm">
                                                {/* [수정] 너비 축소에 맞춰 텍스트 간소화 */}
                                                <div>상태</div>
                                                <div className="text-left">닉네임</div>
                                                <div className="text-left">코드</div>
                                                <div className="text-left">상품명</div>
                                                <div>수량</div>
                                                <div className="text-right">금액</div>
                                                <div>주소</div>
                                                <div className="text-left">메모</div>
                                                <div></div>
                                            </div>

                                            {/* Data Rows */}
                                            {filteredOrders.map((order, idx) => {
                                                const isFirst = firstOrderIds[order.customer] === order.id;
                                                const isCombinedPayment = order.deposit > 0 && order.cardAmount > 0;
                                                
                                                // [수정] 색상 테마 변경: 눈이 편한 파스텔 톤 (배경 100 / 글자 700 / 테두리 200)
                                                // 현금: 완납(초록), 복합(주황), 미결제(기본)
                                                const cashButtonClass = order.deposit > 0 
                                                    ? (isCombinedPayment 
                                                        ? 'bg-amber-100 text-amber-700 border-amber-200 hover:bg-amber-200' 
                                                        : 'bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200') 
                                                    : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300 hover:text-slate-600';
                                                
                                                // 카드: 결제(빨강), 미결제(기본)
                                                const cardButtonClass = order.cardAmount > 0 
                                                    ? (isCombinedPayment 
                                                        ? 'bg-rose-100 text-rose-700 border-rose-200 hover:bg-rose-200' 
                                                        : 'bg-rose-100 text-rose-700 border-rose-200 hover:bg-rose-200')
                                                    : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300 hover:text-slate-600';

                                                // 배송: 결제(파랑), 미결제(기본)
                                                const shipButtonClass = order.isShippingPaid
                                                    ? 'bg-blue-100 text-blue-700 border-blue-200 hover:bg-blue-200'
                                                    : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300 hover:text-slate-600';

                                                return (
                                                    // [수정] 행 높이 축소 (py-1 -> py-0.5)
                                                    <div key={order.id} onClick={() => setFocusedOrderId(order.id)} className={`grid grid-rows-compact gap-2 px-3 py-0.5 items-center text-xs hover:bg-slate-50 dark:hover:bg-slate-800 border-b border-slate-100 dark:border-slate-800 cursor-pointer ${focusedOrderId === order.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`}>
                                                        {/* [수정] 버튼 컨테이너: 간격 축소 (gap-1 -> gap-0.5) */}
                                                        <div className="grid grid-cols-3 gap-0.5 w-full">
                                                            
                                                            {/* 1. 현금 결제 버튼 (텍스트) - [수정] 높이 더 축소 (h-5 -> h-4) */}
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleAutoDepositFull(order.id); }} 
                                                                onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleAmountEdit(order.id); }} 
                                                                className={`w-full h-4 rounded-[3px] text-[9px] font-bold border transition-all flex items-center justify-center ${cashButtonClass}`}
                                                                title={`현금 결제 ${order.deposit > 0 ? `(${order.deposit.toLocaleString()}원)` : '(클릭: 전액, 우클릭: 복합/입력)'}`}
                                                            >
                                                                현금
                                                            </button>

                                                            {/* 2. 배송비 토글 버튼 (텍스트, 가운데) - [수정] 높이 더 축소 */}
                                                            {isFirst ? (
                                                                <button 
                                                                    onClick={(e) => { e.stopPropagation(); handleShippingToggle(order.id); }} 
                                                                    onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleShippingEdit(order.id); }}
                                                                    className={`w-full h-4 rounded-[3px] text-[9px] font-bold transition-all border flex items-center justify-center ${shipButtonClass}`}
                                                                    title={order.isShippingPaid ? "배송비 결제 완료" : "배송비 미결제"}
                                                                >
                                                                    배송
                                                                </button>
                                                            ) : <div></div>} 
                                                            
                                                            {/* 3. 카드 결제 버튼 (텍스트) - [수정] 높이 더 축소 */}
                                                            <button 
                                                                onClick={(e) => { e.stopPropagation(); handleAutoCardFull(order.id); }} 
                                                                onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); handleToggleAmountEdit(order.id, 'card'); }}
                                                                className={`w-full h-4 rounded-[3px] text-[9px] font-bold border transition-all flex items-center justify-center ${cardButtonClass}`}
                                                                title={`카드 결제 ${order.cardAmount > 0 ? `(${order.cardAmount.toLocaleString()}원)` : '(클릭: 전액, 우클릭: 복합/입력)'}`}
                                                            >
                                                                카드
                                                            </button>
                                                        </div>
                                                        <div className="relative"><input id={`cell-customer-${idx}`} className="w-full bg-transparent font-bold outline-none" value={order.customer} onChange={e => handleUpdateOrder(order.id, 'customer', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'customer', idx)} /></div>
                                                        <div className="relative"><input id={`cell-code-${idx}`} className="w-full bg-transparent font-mono outline-none text-slate-500" value={productNumbers[order.product] || ''} onChange={e => handleUpdateOrder(order.id, 'codeInput', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'code', idx)} /></div>
                                                        <div className="relative"><input id={`cell-product-${idx}`} className="w-full bg-transparent font-bold outline-none" value={order.product} onChange={e => handleUpdateOrder(order.id, 'product', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'product', idx)} /></div>
                                                        <div className="flex justify-center"><input id={`cell-quantity-${idx}`} type="number" className="w-full text-center bg-transparent font-bold outline-none" value={order.quantity} onChange={e => handleUpdateOrder(order.id, 'quantity', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'quantity', idx)} /></div>
                                                        <div className="text-right"><input id={`cell-price-${idx}`} className="w-full text-right bg-transparent font-mono outline-none focus:border-b focus:border-blue-500 cursor-text" value={order.price.toLocaleString()} onChange={e => handleUpdateOrder(order.id, 'price', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'price', idx)} /></div>
                                                        <div className="flex justify-center"><div className={`w-5 h-5 rounded-sm flex items-center justify-center cursor-default ${order.isAddressFilled ? 'bg-brand-600 text-white' : 'text-slate-300 bg-slate-100 dark:bg-slate-800'}`}><Icon name="MapPin" size={10}/></div></div>
                                                        <div><input id={`cell-memo-${idx}`} className="w-full bg-transparent text-slate-500 outline-none" value={order.memo} onChange={e => handleUpdateOrder(order.id, 'memo', e.target.value)} onKeyDown={e => handleGridKeyDown(e, 'memo', idx)} /></div>
                                                        <div className="flex justify-end"><button onClick={(e) => { e.stopPropagation(); handleDelete(order.id); }} className="text-slate-300 hover:text-rose-500"><Icon name="X" size={10}/></button></div>
                                                        
                                                        {/* Inline Edit Panels */}
                                                        {editingAmountId === order.id && (
                                                            <div className="col-span-full p-2 bg-slate-50 flex gap-2 justify-start pl-4 items-center border-y border-slate-100" onClick={e=>e.stopPropagation()}>
                                                                <span className="text-[10px] text-slate-500 font-bold">현금:</span>
                                                                <input 
                                                                    type="number" 
                                                                    placeholder="현금 금액" 
                                                                    className="w-20 p-1 border rounded text-xs text-right font-mono outline-none focus:border-brand-500" 
                                                                    value={order.deposit} 
                                                                    autoFocus={true}
                                                                    onChange={e => {
                                                                        const val = Number(e.target.value);
                                                                        handleSetDepositAmount(order.id, val);
                                                                        // [MODIFIED] If opened via Card Right Click, update Card automatically
                                                                        if (editSource === 'card') {
                                                                            const priceNum = parseNum(order.price);
                                                                            const remainder = Math.max(0, priceNum - val);
                                                                            handleSetCardAmount(order.id, remainder);
                                                                        }
                                                                    }}
                                                                    onBlur={() => handleToggleAmountEdit(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') handleToggleAmountEdit(null); }}
                                                                />
                                                                <span className="text-[10px] text-slate-500 font-bold ml-4">카드:</span>
                                                                <input 
                                                                    type="number" 
                                                                    placeholder="카드 금액" 
                                                                    className="w-20 p-1 border rounded text-xs text-right font-mono outline-none focus:border-rose-500" 
                                                                    value={order.cardAmount} 
                                                                    onChange={e => handleSetCardAmount(order.id, e.target.value)}
                                                                    onBlur={() => handleToggleAmountEdit(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') handleToggleAmountEdit(null); }}
                                                                />
                                                            </div>
                                                        )}
                                                        {editingShippingId === order.id && (
                                                            <div className="col-span-full p-1.5 bg-brand-50 dark:bg-brand-900/20 border-y border-brand-100 dark:border-brand-800 flex gap-2 justify-start pl-4 items-center animate-fade-in shadow-inner" onClick={e=>e.stopPropagation()}>
                                                                <span className="text-[10px] font-bold text-brand-600 dark:text-brand-300">개별 배송비:</span>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-16 p-0.5 rounded-sm border border-brand-200 text-right font-bold text-xs text-brand-700 outline-none" 
                                                                    value={order.customShippingFee ?? quickShipping} 
                                                                    onChange={e => handleUpdateOrder(order.id, 'customShippingFee', Number(e.target.value))} 
                                                                    onBlur={() => setEditingShippingId(null)}
                                                                    onKeyDown={(e) => { if (e.key === 'Enter') setEditingShippingId(null); }}
                                                                />
                                                                <button onClick={() => handleUpdateOrder(order.id, 'customShippingFee', null)} className="text-[10px] bg-white text-brand-600 px-2 py-0.5 rounded-sm border border-brand-200 hover:bg-brand-50">기본값</button>
                                                                <button onClick={() => setEditingShippingId(null)} className="text-[10px] bg-brand-600 text-white px-2 py-0.5 rounded-sm hover:bg-brand-700 ml-1">확인</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                        {activeTab === 'customer' && <CustomerTab customerDB={customerDB} setCustomerDB={setCustomerDB} orders={orders} showToast={showToast} />}
                        {activeTab === 'statement' && <StatementTab orders={orders} quickShipping={quickShipping} customerDB={customerDB} categoryOrder={categoryOrder} />}
                    </main>
                    
                    {toast && <div className="fixed top-6 right-6 px-4 py-2.5 bg-slate-800 text-white rounded-md shadow-lg flex items-center gap-2 animate-fade-in z-[100]"><Icon name="CheckCircle" size={14} weight="fill"/><span className="text-xs">{toast.message}</span></div>}
                </div>
            );
        };
        
        try { ReactDOM.createRoot(document.getElementById('root')).render(<App />); } catch (e) { document.body.innerHTML = `<div style="color:red;padding:20px">${e.message}</div>`; }
    </script>
</body>
</html>
